:: set echo to "on" if you want to expose the command lines used during the workflows. Useful for debugging
@echo off

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:: Leave DoVi_Scripts.bat and the tools folder in the same folder.
:: The default output folder is where ever you place "DoVi_Scripts" folder. 
:: You can change the output or temp path : Example: set output_path=D:\Video.Folder\
:: You can use external bat files for the settings. must be (tools\SETTINGS.bat)
:: Click on the DoVi_Scripts.bat, select a mode, a workflow, drag and drop input and wait...
:: MANY THANKS TO ALL THE TOOLS/CODES AUTHORS I'M USING IN THESE SCRIPTS.
:: anything that start with :: is a comment.
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::do not touch  / script filename, date and version
set script.container=MKV
set "script_name=%~nx0"
for %%F in (%~dp0%script_name%) do set "ModifiedDate=%%~tF"
::do not touch  /  find bat filename for container settings
echo "%script_name%" > "script_name.txt"
findstr /c:"MKV" "script_name.txt" >Nul
if %errorlevel%==0 set script.container=MKV
findstr /c:"MP4" "script_name.txt" >Nul
if %errorlevel%==0 set script.container=MP4
findstr /c:"TS" "script_name.txt" >Nul
if %errorlevel%==0 set script.container=TS
del "script_name.txt" >Nul
set version=3.0.8
echo   Donate: https://www.paypal.com/donate/^?hosted_button_id=6ML5KUZG9XGB6                  Date: %ModifiedDate% 
echo   Contact: R3S3T_9999@proton.me                                                          Version: %version%_%script.container%
echo   Tutorials: https://www.youtube.com/playlist^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo.

TITLE DoVi_Scripts_%version%

::dot not touch / call external settings file if exist
if exist "%~dp0tools\SETTINGS.bat" call "%~dp0tools\SETTINGS.bat"& goto :external.settings

::================================================================================================================================================
::==================================================== PATHS ====================================================================================
::================================================================================================================================================

:: change the output path here. NO SPACE NOR SPECIAL CHARACTERS!! (default=\DoVi_Scripts folder)
set output_path=%~dp0
:: change the temporary files folder here. NO SPACE NOR SPECIAL CHARACTERS!! (default=\DoVi_Scripts folder)
set temp_folder=%~dp0
:: choose if you want the output path to be the same as the input path (YES OR NO default=NO) (may not work for all the workflows)
set same_input_output=NO
:: choose if you want the temp folder to be deleted after each workflow YES or NO (default=YES)
set DEL_temp=YES

::================================================================================================================================================
::==================================================== MUX AND AUDIO SETTINGS ==============================================================
::================================================================================================================================================

::Choose prefered container. ("TS" or "MKV" or "MP4" or %script.container%) Default= This setting is controled by the script .bat filename EG. DoVi_Scripts_MKV.bat sets the container to MKV 
set container=%script.container%
::choose if you want to mux at the end of the workflows.  ("YES" or "NO" default = "YES") this wont work if "set container=none". mp4 version not affected by this setting
set MUX=YES
::choose if you want to mux all the audio from the input or just the main audio track. This is valid only if "set MUX=YES"  (YES or NO default = YES )
set mux_all_audio=YES
::choose if you want to mux all the subtitles(up to 30) from the input or just forced/full. This is valid only if "set MUX=YES" (YES or NO default = YES )
set mux_all_sub=YES
::mkvtoolnix settings
set mkvtoolnix_settings=--no-date
:: choose the mp4muxer version (OLD or NEW default = OLD) OLD works on (2018) LG TVS but Itunes P8 hybrid wont work if you dont fix the bitstream framerate first. And when it has to mux lossless or subs, the old mp4box needed will not properly set the BL compatibility ID which doesnt seem to cause issues though.
set mp4_version=NEW
::choose if you want to force the mp4muxer. Some EC3 track wont work in mp4box.(default=NO)
set force.mp4muxer=NO
:: choose if you want to force the latest mp4box when mp4_version is set to NEW. mp4box is faster (default=YES)
set forcemp4box2=YES
:: (only for 23.976)  choose if you want the old mp4 workflows to fix appleTV missing bitstream. (Default=NO)  Do not use this option blindly for all the movies/shows.
set FIXapple=NO
:: you can disable ddp encoding for all the workflows (except 8-1) (YES or NO default = NO). (except 8-1)
set encode_DDP=NO
:: you can disable ddp encoding for the MP4 version (YES or NO default = YES).
set encode_DDP_MP4=YES
:: you can disable 7.1 ddp encoding here. This set to "NO" will downscale 7.1 to 5.1... (YES or NO default = YES) The point of this setting is that you get higher bitrate and faster processing with 5.1 encoding (1536 vs 1024). mp4 version and dee workflows not affected by this setting
set encode_7.1=YES
::choose EC3 DD+ encoding bitrate (default= 1024)  2.0/5.1 = max 1536kbps and  7.1 = max 1024kbps. dee workflows not affected by this setting
set DDP_bitrate=1024
::choose if you want 8-1-1 to auto select the audio to encode based on language and best format. (default=YES)
set auto.select.audio=YES
::choose if you want to remove the dialogue normalization of existing EC3/DDP/AC3/DD tracks (default= NO) DDP Atmos metadata may no longer works if you enable this.  Works only if mux_all_audio=NO
set removeDialogueNorm=NO
::choose dialogue normalization for DEE 8-1-3 EC3 encoding (default = -31 / none)
set dialnorm=-31
:: choose if you want to encode 7.1/5.1 audio to LPCM-7.1/5.1. Choices are NO or LPCM or FLAC (YES or NO default = NO). ***FLAC not supported in TSMuxer
set encode_LL=NO
:: choose if you want to also mux the lossless audio when you convert to DD+. This is only valid if set MUX=YES (YES or NO default = YES).
set keep_lossless=YES
:: choose if you want to extract the subtitles (YES or NO default = NO).
set export.subs=NO
:: choose if you want to convert sup pgs subtitles to SRT. (YES or NO default =NO). if export.subs=NO this option has no effect for the TS and MKV version. Keep in mind that automatic OCR is not perfect
set convert.SUPTOSRT=NO

::================================================================================================================================================
::====================================SCREENSHOTS SETTINGS=================================================================================
::================================================================================================================================================

:: Choose a custom filename for the screeshots workflow OSD (7-1 / 6-2 / 6-3 / 6-4) (default = nothing)
set OSD.filename1=
set OSD.filename2=
set OSD.filename3=
:: choose if you want to use dynamic peak detection in 7-2 / 7-1 / 8-2-2  true or false (default= false)  see info here: https://github.com/Asd-g/avslibplacebo?tab=readme-ov-file#tone-mapping
set peak_detect=false
:: choose the SDR tone mapping function for 7-2 / 7-1 / 8-2-2 (default = bt2390) choices are: "clip", "st2094-40", "st2094-10", "bt2390", "bt2446a", "spline", "reinhard", "mobius", "hable", "gamma", "linear", "linearlight" see info here: https://github.com/Asd-g/avslibplacebo?tab=readme-ov-file#tone-mapping
set tone_mapping_function=bt2390
:: choose the SDR tone mapping mode  in 7-2 / 7-1 / 8-2-2 choices are: (default = perceptual") "perceptual", "softclip", "relative", "saturation", "absolute", "desaturate", "darken", "highlight", "linear" see info here: https://github.com/Asd-g/avslibplacebo?tab=readme-ov-file#tone-mapping
set gamut_mapping_mode=perceptual
:: This helps block out annoying "sparkling" or "flickering" due to small variations in frame-to-frame brightness for the SDR tone mapping mode  in 7-2 / 7-1 / 8-2-2 (default=20.0) see info here: https://github.com/Asd-g/avslibplacebo?tab=readme-ov-file#tone-mapping
set smoothing_period=20.0
::Which percentile of the input image brightness histogram to consider as the true peak of the scene for the SDR tone mapping mode  in 7-2 / 7-1 / 8-2-2 (default=99.995) see info here: https://github.com/Asd-g/avslibplacebo?tab=readme-ov-file#tone-mapping
set percentile=99.995
:: choose the amount of frames to export in 7 (default=25)
set frame_number=25
:: choose the frame interval for the screenshot export in 7 (default = 000 which means every 2000 and 00 would mean every 200 etc...)
set frame_interval=000
:: choose if you want to bake fel when input is P7 fel in 7-2 and 7-3 (default = YES)
set bakefel7273=YES
::choose if you want to measure the screenshots brightness in 7-1 and 7-2 (2 times slower) (default=NO)
set Measure_CAP=NO
:: choose if you want 7-2 to add the L1 max avg value in the osd if input has DV.. (default = NO)
set rpuvalues=NO
::choose if you want to upscale to 4k or export screenshot as encoded. (7-2)  if both inputs are 1080p, the script wont upscale regardless of this setting  (default= YES)
set upscale=YES
::choose the upscaling algo to use in 7-2... choices are: Spline64 / Spline36(default)  / Lanczos4 / Lanczos / Bicubic / Bilinear  
set upscale_algo=Spline36
::choose if you want 7-3 to ouput heatmap and gamutmap in HDR 100nits instead of SDR (Default = NO)
set maptohdr7.3=NO
::choose if you want OSD information in your screenshot for 7-1 / 7-2 / 7-3 (default= YES)
set screenshot_OSD=YES
::choose osd text color in 7-1  / 7-2  / 7-3 (default = dark grey: $5A5A5A). ignored if screenshot_OSD=NO
set osdcolor=$5A5A5A
::choose 7-1 / 7-2 / 7-3 png compression. Values from 0-9(min-max) (default = 6)
set pic_compression=6
::force HDR flag for raw magicYUV avi capture input (default=HDR) (SDR or HDR)
set avimode=HDR

::================================================================================================================================================
::=====================================ENCODERS SETTINGS====================================================================================
::================================================================================================================================================

::choose if you want encode logs. This makes the progress bar to display a new line every few frames (default = NO)
set encode_log=NO
:: choose if you want to keep the prores encode in 3-1, 6-2 and 8-2-5 (default = NO)
set keep_prores=NO
::choose if you want 8-2 to downscale to 1080p (default = NO)
set downscale=NO
:: In 8-2, choose the video encoder you want to use: x265.exe or x264.exe or NVenc gpu  (choices are: NVENC or X265 or X264) (default= X265)  NVenc is faster but much worse quality. X264 can't do HDR.
set Encoder=X265
:: choose x265/x264 encoding mode. Choices are: CRF=0 / One Pass bitrate=1 / Two Pass bitrate=2 (default=0)
set x265x264_mode=0
:: Ignored if x265x264_mode=1 or 2 (bitrate). Choose CRF value (default=15).  Higher values= smaller filesize but lower quality. Final bitrate depend on the source type(grain, dark, action etc.) but the quality is always constant/the same.
set x265x264_CRF=15
:: Ignored if x265x264_mode=0 (CRF). Choose one or two pass bitrate target (default=25000). Final bitrate will match this value but depending on the source type(grain, dark, action etc.), the quality will NOT always be the same.
set x265x264_bitrate=25000
:: Choose x265/x264 encoding preset/speed/efficiency (default=slow).  From worse(faster) to best quality(slower),  choices are  'ultrafast', 'superfast', 'veryfast', 'faster', 'fast', 'medium', 'slow', 'slower', 'veryslow'  
set x265x264_speed=slow
::choose HDR x265 settings for 8-2-1 (MDL/MDP/maxcll/fall are taken from input)
set X265_HDR_settings=--aq-mode 1 --aq-strength 1.0 --psy-rdoq 1.0 --psy-rd 2.0 --qcomp 0.60 --profile main10 --level-idc 5.1 --output-depth 10 --range limited --hdr10 --colorprim bt2020 --colormatrix bt2020nc --transfer smpte2084 --hdr10-opt --repeat-headers --hrd --aud --deblock -2:-2 --max-luma 1023 --no-sao --chromaloc 2 --vbv-maxrate 160000 --vbv-bufsize 160000 --sar 1 --no-open-gop
::choose SDR x265 settings for 8-2-1
set X265_SDR_settings=--aq-mode 1 --aq-strength 1.0 --psy-rdoq 1.0 --psy-rd 2.0 --qcomp 0.60 --profile main10 --level-idc 5.1 --output-depth 10 --range limited --no-hdr10 --colorprim bt709 --colormatrix bt709 --transfer bt709 --repeat-headers --hrd --aud --deblock -2:-2 --max-luma 1023 --no-sao --vbv-maxrate 160000 --vbv-bufsize 160000 --sar 1 --no-open-gop
::choose SDR x264 settings for 8-2-2.
set X264_SDR_settings=--aq-mode 1 --aq-strength 1.0 --vbv-maxrate 62500 --vbv-bufsize 78125 --deblock -1:-1 --ref 5 --subme 11 --merange 32 --no-fast-pskip --no-dct-decimate --level 5.2 --range tv --colorprim bt709 --colormatrix bt709 --transfer bt709
::choose HDR NVenc settings for 8-2-1 (MDL/MDP/maxcll/fall are taken from input)
set NVENC_HDR_settings=--codec h265 --vbr 50000 --multipass 2pass-full --preset P7 --output-depth 10 --profile main10 --max-bitrate 160000 --vbv-bufsize 160000 --colormatrix bt2020nc --colorprim bt2020 --transfer smpte2084 --colorrange limited --chromaloc 2 --aud --repeat-headers
::choose SDR NVenc settings for 8-2-2
set NVENC_SDR_settings=--codec h265 --vbr 50000 --multipass 2pass-full --preset P7 --output-depth 10 --profile main10 --max-bitrate 160000 --vbv-bufsize 160000 --colormatrix bt709 --colorprim bt709 --transfer bt709 --colorrange limited --aud --repeat-headers
::choose Prores encoding settings for 8-2-3 (qscale value control the compression/bitrate/size/speed
set PRORES_settings=-c:v prores_ks -profile:v 3 -vendor apl0 -pix_fmt yuv422p10le -an -hide_banner -y
:: DEE Profile 5 encoding settings 8-2-6 for CRF encoding only. Ignored if DEE_CRF=NO. YOU MUST  EDIT: ''DEE\python_scripts\encode_dvmezz_to_dv5.py'' ... Change it to https://justpaste.it/enibt  Must be separated by '':'' do not change chromaloc=0:colormatrix=2:colorprim=2:transfer=2  keyint should be changed if input is not 23.976 and bufsize and maxrate are hardcoded in ''encode_dvmezz_to_dv5.py vbv-maxrate=160000:vbv-bufsize=160000
set DEE_CRF_settings=crf=17:deblock=-2-2:aq-mode=1:aq-strength=1.0:psy-rd=2.0:psy-rdoq=1.0:no-cutree=0:min-keyint=23:keyint=250:level-idc=5.1:no-open-gop=1:aud=1:hrd=1:repeat-headers=1:sar=1:sao=0:chromaloc=0:colormatrix=2:colorprim=2:transfer=2:
::enable crf encoding in 8-2-6 DEE P5 encoding  (default = NO) YOU MUST  EDIT: ''DEE\python_scripts\encode_dvmezz_to_dv5.py'' ... Change it to https://justpaste.it/enibt
set DEE_CRF=NO
::choose the DEE.exe profile 5 preset  for 8-2(default= slow) From worse(faster) to best quality(slower),  choices are  'ultrafast', 'superfast', 'veryfast', 'faster', 'fast', 'medium', 'slow', 'slower', 'veryslow' 
set DEE_P5_preset=slow
::choose the DEE.exe profile 5 preset for 8-2 (default= 25000). Only valid for two pass encoding, Ignored if DEE_CRF=YES
set DEE_P5_bitrate=25000
::choose the number of pass in 8-2-6 DEE P5 encoding for 8-2 (default = 2) Ignored if DEE_CRF=YES
set DEE_pass=2
::enable or disable loop mode in 8-2 (default = NO)
set loop_mode=NO

::=======================================================================================================================================================
::=====================================AQ strenght comparisons settings====================================================================================
::=======================================================================================================================================================

:: settings for AQ strenght compression testing. (workflow 8-2-7) Do NOT add  --aq-strength here
set AQTEST.HDRsettings=--aq-mode 4  --psy-rdoq 1.0 --psy-rd 2.0 --qcomp 0.60 --deblock -2:-2 --profile main10 --level-idc 5.1 --output-depth 10 --range limited --hdr10 --colorprim bt2020 --colormatrix bt2020nc --transfer smpte2084 --hdr10-opt --repeat-headers --hrd --aud --max-luma 1023 --no-sao --chromaloc 2 --vbv-maxrate 160000 --vbv-bufsize 160000 --sar 1 --no-open-gop --no-cutree
set AQTEST.SDRsettings=--aq-mode 4 --psy-rdoq 1.0 --psy-rd 2.0 --qcomp 0.60 --deblock -2:-2 --profile main10 --level-idc 5.1 --output-depth 10 --range limited --no-hdr10 --colorprim bt709 --colormatrix bt709 --transfer bt709 --repeat-headers --hrd --aud --max-luma 1023 --no-sao --vbv-maxrate 160000 --vbv-bufsize 160000 --sar 1 --no-open-gop --no-cutree
set AQTEST.X264settings=--aq-mode 3 --vbv-maxrate 62500 --vbv-bufsize 78125 --psy-rd 1.05:0.15 --deblock -1:-1 --ref 5 --subme 11 --merange 32 --no-fast-pskip --no-dct-decimate --level 5.2 --range tv --colorprim bt709 --colormatrix bt709 --transfer bt709
:: Amount of frames to check in AQ comparisons  (default=3)
set AQframes=3
:: Total of frames to encode in sequence (shorter than 120 is not accurate)  (default=120)
set AQ.sequence.frames=120
::AQ values to use in comparisons:
set AQ.value1=0.70
set AQ.value2=0.80
set AQ.value3=0.90
set AQ.value4=1.0
set AQ.value5=1.10
set AQ.value6=1.20
set AQ.value7=1.30

::================================================================================================================================================
::=====================================ADVANCED SETTINGS======================================================================================
::================================================================================================================================================

:: choose if you want 6-4 to also plot L3 (default = YES) ignored if trims_plot_mode=NEW
set plot_L3=YES
:: plot cmv4.0 only in 6-4. This disable L2 plot (default = NO) ignored if trims_plot_mode=NEW
set cmv4.0.only=NO
:: plot vector field in 6-4 (default = YES) ignored if trims_plot_mode=NEW
set plotvector=YES
:: choose the timestamp for the sample maker workflow (9-3) (default=5m)
set timestamp=00:00:00-00:05:00
:: choose if  you want to auto-scale the L2/L8 graph  in 6-4 (default = YES) Set it to NO if you want to compare trims from two releases at the same scale.
set auto_scale_plot=YES
:: choose 6-3 / 6-4 / 6-2 / 6-6  plot image resolution (default= 3000:1200)
set plotimage.res=3000:1200
::choose if you want to use the old or new trims plot. Old is slower but more detailed. (default = NEW)
set trims_plot_mode=NEW
:: choose if you want to get a copy of the converted RPU for the p5 to p8 workflows (YES or NO default = YES).
set keep_rpu=YES
:: choose if you want to keep a copy of the EL for the P7 to P8 workflows (YES or NO default = NO).
set keep_EL=NO
::choose if  you want to remove HDR10plus when injecting DV(YES or NO default= NO)
set drop.HDR10plus=NO
::choose if you dont want to use ffmpeg piping for demuxing.  This option makes the process a lot faster but in rare occasion it can corrupt the output(default = NO)
set ffmpeg_pipe=NO
::choose if you dont want to use ffmpeg piping for demuxing that matter less: workflows 7 and  6. You might have to disable if you notice issues.   (default = YES)
set ffmpeg_pipe_secondary=YES
::choose if you want to auto adjust L6 for XML input. Will take value from L1...  YES or NO (default=YES)
set Auto.L6.XML=YES
::choose the validation type for positive lift in the metafier validation. --with-lift = any postive lift over 2100(0.025)  /   --with-zero-lift = any positive lift (over 2048 / 0) default = --with-lift
set lift=--with-lift
::Choose if you want to validate/test the metadata with Dolby Metafier at the end of the workflows (default=YES)
set validate_metadata=YES
::enable or disable cropped input detection (default= YES)
set auto.crop=YES
::disable or enable stats calculation in 6-2 / 6-3 / 6-4 (default= YES)
set generate_stats=YES
::=====================================CM ANALYZE (3-1) SETTINGS====================================================================================
::workaround for movies that wont work in madvr scene cut generation in 3-1 (default= NO)
set madvr_workaround=NO
:: choose the prores encoding quality/size in 3-1 (default = 4) higher values means faster encoding(depending on your cpu) and smaller filesize.
set qscale=4
:: force cpu for the CM_analyze (3-1)  YES or NO (default=NO)
set CM_CPU=NO
:: choose if you want to force frame by frame analysis in 3-1 (default = NO)
set force.FBF=NO
::================================================================================================================================================
:: you may have to set this to YES for some TS/M2TS/MPLS input with delay. This option will not work for TS/M2TS/MPLS input with negative delay or without any delay. Default = NO 
set input.delay=NO
:: choose the frame number to check when the dovi_tool -info RPU (default=24)
set frame.to.read_path=24
:: choose the brightness percentage for 9-5 pgs tonemapping (default=60)
set percentage=60
:: choose if you want 6-2 SDR plot downscale the input to speed up the process. This option will work only if crop.prores62=YES and when you opt to crop (default = NO)
set downscaleHDRmeasure=NO
:: choose if you want 6-2 to convert to prores when you opt to crop. This may be faster depending on your CPU (default = NO)
set crop.prores62=NO
:: choose if you want 9-1 to downscale the input to speed up the process when input is 4K. (default = YES)
set downscaleframediff=YES
:: choose if you want 6-2 to measure frame by frame. VERY VERY slow... YES or NO (default = NO)
set Measure_HDR_FBF=NO
:: choose if you want 7-3 to uncrop... needed for heatmap but might not work if cropped is not mod2 (default = YES)
set uncropheatmap=YES
:: choose the scene detection algo to use in 7-4 choices: detect-content (change in HSV color space) / detect-adaptive (better fast movement detection) / detect-threshold (intensity/brightness)
set scene_detect_type=detect-adaptive
:: choose if you want to force ffms2 instead of dgdemux in 7-1 and 8-2 (dovi baker).  default = NO (not needed anymore, the script will auto detect nvidia gpu) 
set force_ffms2=NO
::choose if you want to index your input before the prores encoding in 3-1  and 8-2-3 default=NO (disabling indexing is not recommended as it is needed for frame accurate reading)
set disable_indexing=NO
:: set the number of thread to use in 7-1 dovibaker (default = 8) http://avisynth.nl/index.php/SetFilterMTMode
set Prefetch=Prefetch(8)
::choose if you want 3-2 to generate DV without floor. Otherwise average value below 10nits and max pq value under 100nits are ignored as it is in Dolby Vision cmv 4.0. (default = NO)
set Force.DV.NOFLOOR=NO
::choose if you want 7-4 to compare with L1=0/0/0 instead of the usual 100/2.5/0.000262nits floor (default=NO)
set nofloor74=NO
::Choose if you want to remove the 100 L2 trim pass. (only valid for 1-1xml and 3-1) (require the dolby metafier) (default=NO)
set remove_100=NO
::Choose if you want to remove the 600 L2 trim pass.(only valid for 1-1xml and 3-1) (require the dolby metafier)(default=NO)
set remove_600=NO
::Choose if you want to remove the 1000 L2 trim pass.(only valid for 1-1xml and 3-1) (require the dolby metafier) (default=NO)
set remove_1000=NO
:: choose if  you want to remove cmv4.0 in (1-1xml) and (3-1) (default = NO)
set rem_cmv4=NO
:: choose if you want 8-6 to downmix 7.1 channels to 5.1 (default = NO)
set audiowavedownmix=NO
:: export cmv2.9 and cmv4.0 samples in 7-4 (default = NO)
set two.sample=NO
:: bypass nvidia check in 8-2 7-1 7-2 7-3 7-4 7-5 in case Nvidia is not detected for some reasons  (default = NO)
set no_nvidia_check=NO
:: override 7-2 upscaling factor if source is not 1080p or 2160p.  EG use 3 for 720p and 2 for 1080p...  (default = 2) 
set Xup=2
:: disable auto framecount match in workflow 1 (default = NO)
set dontfixframecount=NO
:: disable or enable output path HDD space check  (default = YES)
set checkoutputspace=YES

::================================================================================================================================================
::=====================================LANGUAGE SETTINGS====================================================================================
::================================================================================================================================================

:: set desired audio language (YES or NO default = english) If all set to no, it will get you the first best audio regardless of the language. (otherwise the audio selected is preferred by default).
set english=YES
set french=NO
set spanish=NO
set german=NO
set italian=NO
set chinese=NO
set dutch=NO
set finish=NO
set russian=NO
set polish=NO
set japenese=NO
set portuguese=NO
set korean=NO
set arabic=NO
set swedish=NO
set turkish=NO
set hindi=NO
set thai=NO
set indonesian=NO
set vietnamese=NO
set greek=NO
set czech=NO
set hebrew=NO
set malay=NO
set tagalog=NO
set dansk=NO
set norwegian=NO
set romanian=NO
set hungarian=NO
set bengali=NO
set maltese=NO
set icelandic=NO
set slovak=NO
set serbian=NO
set estonian=NO
set catalan=NO
:: audio tag variants
if "%english%"=="YES" set lang=English& set langDG=eng
if "%french%"=="YES" set lang=French& set langDG=fra
if "%spanish%"=="YES" set lang=Spanish& set langDG=spa
if "%german%"=="YES" set lang=German& set langDG=deu
if "%italian%"=="YES" set lang=Italian& set langDG=ita
if "%chinese%"=="YES" set lang=Chinese& set langDG=zho
if "%dutch%"=="YES" set lang=Dutch& set langDG=nld
if "%finish%"=="YES" set lang=Finish& set langDG=fin
if "%russian%"=="YES" set lang=Russian& set langDG=rus
if "%polish%"=="YES" set lang=Polish& set langDG=pol
if "%japenese%"=="YES" set lang=Japanese& set langDG=jpn
if "%portuguese%"=="YES" set lang=Portuguese& set langDG=por
if "%korean%"=="YES" set lang=Korean& set langDG=kor
if "%arabic%"=="YES" set lang=Arabic& set langDG=ara
if "%swedish%"=="YES" set lang=Swedish& set langDG=swe
if "%turkish%"=="YES" set lang=Turkish& set langDG=tur
if "%hindi%"=="YES" set lang=Hindi& set langDG=hin
if "%thai%"=="YES" set lang=Thai& set langDG=tha
if "%indonesian%"=="YES" set lang=Indonesian& set langDG=idn
if "%vietnamese%"=="YES" set lang=Vietnamese& set langDG=vie
if "%greek%"=="YES" set lang=Greek& set langDG=ell
if "%czech%"=="YES" set lang=Czech& set langDG=ces
if "%hebrew%"=="YES" set lang=Hebrew& set langDG=heb
if "%malay%"=="YES" set lang=Malay& set langDG=zlm
if "%tagalog%"=="YES" set lang=Tagalog& set langDG=tlg
if "%dansk%"=="YES" set lang=Dansk& set langDG=dan
if "%norwegian%"=="YES" set lang=Norwegian& set langDG=nor
if "%romanian%"=="YES" set lang=Romanian& set langDG=ron
if "%hungarian%"=="YES" set lang=Hungarian& set langDG=hun
if "%bengali%"=="YES" set lang=Bengali& set langDG=ben
if "%maltese%"=="YES" set lang=Maltese& set langDG=mlt
if "%icelandic%"=="YES" set lang=Icelandic& set langDG=isl
if "%slovak%"=="YES" set lang=Slovak& set langDG=slk
if "%serbian%"=="YES" set lang=Serbian& set langDG=srp
if "%estonian%"=="YES" set lang=Estonian& set langDG=est
if "%catalan%"=="YES" set lang=Catalan& set langDG=cat

:: do not touch
for %%i in (%output_path%) do set letterpath=%%~di
cd /d "%output_path%"

::================================================================================================================================================
::===================================== TOOLS PATHS ============================================================================================
::================================================================================================================================================

::---------------TOOLS NOT INCLUDED IN PACK DUE TO COPYRIGHTS----------------------------------------------------------

::https://professional.dolby.com/product/media-processing-and-delivery/dee--dolby-encoding-engine/
set DEE_path=%~dp0tools\DEE\dee.exe 
::set DEE_python_P5_script=%~dp0DEE\python_scripts\encode_dvmezz_to_dv8.py
set DEE_python_P5_script=%~dp0tools\DEE\python_scripts\encode_dvmezz_to_dv5.py
::Create a Folder ''EAE'' and put these files in it. Get the files from plex media server ''C:\Program Files\Plex\Plex Media Server''  https://i.ibb.co/c8sWD4p/Capture-d-cran-2024-07-20-094922.png
set EAE_path=%~dp0tools\EAE
:: https://github.com/pabloromeo/clusterplex/files/9396885/EasyAudioEncoder.zip
set EAE=%~dp0tools\EAE\EasyAudioEncoder.exe
:: create a free account and download the exe here:  https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools-v550
set metafier_path=%~dp0tools\metafier.exe
set cm_analyzer_path=%~dp0tools\cm_analyze.exe
set cm_offline_path=%~dp0tools\cm_offline.exe

:: NOTHING TO CHANGE HERE UNLESS YOU HAVE TO. 
::---------------TOOLS INCLUDED IN PACK---------------------------------------------------------------
set dovi_tool_path=%~dp0tools\dovi_tool.exe
set dovi_tool_nofloor=%~dp0tools\dovi_tool_no_floor.exe
set dovi_tool_FIX_path=%~dp0tools\dovi_tool.fix.exe
set dovi_tool_29to40=%~dp0tools\dovi_tool_2.9_to_4.0.exe
set dovi_tool_Hplus=%~dp0tools\dovi_tool_HDR10plus_tuning.exe
set hdr10plus_parser_path=%~dp0tools\hdr10plus_tool.exe
set tsmuxer_path=%~dp0tools\tsMuxeR.exe
set tsmuxer.GUI_path=%~dp0tools\tsMuxeRGUI.exe
set ffmpeg_path=%~dp0tools\ffmpeg.exe
set ffprobe_path=%~dp0tools\ffprobe.exe
set mkvmerge_path=%~dp0tools\mkvtoolnix\mkvmerge.exe
set mkvtoolnix_path=%~dp0tools\mkvtoolnix\mkvtoolnix-gui.exe
set mkvextract_path=%~dp0tools\mkvtoolnix\mkvextract.exe
set madvr_path=%~dp0tools\madvr\madMeasureHDR.exe
set AC3.64kbps_path=%~dp0tools\64kbps.Silent.AC3.Track.ac3
set thdmerge_path=%~dp0tools\thdmerge.exe
set mp4muxer_path=%~dp0tools\mp4muxer.exe
set mp4muxerNEW_path=%~dp0tools\mp4muxerNEW.exe
set mp4demuxer_path=%~dp0tools\mp4demuxer.exe
set mp4box_path=%~dp0tools\GPAC\mp4box.exe
set mp4box2_path=%~dp0tools\GPAC2.0\mp4box.exe
set DVH1=%~dp0tools\DoVi_mp4_DVH1.exe
set detectborders_path=%~dp0tools\DetectBorders.exe
set mediainfo_path=%~dp0tools\mediainfo.exe
set delaycut=%~dp0tools\delaycut.exe
set DGDemux_path=%~dp0tools\DGDemux.exe
set eac3to_path=%~dp0tools\EAC3TO\eac3to.exe
set JQ_path=%~dp0tools\jq-win64.exe
set MPV_path=%~dp0tools\MPV\mpv.com
set MPC_path=%~dp0tools\MPC-HC\mpc-hc64.exe
set plotbitrate_path=%~dp0tools\plotbitrate-main\plotbitrate.py
set wave=%~dp0tools\audiowaveform.exe
set PLEX=%~dp0tools\EAE\PlexTranscoder.exe
set supfoe=%~dp0tools\SUPfoe.exe
set imagemagick=%~dp0tools\ImageMagick\magick.exe
set RPU.to.XML=%~dp0tools\dovi_meta.exe
set scenedetect_path=%~dp0tools\scenedetect\scenedetect.exe
set gnuplot=%~dp0tools\gnuplot\bin\gnuplot.exe
set AvsPmod_path=%~dp0tools\AvsPmod\AvsPmod.exe
set DGIndexNV_path=%~dp0tools\dgdecnv_242\DGIndexNV.exe
set DGDecodeNV.dll=%~dp0tools\dgdecnv_242\DGDecodeNV.dll
set DoViBaker=%~dp0tools\DoViBaker_x64.dll
set ffms2=%~dp0tools\FFMS2\ffms2.dll
set ffmsindex=%~dp0tools\FFMS2\ffmsindex.exe
set subtitle_tonemap=%~dp0tools\subtitle_tonemap.exe
set x265_path=%~dp0tools\x265.exe
set x264_path=%~dp0tools\x264.exe
set nvenc_path=%~dp0tools\NVEncC\NVEncC64.exe
set avs2pipe_path=%~dp0tools\avs2pipemod64.exe
set vspipe_path=%~dp0tools\VapourSynth\VSPipe.exe
set subtitle.edit=%~dp0tools\Subtitle.Edit\SubtitleEdit.exe
set cmdcolor=%~dp0tools\cmdcolor.exe

if not exist "%~dp0tools\" echo WARNING! Tools folder "%~dp0tools\" is missing, see how your folder(without space or special characters) is supposed to look: https://ibb.co/Q8kbGF3 & pause & exit
if not exist "%output_path%" echo Invalid output_path, "%output_path%" does not exist... & pause & exit
if not exist "%temp_folder%" echo Invalid temp_path, "%temp_folder%" does not exist... & pause & exit
if not exist "%~dp0tools\cmdcolor.exe" ECHO "%~dp0tools\cmdcolor.exe"  not found, update your tools folder... & PAUSE & EXIT
if not exist "%~dp0tools\EAE" echo WARNING! No EAE folder found, disabling 7.1 EC3 encoding (the script will still work correctly).... See line 395 & set encode_7.1=NO
if not exist "%~dp0tools\metafier.exe" (
     echo.
     echo WARNING! "%~dp0tools\metafier.exe" not found. Disabling L2 trims removal and metadata validation . Some workflow will ^not work but most should be fine...
	 echo You can download the Dolby exe here: https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools-v550
     set remove_100=NO
     set remove_600=NO
     set remove_1000=NO
     set validate_metadata=NO
)

:external.settings
if not exist "%~dp0tools\trackcount.py" echo "%~dp0tools\trackcount.py" is missing from the tools folder. Update it...& pause & exit

if /i "%mp4_version%"=="NEW" if /i "%container%"=="MP4" set encode_7.1=NO& echo MP4_version=NEW, disabling 7.1 EC3 encoding....
if /i "%encode_LL%"=="FLAC" set encode_LL=YES& set llcodec=flac -compression_level 0& set mname=FLAC& set mcont=mp4
if /i "%encode_LL%"=="LPCM" set encode_LL=YES& set llcodec=pcm_s24le& set mname=LPCM& set mcont=mov
if /i "%container%"=="TS" if "%mname%"=="LPCM" set mcont=wav
if /i "%container%"=="TS" if "%mname%"=="FLAC" set encode_LL=NO
set batch.info=n

::##################################################################################################################################################################################################
::##################################################################### DO NOT TOUCH ###############################################################################################################
::##################################################################################################################################################################################################
set start_time=%time%
:Main.Menu

echo.
echo     _____    __      ___       _____           _       _        
echo    ^|  __ \   \ \    / (_)     / ____^|         (_)     ^| ^|       
echo    ^| ^|  ^| ^| __\ \  / / _     ^| (___   ___ _ __ _ _ __ ^| ^|_ ___  
echo    ^| ^|  ^| ^|/ _ \ \/ / ^| ^|     \___ \ / __^| '__^| ^| '_ \^| __/ __^| 
echo    ^| ^|__^| ^| (_) \  /  ^| ^|     ____) ^| (__^| ^|  ^| ^| ^|_) ^| ^|_\__ \ 
echo    ^|_____/ \___/ \/   ^|_^|    ^|_____/ \___^|_^|  ^|_^| .__/ \__^|___/ 
echo    -Author: RESET_9999--------------------------^|__^|-----------            
echo.
echo.

if "%letterpath%"=="C:" (
      echo \033[31m WARNING | "%cmdcolor%"
      echo OS drive output path(C:\^) detected, some workflow might ^not work properly... 
)

if not "%~1" == "" goto :direct.input

echo.
echo 1) MODE.I=  INJECT / EDIT / EXTRACT / INFO / VALIDATE
echo 2) MODE.F=  ^VERIFY SYNC / REMOVER / TRANSFER LEVELS
echo 3) MODE.H=  DoVi MAKER from HDR10 (Dolby Algo or MadVR or HDR10^+)
echo 4) MODE.7=  DoVi Profile 7 Input (MKV/BDMV)
echo 5) MODE.B=  DoVi %container% Batch Muxer
echo 6) MODE.P=  Plotter (DoVi/HDR10/HLG/SDR)
echo 7) MODE.S=  Screenshots ^& Player
echo 8) MODE.E=  Encoders (video and audio)
echo 9) MODE.M=  MORE
echo.
choice /C:123456789 /M Choice?
if ERRORLEVEL 9 (
goto :MODE.M
)

if ERRORLEVEL 8 (
goto :MODE.E
)

if ERRORLEVEL 7 (
goto :MODE.S
)

if ERRORLEVEL 6 (
goto :MODE.P
)

if ERRORLEVEL 5 (
goto :MODE.B
)

if ERRORLEVEL 4 (
goto :MODE.P7
)

if ERRORLEVEL 3 (
goto :MODE.H
)

if ERRORLEVEL 2 (
goto :MODE.F
)

if ERRORLEVEL 1 (
goto :Workflow.1
)

::----------------------------------------------------------------DV.inject.+audio if present.Workflow.1----------------------------------------------------------------------------------------------------------------------------
:Workflow.1  
echo.
:: what this workflow does
echo.
echo \033[36m          ================================== | "%cmdcolor%"
echo \033[36m          - INJECTOR / EDITOR / EXTRACTOR - | "%cmdcolor%"
echo \033[36m          ================================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow inject / extract and can edit two or one input (press enter to skip the 2nd input)
echo -- Can batch process files: input(s) can be folder(s) with files
echo -- Input can be MKV/TS/M2TS/MP4/HEVC/RPU/XML/HDR10plus.json/P5/P8/P7/folder(s)
echo -- Can auto-Crop, Edit L5/L6/L9 and Resync DV or HDR10plus, validate metadata with metafier(XML)
echo -- Can use external json config for more rpu edition. json must be same filename/path. do not input as metadata
echo -- json input for the metadata input must be hdr10plus.
echo -- You can inject both DV and HDR10plus if the metadata inputs have the same path/filename as the BL.
echo -- For the batch injector, both folders must contain only the files to process and they must be in the same order
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
:try_again1

::user input
echo   Drag and drop a file or a folder with files (MKV/TS/M2TS/HEVC/H265/RPU/XML/FOLDER) and press enter...
set /p video_path=
echo.

:: make variable of path, filename and extension. only input with "!" wont work.
Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi

goto :skip.direct

::------------------------------------------------------------------------direct input--------------------------------------------------------------------------------

:direct.input
Setlocal EnableDelayedExpansion
echo.

set "filepath=%~dp1"
set "filename=%~nx1"
set "fileext=%~x1"
if /i "%fileext%"==".mkv" set "filename=!filename:~,-4!"
if /i "%fileext%"==".mp4" set "filename=!filename:~,-4!"
if /i "%fileext%"==".m2ts" set "filename=!filename:~,-5!"
if /i "%fileext%"==".hevc" set "filename=!filename:~,-5!"
if /i "%fileext%"==".h265" set "filename=!filename:~,-5!"
if /i "%fileext%"==".ts" set "filename=!filename:~,-3!"
if /i "%fileext%"==".bin" set "filename=!filename:~,-4!"
if /i "%fileext%"==".xml" set "filename=!filename:~,-4!"

set video_path="%filepath%%filename%%fileext%"
echo.
echo \033[92m  INPUT: "%filepath%%filename%%fileext%"| "%cmdcolor%"
echo.
:skip.direct

if /i "%checkoutputspace%"=="NO" goto :skiphddcheck
::Use PowerShell to get disk space information
for /f "tokens=*" %%A in ('powershell -command "(Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DeviceID -eq '%letterpath%' }).FreeSpace"') do set "free=%%A"
for /f "tokens=*" %%A in ('powershell -command "(Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DeviceID -eq '%letterpath%' }).Size"') do set "total=%%A"
::Calculate used space
for /f %%A in ('powershell -command "[math]::Floor([long]%free% / 1GB)"') do set "free_gb=%%A"
if %free_gb% leq 200 echo \033[31m WARNING: Output path "%output_path%" has only %free_gb%GB of free space. Processing large file may not work.... | "%cmdcolor%"
:skiphddcheck

if /i "%same_input_output%"=="YES" set output_path=%filepath%
if /i "%fileext%"==".xml" goto :batch.editor
if /i "%fileext%"==".bin" goto :batch.editor
if /i "%fileext%"==".mpls" goto :batch.editor

::------------------------------------------------------------------------dual input-------------------------------------------------------------------------------- 
::look for dv metadata with same filename as BL
if exist "%filepath%%filename%.xml" set metadata_path="%filepath%%filename%.xml"& echo \033[92m  MATCHING METADATA FOUND: "%filepath%%filename%.xml"| "%cmdcolor%"& goto :skip.manual.input
if exist "%filepath%%filename%.bin" set metadata_path="%filepath%%filename%.bin"& echo \033[92m  MATCHING METADATA FOUND: "%filepath%%filename%.bin"| "%cmdcolor%"& goto :skip.manual.input

set batchfolderextract=n
set folder.user.input=Drag and drop any file with
if [%fileext%]==[] set batchfolderextract=y& set folder.user.input=Drag and drop a folder with
echo   (OPTIONAL) %folder.user.input% Dynamic Metadata (RPU/XML/JSON/MKV/MP4/TS/M2TS/HEVC) and/or press enter...& set /p metadata_path=
echo.
if [%metadata_path%]==[] goto :batch.editor
:skip.manual.input
echo.
:: make variable of path, filename and extension. only input with "!" wont work.
for %%i in (!metadata_path!) do set filename_dv=%%~ni
for %%i in (!metadata_path!) do set filepath_dv=%%~di%%~pi
for %%i in (!metadata_path!) do set fileext_dv=%%~xi

if [%fileext%]==[] if [%fileext_dv%]==[] goto :batchP8muxer
if /i "%fileext_dv%"==".rpu" echo RPU extension is wrong, must be: .bin & pause & goto :try_again1

:: make and set temp folder
if exist "%temp_folder%temp.folder_new" if exist "%temp_folder%temp.folder" rmdir /Q /S "%temp_folder%temp.folder_new" & rmdir /Q /S "%temp_folder%temp.folder"
if exist "%temp_folder%temp.folder" set E1=_new
MD "%temp_folder%temp.folder%E1%"
set TEMP=%temp_folder%temp.folder%E1%\

:: check BL for p5 or ST p7
if /i "%fileext%"==".avif" set raw.in=y
if /i "%fileext%"==".hevc" set raw.in=y
if /i "%fileext%"==".h265" set raw.in=y

::------------------------------------------------------------------audio----------------------------------------------------------------------------------------
::check for raw input and disable muxing.
if "%raw.in%"=="y" set MUX=NO& set container=none& goto :skipaudio
if /i "%encode_DDP%"=="NO" goto :skipaudio
if /i "%container%"=="MP4" goto :skipaudio

:: check if lossless audio present, if not skip the user prompt.
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Audio;%%Format%% --LogFile="%TEMP%audio.format.txt" >Nul
findstr /c:"MLP" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm.au=n
if "%mlp%"=="n" if "%dts%"=="n"  if "%pcm.au%"=="n" goto :skipaudio

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
:: check audio tracks info
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath%%filename%%fileext%"

echo.
:: user input for triggering audio encoding
echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n

:skipaudio
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------check input 1-------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::check input 1
echo "%filename_dv%" > "%TEMP%filename_DV.txt"
echo "%filename%" > "%TEMP%filename.txt"

echo \033[92mChecking Metadata input...| "%cmdcolor%"

::check if input is dual layer dual track
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2

::make sample of BL input
"%mkvmerge_path%" --output ^"%TEMP%bl.sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:00:10 > Nul
"%mediainfo_path%" "%TEMP%bl.sample.mkv" --output=JSON > "%TEMP%mediainfo.bl.JSON"
::check input 1 hdr format
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.bl.JSON" > "%TEMP%check.bl.input.txt"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.bl.JSON" > "%TEMP%check.bl.HDR10plus.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.bl.JSON" > "%TEMP%col.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.bl.JSON" > "%TEMP%masteringDL.txt"
type "%TEMP%mediainfo.bl.JSON" | findstr HLG >"%TEMP%pq.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	"%mediainfo_path%" "%filepath%%filename%%fileext%"  --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%"  --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%"  --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"

::check for P5, P8, HLG or ST-DL P7 input 
set p7_bl=n& set p5_bl=n& set p8_bl=n& set hlg.input=n

findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set hlg.input=y
findstr /c:"07" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set p7_bl=y
if "%video.count%"=="2" set p7_bl=n
findstr /c:"05" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set p5_bl=y
findstr /c:"08" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set p8_bl=y
findstr /c:"2094" "%TEMP%check.bl.HDR10plus.txt" >Nul
if %errorlevel%==0 set HDR10plus_BL=y

for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "framerate=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxcll.txt"') do (
    set "maxcll=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxfall.txt"') do (
    set "maxfall=%%a"
)
set "maxfall=%maxfall: =%"
set "maxcll=%maxcll: =%"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
if "%maxcll%"==" =" set maxcll=0
if "%maxfall%"==" =" set maxfall=0
if "%maxcll%"=="" set maxcll=0
if "%maxfall%"=="" set maxfall=0
for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
set MDL=%MDL:~1,-1%& set col=%col:~1,-1%
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------check input 2------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if /i "%fileext_dv%"==".xml" goto :CHECKCROP
if /i "%fileext_dv%"==".bin" goto :skipvideoinput
if /i "%fileext_dv%"==".json" set HDR10plus_meta=y& set forceHDR10plus=y& goto :resync.input

::make sample of metadata input
"%mkvmerge_path%" --output ^"%TEMP%meta.sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath_dv%%filename_dv%%fileext_dv%^" ^"^)^" --split parts:00:00:00-00:00:10 > Nul
"%mediainfo_path%" "%TEMP%meta.sample.mkv" --output=JSON > "%TEMP%mediainfo.meta.JSON"
::check input 1 hdr format
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.meta.JSON" > "%TEMP%check.meta.input.txt"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.meta.JSON" > "%TEMP%check.meta.HDR10plus.txt"

:skipvideoinput

::check dv input metadata, make a 10sec sample if input is not rpu
if /i "%fileext_dv%"==".bin" set temp.rpu="%filepath_dv%%filename_dv%%fileext_dv%"& goto :rpu

set P5_meta=n& set P8_meta=n& set P7_meta=n& set HDR10plus_meta=n& set DV_meta=n

findstr /c:"FORCEHDR10PLUS" "%TEMP%filename_DV.txt" >Nul
if %errorlevel%==0 set HDR10plus_meta=y& set forceHDR10plus=y& goto :resync.input
findstr /c:"forcehdr10plus" "%TEMP%filename_DV.txt" >Nul
if %errorlevel%==0 set HDR10plus_meta=y& set forceHDR10plus=y& goto :resync.input
findstr /c:"FORCEHDR10PLUS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set HDR10plus_meta=y& set forceHDR10plus=y& goto :resync.input
findstr /c:"forcehdr10plus" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set HDR10plus_meta=y& set forceHDR10plus=y& goto :resync.input

findstr /c:"05" "%TEMP%check.meta.input.txt" >Nul
if %errorlevel%==0 set P5_meta=y& set DV_meta=y
findstr /c:"07" "%TEMP%check.meta.input.txt" >Nul
if %errorlevel%==0 set P7_meta=y& set DV_meta=y
findstr /c:"08" "%TEMP%check.meta.input.txt" >Nul
if %errorlevel%==0 set P8_meta=y& set DV_meta=y
findstr /c:"2094" "%TEMP%check.meta.HDR10plus.txt" >Nul
if %errorlevel%==0 set HDR10plus_meta=y

if "%HDR10plus_meta%"=="n" if "%DV_meta%"=="n" echo Input is HDR10 only, nothing to do...& pause & exit
if "%HDR10plus_meta%"=="y" if "%DV_meta%"=="n" set forceHDR10plus=y& goto :resync.input

"%mkvextract_path%" "%TEMP%meta.sample.mkv" tracks 0:"%TEMP%temp.vid.hevc" > Nul 
"%dovi_tool_path%" extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" > Nul
set temp.rpu="%TEMP%chunk.RPU.bin"

:rpu
:: export metadata from 23sec sample to json files for input info display
echo.
"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
"%dovi_tool_path%" export -i %temp.rpu% -o "%TEMP%full.json" > Nul
"%dovi_tool_path%" export -i %temp.rpu% -d scenes="%TEMP%scene.cuts.txt" > Nul

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":24" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":25" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=P3
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=BT2020

type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "DVprofile=%%a"
)
set "DVprofile=%DVprofile: =%"

if "%p5_bl%"=="y" if not "%DVprofile%"=="5" echo BL is profile 5 but the RPU is not...& pause & exit
if "%P7_bl%"=="y" if "%DVprofile%"=="7" set MBOX=:hdr=none:dvp=7.6& set dv.profile=7& set ID=1& set JUSTINJECT=y
set cmdcolortype=& set colorsoft=&set cmdcolortype2=& set colorsoft2=&set cmdcolortype3=& set colorsoft3=
set first_line=
set second_line=
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^1:"') do (
    set "first_line=%%a"
)
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^2:"') do (
    set "second_line=%%a"
)

if "%first_line%"=="1:0" (
    set scenecuts0=YES (good^)
) else (
    set scenecuts0=NO& set cmdcolortype2=\033[31m& set colorsoft2=^| "%cmdcolor%"
)

set consecutiveSC=NO (good)
if "%first_line%"=="1:0" if "%second_line%"=="2:1" set consecutiveSC=YES& set cmdcolortype3=\033[31m& set colorsoft3=^| "%cmdcolor%"

set L5missing=n
if "%left%"==" =" set L5missing=y& set noL5warning=WARNING, Level 5 is missing...& set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=\033[31m& set colorsoft=^| "%cmdcolor%"

::----------------------------------------------------------CHECK CROPPED INPUT------------------------------------------------------------------------------------------------------------------
:CHECKCROP
set crop_path=false& set cropped.input=n
if /i "%auto.crop%"=="NO" goto :skip.crop
::check bl resolution and crop if nescessary
if not "%Height%"=="2160" if not "%Height%"=="1080" set crop_path=true& set EditL5=y& set L5.left_path=0& set L5.right_path=0& set L5.top_path=0& set L5.bottom_path=0& set cropped.input=y

:skip.crop

if /i "%fileext_dv%"==".xml" goto :skipinfo
if /i "%auto.crop%"=="NO" if "%cropped.input%"=="y" if not "%top%"=="0" if not "%top%"=="N.A." set cmdcolortype=\033[31m& set colorsoft=^| "%cmdcolor%"& set warning=  (BL is cropped, L5 should be edited to 0)

::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------input info OSD---------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%videoframecount1.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%videoframecount1.txt"') do (
    set "videoframecount1=%%a"
)
set videoframecount1=%videoframecount1:~1,-1%

"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path%
:: dv input info display
echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
"%dovi_tool_path%" info -s %temp.rpu%
if "%L5missing%"=="y" echo %cmdcolortype%  %noL5warning% %warning%%colorsoft%
if "%scenecuts0%"=="NO" echo %cmdcolortype2%  WARNING: 1st Frame is not a Scene Cut%colorsoft2%
if "%consecutiveSC%"=="YES" echo %cmdcolortype3%  WARNING: Consecutive Scene Cuts%colorsoft3%
echo   Metadata: "%filepath_dv%%filename_dv%%fileext_dv%"
echo   Base Layer: "%filepath%%filename%%fileext%"
if "%p5_bl%"=="y" echo   Base Layer: ICtCp (DoVi P5)
if "%p7_bl%"=="y" echo   Base Layer (HDR10^+P7): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
if "%p8_bl%"=="y" echo   Base Layer (HDR10^+P8): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
if "%hlg.input%"=="y" echo   Base Layer: HLG HDR
if not "%p8_bl%"=="y" if not "%p7_bl%"=="y" if not "%p5_bl%"=="y" if not "%hlg.input%"=="y" echo   Base Layer (HDR10): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
echo   Resolution: %Width% x %Height% ^@ %framerate%
if not "%raw.in%"=="y" echo   Base Layer Frame count: %videoframecount1%
if /i "%checkoutputspace%"=="NO" goto :skipinfo
if %free_gb% leq 200 echo \033[31m  Output Path Free Space: %free_gb%gb | "%cmdcolor%"
if not %free_gb% leq 200 echo   Output Path Free Space: %free_gb%gb 

echo.&echo.

:skipinfo
::------------------------------------------------------------------keywords in filename--------------------------------------------------------------------------------------------

::check if BL has keywords in the filename
findstr /c:"P5BL" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set p5_bl=y
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"DONTMUX" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set MUX=NO
findstr /c:"REMOVECMV4" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set rem_cmv4=YES
findstr /c:"KEEP1000" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set remove_1000=NO
findstr /c:"KEEP600" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set remove_600=NO
findstr /c:"KEEPTRIMS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set remove_600=NO& set remove_1000=NO
findstr /c:"JUSTINJECT" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set JUSTINJECT=y
findstr /c:"FIXAPPLE" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set FIXapple=YES

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
if "%p5_bl%"=="y" set MBOX=& set dv.profile=5& set ID=0
if "%P7_bl%"=="y" if "%JUSTINJECT%"=="y" set MBOX=:hdr=none:dvp=7.6& set dv.profile=7& set ID=1 

::check if hdr10plus is present and remove it if configured to do so
findstr /c:"2094" "%TEMP%check.bl.HDR10plus.txt" >Nul
if %errorlevel%==0 (
     if /i "%drop.HDR10plus%"=="YES" set dropH=--drop-hdr10plus
)

::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------user edit input------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:: skip resync and L6 if input xml
if /i "%Auto.L6.XML%"=="YES" if "%fileext_dv%"==".xml" set EditL6=y& goto :skip.resync

:: L6 edit and resync (user prompt)
echo   Do you want to edit Level 6^? (default= n )
echo.
echo --^> YES= y
echo --^> NO= n
set /p EditL6=
if "%EditL6%"=="" set EditL6=n
if /i "%EditL6%"=="y" set EditL6=y
if /i "%EditL6%"=="n" set EditL6=n
if /i "%EditL6%"=="yes" set EditL6=y
if /i "%EditL6%"=="no" set EditL6=n
if not "%EditL6%"=="n" if not "%EditL6%"=="y" set EditL6=n
echo.

if "%fileext_dv%"==".xml" goto :skip.resync
:resync.input
echo   Do you want to re-sync the metadata^? ^If yes, enter a frame number. E.G.: -24 or 24 and/or press enter to skip...(default = no resync)& set /p delay8=
if [%delay8%]==[] set delay8=& goto :skip.resync
if /i "%delay8%"=="n" set delay8=& goto :skip.resync
if /i "%delay8%"=="no" set delay8=& goto :skip.resync
if /i "%delay8%"=="o" set delay8=& goto :skip.resync
if "%delay8%"=="0" set delay8=& goto :skip.resync

set resync=d
set dup=%delay8%
for %%i in (%delay8%) do set delay.name=%%~ni
echo %delay.name% > "%TEMP%delay.name.txt"
findstr /c:"-" "%TEMP%delay.name.txt" >Nul
if %errorlevel%==0 set resync=r& set rem=%delay8:-=%

:skip.resync
if /i "%forceHDR10plus%"=="y" goto :skip.xml
if "%cropped.input%"=="y" goto :skip.l5
if /i "%auto.crop%"=="YES" if /i "%left%"=="N.A." if not "%fileext_dv%"==".xml" set EditL5=y& goto :S

:skip

echo.
:: L5 edit(user input)
echo   Do you want to edit Level 5^? (default= n )
echo.
echo --^> YES= y
echo --^> NO= n
set /p EditL5=

:S
if "%EditL5%"=="" set EditL5=n
if /i "%EditL5%"=="y" set EditL5=y
if /i "%EditL5%"=="n" set EditL5=n
if /i "%EditL5%"=="yes" set EditL5=y
if /i "%EditL5%"=="no" set EditL5=n
if not "%EditL5%"=="n" if not "%EditL5%"=="y" set EditL5=n
if not "%EditL5%"=="y" goto :skip.l55

:: manual or auto L5 (user input)
echo   Manual or Auto Level 5 edit ^? (default = m)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p autoL5=

if /i "%autoL5%"=="a" set autoL5=a
if /i "%autoL5%"=="m" set autoL5=m
if /i "%autoL5%"=="auto" set autoL5=a
if /i "%autoL5%"=="manual" set autoL5=m
if not "%autoL5%"=="m" if not "%autoL5%"=="a" set autoL5=m
if "%autoL5%"=="a" goto :measure.letterbox

:: check for raw or ts/m2ts input in order to prepare crop readings in avspmod (ts/m2ts files are buggy and raw hevc cant be played in directshow)
set cropcheck="%filepath%%filename%%fileext%"
if not "%raw.in%"=="y" if not "%fileext%"==".ts" if not "%fileext%"==".m2ts" goto :skip.sample

:: make mkv sample if input raw hevc or ts/m2ts
echo.
echo Raw HEVC or TS/M2TS input, making a MKV sample to allow avspmod to read the input...
"%mkvmerge_path%" --output ^"%TEMP%sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set cropcheck="%TEMP%sample.mkv"

::make script for avspmod with raised black for better letterbox reading
:skip.sample
echo DirectShowSource(%cropcheck%) > "%TEMP%%filename%.avs"
echo Levels(0, 2.5, 255, 0, 255, coring=false) >> "%TEMP%%filename%.avs"
:: launch avspmod
start "" "%AvsPmod_path%" "%TEMP%%filename%.avs"

:: manual L5 (user input)
echo   Set the left border offset... choose a number and press enter...& set /p L5.left_path=
if "%L5.left_path%"=="" set L5.left_path=0
echo   Set the right border offset... choose a number and press enter...& set /p L5.right_path=
if "%L5.right_path%"=="" set L5.right_path=0
echo   Set the top border offset... choose a number and press enter...& set /p L5.top_path=
if "%L5.top_path%"=="" set L5.top_path=0
echo   Set the bottom border offset... choose a number and press enter...& set /p L5.bottom_path=
if "%L5.bottom_path%"=="" set L5.bottom_path=0
goto :skip.l5

:: auto l5... may not be accurate, you should use AvsPmod instead.
:measure.letterbox
::make a 3 min sample. (in case input is ts/m2ts/hevc which doesnt work in detect borders)
"%mkvmerge_path%" --output ^"%TEMP%chunk.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
:: measure letterbox with detectborders
echo \033[92mMeasuring the letterbox... | "%cmdcolor%"

"%detectborders_path%" --ffmpeg-path="%ffmpeg_path%" --input-file="%TEMP%chunk.mkv" --log-file="%TEMP%\borders.txt"

for /f "tokens=2 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.left_path=%%a"
)
for /f "tokens=4 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.right_path=%%a"
)
for /f "tokens=3 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.top_path=%%a"
)
for /f "tokens=5 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.bottom_path=%%a"
)
:: set borders to 0 in case l5 variables are empty (better than having wrong value).
if "%L5.left_path%"=="" echo WARNING... Measuring didnt work properly, L5 will be set to 0...& set L5.left_path=0
if "%L5.right_path%"=="" set L5.right_path=0
if "%L5.top_path%"=="" set L5.top_path=0
if "%L5.bottom_path%"=="" set L5.bottom_path=0
if "%L5.top_path%"=="264" set L5.top_path=263
if "%L5.bottom_path%"=="264" set L5.bottom_path=263
if "%L5.top_path%"=="278" set L5.top_path=277
if "%L5.bottom_path%"=="278" set L5.bottom_path=277
::echo borders measurements for verification.
echo left border: %L5.left_path%
echo right border: %L5.right_path%
echo top border: %L5.top_path%
echo bottom border: %L5.bottom_path%

:skip.l5
:: Edit active area: generate L5 active area json
echo { > "%TEMP%L5.json"
echo    "active_area": { >> "%TEMP%L5.json"
echo        "crop": %crop_path%, >> "%TEMP%L5.json"
echo        "presets": [ >> "%TEMP%L5.json"
echo            { >> "%TEMP%L5.json"
echo                "id": 0, >> "%TEMP%L5.json"
echo                "left": %L5.left_path%, >> "%TEMP%L5.json"
echo                "right": %L5.right_path%, >> "%TEMP%L5.json"
echo                "top": %L5.top_path%, >> "%TEMP%L5.json"
echo                "bottom": %L5.bottom_path% >> "%TEMP%L5.json"
echo            } >> "%TEMP%L5.json"
echo        ], >> "%TEMP%L5.json"
echo        "edits": { >> "%TEMP%L5.json"
echo            "all": 0 >> "%TEMP%L5.json"
echo        } >> "%TEMP%L5.json"
echo    } >> "%TEMP%L5.json"
echo } >> "%TEMP%L5.json"

:skip.l55
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------XML input------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if not "%fileext_dv%"==".xml" goto :skip.xml
if /i "%remove_100%"=="YES" set rem_trims=y& set L2.100=,1
if /i "%remove_600%"=="YES" set rem_trims=y& set L2.600=,27,28
if /i "%remove_1000%"=="YES" set rem_trims=y& set L2.1000=,48,49

:: personal function... check if BL has KEEPTRIMS in the filename
findstr /c:"KEEPTRIMS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set rem_trims=n

::removes 600 and 1000nits trims from xml with the dolby metafier
if "%rem_trims%"=="y" (
echo.
      echo \033[92mRemoving L2 trims...| "%cmdcolor%"
     "%metafier_path%"  -o "%TEMP%out.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% "%filepath_dv%%filename_dv%%fileext_dv%"
     echo Generate RPU from XML
     "%dovi_tool_path%" generate --xml "%TEMP%out.xml" --canvas-width %Width% --canvas-height %Height% --rpu-out "%TEMP%rpu.bin"
     set RPU="%TEMP%rpu.bin"& goto :skip.xml
)

:: generate RPU from xml file
echo.
echo \033[92mGenerate RPU from XML...| "%cmdcolor%"
echo.
"%dovi_tool_path%" generate --xml "%filepath_dv%%filename_dv%%fileext_dv%" --canvas-width %Width% --canvas-height %Height% --rpu-out "%TEMP%rpu.bin"
if NOT ["%errorlevel%"]==["0"] echo invalid xml, press a key to try again & rmdir /Q /S "%TEMP%" & pause & exit
set RPU="%TEMP%rpu.bin"

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:skip.xml
if /i "%fileext%"==".xml" (
      copy /y %RPU% "%output_path%"
	  rename "%output_path%rpu.bin" "%filename%.bin"
	  rmdir /Q /S "%TEMP%"
	  pause & exit
)

if /i "%fileext%"==".avif" set HDR="%filepath%%filename%%fileext%"& goto :skip
if /i "%fileext%"==".hevc" set HDR="%filepath%%filename%%fileext%"& goto :skip
if /i "%fileext%"==".h265" set HDR="%filepath%%filename%%fileext%"& goto :skip

:: go to the track infos script
set job=1.1& goto :tracks.info

:job.1.1
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------DEMUX BL-----------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:: check for raw input and skip demux
echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.

Setlocal EnableDelayedExpansion

if not "%fileext%"==".mkv" goto :notmkv
if /i "%container%"=="MKV" if /i "%export.subs%"=="NO" if /i "%mux_all_audio%"=="YES" if /i "%mux_all_sub%"=="YES" "%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc" & set HDR="%TEMP%BL.hevc"& goto :skip

"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
set HDR="%TEMP%BL.hevc"
goto :skip
 
:notmkv
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=%T1.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath%%filename%%fileext%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath%%filename%%fileext%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
	 "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
	 set HDR="%TEMP%%filename%.track_%T1.ID%.hevc"

:skip
if /i "%fileext_dv%"==".json" goto :skipp7demux
if "%JUSTINJECT%"=="y" goto :skipp7demux
if "%forceHDR10plus%"=="y" goto :skipp7demux

:: if input BL has EL and metadata is not P7, remove EL
echo.
if not "%p7_bl%"=="y" goto :skipp7demux
     cd /d "%TEMP%"
	 if /i "%raw.in%"=="y" set bltodemux="%filepath%%filename%%fileext%"
	 if not "%raw.in%"=="y" rename "%TEMP%BL.hevc"  "BLtodemux.hevc" & set bltodemux="%TEMP%BLtodemux.hevc"
      echo \033[92mP8 or P5 metadata input with a P7 video input. Removing the EL from the BL...| "%cmdcolor%"
     "%dovi_tool_path%" demux -i %bltodemux%
	 set HDR="%TEMP%BL.hevc"
	 echo Done.
	 cd /d "%output_path%"

:skipp7demux
if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"

::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------------hdr10plus input-----------------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if exist "%filepath%%filename%.json" if not "%forceHDR10plus%"=="y" set JSONinput="%filepath%%filename%.json"& set dualinject=y& goto :Hplusinject
if not "%forceHDR10plus%"=="y" goto :skipjson.hdrplus
if  "%fileext_dv%"==".json" set JSONinput="%filepath_dv%%filename_dv%%fileext_dv%"& goto :skiphdr10plusextract

echo.&echo.
echo \033[36m       =========================== | "%cmdcolor%"
echo \033[36m       -    EXTRACTING HDR10plus     - | "%cmdcolor%"
echo \033[36m       =========================== | "%cmdcolor%"
echo.
if /i "%fileext_dv%"==".h265" set rawhp=y
if /i "%fileext_dv%"==".hevc" set rawhp=y
if /i "%rawhp%"=="y" set Hmeta="%filepath_dv%%filename_dv%%fileext_dv%"& goto :extracHplus

if not "%fileext_dv%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath_dv%%filename_dv%%fileext_dv%" tracks 0:"%TEMP%BL.hevc"
set Hmeta="%TEMP%BL.hevc"

:extracHplus
"%hdr10plus_parser_path%" extract %Hmeta% -o "%TEMP%%filename_dv%.json"
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%hdr10plus_parser_path%"  --skip-validation extract %Hmeta% -o "%TEMP%%filename_dv%.json"
set JSONinput="%TEMP%%filename_dv%.json"
goto :skiphdr10plusextract

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath_dv%%filename_dv%%fileext_dv%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" --skip-validation extract -o "%TEMP%%filename_dv%.json"  -
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%ffmpeg_path%" -i "%filepath_dv%%filename_dv%%fileext_dv%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" --skip-validation extract -o "%TEMP%%filename_dv%.json"  -
set JSONinput="%TEMP%%filename_dv%. json"

:skiphdr10plusextract

if /i "%resync%"=="d" goto :dup
if not "%resync%"=="r" goto :Hplusinject

::=============================remove hdr10plus  frames========================================================
::generate remove frames json
echo { > "%TEMP%remove.json"
echo    "remove": [ >> "%TEMP%remove.json"
echo        "1-%rem%" >> "%TEMP%remove.json"
echo    ] >> "%TEMP%remove.json"
echo } >> "%TEMP%remove.json"
echo.
      echo.
      echo \033[92mRemoving frame 1 to %rem%...| "%cmdcolor%"
	  "%hdr10plus_parser_path%" editor -i %JSONinput% -j "%TEMP%remove.json" -o "%TEMP%%filename_dv%_HDR10plus_Synced.json" >Nul
	  set JSONinput="%TEMP%%filename_dv%_HDR10plus_Synced.json"
goto :Hplusinject

::=============================duplicate hdr10plus  frames========================================================
:dup
::generate duplicate frames json
echo { > "%TEMP%duplicate.json"
echo 	"duplicate": [ >> "%TEMP%duplicate.json"
echo 		{ >> "%TEMP%duplicate.json"
echo 			"source": 1, >> "%TEMP%duplicate.json"
echo 			"offset": 1, >> "%TEMP%duplicate.json"
echo 			"length": %dup% >> "%TEMP%duplicate.json"
echo 		} >> "%TEMP%duplicate.json"
echo 	] >> "%TEMP%duplicate.json"
echo } >> "%TEMP%duplicate.json"
echo.
      echo.
      echo \033[92mDuplicating frame one, %dup% times...| "%cmdcolor%"
     "%hdr10plus_parser_path%" editor -i %JSONinput% -j "%TEMP%duplicate.json" -o "%TEMP%%filename_dv%_HDR10plus_Synced.json" >Nul
	  set JSONinput="%TEMP%%filename_dv%_HDR10plus_Synced.json"

:Hplusinject
::==================================INJECT=========================================================================
echo.&echo.
echo \033[36m       ======================= | "%cmdcolor%"
echo \033[36m       - INJECTING HDR10plus - | "%cmdcolor%"
echo \033[36m       ======================= | "%cmdcolor%"
echo.

:: inject HDR10plus json input
"%hdr10plus_parser_path%" inject -i %HDR% -j %JSONinput% -o "%output_path%%filename%_HDR10plus_injected.hevc"
set HDR="%output_path%%filename%_HDR10plus_injected.hevc"

if /i "%dualinject%"=="y" goto :skipjson.hdrplus
if /i "%resync%"=="d" copy /y %JSONinput% "%output_path%" > nul
if /i "%resync%"=="r" copy /y %JSONinput% "%output_path%" > nul
if /i "%container%"=="MP4" set container=MKV
set keep_rpu=NO& set validate_metadata=NO& goto :MUXER

:skipjson.hdrplus

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------DEMUX dovi input------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:: check for raw dv input
if /i "%fileext_dv%"==".xml" goto :skip.rpu.conversion
if /i "%fileext_dv%"==".bin" set RPU="%filepath_dv%%filename_dv%%fileext_dv%"& goto :rpu.input

echo.&echo.
echo \033[36m     ======================= | "%cmdcolor%"
echo \033[36m     -   EXTRACTING DoVi   - | "%cmdcolor%"
echo \033[36m     ======================= | "%cmdcolor%"
echo.

if /i "%fileext_dv%"==".hevc" "%dovi_tool_path%" extract-rpu "%filepath_dv%%filename_dv%%fileext_dv%" -o "%TEMP%%filename%_RPU.bin"& set RPU="%TEMP%%filename%_RPU.bin"& goto :rpu.input
if /i "%fileext_dv%"==".h265" "%dovi_tool_path%" extract-rpu "%filepath_dv%%filename_dv%%fileext_dv%" -o "%TEMP%%filename%_RPU.bin"& set RPU="%TEMP%%filename%_RPU.bin"& goto :rpu.input

set dualT=0
::check for dual track dual layer p7 input
"%mediainfo_path%" "%filepath_dv%%filename_dv%%fileext_dv%" --output=JSON > "%TEMP%mediainfo3.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo3.JSON" > "%TEMP%video.count2.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count2.txt"') do (
    set "video.count2=%%a"
)
set video.count2=%video.count2:~1,-1%
if "%video.count2%"=="3" set video.count2=2
if "%video.count2%"=="2" set DT=-map 0:1& set dualT=1& goto :skip.mkvextract

if not "%fileext_dv%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath_dv%%filename_dv%%fileext_dv%" tracks %dualT%:"%TEMP%BLDV.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BLDV.hevc" -o "%TEMP%%filename_dv%_RPU.bin"
set RPU="%TEMP%%filename_dv%_RPU.bin"& goto :rpu.input

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath_dv%%filename_dv%%fileext_dv%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%TEMP%%filename%_RPU.bin" -
set RPU="%TEMP%%filename%_RPU.bin"

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------convert RPU--------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:rpu.input
echo.
if "%p5_bl%"=="y" echo \033[92mP5 RPU to P5 BL injection, no RPU profile conversion required... | "%cmdcolor%"& goto :skip.rpu.conversion
if "%P7_bl%"=="y" if "%DVprofile%"=="7" echo \033[92mP7 RPU to P7 BL injection, no RPU profile conversion required... | "%cmdcolor%"& goto :skip.rpu.conversion
if "%JUSTINJECT%"=="y" echo \033[92mJust inject, no RPU profile conversion required... | "%cmdcolor%"& goto :skip.rpu.conversion
if "%DVprofile%"=="8" echo \033[92mP8 RPU to P8 BL injection, no RPU profile conversion required... | "%cmdcolor%"& goto :skip.rpu.conversion

::----------------------------------------------------------------------------------------------
::---------------------------------------P5----------------------------------------------------
::----------------------------------------------------------------------------------------------
echo.
:: P5 to P8
if not "%DVprofile%"=="5" goto :skipP5

     echo { > "%TEMP%profile.json"
	 echo     "mode": 3 >> "%TEMP%profile.json"
	 echo } >> "%TEMP%profile.json"
	 echo \033[92mConverting Profile 5 RPU to Profile 8... | "%cmdcolor%"
	 
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%profile.json" --rpu-out "%TEMP%%filename%_P5_to_P8.bin" >Nul
if not %errorlevel%==0 (
      echo Failed to convert RPU... Guessing invalid L6 and will try to fix...
	  "%dovi_tool_FIX_path%" editor -i %RPU% -j "%TEMP%profile.json" --rpu-out "%TEMP%%filename%_P5_to_P8.bin" >Nul
	  set EditL6=y
)
echo Done.
set RPU="%TEMP%%filename%_P5_to_P8.bin"

:skipP5
::----------------------------------------------------------------------------------------------
::---------------------------------------P7----------------------------------------------------
::----------------------------------------------------------------------------------------------
:: P7 to P8
if not "%DVprofile%"=="7" goto :skip.rpu.conversion
     echo { > "%TEMP%profile.json"
	 echo     "mode": 2 >> "%TEMP%profile.json"
	 echo } >> "%TEMP%profile.json"
	 echo \033[92mConverting Profile 7 RPU to Profile 8... | "%cmdcolor%"
	 "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%profile.json" --rpu-out "%TEMP%%filename%_P7_to_P8.bin" >Nul
	 set RPU="%TEMP%%filename%_P7_to_P8.bin"
	 echo Done.
 
:skip.rpu.conversion

::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------HLG BL---------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if not "%hlg.input%"=="y" goto :skiphlg

echo { > "%TEMP%hlg.json"
echo     "mode": 4 >> "%TEMP%hlg.json"
echo } >> "%TEMP%hlg.json"
echo.
echo \033[92mHLG base layer detected, converting to profile 8.4... | "%cmdcolor%"
"%dovi_tool_path%" editor -i %RPU%  -j  "%TEMP%hlg.json" --rpu-out "%TEMP%%filename%_HLG.bin" >Nul
set RPU="%TEMP%%filename%_HLG.bin"
echo Done.

:skiphlg

::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------EDIT L6--------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if not "%EditL6%"=="y" goto :skipL6
set MDL.max_path=1000& set MDL.min_path=1

findstr /m "1000" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=1000
findstr /m "4000" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=4000
findstr /m "10000" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=10000
findstr /m "2000" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=2000
findstr /m "0.0050" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=50
findstr /m "0.0001" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=1
findstr /m "0.0020" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=20
findstr /m "0.0010" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=10
findstr /m "0.0000" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=0

"%dovi_tool_path%" info -s %RPU% >"%TEMP%sum.rpu.json"
type "%TEMP%sum.rpu.json" | findstr L1 > "%TEMP%L1.txt"
for /f "tokens=4 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=6 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxfall_path=%%a"
)

if not "%fileext_dv%"==".xml" if not "%p5_bl%"=="y" goto :skipMDLoverride

type "%TEMP%sum.rpu.json" | findstr "RPU mastering display:" > "%TEMP%L1m.txt"
for /f "tokens=3 delims=(/n)" %%a in ('type "%TEMP%L1m.txt"') do (
    set "MDL.max_path=%%a"
)
for /f "tokens=2 delims=(./)" %%a in ('type "%TEMP%L1m.txt"') do (
    set "MDL.min_path=%%a"
)

set MDL.min_path=%MDL.min_path:0=%
if "%MDL.min_path%"=="5" set MDL.min_path=50
if "%MDL.min_path%"=="2" set MDL.min_path=20

:skipMDLoverride

::-----------------------------------------------------------------------------------------------------------------------------------------------------------
:: generate l6 json and edit the rpu
echo { > "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %MDL.max_path%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %MDL.min_path%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"

echo.
echo \033[92mEditing L6... MDL_Min=%MDL.min_path%, MDL_Max=%MDL.max_path%, MaxCLL=%maxcll_path%, MaxFALL=%maxfall_path% | "%cmdcolor%"
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L6.json" --rpu-out "%TEMP%%filename%RPU-L6.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%%filename%RPU-L6.bin"
if "%fileext_dv%"==".xml" rename %RPU% "%filename%_Generated.bin" & set RPU="%TEMP%%filename%_Generated.bin"
echo Done.

:skipL6
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------EDIT L5---------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::edit L5 active area
if not "%EditL5%"=="y" goto :skipL5edit
     echo.
	 if /i "%auto.crop%"=="YES" if "%cropped.input%"=="y" echo Cropped input detected, the script will crop the RPU...& echo.
     echo \033[92mEditing L5... Left=%L5.left_path%, Right=%L5.right_path%, Top=%L5.top_path%, Bottom=%L5.bottom_path% | "%cmdcolor%"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L5.json" --rpu-out "%TEMP%%filename%RPU-L5.bin" > nul
	 set RPU="%TEMP%%filename%RPU-L5.bin"
	 echo Done.
:skipL5edit

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------cmv4.0---------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

echo.
if "%cmv4.0%"=="y" if /i "%rem_cmv4%"=="YES" echo \033[92mRemoving cmv4.0 metadata block... | "%cmdcolor%"
if "%cmv4.0%"=="y" (
     if /i "%rem_cmv4%"=="YES" (
     echo { > "%TEMP%CM4.json"
     echo 	"remove_cmv4": true >> "%TEMP%CM4.json"
     echo } >> "%TEMP%CM4.json"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%CM4.json" --rpu-out "%TEMP%%filename%_RPU-cmv4.removed.bin" > nul
	 set RPU="%TEMP%%filename%_RPU-cmv4.removed.bin"
	 echo Done.
	 )
)

:: check if the script has to resync
if /i "%resync%"=="r" goto :REMOVE
if /i "%resync%"=="d" goto :DUPLICATE
goto :fix.framecount

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------REMOVE--------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:REMOVE
::generate remove frames json
echo { > "%TEMP%remove.json"
echo    "remove": [ >> "%TEMP%remove.json"
echo        "1-%rem%" >> "%TEMP%remove.json"
echo    ] >> "%TEMP%remove.json"
echo } >> "%TEMP%remove.json"
echo.
echo \033[92mRemoving frame 1 to %rem%... | "%cmdcolor%"
:: remove frames
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%remove.json" --rpu-out "%TEMP%%filename%_%rem%_frames_removed.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%%filename%_%rem%_frames_removed.bin"
echo Done.
goto :fix.framecount

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------DUPLICATE---------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:DUPLICATE
::generate duplicate frames json
echo { > "%TEMP%duplicate.json"
echo 	"duplicate": [ >> "%TEMP%duplicate.json"
echo 		{ >> "%TEMP%duplicate.json"
echo 			"source": 1, >> "%TEMP%duplicate.json"
echo 			"offset": 1, >> "%TEMP%duplicate.json"
echo 			"length": %dup% >> "%TEMP%duplicate.json"
echo 		} >> "%TEMP%duplicate.json"
echo 	] >> "%TEMP%duplicate.json"
echo } >> "%TEMP%duplicate.json"
echo.
echo  \033[92mDuplicating frame one: %dup% times...  | "%cmdcolor%"
:: duplicates frames
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%duplicate.json" --rpu-out "%TEMP%%filename%_%dup%_frames_duplicated.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%%filename%_%dup%_frames_duplicated.bin"
echo Done.

:fix.framecount
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------FRAMECOUNT--------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
if /i "%raw.in%"=="y" goto :INJECT
if "%video.count%"=="2" goto :INJECT
if /i "%dontfixframecount%"=="YES" goto :INJECT
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%videoframecount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%videoframecount.txt"') do (
    set "videoframecount=%%a"
)
set videoframecount=%videoframecount:~1,-1%

"%dovi_tool_path%" info -s %RPU% > "%TEMP%final.rpu.json"
type "%TEMP%final.rpu.json" | findstr Frames: > "%TEMP%final.rpuframecount.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%final.rpuframecount.txt"') do (
    set "rpuframecount=%%a"
)
set "rpuframecount=%rpuframecount: =%"

if "%rpuframecount%"=="%videoframecount%" goto :INJECT

set /a framecount.diff=%videoframecount% - %rpuframecount%

for %%i in (%framecount.diff%) do set math=%%~ni
echo %math% > "%TEMP%math.txt"
findstr /c:"-" "%TEMP%math.txt" >Nul
if %errorlevel%==0 (
    set substract=y& set math=-
    ) else (
    set addition=y& set math=+
)

if "%addition%"=="y" goto :duplicate2

::-----------------------------------------------rem 2-----------------------------------------------------
:: removes frame at the end
:remove2
set framecount.diff=%framecount.diff:-=%
set /a tosubstract=%rpuframecount% - %framecount.diff%
set /a rpuframecount=%rpuframecount% - 1

echo { > "%TEMP%edits2.json"
echo    "remove": [ >> "%TEMP%edits2.json"
echo        "%tosubstract%-%rpuframecount%" >> "%TEMP%edits2.json"
echo    ] >> "%TEMP%edits2.json"
echo } >> "%TEMP%edits2.json"
echo.
echo \033[92mVideo/RPU framecount mismatch. Removing frame %tosubstract% to %rpuframecount%... | "%cmdcolor%"

goto :resync2

::----------------------------------------------dup 2-----------------------------------------------------
::duplicate frames at the end
:duplicate2
set framecount.diff=%framecount.diff:-=%
set /a rpuframecount=%rpuframecount% - 1
echo { > "%TEMP%edits2.json"
echo 	"duplicate": [ >> "%TEMP%edits2.json"
echo 		{ >> "%TEMP%edits2.json"
echo 			"source": %rpuframecount%, >> "%TEMP%edits2.json"
echo 			"offset": %rpuframecount%, >> "%TEMP%edits2.json"
echo 			"length": %framecount.diff% >> "%TEMP%edits2.json"
echo 		} >> "%TEMP%edits2.json"
echo 	] >> "%TEMP%edits2.json"
echo } >> "%TEMP%edits2.json"
echo.
echo \033[92mVideo/RPU framecount mismatch. Duplicating frame %rpuframecount%, %framecount.diff% times... | "%cmdcolor%"

:resync2
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%edits2.json" --rpu-out "%TEMP%%filename%_Final.bin" > nul
set RPU="%TEMP%%filename%_Final.bin"
echo Done.
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------INJECT------------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:INJECT
echo.&echo.
echo \033[36m         ================ | "%cmdcolor%"
echo \033[36m         - INJECTING DV - | "%cmdcolor%"
echo \033[36m         ================ | "%cmdcolor%"
echo.

:: copy final rpu to output path
if /i "%keep_rpu%"=="YES" copy /y %RPU% "%output_path%" > nul

:: inject final rpu
"%dovi_tool_path%" %dropH% inject-rpu -i %HDR% --rpu-in %RPU% -o "%output_path%%filename%_final.hevc"
if NOT ["%errorlevel%"]==["0"] pause
set HDR="%output_path%%filename%_final.hevc"& goto :MUXER

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

 ::----------------------------------------------------------------DV.inject.+batch.Workflow.6----------------------------------------------------------------------------------------------------------------------------

:batchP8muxer
set batch.info=y
::move %video_path%\*.bat "%output_path%" >Nul 2>&1
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %video_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
if [%fileext1%]==[] echo input must be a folder& pause & exit

::----------------------------folder 2-----------------------------------
set countDV=0
:: find how many files there are to process
for /r %metadata_path% %%F in (*) do (
    set /a "countDV+=1"
    set "fileDV!countDV!=%%~fF"
)
:: set files to variables
>variablesDV.txt (
    for /l %%i in (1,1,%countDV%) do (
        echo fileDV%%i=!fileDV%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variablesDV.txt") do (
    set "%%a=%%b"
)

del variablesDV.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%countDV%) do (
    for %%j in ("!fileDV%%i!") do (
        set "filenameDV%%i=%%~nj"
        set "filepathDV%%i=%%~dpj"
        set "fileextDV%%i=%%~xj"
    )
)
if [%fileextDV1%]==[]  echo input must be a folder...& pause & exit

if exist "%output_path%%filename1%.bat" goto :skip.l5
if exist "%output_path%%filename1%.json" goto :skip.l5

echo   Do you want to edit L5... y or n ^? and/or press enter... & set /p editL5_path=
if "%editL5_path%"=="Y" set editL5_path=y
if not "%editL5_path%"=="y" (
     set editL5_path=n
	 goto :skip.l5
)

echo   Manual or Auto L5... a or m ^? and/or press enter... & set /p autoL5=
if /i "%autoL5%"=="a" goto :skip.l5

set left=0& set right=0& set top=0& set bottom=0
echo Left L5 offset (default = 0) & set /p left=
if [%left%]==[] set left=0
echo Right L5 offset (default = 0) & set /p right=
if [%right%]==[] set right=0
echo Top L5 offset (default = 0) & set /p top=
if [%top%]==[] set top=0
echo Bottom L5 offset (default = 0) & set /p bottom=
if [%bottom%]==[] set bottom=0

:skip.l5

::----------------------------------------------------------------------------------------------------------------------------------------------loop -------------------------------------------------------------------------------------------------------------------------------------------------------------

:loop.p5.to.p8
if exist "%temp_folder%temp_folder18" rmdir /Q /S "%temp_folder%temp_folder18"
MD "%temp_folder%temp_folder18"
set TEMP=%temp_folder%temp_folder18\

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" echo Invalid extension, skipping file...& goto :end
 echo.
 echo \033[92m Processing the BL input: "%filepath1%%filename1%%fileext1%" | "%cmdcolor%"
 echo. 

::check if BL has keywords in the filename
echo "%filename1%" > "%TEMP%filename.txt"
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"FRENCH" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set lang=French& set langDG=fra& set lmp4=fr-FR& set lmkv=fr
findstr /c:"FIXAPPLE" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set FIXapple=YES

if exist "%output_path%%filename1%.bat" call "%output_path%%filename1%.bat" & goto :skip.measure
if exist "%output_path%%filename1%.json" goto :skip.measure
if not "%editL5_path%"=="y" goto :skip.L5.json
if not "%autoL5%"=="a" goto :skip.measure

:measure.letterbox
::measure letterbox
echo Measuring the video letterbox...
"%detectborders_path%" --ffmpeg-path="%ffmpeg_path%" --input-file="%filepath1%%filename1%%fileext1%" --log-file="%TEMP%\borders.txt"
:: read borders detection results
for /f "tokens=2 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "left=%%a"
)
for /f "tokens=4 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "right=%%a"
)
for /f "tokens=3 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "top=%%a"
)
for /f "tokens=5 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "bottom=%%a"
)

if [%right%]==[] set right=0
if [%left%]==[] set left=0
if [%right%]==[] set right=0
if [%bottom%]==[] set bottom=0
if "%bottom%"=="278" set bottom=277
if "%top%"=="278" set top=277
if "%bottom%"=="264" set bottom=263
if "%top%"=="264" set top=263

:skip.measure
:: Edit active area: generate L5 active area json
echo { > "%TEMP%L5.json"
echo    "mode": 0, >> "%TEMP%L5.json"
echo    "active_area": { >> "%TEMP%L5.json"
echo        "crop": false, >> "%TEMP%L5.json"
echo        "presets": [ >> "%TEMP%L5.json"
echo            { >> "%TEMP%L5.json"
echo                "id": 0, >> "%TEMP%L5.json"
echo                "left": %left%, >> "%TEMP%L5.json"
echo                "right": %right%, >> "%TEMP%L5.json"
echo                "top": %top%, >> "%TEMP%L5.json"
echo                "bottom": %bottom% >> "%TEMP%L5.json"
echo            } >> "%TEMP%L5.json"
echo        ], >> "%TEMP%L5.json"
echo        "edits": { >> "%TEMP%L5.json"
echo            "all": 0 >> "%TEMP%L5.json"
echo        } >> "%TEMP%L5.json"
echo    } >> "%TEMP%L5.json"
echo } >> "%TEMP%L5.json"

set l5json="%TEMP%L5.json"
if exist "%output_path%%filename1%.json" set l5json="%output_path%%filename1%.json"

:skip.L5.json

echo { > "%TEMP%CM4.json"
echo 	"remove_cmv4": true >> "%TEMP%CM4.json"
echo } >> "%TEMP%CM4.json"

set job=1.2& goto :tracks.info

:job.1.2
::-----------------------------------------------------------demux----------------------------------------------------------------------------------------------------------------------
:: check input HDR
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"

echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.

::demux mkv
if not "%fileext1%"==".mkv" goto :notmkv
     "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
	 set HDR="%TEMP%BL.hevc"
	 goto :mkv
	 
:notmkv

:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
:: demux non mkv
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"
	
:mkv
:: fix apple missing frame rate bitstream. expect 23.976
if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"

::-----------------------------------------------------------------------------
echo %filename1% > "%TEMP%filename.txt"
:: personal function... check if BL has KEEPTRIMS in the filename
findstr /c:"KEEPTRIMS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set rem_trims=n
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"DONTMUX" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set MUX=NO
findstr /c:"REMOVECMV4" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set rem_cmv4=YES

::------------------------------------------------DV-------------------------------------------------------------------------------------------------------------------------------

 echo.
 echo \033[92m Processing the DoVi input: "%filepathDV1%%filenameDV1%%fileextDV1%" | "%cmdcolor%"
 echo.
::extract DV
if not "%fileextDV1%"==".xml" goto :skip.xml

:: Read BL input resolution for xml to rpu generation (support variable L5)
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)

if /i "%remove_100%"=="YES" set rem_trims=y& set L2.100=,1
if /i "%remove_600%"=="YES" set rem_trims=y& set L2.600=,27,28
if /i "%remove_1000%"=="YES" set rem_trims=y& set L2.1000=,48,49

::removes 600 and 1000nits trims from xml with the dolby metafier
if "%rem_trims%"=="y" (
      echo \033[92m Removing L2 trims. | "%cmdcolor%"
     "%metafier_path%"  -o "%TEMP%out.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% "%filepathDV1%%filenameDV1%%fileextDV1%"
     echo \033[92m Generate RPU from XML...| "%cmdcolor%"
     "%dovi_tool_path%" generate --xml "%TEMP%out.xml" --canvas-width %Width_path% --canvas-height %Height_path% --rpu-out "%TEMP%rpu.bin"
     set RPU="%TEMP%rpu.bin"& goto :skip.keeptrims
)

:: generate RPU from xml file
 echo.
 echo \033[92m Generate RPU from XML...| "%cmdcolor%"

"%dovi_tool_path%" generate --xml "%filepathDV1%%filenameDV1%%fileextDV1%" --canvas-width %Width_path% --canvas-height %Height_path% --rpu-out "%TEMP%rpu.bin"
if NOT ["%errorlevel%"]==["0"] echo invalid xml, press a key to try again & rmdir /Q /S "%TEMP%" & pause & goto :xml1.again
set RPU="%TEMP%rpu.bin"
 echo Done.
 echo.
:skip.keeptrims
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MasteringDisplay_Luminance%% --LogFile="%TEMP%MDL.txt" >Nul
::check for HLG BL and set profile conversion to mode 4
type "%TEMP%mediainfo.JSON" | findstr HLG >"%TEMP%pq.txt"
findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set hlg.input=y
:: match source pq
set max=3079& set min=7& set MDL.max_path=1000& set MDL.min_path=1

findstr /m "1000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=1000
set max=3079
)
findstr /m "4000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=4000
set max=3696
)
findstr /m "10000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=10000
set max=4095
)
findstr /m "2000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=2000
set max=3388
)
findstr /m "0.0050" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=50
set min=62
)
findstr /m "0.0001" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=1
set min=7
)
findstr /m "0.0020" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=20
set min=38
)
findstr /m "0.0010" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=10
set min=19
)
findstr /m "0.0000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=0
set min=0
)
"%dovi_tool_path%" info -s %RPU% > "%TEMP%sum.rpu.json"
type "%TEMP%sum.rpu.json" | findstr L1 > "%TEMP%L1.txt"
FOR /F "tokens=4 delims=(:.)" %%T IN (%TEMP%L1.txt) DO set maxcll_path=%%T
FOR /F "tokens=6 delims=(:.)" %%T IN (%TEMP%L1.txt) DO set maxfall_path=%%T

::-----------------------------------------------------------------------------------------------------------------------------------------------------------
:: generate l6 json and edit the rpu
echo { > "%TEMP%L6.json"
if "%hlg.input%"=="y" echo    "mode": 4, >> "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %MDL.max_path%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %MDL.min_path%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"
if /i "%hlg.input%"=="y" echo \033[92m HLG detected, converting to profile 8.4... | "%cmdcolor%"
echo.

echo \033[92m MDL_min=%MDL.min_path%, MDL_max=%MDL.max_path%, Maxcll=%maxcll_path%, Maxfall=%maxfall_path% | "%cmdcolor%"

echo.
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L6.json" --rpu-out "%TEMP%%filename1%_Generated.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%%filename1%_Generated.bin"
xcopy /s /f  "%TEMP%%filename1%_Generated.bin" "%output_path%" >Nul
echo Done.& goto :skip.p5

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:skip.xml
if "%fileextDV1%"==".hevc" "%dovi_tool_path%" extract-rpu "%filepathDV1%%filenameDV1%%fileextDV1%" -o "%TEMP%%filenameDV1%_RPU.bin"& set RPU="%TEMP%%filenameDV1%_RPU.bin"& goto :skip
if "%fileextDV1%"==".h265" "%dovi_tool_path%" extract-rpu "%filepathDV1%%filenameDV1%%fileextDV1%" -o "%TEMP%%filenameDV1%_RPU.bin"& set RPU="%TEMP%%filenameDV1%_RPU.bin"& goto :skip
if "%fileextDV1%"==".bin" set RPU="%filepathDV1%%filenameDV1%%fileextDV1%"& goto :skip

"%ffmpeg_path%" -i "%filepathDV1%%filenameDV1%%fileextDV1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%TEMP%%filenameDV1%_RPU.bin" -
set RPU="%TEMP%%filenameDV1%_RPU.bin"

::---------------------------------------------convert RPU and inject -------------------------------------------------------------------------------------------------------------
:skip

"%dovi_tool_path%" info --input %RPU% -f 500 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "profile=%%a"
)
set "profile=%profile: =%"

if not "%profile%"=="5" goto :skip.p5
echo { > "%TEMP%profile.json"
echo     "mode": 3 >> "%TEMP%profile.json"
echo } >> "%TEMP%profile.json"
echo.
 echo \033[92m Converting P5 to P8...| "%cmdcolor%"
 echo.
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%profile.json" --rpu-out "%TEMP%%filenameDV1%RPU-P8.bin" > Nul
if %errorlevel%==1 "%dovi_tool_FIX_path%" editor -i %RPU% -j "%TEMP%profile.json" --rpu-out "%TEMP%%filenameDV1%RPU-P8.bin"
set RPU="%TEMP%%filenameDV1%RPU-P8.bin"

:skip.p5
:: edit l5
if "%editL5_path%"=="y" (
      echo \033[92m Editing L5...| "%cmdcolor%"
	  echo.
     "%dovi_tool_path%" editor -i %RPU% -j %l5json% --rpu-out "%TEMP%RPU-L5.bin" > Nul
     set RPU="%TEMP%RPU-L5.bin"
	 echo Done.
)
if "%rem_cmv4%"=="y" (
      echo \033[92m Removing CMV4.0...| "%cmdcolor%"
	  echo.
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%CM4.json" --rpu-out "%TEMP%RPU-cmv4.rem.bin" > Nul
     set RPU="%TEMP%RPU-cmv4.rem.bin"
	 echo Done.
)

echo.&echo.
echo \033[36m         ================ | "%cmdcolor%"
echo \033[36m         - INJECTING DV - | "%cmdcolor%"
echo \033[36m         ================ | "%cmdcolor%"
echo.

"%dovi_tool_path%" %dropH% inject-rpu -i %HDR% --rpu-in %RPU% -o "%output_path%%filename1%_DV.hevc"
set HDR="%output_path%%filename1%_DV.hevc"

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
goto :MUXER

:job.1.2.done
::---------------------------------------------------------------------end-----------------------------------------------------------------------------------------------
:end

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

:: go to next file or end the script
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set filenameDV1=!filenameDV%%i!& set filepathDV1=!filepathDV%%i!& set fileextDV1=!fileextDV%%i!& set f%%i=n& goto :loop.p5.to.p8
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::###########################################################   batch editor   ###########################################################################################################################
::##################################################################################################################################################################################################

:batch.editor

set batch.info=y
cd /d "%output_path%"
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %video_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if [%fileext1%]==[] (
     for %%i in (!video_path!) do set filename1=%%~ni
     for %%i in (!video_path!) do set filepath1=%%~di%%~pi
     for %%i in (!video_path!) do set fileext1=%%~xi
)

if /i "%same_input_output%"=="YES" set output_path=%filepath1%

:: make and set temp folder
if exist "%temp_folder%temp.folder1" if exist "%temp_folder%temp.folder1_new" if exist "%temp_folder%temp.folder1_new1" if exist "%temp_folder%temp.folder1_new2" if exist "%temp_folder%temp.folder1_new3" if exist "%temp_folder%temp.folder1_new4" if exist "%temp_folder%temp.folder1_new5" rmdir /Q /S "%temp_folder%temp.folder1" & rmdir /Q /S  "%temp_folder%temp.folder1_new" & rmdir /Q /S  "%temp_folder%temp.folder1_new1" & rmdir /Q /S  "%temp_folder%temp.folder1_new2" & rmdir /Q /S  "%temp_folder%temp.folder1_new3" & rmdir /Q /S  "%temp_folder%temp.folder1_new4" & rmdir /Q /S  "%temp_folder%temp.folder1_new5"
if exist "%temp_folder%temp.folder1" set E1=_new
if exist "%temp_folder%temp.folder1_new" set E1=_new1
if exist "%temp_folder%temp.folder1_new1" set E1=_new2
if exist "%temp_folder%temp.folder1_new2" set E1=_new3
if exist "%temp_folder%temp.folder1_new3" set E1=_new4
if exist "%temp_folder%temp.folder1_new4" set E1=_new5
MD "%temp_folder%temp.folder1%E1%"
set TEMP=%temp_folder%temp.folder1%E1%\

if /i "%fileext1%"==".mpls" set p7from1=y& goto :p7from1

::check if BL has keywords in the filename
echo "%filename1%" > "%TEMP%filename.txt"
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"DONTMUX" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set MUX=NO
findstr /c:"FIXAPPLE" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set FIXapple=YES
findstr /c:"REMOVECMV4" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set rem_cmv4=YES

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 (
     if /i "%drop.HDR10plus%"=="YES" set dropH=--drop-hdr10plus
)

::--------------------------------------------------input info------------------------------------------------------------------------------

if exist "%filepath1%%filename1%.json" set editL5=n& set editL6=n& set editL9=n& set resync=n& goto :LOOP.EDIT

if /i "%fileext1%"==".bin" set MUX=NO& set container=none& set temp.rpu="%filepath1%%filename1%%fileext1%"& goto :rpu
if /i "%fileext1%"==".xml" (
        "%dovi_tool_path%" generate --xml "%filepath1%%filename1%%fileext1%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%output_path%%filename1%_rpu_xml.bin" >Nul
		set MUX=NO& set container=none& set temp.rpu="%output_path%%filename1%_rpu_xml.bin"
		goto :rpu
)

set mkvID=0
if not "%fileext1%"==".mp4" goto :skipdualtrackin
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfotemp.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="2" set mkvID=1
:skipdualtrackin
::check dv l5
"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:00:23 > Nul
"%mkvextract_path%" "%TEMP%1.mkv" tracks %mkvID%:"%TEMP%temp.vid.hevc" > Nul

::export input info
"%mediainfo_path%" "%TEMP%1.mkv" --output=JSON > "%TEMP%mediainfo.bl.JSON"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.bl.JSON" > "%TEMP%check.DV.bl.txt"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.bl.JSON" > "%TEMP%check.HDR10plus.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%col.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"
	
:: read input info
set P5=n& set P8=n& set P7=n& set HDR10plus=n& set DV.input=n
if "%video.count%"=="2" set P7=y& set DV.input=y
findstr /c:"05" "%TEMP%check.DV.bl.txt" >Nul
if %errorlevel%==0 set P5=y& set DV.input=y
findstr /c:"07" "%TEMP%check.DV.bl.txt" >Nul
if %errorlevel%==0 set P7=y& set DV.input=y
findstr /c:"08" "%TEMP%check.DV.bl.txt" >Nul
if %errorlevel%==0 set P8=y& set DV.input=y
findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 set HDR10plus=y
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "framerate=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxcll.txt"') do (
    set "maxcll=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxfall.txt"') do (
    set "maxfall=%%a"
)
set "maxfall=%maxfall: =%"
set "maxcll=%maxcll: =%"

for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
set col=%col:~1,-1%
if "%maxcll%"==" =" set maxcll=0
if "%maxfall%"==" =" set maxfall=0
if "%maxcll%"=="" set maxcll=0
if "%maxfall%"=="" set maxfall=0
if "%HDR10plus%"=="n" if "%DV.input%"=="n" echo Input is HDR10 only, nothing to do...& pause & exit
if "%HDR10plus%"=="y" if "%DV.input%"=="n" set inputfrom1=y& goto :HDR10PLUS

"%dovi_tool_path%" extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" > Nul
set temp.rpu="%TEMP%chunk.RPU.bin"

:rpu
echo.
echo \033[92mChecking Metadata input...| "%cmdcolor%"
echo.

"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
"%dovi_tool_path%" export -i %temp.rpu% -o "%TEMP%full.json" > Nul
"%dovi_tool_path%" export -i %temp.rpu% -d scenes="%TEMP%scene.cuts.txt" > Nul

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":24" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":25" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=P3
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=BT2020

type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "DVprofile=%%a"
)
set "DVprofile=%DVprofile: =%"

if /i "%fileext1%"==".bin" GOTO :SKIPMDL2
if /i "%fileext1%"==".xml" GOTO :SKIPMDL2

"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
set MDL=%MDL:~1,-1%
:SKIPMDL2
set cmdcolortype=& set colorsoft=&set cmdcolortype2=& set colorsoft2=&set cmdcolortype3=& set colorsoft3=& set first_line=& set second_line=
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^1:"') do (
    set "first_line=%%a"
)
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^2:"') do (
    set "second_line=%%a"
)

if "%first_line%"=="1:0" (
    set scenecuts0=YES (good^)
) else (
    set scenecuts0=NO& set cmdcolortype2=\033[31m& set colorsoft2=^| "%cmdcolor%"
)

set consecutiveSC=NO (good)
if "%first_line%"=="1:0" if "%second_line%"=="2:1" set consecutiveSC=YES& set cmdcolortype3=\033[31m& set colorsoft3=^| "%cmdcolor%"

set L5missing=n
if "%left%"==" =" set L5missing=y& set noL5warning=WARNING, Level 5 is missing...&set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=\033[31m& set colorsoft=^| "%cmdcolor%"

"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path%

echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"

"%dovi_tool_path%" info -s %temp.rpu%
if "%L5missing%"=="y" echo %cmdcolortype%  %noL5warning%%colorsoft%
if "%scenecuts0%"=="NO" echo %cmdcolortype2%  WARNING: 1st Frame is not a Scene Cut%colorsoft2%
if "%consecutiveSC%"=="YES" echo %cmdcolortype3%  WARNING: Consecutive Scene Cuts%colorsoft3%
if "%DVprofile%"=="5" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer: ICtCp (DoVi P5)
if "%DVprofile%"=="7" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer (HDR10^+P7): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
if "%DVprofile%"=="8" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer (HDR10^+P8): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Resolution\FPS: %Width% x %Height% ^@ %framerate%
if /i "%batchfolderextract%"=="n" echo   Input: "%filepath1%%filename1%%fileext1%"
if /i "%checkoutputspace%"=="NO" goto :skipquickinfo
if %free_gb% leq 200 echo \033[31m  Output Path Free Space: %free_gb%gb| "%cmdcolor%"
if not %free_gb% leq 200 echo   Output Path Free Space: %free_gb%gb
:skipquickinfo
echo.

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
if "%DVprofile%"=="5" set MBOX=& set dv.profile=5& set ID=0
if "%DVprofile%"=="7" set MBOX=:hdr=none:dvp=7.6& set dv.profile=7.6& set ID=1
if exist "%filepath1%%filename1%.json" set editL5=n& set editL6=n& set editL9=n& set resync=n& goto :LOOP.EDIT

::------------------------------------------------choices-------------------------------------------------------------------------------

if /i "%batchfolderextract%"=="y" set choiceM=Extract=E& goto :skipoptions
if /i "%fileext1%"==".bin" set choiceM=Read=E
if /i "%fileext1%"==".xml" set choiceM=Read=E
if "%DVprofile%"=="7" if not "%fileext1%"==".bin" set p7inputchoice=P7_to_P8=7 
if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" if not "%DVprofile%"=="5" set removechoice=Remover=V
if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" set choiceM=Extract=E
set metafier=Metafier=M
set checksync=Check_Sync=S
set Tlevels=Transfer_Levels=T
if "%cmv4.0%"=="y" set remcmv4.0meta=Remove_CMV4=4 

:skipoptions
::user input
echo \033[92m --------------------------------------------------------------------------------------------------| "%cmdcolor%"
echo   ^*You can select more than one value but no space between values (except: e/m/p/s/7/v/r/t).
echo   ^*EG: You can select 569fp4 or 569dp4 but not 569p4fd, 569p4fr, 569p4ms, emsv, etc...
echo.
echo \033[36m  CHOICES: (default=X ^Exit) | "%cmdcolor%"
echo   Exit=X   L5=5   L6=6   L9=9   Resync=R or D   SceneCut_Edit=F   Source_PQ=Q  %remcmv4.0meta%
echo   PLOT=P   %choiceM%   %checksync%   %Metafier%   %Tlevels%   %p7inputchoice%  %removechoice%     
echo \033[92m --------------------------------------------------------------------------------------------------| "%cmdcolor%"
set /p editchoice=

if /i "%editchoice%"=="" set editchoice=x
set editL5=n& set editL6=n& set editL9=n& set resync=n& set editsync=n& set sourcepq=n
echo %editchoice% > "%TEMP%editchoice.txt"
findstr /m "5" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set editL5=y
findstr /m "6" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set editL6=y
findstr /m "9" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set editL9=y
findstr /m "4" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set rem_cmv4=YES
findstr /m "Q" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set sourcepq=y
findstr /m "q" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set sourcepq=y
findstr /m "R" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set resync=r
findstr /m "r" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set resync=r
findstr /m "D" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set resync=d
findstr /m "d" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set resync=d
findstr /m "F" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set resync=s
findstr /m "f" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set resync=s
findstr /m "E" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :extractor
findstr /m "e" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :extractor
findstr /m "M" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :METAFIER
findstr /m "m" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :METAFIER
findstr /m "T" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :transferlevelfrom1
findstr /m "t" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :transferlevelfrom1
findstr /m "X" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 echo \033[92mThe script has been completed. Press a key to exit| "%cmdcolor%"& rmdir /Q /S "%TEMP%"  & exit
findstr /m "x" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 echo \033[92mThe script has been completed. Press a key to exit| "%cmdcolor%"& rmdir /Q /S "%TEMP%" & exit
findstr /m "7" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set p7from1=y& goto :p7from1
findstr /m "P" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :plotfrom1
findstr /m "p" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :plotfrom1
findstr /m "S" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :checksyncfrom1
findstr /m "s" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 goto :checksyncfrom1
findstr /m "V" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set removefromone=y&goto :removefrom1
findstr /m "v" "%TEMP%editchoice.txt" >Nul
if %errorlevel%==0 set removefromone=y&goto :removefrom1

set raw=n
if /i "%fileext1%"==".hevc" set MUX=NO& set container=none& set raw=y& goto :skip
if /i "%fileext1%"==".h265" set MUX=NO& set container=none& set raw=y& goto :skip
if /i "%encode_DDP%"=="NO" goto :skip
if /i "%container%"=="MP4" goto :skip

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Audio;%%Format%% --LogFile="%TEMP%audio.format.txt" >Nul
findstr /c:"MLP" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm.au=n
if "%mlp%"=="n" if "%dts%"=="n"  if "%pcm.au%"=="n" goto :skip

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
:: check audio tracks info
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath1%%filename1%%fileext1%"

echo.
set convert_audio=n
echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n
:skip

::-------------------------------------------sourcePQ--------------------------------------------------------
:: Do not edit if you dont know what you're doing. Changing this for real movie is wrong.
if /i "%sourcepq%"=="n" goto :skipsourcepq
echo.
echo.
     echo -------------------------------------------------------------------------------------------------
     echo Values must be in 12bit. EG: 1000nits=3079 / 4000nits=3696 / 10 000nits=4095 / 0.0001=7 / 0.0050=62
	 echo -------------------------------------------------------------------------------------------------
	 echo.
     echo   Enter Source_PQ MAX and press enter... (default=3079)
	 set /p maxPQ=
    echo   Enter Source_PQ MIN and press enter... (default=7)
	 set /p minPQ=

if "%minPQ%"=="" set minPQ=7
if "%maxPQ%"=="" set maxPQ=3079
:skipsourcepq


::-------------------------------------------L9--------------------------------------------------------
if not "%cmv4.0%"=="y" set editL9=n
if /i "%editL9%"=="y" echo  DCIP3D65=1 or BT2020=2^? (default=1) & set /p MDC=
if /i "%MDC%"=="" set MDC=DCIP3D65
if /i "%MDC%"=="1" set MDC=DCIP3D65
if /i "%MDC%"=="2" set MDC=BT2020
if not "%MDC%"=="BT2020" if not "%MDC%"=="DCIP3D65" set MDC=DCIP3D65

::------------------------------------------L5--------------------------------------------------------
if /i "%editL5%"=="n" goto :no.auto.l5
if /i "%fileext1%"==".bin" set autoL5=m& goto :no.auto.l5
if /i "%fileext1%"==".xml" set autoL5=m& goto :no.auto.l5
echo   Manual or Auto Level 5 edit ^? (default= m)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p autoL5=
if /i "%autoL5%"=="" set autoL5=m
if /i "%autoL5%"=="m" set autoL5=m
if /i "%autoL5%"=="a" set autoL5=a
if not "%autoL5%"=="a" if not "%autoL5%"=="m" set autoL5=m

:no.auto.l5
::-------------------------------------------resync--------------------------------------------------------

if /i "%resync%"=="r" (
     echo   Enter the first frame to remove (0= frame1^)... and press enter... & set /p rem=
	 echo   Enter the second frame to remove (0= frame1^)... and press enter... & set /p remm=
)

if /i "%resync%"=="d" (
     echo   How many frame do you want to duplicate^? and press enter... 
	 set /p dup=
	 echo   Which frame do you want to duplicate^? and press enter... 
	 set /p sour=
	 echo   After which frame do you want to add the duplicated frames^? 
	 set /p offs=
)

::-------------------------------------------L6--------------------------------------------------------

::L6 condition
if /i "%editL6%"=="n" goto :skipL6
     echo   Enter Mastering Display Luminance MAX and press enter... (default=1000)
	 set /p MDL.max_path=
     echo   Enter Mastering Display Luminance MIN and press enter... (0.0050=50 / 0.0001=1 etc...)(default=1)
	 set /p MDL.min_path=
     echo   Enter Maxcll and press enter...(default=0)
	 set /p maxcll_path=
     echo   Enter Maxfall and press enter...(default=0)
	 set /p maxfall_path=

if "%MDL.max_path%"=="" set MDL.max_path=1000
if "%MDL.min_path%"=="" set MDL.min_path=1
if "%maxcll_path%"=="" set maxcll_path=0
if "%maxfall_path%"=="" set maxfall_path=0

::------------------------------------------L5--------------------------------------------------------

:skipL6
::L5 condition
if /i  "%editL5%"=="n" goto :LOOP.EDIT
if /i "%fileext1%"==".bin" goto :selection
if /i "%fileext1%"==".xml" goto :selection
if /i "%autoL5%"=="a" goto :LOOP.EDIT

:: check for raw or ts/m2ts input in order to prepare crop readings in avspmod (ts/m2ts files are buggy and raw hevc cant be played in directshow)
set cropcheck="%filepath1%%filename1%%fileext1%"
if not "%raw%"=="y" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" goto :skip.sample
:: make mkv sample if input raw hevc or ts/m2ts
echo.
echo Raw HEVC or TS/M2TS input, making a MKV sample to allow avspmod to read the input...
"%mkvmerge_path%" --output ^"%TEMP%sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set cropcheck="%TEMP%sample.mkv"
::make script for avspmod with raised black for better letterbox reading
:skip.sample
echo DirectShowSource(%cropcheck%) > "%TEMP%%filename1%.avs"
echo Levels(0, 2.5, 255, 0, 255, coring=false) >> "%TEMP%%filename1%.avs"
:: launch avspmod
start "" "%AvsPmod_path%" "%TEMP%%filename1%.avs"

:selection
:: user input for manual l5
echo   Set the left border... choose a number and press enter...& set /p L5.left_path=
if "%L5.left_path%"=="" set L5.left_path=0
echo   Set the right border... choose a number and press enter...& set /p L5.right_path=
if "%L5.right_path%"=="" set L5.right_path=0
echo   Set the top border... choose a number and press enter...& set /p L5.top_path=
if "%L5.top_path%"=="" set L5.top_path=0
echo   Set the bottom border... choose a number and press enter...& set /p L5.bottom_path=
if "%L5.bottom_path%"=="" set L5.bottom_path=0

::---------------------------------------------------------------------loop edit--------------------------------------------------------------------
if not "%DEL_temp%"=="NO" rmdir /Q /S "%TEMP%"
:LOOP.EDIT
:: make and set temp folder
if exist "%temp_folder%temp.folder11" rmdir /Q /S "%temp_folder%temp.folder11"
MD "%temp_folder%temp.folder11"
set TEMP=%temp_folder%temp.folder11\

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" if not "%fileext1%"==".h265" if not "%fileext1%"==".hevc" echo Invalid extension, skipping file...& goto :job.2.1.1.done
echo.
echo \033[92mProcessing "%filename1%%fileext1%" | "%cmdcolor%"
echo.
if /i "%fileext1%"==".bin" set temp.rpu="%filepath1%%filename1%%fileext1%"& goto :skip.sample
"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:00:23 > Nul
"%mkvextract_path%" "%TEMP%1.mkv" tracks 0:"%TEMP%temp.vid.hevc" > Nul

"%dovi_tool_path%" extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" > Nul
set temp.rpu="%TEMP%chunk.RPU.bin"

:skip.sample

"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
"%dovi_tool_path%" export -i %temp.rpu% -o "%TEMP%full.json" > Nul
type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "DVprofile=%%a"
)
set "DVprofile=%DVprofile: =%"

set cmv4.0=n
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
if "%DVprofile%"=="5" set MBOX=& set dv.profile=5& set ID=0
if "%DVprofile%"=="7" set MBOX=:hdr=none:dvp=7.6& set dv.profile=7.6& set ID=1

set raw=n
if /i "%fileext1%"==".h265" set raw=y
if /i "%fileext1%"==".hevc" set raw=y
if /i  "%editL5%"=="n" goto :skipautoL5
if /i "%autoL5%"=="m" goto :skipautoL5

"%mkvmerge_path%" --output ^"%TEMP%chunk.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
echo Measuring the letterbox...
"%detectborders_path%" --ffmpeg-path="%ffmpeg_path%" --input-file="%TEMP%chunk.mkv" --log-file="%TEMP%\borders.txt"
:: read borders detection results
for /f "tokens=2 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.left_path=%%a"
)
for /f "tokens=4 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.right_path=%%a"
)
for /f "tokens=3 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.top_path=%%a"
)
for /f "tokens=5 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.bottom_path=%%a"
)

echo left border: %L5.left_path%
echo right border: %L5.right_path%
echo top border: %L5.top_path%
echo bottom border: %L5.bottom_path%

:skipautoL5

if "%raw%"=="y"  set HDR="%filepath1%%filename1%%fileext1%"& goto :skip
if /i "%fileext1%"==".bin" set RPU="%filepath1%%filename1%.bin"& goto :no.demux

set job=2.1.1& goto :tracks.info

:job.2.1.1
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------DEMUX BL------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.

if not "%fileext1%"==".mkv" goto :notmkv
     "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
	 set HDR="%TEMP%BL.hevc"
	 goto :skip
	 
:notmkv
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" if not "!T%%i.Format!"=="null" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
	 "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
	 set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"

:skip
:: extract rpu
"%dovi_tool_path%" extract-rpu %HDR% -o "%TEMP%RPU.bin"
set RPU="%TEMP%RPU.bin"

if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"
:no.demux

::----------------------------external json-------------------------------------
if exist "%filepath1%%filename1%.json" (
	 echo.
     echo \033[92mEditing RPU using external JSON config,  "%filename1%.json" | "%cmdcolor%"
     "%dovi_tool_path%" editor -i %RPU% -j "%filepath1%%filename1%.json" --rpu-out "%TEMP%%filename1%_RPU-edited-ext.bin"
	 set RPU="%TEMP%%filename1%_RPU-edited-ext.bin"
	 echo Done.
     echo.
	 goto :INJECT
)

::----------------------------edit L5-------------------------------------
if /i "%editL5%"=="n" goto :skipL5

::generate L5 active area json
echo { > "%TEMP%L5.json"
echo    "active_area": { >> "%TEMP%L5.json"
echo        "crop": false, >> "%TEMP%L5.json"
echo        "presets": [ >> "%TEMP%L5.json"
echo            { >> "%TEMP%L5.json"
echo                "id": 0, >> "%TEMP%L5.json"
echo                "left": %L5.left_path%, >> "%TEMP%L5.json"
echo                "right": %L5.right_path%, >> "%TEMP%L5.json"
echo                "top": %L5.top_path%, >> "%TEMP%L5.json"
echo                "bottom": %L5.bottom_path% >> "%TEMP%L5.json"
echo            } >> "%TEMP%L5.json"
echo        ], >> "%TEMP%L5.json"
echo        "edits": { >> "%TEMP%L5.json"
echo            "all": 0 >> "%TEMP%L5.json"
echo        } >> "%TEMP%L5.json"
echo    } >> "%TEMP%L5.json"
echo } >> "%TEMP%L5.json"

	 echo.
     echo \033[92mEditing Level 5 to B=%L5.bottom_path%, T=%L5.top_path% L=%L5.left_path%, R=%L5.right_path%   | "%cmdcolor%"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L5.json" --rpu-out "%TEMP%%filename1%RPU-L5.bin" > nul
     set RPU="%TEMP%%filename1%RPU-L5.bin"
	 	 echo Done.
     echo.
:skipL5

::----------------------------edit L6-------------------------------------
if /i "%editL6%"=="n" goto :skipL6

echo { > "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %MDL.max_path%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %MDL.min_path%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"

	 echo.
     echo \033[92mEditing Level 6 to MDL %MDL.max_path%-%MDL.min_path%, maxCLL-FALL %maxcll_path%-%maxfall_path% | "%cmdcolor%"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L6.json" --rpu-out "%TEMP%%filename1%RPU-L6.bin" > nul
	  set RPU="%TEMP%%filename1%RPU-L6.bin"
	  	 echo Done.
     echo.
:skipL6

::----------------------------edit L9-------------------------------------
if not "%cmv4.0%"=="y" goto :skipL9
if /i "%editL9%"=="n" goto :skipL9
	 echo { > "%TEMP%l9.json"
     echo "mode": 0, >> "%TEMP%l9.json"
     echo "level9": "%MDC%" >> "%TEMP%l9.json"
     echo } >> "%TEMP%l9.json"
	 echo.
     echo \033[92mEditing Level 9 to %MDC% | "%cmdcolor%"
	 
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%l9.json" --rpu-out "%TEMP%%filename1%RPU-L9.bin" > nul
     set RPU="%TEMP%%filename1%RPU-L9.bin"
	 	 echo Done.
     echo.
:skipL9

::---------------------------remove cmv4.0------------------------------
if "%cmv4.0%"=="y" (
     if /i "%rem_cmv4%"=="YES" (
     echo { > "%TEMP%CM4.json"
     echo 	"remove_cmv4": true >> "%TEMP%CM4.json"
     echo } >> "%TEMP%CM4.json"
	 echo.
     echo \033[92mRemoving CMV4.0... | "%cmdcolor%"
     echo.
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%CM4.json" --rpu-out "%TEMP%%filename1%_RPU-cmv4.removed.bin" > nul
	 set RPU="%TEMP%%filename1%_RPU-cmv4.removed.bin"
	 echo Done.
     echo.
	 )
)

::---------------------------source PQ------------------------------
     if /i "%sourcePQ%"=="y" (
     echo { > "%TEMP%sourcepq.json"
     echo 	"min_pq": %minPQ%, >> "%TEMP%sourcepq.json"
     echo 	"max_pq": %maxPQ% >> "%TEMP%sourcepq.json"
     echo } >> "%TEMP%sourcepq.json"
	 echo.
     echo \033[92m Editing source_PQ to Max=%maxPQ% / Min=%minPQ% | "%cmdcolor%"
     echo.
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%sourcepq.json" --rpu-out "%TEMP%%filename1%_RPU-sourcePQ_edited.bin" > nul
	 set RPU="%TEMP%%filename1%_RPU-sourcePQ_edited.bin"
	 echo Done.
     echo.
)

if /i "%resync%"=="s" goto :REFRESH
if /i "%resync%"=="r" goto :REMOVE
if /i "%resync%"=="d" goto :DUPLICATE
goto :INJECT

::-----------------------------------------------------------------------------------------------------
::------------------------------------------REMOVE-------------------------------------------------
::-----------------------------------------------------------------------------------------------------

:REMOVE
::generate remove frames json
echo { > "%TEMP%edition.json"
echo 	"remove": [ >> "%TEMP%edition.json"
echo        "%rem%-%remm%" >> "%TEMP%edition.json"
echo    ] >> "%TEMP%edition.json"
echo } >> "%TEMP%edition.json"
echo.
echo \033[92mRemoving frame %rem% to %remm% | "%cmdcolor%"
	 echo Done.
     echo.
goto :EDIT

::-----------------------------------------------------------------------------------------------------
::----------------------------------------DUPLICATE------------------------------------------------
::-----------------------------------------------------------------------------------------------------

:DUPLICATE
::generate duplicate frames json (inclusive)%mkvextract_path% %video_path%
echo { > "%TEMP%edition.json"
echo 	"duplicate": [ >> "%TEMP%edition.json"
echo 		{ >> "%TEMP%edition.json"
echo 			"source": %sour%, >> "%TEMP%edition.json"
echo 			"offset": %offs%, >> "%TEMP%edition.json"
echo 			"length": %dup% >> "%TEMP%edition.json"
echo 		} >> "%TEMP%edition.json"
echo 	] >> "%TEMP%edition.json"
echo } >> "%TEMP%edition.json"

echo \033[92mDuplicating frame %sour%, %dup% times after frame %offs% | "%cmdcolor%"
	 echo Done.
     echo.
goto :EDIT

::-----------------------------------------------------------------------------------------------------
::---------------------------------------REFRESH FLAG--------------------------------------------
::-----------------------------------------------------------------------------------------------------

:REFRESH
echo \033[92mExporting Scene cuts...| "%cmdcolor%"
echo.
"%dovi_tool_path%" export -i %RPU% -d scenes="%output_path%%filename1%_scene-cuts.txt"
echo \033[92mCheck "%output_path%%filename1%_scene-cuts.txt" and select if you have to add or remove a refresh flag(s)... | "%cmdcolor%"
echo.
echo Do you want to Add(a) or Remove(r) scene_refresh_flag(scene cut)^? (default= a)
echo.
echo --^> Add= a 
echo --^> Remove= r
echo.
set /p scene=
if /i "%scene%"=="" set scene=a
if /i "%scene%"=="a" set scene=a
if /i "%scene%"=="r" set scene=r
if /i "%scene%"=="a" goto :add.flag

::--------------------------------------remove flag----------------------------------------------------------------------

echo Check the "%output_path%%filename1%_scene-cuts.txt" and determine how many frames you have to remove^? (inclusive, 0 based)& set /p rem=
 ::make reset scene cut json
(
echo {
echo     "scene_cuts": {
echo         "1-%rem%": false
echo     }
echo }
) > "%TEMP%edition.json"
echo.
echo \033[92mRemoving Refresh Scene flag for frame 1 to %rem%| "%cmdcolor%"
echo.
goto :EDIT
::--------------------------------------add flag----------------------------------------------------------------------

:add.flag
echo Which frames do you want to add a scene cut flag^? (inclusive, default=0  1st frame)& set /p addSC=
if "%addSC%"=="" set addSC=0

     echo { > "%TEMP%edition.json"
	 echo     "mode": 0, >> "%TEMP%edition.json"
	 echo     "scene_cuts": { >> "%TEMP%edition.json"
	 echo         "%addSC%-%addSC%": true >> "%TEMP%edition.json"
	 echo 		} >> "%TEMP%edition.json"
	 echo } >> "%TEMP%edition.json"
echo.
echo \033[92mAdding a Scene Cut flag at frame %addSC%| "%cmdcolor%"
echo.

:EDIT
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%edition.json" --rpu-out "%TEMP%%filename1%_RPU_Edited.bin" > Nul
set RPU="%TEMP%%filename1%_RPU_Edited.bin"
	 echo Done.
     echo.

::---------------------------------------inject-------------------------------------------------------------------------
	 
:INJECT
if /i "%fileext1%"==".bin" (
        copy /y %RPU% "%output_path%"
        goto :job.2.1.1.done
)
echo.
echo \033[36m          ============== | "%cmdcolor%"
echo \033[36m          - INJECTING - | "%cmdcolor%"
echo \033[36m          ============== | "%cmdcolor%"
echo.
"%dovi_tool_path%" %dropH% inject-rpu -i %HDR% --rpu-in %RPU% -o "%output_path%%filename1%_final.hevc"
set HDR="%output_path%%filename1%_final.hevc"
copy /y %RPU% "%output_path%"
goto :MUXER

::------------------------------------------------------------------------------end--------------------------------------------------------------------------------------------------------------

:job.2.1.1.done
echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)

set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set p7_bl=& set p5_bl=& set dropH=& set mlp=& set dts=& set pcm.au=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set trims=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set dv.profile=
set final.vid=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=
set upal2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :LOOP.EDIT
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ---------------------------------------------------------READER/EXTRACTOR-------------------------------------------------------------------------------------------------------------------------

:extractor
if /i "%batchfolderextract%"=="y" goto :batchexfrom1

if /i "%same_input_output%"=="YES" set output_path=%filepath1%
:rpucheckagainframe
if /i "%fileext1%"==".xml" (
     "%dovi_tool_path%" generate --xml "%filepath1%%filename1%%fileext1%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%%filename1%_rpu.bin" >Nul
	 echo   Enter which frame you want to read and/or press enter... ^(you can skip^) & set /p frame.to.read_path=
	 set RPU="%TEMP%%filename1%_rpu.bin"& goto :rawmetadatainput
)

if /i "%fileext1%"==".bin" (
    echo   Enter which frame you want to read and/or press enter... ^(you can skip^) & set /p frame.to.read_path=
	set RPU="%filepath1%%filename1%%fileext1%"& goto :rawmetadatainput
)

if not [%fileext1%]==[] goto :skip.bd
:: find the right playlist 
"%DGDemux_path%" -d %input%
:mplsagain1ff
echo   Drag and drop the main movie MPLS and press enter... & set /p mpls_path=

if [%mpls_path%]==[] goto :mplsagain1ff
for %%i in (!mpls_path!) do set filename=%%~ni
for %%i in (!mpls_path!) do set filepath=%%~di%%~pi

"%mediainfo_path%" %mpls_path% --output=JSON > "%TEMP%mediainfo.JSON"
:: demux
"%DGDemux_path%" -nopre -i %mpls_path% -o "%TEMP%"
FOR /R "%TEMP%" %%E IN (*1015*.hevc) do set "EL=%%~nE
set HDR="%TEMP%%EL%.hevc"& goto :skip
:skip.bd

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
if "%fileext1%"==".hevc" set HDR="%filepath1%%filename1%.hevc"& goto :skip
if "%fileext1%"==".h265" set HDR="%filepath1%%filename1%.h265"& goto :skip

MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul

::check for dual track dual layer p7 input
for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[0].VideoCount "%TEMP%mediainfo.JSON"`) do set video.count=%%~a
rmdir /Q /S  "%letterpath%\JQ\" > nul
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DT=-map 0:1& goto :skip.mkvextract

if not "%fileext1%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
set HDR="%TEMP%BL.hevc"& goto :skip

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename1%_RPU.bin" -
set RPU="%output_path%%filename1%_RPU.bin"& goto :read

:skip
"%dovi_tool_path%" extract-rpu %HDR% -o "%output_path%%filename1%_RPU.bin"
set RPU="%output_path%%filename1%_RPU.bin"

:read
if [%frame.to.read_path%]==[] set frame.to.read_path=40
"%dovi_tool_path%" info --input %RPU% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"
type "%TEMP%temp.rpu.json" | findstr target_max_pq > "%TEMP%trims.json"

"%dovi_tool_path%" export -i %RPU% -o "%TEMP%full.json"

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":24" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":25" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=(P3)
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=(BT2020)

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"

"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%col.txt"
"%JQ_path%" .media.track[1].Duration "%TEMP%mediainfo.JSON" > "%TEMP%du.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
	"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "framerate=%%a"
)
	
for /f "delims=" %%x in (%TEMP%du.txt) do set du=%%x

:skip
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "DVprofile=%%a"
)
set "DVprofile=%DVprofile: =%"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "W=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "H=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxcll.txt"') do (
    set "maxcll=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxfall.txt"') do (
    set "maxfall=%%a"
)
if "%maxcll%"==" =" set maxcll=0
if "%maxfall%"==" =" set maxfall=0
if "%maxcll%"=="" set maxcll=0
if "%maxfall%"=="" set maxfall=0
set cmdcolortype=& set colorsoft=&set cmdcolortype2=& set colorsoft2=&set cmdcolortype3=& set colorsoft3=
set MDL=%MDL:~1,-1%& set col=%col:~1,-1%
set L5missing=n
if "%left%"==" =" set L5missing=y& set noL5warning=WARNING, Level 5 is missing...&set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=\033[31m& set colorsoft=^| "%cmdcolor%"
if "%left%"=="" set L5missing=y& set noL5warning=WARNING, Level 5 is missing...&set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=\033[31m& set colorsoft=^| "%cmdcolor%"

"%dovi_tool_path%" export -i %RPU% -d scenes="%TEMP%scene.cuts.txt"

set first_line=
set second_line=
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^1:"') do (
    set "first_line=%%a"
)
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^2:"') do (
    set "second_line=%%a"
)

if "%first_line%"=="1:0" (
    set scenecuts0=YES (good^)
) else (
    set scenecuts0=NO& set cmdcolortype2=\033[31m& set colorsoft2=^| "%cmdcolor%"
)

set consecutiveSC=NO (good)
if "%first_line%"=="1:0" if "%second_line%"=="2:1" set consecutiveSC=YES& set cmdcolortype3=\033[31m& set colorsoft3=^| "%cmdcolor%"

::read RPU
:rawmetadatainput

"%dovi_tool_path%" info --input %RPU% -f %frame.to.read_path%
echo.
echo \033[36m   ============== | "%cmdcolor%"
echo \033[36m   - INPUT INFO - | "%cmdcolor%"
echo \033[36m   ============== | "%cmdcolor%"
echo.
"%dovi_tool_path%" info -s %RPU%
if "%L5missing%"=="y" echo %cmdcolortype%  %noL5warning%%colorsoft%
if "%scenecuts0%"=="NO" echo %cmdcolortype2%  WARNING: 1st Frame is not a Scene Cut%colorsoft2%
if "%consecutiveSC%"=="YES" echo %cmdcolortype3%  WARNING: Consecutive Scene Cuts%colorsoft3%
if "%DVprofile%"=="5" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer: ICtCp (DoVi P5)
if "%DVprofile%"=="7" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer (HDR10^+P7): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
if "%DVprofile%"=="8" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer (HDR10^+P8): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits
if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Resolution\FPS: %Width% x %Height% ^@ %framerate%
if /i "%batchfolderextract%"=="n" echo   Input: "%filepath1%%filename1%%fileext1%"
if /i "%checkoutputspace%"=="NO" goto :skipquickinfo
if %free_gb% leq 200 echo \033[31m  Output Path Free Space: %free_gb%gb| "%cmdcolor%"
if not %free_gb% leq 200 echo   Output Path Free Space: %free_gb%gb
:skipquickinfo
echo.
if /i "%cmv4.0%"=="y" set L8trims=-annotate +2623+118  "L8 trims: %t81%%t84%%t82%%t83%"
if "%level9%"=="y" set L9MDP=-annotate +480+122  "%MDP.RPU%"

if "%fileext1%"==".bin" if not "%frame.to.read_path%"=="" set frame.to.read_path=& goto :rpucheckagainframe
if "%fileext1%"==".xml" if not "%frame.to.read_path%"=="" set frame.to.read_path=& goto :rpucheckagainframe
if exist "%output_path%scenes.txt" del "%output_path%scenes.txt"

:skipresizing
Setlocal DisableDelayedExpansion
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo \033[92m The script has been completed, press a key to start again...| "%cmdcolor%"& pause & set cmv4.0=n& exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: Metafier XML validation and extractor--------------------------------------------------------------------------------------------------------------------------------------------

:METAFIER
if /i "%same_input_output%"=="YES" set output_path=%filepath1%

set size=
:: check for raw input and skip demux
if /i "%fileext1%"==".xml" set XML="%filepath1%%filename1%%fileext1%"& goto :XML
if /i "%fileext1%"==".bin" set RPU="%filepath1%%filename1%%fileext1%"& goto :read
if /i "%fileext1%"==".hevc" set HDR="%filepath1%%filename1%%fileext1%"& goto :extract
if /i "%fileext1%"==".h265" set HDR="%filepath1%%filename1%%fileext1%"& goto :extract

::check for dual track dual layer p7 input
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul
for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[0].VideoCount "%TEMP%mediainfo.JSON"`) do set video.count=%%~a

rmdir /Q /S  "%letterpath%\JQ\" > nul

set size=--size %Width%x%Height%
if not "%fileext1%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename1%_rpu.bin"
set RPU="%output_path%%filename1%_rpu.bin"& goto :read

:skip.mkvextract
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DT=-map 0:1 
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename1%_rpu.bin" -
set RPU="%output_path%%filename1%_rpu.bin"& goto :read

:extract
"%dovi_tool_path%" extract-rpu %HDR% -o "%output_path%%filename1%_rpu.bin"
set RPU="%output_path%%filename1%_rpu.bin"

:read
set framereatechange=
echo "%filename1%" > "%TEMP%filename.txt"
findstr /c:"24FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=24.000
findstr /c:"25FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=25.000
findstr /c:"29FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=29.970
findstr /c:"30FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=30.000
findstr /c:"50FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=50.000
findstr /c:"59FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=59.940
findstr /c:"60FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=60.000

if "%framerate%"=="24.000" set framereatechange=--rate 24
if "%framerate%"=="25.000" set framereatechange=--rate 25
if "%framerate%"=="29.970" set framereatechange=--rate 30000/1001
if "%framerate%"=="30.000" set framereatechange=--rate 30
if "%framerate%"=="50.000" set framereatechange=--rate 50
if "%framerate%"=="59.940" set framereatechange=--rate 60000/1001
if "%framerate%"=="60.000" set framereatechange=--rate 60

:: convert to RPU to XML
"%RPU.to.XML%" convert %RPU% "%output_path%%filename1%_DV.xml" %framereatechange% %size%
set XML="%output_path%%filename1%_DV.xml"

:XML
"%metafier_path%" --validate %lift% %XML%

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:MODE.F
echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= VERIFY_SYNC (DoVi or HDR10plus)
echo 2) Workflow.2= REMOVER (DoVi or HDR10plus)
echo 3) Workflow.3= TRANSFER RPU level(s) and/or Scene cuts to another RPU
echo 4) Workflow.4= EXPORT Level 5 config file
echo 5) Workflow.5= EXPORT EDL timecodes file ^for Resolve
echo 6) Workflow.6= REMOVE Level 2 trims
echo 7) Workflow.7= Batch DoVi INFO...
echo 8) Workflow.8= Find scene cuts difference between two sources
echo 9) Workflow.9= Go back to the main menu...

echo.
choice /C:123456789 /M Choice?

if ERRORLEVEL 9 (
goto :Main.Menu
)

if ERRORLEVEL 8 (
goto :Workflow.8
)

if ERRORLEVEL 7 (
goto :Workflow.7
)

if ERRORLEVEL 6 (
goto :Workflow.6
)

if ERRORLEVEL 5 (
goto :Workflow.5
)

if ERRORLEVEL 4 (
goto :Workflow.4
)

if ERRORLEVEL 3 (
goto :Workflow.3
)

if ERRORLEVEL 2 (
goto :Workflow.2
)

if ERRORLEVEL 1 (
goto :Workflow.1
)


::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

::-----------------------------------------------------------------------------Scene cut-----------------------------------------------------------------------------------------------
:Workflow.1
::check sync 
:again6667
echo.
echo \033[36m          =============== | "%cmdcolor%"
echo \033[36m          - SCENE CUTS - | "%cmdcolor%"
echo \033[36m          =============== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow export all the scene cuts to a text file for sync verification
echo -- Quick mode: will export only the first 5 MIN
echo -- Full mode: will export all the scene cuts
echo -- Will make an avs script for avspmod(with indexing) unless the input is an RPU/json/xml
echo -- Input can be RPU/MKV/TS/M2TS/MP4/HEVC/H265/JSON/XML
echo -- Input can be a json HDR10plus file. If input has DV and HDR10plus, DV is prefered
echo -- Tutorial: https://youtu.be/lIO_ZfT-LnY^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

echo   Drag and drop your RPU/MKV/TS/M2TS/MP4/HEVC/H265 file and press enter... 
set /p video_path=

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename1=%%~ni
for %%i in (!video_path!) do set filepath1=%%~di%%~pi
for %%i in (!video_path!) do set fileext1=%%~xi
Setlocal DisableDelayedExpansion

set inputfrom1=n
:: make and set temp folder
if exist "%temp_folder%temp.folder9_new" if exist "%temp_folder%temp.folder9" rmdir /Q /S "%temp_folder%temp.folder9_new" & rmdir /Q /S "%temp_folder%temp.folder9"
if exist "%temp_folder%temp.folder9" set E1=_new
MD "%temp_folder%temp.folder9%E1%"
set TEMP=%temp_folder%temp.folder9%E1%\

:checksyncfrom1
if /i "%same_input_output%"=="YES" set output_path=%filepath1%
if /i "%fileext1%"==".bin" set RPU="%filepath1%%filename1%%fileext1%"& goto :RPU
if /i "%fileext1%"==".json" set Hplus=y& copy /y "%filepath1%%filename1%%fileext1%" "%TEMP%" & goto :skipsample
if /i "%fileext1%"==".xml" goto :skipsample

echo   Quick(q) or Full(s) scene cuts export^? (default=s)
echo.
echo --^> Quick= q
echo --^> Full= s
echo.
set /p export.type=
if /i "%export.type%"=="" set export.type=s
if /i "%export.type%"=="q" set export.type=q
if /i "%export.type%"=="s" set export.type=s
if not "%export.type%"=="s" if not "%export.type%"=="q" set export.type=s
if /i "%export.type%"=="q" goto :458989

"%mkvmerge_path%" --output ^"%TEMP%bl.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:00:23 > Nul
"%mediainfo_path%" "%TEMP%bl.mkv" --output=JSON > "%TEMP%mediainfo.JSON"

"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"

set DV=n&set Hplus=n
::check if BL has keywords in the filename1
echo "%filename1%" > "%TEMP%filename1.txt"
findstr /c:"FORCEHDR10PLUS" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set Hplus=y& goto :HDR10PLUS
echo "%filename1%" > "%TEMP%filename1.txt"
findstr /c:"forcehdr10plus" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set Hplus=y& goto :HDR10PLUS

findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y
findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y
findstr /c:"08" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y
findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 set Hplus=y

if /i "%raw%"=="y" if /i "%DV%"=="y" set DV="%filepath1%%filename1%%fileext1%"& goto :DEMUX
if /i "%DV%"=="y" goto :skipsample

:HDR10PLUS
if /i "%fileext1%"==".hevc" set raw=y 
if /i "%fileext1%"==".h265" set raw=y 

if /i "%raw%"=="y" (
	  "%hdr10plus_parser_path%" extract "%filepath1%%filename1%%fileext1%" -o "%TEMP%%filename1%.json"
      if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%hdr10plus_parser_path%" --skip-validation extract %HDR% -o "%TEMP%%filename1%.json"
	  copy /y "%TEMP%%filename1%.json" "%output_path%" > nul
	  goto :skipsample
)

if not "%fileext1%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
"%hdr10plus_parser_path%" extract "%TEMP%BL.hevc" -o "%TEMP%%filename1%.json"
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%hdr10plus_parser_path%"  --skip-validation extract "%TEMP%BL.hevc" -o "%TEMP%%filename1%.json"
copy /y "%TEMP%%filename1%.json" "%output_path%" > nul
goto :skipsample

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" extract -o "%TEMP%%filename1%.json" -
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" --skip-validation extract -o "%TEMP%%filename1%.json"  -
copy /y "%TEMP%%filename1%.json" "%output_path%" > nul

:skipsample
if /i "%inputfrom1%"=="y" if not "%DEL_temp%"=="NO" rmdir /Q /S "%TEMP%" & echo The script has been completed... & pause & exit

(
echo {
echo    "min_pq": 7,
echo    "max_pq": 3079,
echo	"remove_cmv4": true,
echo    "level6": {
echo        "max_display_mastering_luminance": 1000,
echo        "min_display_mastering_luminance": 50,
echo        "max_content_light_level": 0,
echo        "max_frame_average_light_level": 0
echo    }
echo }
) > "%TEMP%L6.json"

if "%fileext1%"==".xml" (
     "%dovi_tool_nofloor%" generate --xml "%filepath1%%filename1%%fileext1%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%%filename1%_XML_rpu.bin" > nul
	 set RPU="%TEMP%%filename1%_XML_rpu.bin"& goto :RPU
)

if exist "%TEMP%%filename1%.json" (
	 "%dovi_tool_nofloor%" generate --hdr10plus-json "%TEMP%%filename1%.json" --json "%TEMP%L6.json" --rpu-out "%TEMP%%filename1%_generated_rpu.bin" > nul
	 "%dovi_tool_path%" export -i "%TEMP%%filename1%_generated_rpu.bin" -d scenes="%output_path%%filename1%_Scenes_Cut_HDR10plus.txt"
	 goto :index
)

:skip.json
if not "%fileext1%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename1%_RPU.bin"
set RPU="%output_path%%filename1%_RPU.bin"& goto :RPU

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename1%_RPU.bin" -
set RPU="%output_path%%filename1%_RPU.bin"& goto :RPU

:DEMUX
"%dovi_tool_path%" extract-rpu %DV% -o "%output_path%%filename1%_RPU.bin"
set RPU="%output_path%%filename1%_RPU.bin"

:RPU
:: read edited rpu  (frame 100)
"%dovi_tool_path%" info --input %RPU% -f %frame.to.read_path%
"%dovi_tool_path%" info -s %RPU%
echo.
"%dovi_tool_path%" export -i %RPU% -d scenes="%output_path%%filename1%_Scenes_Cut_DoVi.txt"

:index
if /i "%fileext1%"==".bin" goto :END
if /i "%fileext1%"==".xml" goto :END
if /i "%fileext1%"==".json" goto :END

MD "%output_path%\%filename1%_script\"
::index files for accurate frame reading
"%ffmsindex%" "%filepath1%%filename1%%fileext1%" -f "%output_path%\%filename1%_script\%filename1%.ffindex"

:: Make avs script
echo LoadPlugin("%ffms2%") > "%output_path%\%filename1%_script\%filename1%_script.avs"
echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%output_path%\%filename1%_script\%filename1%.ffindex") >> "%output_path%\%filename1%_script\%filename1%_script.avs"

:END
:: delete TEMP files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
if exist "%output_path%\%filename1%_script\%filename1%.log" del "%output_path%\%filename1%_script\%filename1%.log"

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo \033[92mThe script has been completed, press a key to check another file...| "%cmdcolor%"

::run the scripts in avspmod
if not "%fileext1%"==".json" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" start "" "%AvsPmod_path%" "%output_path%%filename1%_script\%filename1%_script.avs"
if exist "%output_path%%filename1%_Scenes_Cut_HDR10plus.txt" "%output_path%%filename1%_Scenes_Cut_HDR10plus.txt"
if exist "%output_path%%filename1%_Scenes_Cut_DoVi.txt" "%output_path%%filename1%_Scenes_Cut_DoVi.txt"
pause & goto :again6667

:: ---------------------------------------------------------Quick export scene cuts-------------------------------------------------------------------------------------------------------------------------

::Quick export scene cuts
:458989
if "%fileext1%"==".bin" set RPU="%filepath1%%filename1%%fileext1%"& goto :RPU

echo Remuxing a 5min. sample...

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul

"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"

::check if BL has keywords in the filename1
echo "%filename1%" > "%TEMP%filename1.txt"
findstr /c:"FORCEHDR10PLUS" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set Hplus=y& goto :HDR10PLUS
findstr /c:"forcehdr10plus" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set Hplus=y& goto :HDR10PLUS

findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y
findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y
findstr /c:"08" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y
findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 set Hplus=y

if /i "%DV%"=="y" goto :skipHplus

:HDR10PLUS
"%ffmpeg_path%" -i "%TEMP%1.mkv" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" extract -o "%TEMP%%filename1%.json" -
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" --skip-validation extract -o "%TEMP%%filename1%.json"  -
(
echo {
echo    "min_pq": 7,
echo    "max_pq": 3079,
echo	"remove_cmv4": true,
echo    "level6": {
echo        "max_display_mastering_luminance": 1000,
echo        "min_display_mastering_luminance": 50,
echo        "max_content_light_level": 0,
echo        "max_frame_average_light_level": 0
echo    }
echo }
) > "%TEMP%L6.json"

"%dovi_tool_nofloor%" generate --hdr10plus-json "%TEMP%%filename1%.json" --json "%TEMP%L6.json" --rpu-out "%TEMP%%filename1%_generated_rpu.bin"
"%dovi_tool_path%" export -i "%TEMP%%filename1%_generated_rpu.bin" -d scenes="%output_path%%filename1%_Scenes_Cut.txt"
goto :index

:skipHplus

"%ffmpeg_path%" -i "%TEMP%1.mkv" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%TEMP%RPU.bin" -
set RPU="%TEMP%RPU.bin"

echo.
"%dovi_tool_path%" export -i %RPU% -d scenes="%output_path%%filename1%_Scenes_Cut.txt"

:index
MD "%output_path%\%filename1%_script\"

move "%TEMP%1.mkv" "%output_path%\%filename1%_script\" & rename "%output_path%\%filename1%_script\1.mkv" "%filename1%_sample.mkv"
::index files for accurate frame reading
"%ffmsindex%" "%output_path%\%filename1%_script\%filename1%_sample.mkv" -f "%output_path%\%filename1%_script\%filename1%.ffindex"

:: Make avs script
echo LoadPlugin("%ffms2%") > "%output_path%\%filename1%_script\%filename1%_V1_script.avs"
echo FFVideoSource("%output_path%\%filename1%_script\%filename1%_sample.mkv", cachefile="%output_path%\%filename1%_script\%filename1%.ffindex") >> "%output_path%\%filename1%_script\%filename1%_V1_script.avs" 

:: delete TEMP files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
if exist "%output_path%\%filename1%_script\%filename1%.log" del "%output_path%%filename1%_script\%filename1%.log"

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo the script has been completed, press a key to check another file...

::run the scripts in avspmod
start "" "%AvsPmod_path%" "%output_path%%filename1%_script\%filename1%_v1_script.avs"
if exist "%output_path%%filename1%_Scenes_Cut.txt" "%output_path%%filename1%_Scenes_Cut.txt"
pause & goto :again6667

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.2

echo.
echo \033[36m       ============= | "%cmdcolor%"
echo \033[36m       -  REMOVER  - | "%cmdcolor%"
echo \033[36m       ============= | "%cmdcolor%"
echo. 
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This script can remove HDR10plus or Dolby Vision metadata/layer
echo -- This process is lossless and can batch process a folder with files
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

echo Drag and drop a HDR10plus or DV file/folder and press enter...
set /p video_path=

:removefrom1
set batch.info=y
cd /d "%output_path%"
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %video_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if [%fileext1%]==[] (
     for %%i in (!video_path!) do set filename1=%%~ni
     for %%i in (!video_path!) do set filepath1=%%~di%%~pi
     for %%i in (!video_path!) do set fileext1=%%~xi
)

if /i "%same_input_output%"=="YES" set output_path=%filepath1%& cd /d "%filepath1%"
if  /i "%removefromone%"=="y" set whattodo=d& goto :LOOP_REMOVER

echo.
echo Do want to remove Dolby Vision(d) or HDR10plus(h) ^? (default=d)
echo.
echo --^> DV= d 
echo --^> HDR10plus= h
echo.
set /p whattodo=
if  "%whattodo%"=="" set whattodo=d
if /i "%whattodo%"=="d" set whattodo=d
if /i "%whattodo%"=="h" set whattodo=h
if not "%whattodo%"=="h" if not "%whattodo%"=="d" set whattodo=d

::=========================================================================================================================================
::--------------------------------------------------loop--------------------------------------------------------------------------------------------------------------------------
::=========================================================================================================================================

:LOOP_REMOVER
:: make and set temp folder
if exist "%temp_folder%temp.folder32" rmdir /Q /S "%temp_folder%temp.folder32"
MD "%temp_folder%temp.folder32"
set TEMP=%temp_folder%temp.folder32\
echo.
echo Processing "%filename1%%fileext1%"
set raw=n
if /i "%fileext1%"==".hevc" set raw=y
if /i "%fileext1%"==".h265" set raw=y

set job=job.2.2
if "%raw%"=="y" set HDR="%filepath1%%filename1%%fileext1%"& goto :job.2.2
goto :tracks.info
:job.2.2

:: make small mkv remux in case input is raw hevc.
"%mkvmerge_path%" --output ^"%TEMP%meta.sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:00:05> Nul
"%mediainfo_path%" "%TEMP%meta.sample.mkv" --output=JSON > "%TEMP%mediainfo.JSON"

if /i "%whattodo%"=="d" goto :removefrom1

echo.
::=============================================================================================================
::==============================REMOVE HDR10plus=============================================================
::=============================================================================================================

set Hplus=n
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR.txt"
findstr /m "2094" "%TEMP%check.HDR.txt" >Nul
if %errorlevel%==0 set Hplus=y
if /i  "%Hplus%"=="n" echo Input doesnt have HDR10plus, skipping file... & goto :job2.2.done
	
if "%raw%"=="y" "%hdr10plus_parser_path%" remove -i "%filepath1%%filename1%%fileext1%" -o "%output_path%%filename1%_HDR10plus_removed.hevc" & set HDR="%output_path%%filename1%_HDR10plus_removed.hevc"& goto :job2.2.done

if not "%fileext1%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
echo.
echo Removing HDR10plus...
"%hdr10plus_parser_path%" remove -i "%TEMP%BL.hevc" -o "%output_path%%filename1%_HDR10plus_removed.hevc"
set HDR="%output_path%%filename1%_HDR10plus_removed.hevc"
goto :MUXER

:skip.mkvextract
echo.
echo Removing HDR10plus...
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" remove -o "%output_path%%filename1%_HDR10plus_removed.hevc" -
set HDR="%output_path%%filename1%_HDR10plus_removed.hevc"
if not "%raw%"=="y" goto :MUXER

::=============================================================================================================
::==============================REMOVE DV====================================================================
::=============================================================================================================
:removefrom1
set DV.input=n
"%JQ_path%" ".media.track[1].HDR_Format_Profile" "%TEMP%mediainfo.JSON" | findstr /i "08 07 04" >nul && set "DV.input=y"
if /i  "%DV.input%"=="n" echo Input is not Profile 7 nor Profile 8 Dolby Vision, skipping file... & goto :job2.2.done

if "%raw%"=="y" "%dovi_tool_path%" demux -i "%filepath1%%filename1%%fileext1%" & goto :done

if not "%fileext1%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
echo.
echo Removing Dolby Vision...
"%dovi_tool_path%" demux -i "%TEMP%BL.hevc"
goto :done

:skip.mkvextract
echo.
echo Removing Dolby Vision...
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -

:done
rename "%output_path%EL.hevc" "%filename1%_EL_(DV_you_can_delete).hevc"
rename "%output_path%BL.hevc" "%filename1%_DV.removed.hevc"
set HDR="%output_path%%filename1%_DV.removed.hevc"
if not "%raw%"=="y" goto :MUXER

:job2.2.done

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)

set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set p7_bl=& set p5_bl=& set dropH=& set mlp=& set dts=& set pcm.au=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set trims=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set dv.profile=
set final.vid=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=
set upal2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :LOOP_REMOVER
)
setlocal disabledelayedexpansion

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:transferlevelfrom1
rmdir /Q /S "%TEMP%"
set din=y& set rpu=%video_path%

:Workflow.3
:copyagain1
::transfer rpu levels
echo.
echo \033[36m        ===================== | "%cmdcolor%"
echo \033[36m        - TRANSFER LEVEL(S) - | "%cmdcolor%"
echo \033[36m        ===================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow can transfer the metadata level(s) from one rpu to another
echo -- You can select multiple levels but some combinations might not work. 
echo -- No space between the selections, EG: use 12389 and not 1 2 3 8 9 
echo -- Can also transfer scene cuts
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

if /i "%din%"=="y" goto :skipinputfrom1
::user input
echo   Drag and drop the DV file you want to edit the metadata level(s) and press enter...& set /p rpu=
echo.

:skipinputfrom1
::user input
echo   Drag and drop the DV file source you want to get the metadata from and press enter...& set /p source=
echo.
::user input
echo  (Choices are s 1234568911  and you can select multiple values but no space between them)
echo  Which RPU level(s) or Scene Cuts (s) ^do you want to transfer^?

set /p level=
if [%level%]==[] set level=389
if /i "%level%"=="s" set level=s
echo.

:: make and set temp folder
if exist "%temp_folder%temp.folder12_new" if exist "%temp_folder%temp.folder12" rmdir /Q /S "%temp_folder%temp.folder12_new" & rmdir /Q /S "%temp_folder%temp.folder12"
if exist "%temp_folder%temp.folder12" set E1=_new
MD "%temp_folder%temp.folder12%E1%"
set TEMP=%temp_folder%temp.folder12%E1%\

::resync
echo   Do you have to re-sync the metadata to be transfered^? ^If yes, enter a frame number. E.G.: -24 or 24 and/or press enter...& set /p delay8=
if [%delay8%]==[] set delay8=n& goto :skip.resync
if /i "%delay8%"=="n" set delay8=n& goto :skip.resync
if /i "%delay8%"=="no" set delay8=n& goto :skip.resync
if /i "%delay8%"=="o" set delay8=n& goto :skip.resync
if /i "%delay8%"=="0" set delay8=n& goto :skip.resync

set resync=d
set dup=%delay8%
for %%i in (%delay8%) do set delay.name=%%~ni
echo %delay.name% > "%TEMP%delay.name.txt"
findstr /c:"-" "%TEMP%delay.name.txt" >Nul
if %errorlevel%==0 set resync=r& set rem=%delay8:-=%

:skip.resync
:: make variable of path, filename and extension. only input with "!" wont work.
Setlocal EnableDelayedExpansion
for %%i in (!rpu!) do set filename=%%~ni
for %%i in (!rpu!) do set filepath=%%~di%%~pi
for %%i in (!rpu!) do set fileext=%%~xi
for %%i in (!source!) do set filename2=%%~ni
for %%i in (!source!) do set filepath2=%%~di%%~pi
for %%i in (!source!) do set fileext2=%%~xi
Setlocal DisableDelayedExpansion
set rpuext="%filepath2%%filename2%%fileext2%"
set RPU="%filepath%%filename%%fileext%"

if /i "%fileext%"==".bin" goto :skipin1

::-----------------------------------------input one video----------------------------------------------

if not "%fileext%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename%_RPU.bin"
set RPU="%output_path%%filename%_RPU.bin"& goto :skipdemux

:skip.mkvextract
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DT=-map 0:1

"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename%_RPU.bin" -
set RPU="%output_path%%filename%_RPU.bin"

:skipdemux
set filename=%filename%_RPU
set filepath=%output_path%
set fileext=.bin

:skipin1
if /i "%fileext2%"==".bin" set rpuinput2=y& goto :skipin2
::-----------------------------------------input two video----------------------------------------------

if not "%fileext2%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract2
"%mkvextract_path%" "%filepath2%%filename2%%fileext2%" tracks 0:"%TEMP%BL2.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL2.hevc" -o "%output_path%%filename2%_RPU.bin"
set rpuext="%output_path%%filename2%_RPU.bin"& goto :skipdemux2

:skip.mkvextract2
"%mediainfo_path%" "%filepath2%%filename2%%fileext2%" --output=JSON > "%TEMP%mediainfo2.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo2.JSON" > "%TEMP%video.count2.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count2.txt"') do (
    set "video.count2=%%a"
)
set video.count2=%video.count2:~1,-1%
if "%video.count2%"=="2" set DT2=-map 0:1

"%ffmpeg_path%" -i "%filepath2%%filename2%%fileext2%" %DT2% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename2%_RPU.bin" -
set rpuext="%output_path%%filename2%_RPU.bin"

:skipdemux2
set filename2=%filename2%_RPU
set filepath2=%output_path%
set fileext2=.bin

:skipin2
if "%delay8%"=="n" goto :skipresync
if "%resync%"=="d" goto :duplicate
::------------------------------------------rem 1----------------------------------------------------------

::resync one
:remove
echo { > "%TEMP%edits.json"
echo    "remove": [ >> "%TEMP%edits.json"
echo        "1-%rem%" >> "%TEMP%edits.json"
echo    ] >> "%TEMP%edits.json"
echo } >> "%TEMP%edits.json"
echo.
echo \033[92m Removing frame 1 to %rem%...| "%cmdcolor%"
goto :resync1

::--------------------------------------------dup 1--------------------------------------------------------
:duplicate
echo { > "%TEMP%edits.json"
echo 	"duplicate": [ >> "%TEMP%edits.json"
echo 		{ >> "%TEMP%edits.json"
echo 			"source": 1, >> "%TEMP%edits.json"
echo 			"offset": 1, >> "%TEMP%edits.json"
echo 			"length": %dup% >> "%TEMP%edits.json"
echo 		} >> "%TEMP%edits.json"
echo 	] >> "%TEMP%edits.json"
echo } >> "%TEMP%edits.json"
echo.
echo \033[92mDuplicating frame one, %dup% times...| "%cmdcolor%"

:resync1
"%dovi_tool_path%" editor -i %rpuext% -j "%TEMP%edits.json" --rpu-out "%TEMP%%filename2%_verify_sync1.bin" > nul
echo Done.
set rpuext="%TEMP%%filename2%_verify_sync1.bin"
set filepath2=%TEMP%
set RS=_verify_sync1
::-------------------------------------------framecount--------------------------------------------------------

:skipresync

::resync two (match framecount)
"%dovi_tool_path%" info -s "%filepath%%filename%%fileext%" > "%TEMP%source.rpu.json"
"%dovi_tool_path%" info -s %rpuext% > "%TEMP%ext.rpu.json"
type "%TEMP%source.rpu.json" | findstr Frames: > "%TEMP%sourceframecount.txt"
type "%TEMP%ext.rpu.json" | findstr Frames: > "%TEMP%extframecount.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%sourceframecount.txt"') do (
    set "sourceframecount=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%extframecount.txt"') do (
    set "extframecount=%%a"
)

if "%sourceframecount%"=="%extframecount%" (
    if not "%delay8%"=="n" if /i "%keep_rpu%"=="YES" copy /y %rpuext% "%output_path%" > nul
    goto :skipresync2
)
set /a framecount.diff=%sourceframecount% - %extframecount%

for %%i in (%framecount.diff%) do set math=%%~ni
echo %math% > "%TEMP%math.txt"
findstr /c:"-" "%TEMP%math.txt" >Nul
if %errorlevel%==0 (
    set substract=y& set math=-
    ) else (
    set addition=y& set math=+
)
set framecountadjust=y
if "%addition%"=="y" goto :duplicate2

::-----------------------------------------------rem 2-----------------------------------------------------
:: removes frame at the end
:remove2
set framecount.diff=%framecount.diff:-=%
set /a tosubstract=%extframecount% - %framecount.diff%
set /a extframecount=%extframecount% - 1

echo { > "%TEMP%edits2.json"
echo    "remove": [ >> "%TEMP%edits2.json"
echo        "%tosubstract%-%extframecount%" >> "%TEMP%edits2.json"
echo    ] >> "%TEMP%edits2.json"
echo } >> "%TEMP%edits2.json"
echo.
echo \033[92m Removing frame %tosubstract% to %extframecount%...| "%cmdcolor%"
goto :resync2

::----------------------------------------------dup 2-----------------------------------------------------
::duplicate frames at the end
:duplicate2
set framecount.diff=%framecount.diff:-=%
set /a extframecount=%extframecount% - 1
echo { > "%TEMP%edits2.json"
echo 	"duplicate": [ >> "%TEMP%edits2.json"
echo 		{ >> "%TEMP%edits2.json"
echo 			"source": %extframecount%, >> "%TEMP%edits2.json"
echo 			"offset": %extframecount%, >> "%TEMP%edits2.json"
echo 			"length": %framecount.diff% >> "%TEMP%edits2.json"
echo 		} >> "%TEMP%edits2.json"
echo 	] >> "%TEMP%edits2.json"
echo } >> "%TEMP%edits2.json"
echo.
echo \033[92mDuplicating frame %extframecount%, %framecount.diff% times...| "%cmdcolor%"
:resync2
"%dovi_tool_path%" editor -i %rpuext% -j "%TEMP%edits2.json" --rpu-out "%TEMP%%filename2%_verify_sync2.bin" > nul
echo Done.
set rpuext="%TEMP%%filename2%_verify_sync2.bin"
set RS=_verify_sync2
set filepath2=%TEMP%
if /i "%keep_rpu%"=="YES" copy /y %rpuext% "%output_path%" > nul

:skipresync2

if /i "%rpuinput2%"=="y" if not "%framecountadjust%"=="y" if "%delay8%"=="n"  copy /y %rpuext% "%output_path%" > nul
::--------------------------------------------transfer------------------------------------------------------------

set L11=n& set L22=n& set L33=n& set L44=n& set L55=n& set L66=n& set L88=n& set L99=n& set L11=n& set scenecuts=n
echo %level% > "%TEMP%level.txt"
findstr /m "1" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L11=y& set L111=L1
findstr /m "2" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L22=y& set L222=L2
findstr /m "5" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L55=y& set L555=L5
findstr /m "3" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L33=y& set L333=L3
findstr /m "4" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L44=y& set L444=L4
findstr /m "6" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L66=y& set L666=L6
findstr /m "8" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L88=y& set L888=L8
findstr /m "9" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L99=y& set L999=L9
findstr /m "11" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set L111=y& set L1111=L11
findstr /m "s" "%TEMP%level.txt" >Nul
if %errorlevel%==0 set scenecuts=y

if "%L11%"=="n" if "%L22%"=="n" if "%L33%"=="n" if "%L44%"=="n" if "%L55%"=="n" if "%L66%"=="n" if "%L88%"=="n" if "%L99%"=="n" if "%L11%"=="n" goto :scenecuts
if "%L11%"=="y" set L1=1
if "%L22%"=="y" set L1=2
if "%L33%"=="y" set L1=3
if "%L44%"=="y" set L1=4
if "%L55%"=="y" set L1=5
if "%L66%"=="y" set L1=6
if "%L88%"=="y" set L1=8
if "%L99%"=="y" set L1=9
if "%L111%"=="y" set L1=11
if "%L11%"=="y" if "%L22%"=="y" set L1=1, 2
if "%L11%"=="y" if "%L33%"=="y" set L1=1, 3
if "%L11%"=="y" if "%L44%"=="y" set L1=1, 4
if "%L11%"=="y" if "%L55%"=="y" set L1=1, 5
if "%L11%"=="y" if "%L66%"=="y" set L1=1, 6
if "%L11%"=="y" if "%L88%"=="y" set L1=1, 8
if "%L11%"=="y" if "%L99%"=="y" set L1=1, 9
if "%L22%"=="y" if "%L33%"=="y" set L1=2, 3
if "%L22%"=="y" if "%L44%"=="y" set L1=2, 4
if "%L22%"=="y" if "%L55%"=="y" set L1=2, 5
if "%L22%"=="y" if "%L66%"=="y" set L1=2, 6
if "%L22%"=="y" if "%L88%"=="y" set L1=2, 8
if "%L22%"=="y" if "%L99%"=="y" set L1=2, 9
if "%L33%"=="y" if "%L44%"=="y" set L1=3, 4
if "%L33%"=="y" if "%L55%"=="y" set L1=3, 5
if "%L33%"=="y" if "%L66%"=="y" set L1=3, 6
if "%L33%"=="y" if "%L88%"=="y" set L1=3, 8
if "%L33%"=="y" if "%L99%"=="y" set L1=3, 9
if "%L44%"=="y" if "%L55%"=="y" set L1=4, 5
if "%L44%"=="y" if "%L66%"=="y" set L1=4, 6
if "%L44%"=="y" if "%L88%"=="y" set L1=4, 8
if "%L44%"=="y" if "%L99%"=="y" set L1=4, 9
if "%L55%"=="y" if "%L66%"=="y" set L1=5, 6
if "%L55%"=="y" if "%L88%"=="y" set L1=5, 8
if "%L55%"=="y" if "%L99%"=="y" set L1=5, 9
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" set L1=1, 2, 3
if "%L11%"=="y" if "%L22%"=="y" if "%L44%"=="y" set L1=1, 2, 4
if "%L11%"=="y" if "%L22%"=="y" if "%L55%"=="y" set L1=1, 2, 5
if "%L11%"=="y" if "%L22%"=="y" if "%L66%"=="y" set L1=1, 2, 6
if "%L11%"=="y" if "%L22%"=="y" if "%L88%"=="y" set L1=1, 2, 8
if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" set L1=2, 3, 4
if "%L22%"=="y" if "%L33%"=="y" if "%L55%"=="y" set L1=2, 3, 5
if "%L22%"=="y" if "%L33%"=="y" if "%L88%"=="y" set L1=2, 3, 8
if "%L22%"=="y" if "%L44%"=="y" if "%L55%"=="y" set L1=2, 4, 5
if "%L22%"=="y" if "%L44%"=="y" if "%L88%"=="y" set L1=2, 4, 8
if "%L22%"=="y" if "%L55%"=="y" if "%L88%"=="y" set L1=2, 5, 8
if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" set L1=3, 4, 5
if "%L33%"=="y" if "%L44%"=="y" if "%L88%"=="y" set L1=3, 4, 8
if "%L44%"=="y" if "%L55%"=="y" if "%L88%"=="y" set L1=4, 5, 8
if "%L33%"=="y" if "%L88%"=="y" if "%L99%"=="y" set L1=3, 8, 9
if "%L22%"=="y" if "%L33%"=="y" if "%L88%"=="y" if "%L99%"=="y" set L1=2, 3, 8, 9
if "%L33%"=="y" if "%L88%"=="y" if "%L99%"=="y" if "%L111%"=="y" set L1=3, 8, 9, 11
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" set L1=1, 2, 3, 4
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L55%"=="y" set L1=1, 2, 3, 5
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L88%"=="y" set L1=1, 2, 3, 8
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L99%"=="y" set L1=1, 2, 3, 9
if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" set L1=2, 3, 4, 5
if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L88%"=="y" set L1=2, 3, 4, 8
if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" if "%L88%"=="y" set L1=3, 4, 5, 8
if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" if "%L99%"=="y" set L1=3, 4, 5, 9
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" set L1=1, 2, 3, 4, 5
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L88%"=="y" set L1=1, 2, 3, 4, 8
if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" if "%L88%"=="y" set L1=2, 3, 4, 5, 8
if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" if "%L99%"=="y" set L1=2, 3, 4, 5, 9
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L88%"=="y" if "%L99%"=="y" set L1=1, 2, 3, 8, 9
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L55%"=="y" if "%L88%"=="y" if "%L99%"=="y" set L1=1, 2, 3, 5, 8, 9
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" if "%L88%"=="y" if "%L99%"=="y" set L1=1, 2, 3, 4, 5, 8, 9
if "%L11%"=="y" if "%L22%"=="y" if "%L33%"=="y" if "%L44%"=="y" if "%L55%"=="y" if "%L66%"=="y" if "%L88%"=="y" if "%L99%"=="y" set L1=1, 2, 3, 4, 5, 6, 8, 9

cd /d %filepath2%
(
echo {
echo 	"allow_cmv4_transfer": true,
echo 	"source_rpu": "%filename2%%RS%.bin",
echo 	"rpu_levels": [%L1%]
echo }
) > "%TEMP%transfer.json"
echo.
echo \033[92mTransferring metadata level %level% from %filename2% to %filename%...| "%cmdcolor%"
echo.
"%dovi_tool_path%" editor -i "%filepath%%filename%%fileext%" -j "%TEMP%transfer.json" --rpu-out "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered.bin"
set RPU="%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered.bin"

if /i "%scenecuts%"=="n" "%dovi_tool_path%" export -i "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered.bin" -d scenes="%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered_scene_cuts.txt" > nul
if /i "%scenecuts%"=="n" if exist "%output_path%%filename2%%RS%.bin" "%dovi_tool_path%" export -i "%output_path%%filename2%%RS%.bin" -d scenes="%output_path%%filename2%%RS%_scene_cuts.txt" > nul
if /i "%scenecuts%"=="n" if exist "%output_path%%filename2%%RS%.bin" if exist "%~dp0tools\Scene_Cut_Difference.py" python "%~dp0tools\Scene_Cut_Difference.py" -i "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered_scene_cuts.txt"  -i "%output_path%%filename2%%RS%_scene_cuts.txt" -o "%output_path%Scene_Cuts_Difference.txt" > nul
if /i "%scenecuts%"=="n" "%dovi_tool_path%" plot "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered.bin"  -t "Dolby Vision Level 1 Plot"  -o "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered_DoVi_L1_plot.png"
if /i "%scenecuts%"=="n" if exist "%output_path%%filename2%%RS%.bin" "%dovi_tool_path%" plot "%output_path%%filename2%%RS%.bin"  -t "Dolby Vision Level 1 Plot"  -o "%output_path%%filename2%%RS%_DoVi_L1_plot.png"

cd /d "%output_path%"
:scenecuts
if /i "%scenecuts%"=="n" goto :end
if not exist "%~dp0tools\transfer_scenecuts.py" echo \033[31m transfer_scenecuts.py is missing from your tools folder, cant transfer scene cuts. Update your tools folder...| "%cmdcolor%" & pause & exit
::remove 1 from rpu framecount
set /a sourceframecount=%sourceframecount%-1
::make reset scene cut json
(
echo {
echo     "scene_cuts": {
echo         "0-%sourceframecount%": false
echo     }
echo }
) > "%TEMP%reset scenecuts.json"
echo.
echo \033[92mResetting RPU 1 scene cuts to none...| "%cmdcolor%"
::reset scene cuts from rpu to edit
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%reset scenecuts.json" --rpu-out "%TEMP%scenecuts.reset.bin" >Nul
echo Done.
echo.
echo \033[92mExporting RPU 2 scene cuts...| "%cmdcolor%"
::export scene cuts source
"%dovi_tool_path%" export -i %rpuext% -d scenes="%TEMP%SceneCuts.source.txt" >Nul
echo Done.
echo.
:: create scene cuts edit json
python "%~dp0tools\transfer_scenecuts.py" -i "%TEMP%SceneCuts.source.txt" -o "%output_path%SceneCuts_edit.json"
echo \033[92mReplacing RPU 1 scene cuts by RPU 2 scene cuts...| "%cmdcolor%"
:: edit rpu scene cuts with 2nd rpu
"%dovi_tool_path%" editor -i "%TEMP%scenecuts.reset.bin" -j "%output_path%SceneCuts_edit.json" --rpu-out "%output_path%%filename%%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_SceneCuts_transfered.bin"
if exist "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered.bin" del "%output_path%%filename%_%CMV%%L111%%L222%%L333%%L444%%L555%%L666%%L888%%L999%_transfered.bin"

:end
echo Done.
echo.
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.4
::export l5 config
echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - L5 CONFIG - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow just export a Level 5 active area config json file
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
::check if required python script is present in tools folder
if not exist "%~dp0tools\fix.L5.config.py" echo \033[31m "fix.L5.config.py" is missing from the tools folder, update your tools folder. Update it...| "%cmdcolor%"& pause & exit
::user input
echo   Drag and drop a file and press enter...& set /p input=
echo.

:: make variable of path, filename and extension. only input with "!" wont work.
Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

:: make and set temp folder
if exist "%temp_folder%temp.folder14_new" rmdir /Q /S "%temp_folder%temp.folder14_new"
if exist "%temp_folder%temp.folder14" set E1=_new
MD "%temp_folder%temp.folder14%E1%"
set TEMP=%temp_folder%temp.folder14%E1%\

if /i "%fileext%"==".hevc" (
      "%dovi_tool_path%" extract-rpu "%filepath%%filename%%fileext%" -o "%output_path%%filename%_rpu.bin"
	  set RPU="%output_path%%filename%_rpu.bin"& goto :read
)
if /i "%fileext%"==".h265" (
      "%dovi_tool_path%" extract-rpu "%filepath%%filename%%fileext%" -o "%output_path%%filename%_rpu.bin"
	  set RPU="%output_path%%filename%_rpu.bin"& goto :read
)
if /i "%fileext%"==".bin" set RPU="%filepath%%filename%%fileext%"& goto :read
if /i "%fileext%"==".xml" (
      "%dovi_tool_path%" generate --xml "%filepath%%filename%%fileext%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%rpu.bin"
       set RPU="%TEMP%rpu.bin"& goto :read
)

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2

if not "%fileext%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename%_RPU.bin"
set RPU="%output_path%%filename%_RPU.bin"
goto :read

:skip.mkvextract
if "%video.count%"=="2" set DT=-map 0:1
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename%_RPU.bin" -
set RPU="%output_path%%filename%_RPU.bin"

:read
"%dovi_tool_path%" export -i %RPU% -d level5="%TEMP%l5.config.raw.json"
python "%~dp0tools\fix.L5.config.py" -i "%TEMP%l5.config.raw.json" -o "%output_path%%filename%_L5_config.json" >Nul
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.5
:: Export EDL file from dynamic metadata
echo.
echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - EDL MAKER - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This script export a timecode EDL file ^for Resolve from DV or HDR10plus source
echo -- Requires Dolby Metafier
echo -- Input can be XML/RPU/MKV/M2TS/TS/MP4/HEVC/JSON
echo -- If input is not a video, the script assume it's 23.976 unless you add in the filename: '24FPS' '25FPS' '60FPS'
echo -- Tutorial: https://youtu.be/KVx01kCLLS8^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

:: user input
set /p input="Drag and drop a DoVi file and press enter..."
echo.
echo   Do you want to re-sync the metadata^? ^If yes, enter a frame number. E.G.: -24 or 24 and/or press enter...(default = no resync)& set /p delay8=
if [%delay8%]==[] set delay8=& goto :skip.resync
if /i "%delay8%"=="n" set delay8=& goto :skip.resync
if /i "%delay8%"=="no" set delay8=& goto :skip.resync
if /i "%delay8%"=="o" set delay8=& goto :skip.resync
if "%delay8%"=="0" set delay8=& goto :skip.resync

set resync=d
set dup=%delay8%
for %%i in (%delay8%) do set delay.name=%%~ni
echo %delay.name% > "%TEMP%delay.name.txt"
findstr /c:"-" "%TEMP%delay.name.txt" >Nul
if %errorlevel%==0 set resync=r& set rem=%delay8:-=%

:skip.resync

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

if /i "%same_input_output%"=="YES" set output_path=%filepath%

:: make and set temp folder
if exist "%temp_folder%temp.folder15_new" rmdir /Q /S "%temp_folder%temp.folder15_new"
if exist "%temp_folder%temp.folder15" set E1=_new
MD "%temp_folder%temp.folder15%E1%"
set TEMP=%temp_folder%temp.folder15%E1%\

set framerate=23.976
:: check for raw input and skip demux
if /i "%fileext%"==".hevc" set HDR="%filepath%%filename%%fileext%"& goto :extract
if /i "%fileext%"==".h265" set HDR="%filepath%%filename%%fileext%"& goto :extract
if /i "%fileext%"==".xml" set XML="%filepath%%filename%%fileext%"& goto :XML
if /i "%fileext%"==".bin" set RPU="%filepath%%filename%%fileext%"& goto :read
if /i "%fileext%"==".json" set JSON="%filepath%%filename%%fileext%"& goto :json

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"

findstr /c:"dvhe" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set DV=y

::check for dual track dual layer p7 input
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul

for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[0].VideoCount "%TEMP%mediainfo.JSON"`) do set video.count=%%~a

rmdir /Q /S  "%letterpath%\JQ\" > nul

if /i "%DV%"=="y" goto :skipHDR10plus

if not "%fileext%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%hdr10plus_parser_path%" extract "%TEMP%BL.hevc" -o "%output_path%%filename%_hdr10plus.json"
set JSON="%output_path%%filename%_hdr10plus.json"
goto :json

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" extract -o "%output_path%%filename%_hdr10plus.json" -
set JSON="%output_path%%filename%_hdr10plus.json"& goto :json

:skipHDR10plus
if not "%fileext%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename%_rpu.bin"
set RPU="%output_path%%filename%_rpu.bin"
goto :read

:skip.mkvextract
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DT=-map 0:1 
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename%_rpu.bin" -
set RPU="%output_path%%filename%_rpu.bin"& goto :read

:extract
"%dovi_tool_path%" extract-rpu %HDR% -o "%output_path%%filename%_rpu.bin"
set RPU="%output_path%%filename%_rpu.bin"& goto :read

:json
echo { > "%TEMP%L66.json"
echo    "min_pq": 3079, >> "%TEMP%L66.json"
echo    "max_pq": 7, >> "%TEMP%L66.json"
echo	"remove_cmv4": true, >> "%TEMP%L66.json"
echo    "level6": { >> "%TEMP%L66.json"
echo        "max_display_mastering_luminance": 1000, >> "%TEMP%L66.json"
echo        "min_display_mastering_luminance": 50, >> "%TEMP%L66.json"
echo        "max_content_light_level": 0, >> "%TEMP%L66.json"
echo        "max_frame_average_light_level": 0 >> "%TEMP%L66.json"
echo    } >> "%TEMP%L66.json"
echo } >> "%TEMP%L66.json"

"%dovi_tool_path%" generate --hdr10plus-json %JSON% --json "%TEMP%L66.json" --rpu-out "%TEMP%rpu.hdr10plus.bin" >Nul
set RPU="%TEMP%rpu.hdr10plus.bin"

:read

:: check if the script has to resync
if /i "%resync%"=="r" goto :REMOVE
if /i "%resync%"=="d" goto :DUPLICATE
goto :skip.resync

:REMOVE
::generate remove frames json
echo { > "%TEMP%remove.json"
echo    "remove": [ >> "%TEMP%remove.json"
echo        "1-%rem%" >> "%TEMP%remove.json"
echo    ] >> "%TEMP%remove.json"
echo } >> "%TEMP%remove.json"
echo.
echo \033[92mRemoving frame 1 to %rem%... | "%cmdcolor%"
:: remove frames
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%remove.json" --rpu-out "%TEMP%%filename%_%rem%_frames_removed.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%%filename%_%rem%_frames_removed.bin"
echo Done.
goto :skip.resync

:DUPLICATE
::generate duplicate frames json
echo { > "%TEMP%duplicate.json"
echo 	"duplicate": [ >> "%TEMP%duplicate.json"
echo 		{ >> "%TEMP%duplicate.json"
echo 			"source": 1, >> "%TEMP%duplicate.json"
echo 			"offset": 1, >> "%TEMP%duplicate.json"
echo 			"length": %dup% >> "%TEMP%duplicate.json"
echo 		} >> "%TEMP%duplicate.json"
echo 	] >> "%TEMP%duplicate.json"
echo } >> "%TEMP%duplicate.json"
echo.
echo  \033[92mDuplicating frame one: %dup% times...  | "%cmdcolor%"
:: duplicates frames
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%duplicate.json" --rpu-out "%TEMP%%filename%_%dup%_frames_duplicated.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%%filename%_%dup%_frames_duplicated.bin"
echo Done.

:skip.resync

:: convert to RPU to XML
"%RPU.to.XML%" convert %RPU% "%TEMP%%filename%.xml" >Nul
set XML="%TEMP%%filename%.xml"

:XML

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

if "%FPS%"=="24.000" set framerate=24.000
if "%FPS%"=="25.000" set framerate=25.000
if "%FPS%"=="29.970" set framerate=29.970
if "%FPS%"=="30.000" set framerate=30.000
if "%FPS%"=="50.000" set framerate=50.000
if "%FPS%"=="59.940" set framerate=59.940
if "%FPS%"=="60.000" set framerate=60.000

::check if BL has keywords in the filename
echo "%filename%" > "%TEMP%filename.txt"
findstr /c:"24FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=24.000
findstr /c:"25FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=25.000
findstr /c:"60FPS" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set framerate=59.940

"%metafier_path%" --shot-list-duration "%TEMP%shotlist.duration.txt" %XML% >Nul
python "%~dp0tools\EDL_maker.py" -i "%TEMP%shotlist.duration.txt" -o "%output_path%%filename%.edl" -f %framerate%

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

::---------------------------------------------------------remove L2------------------------------------------------------------------------------------
:Workflow.6

echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - REMOVE L2 - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow just overwrites or removes Level 2 trims
echo -- trims to remove can be configured at line 282-286
echo -- Profile 5 input trims can  be overwritten only
echo -- input can be RPU/XML/MKV/M2TS/TS/MP4/HEVC
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
::user input
echo   Drag and drop your file and press enter...
set /p video_path=

echo   Do you want to remove(r) or overwrite(o) Level 2^? (Default= r)
echo.
echo --^> Remove= r 
echo --^> Overwrite= o
echo.
set /p action=
if [%action%]==[] set action=r
if /i "%action%"=="r" set action=r
if /i "%action%"=="o" set action=o
if /i "%action%"=="remove" set action=r
if /i "%action%"=="overwrite" set action=o
if not "%action%"=="r" if not "%action%"=="o" set action=r

if /i "%remove_1000%"=="NO" if /i "%remove_600%"=="NO" if /i "%remove_100%"=="NO" set remove_100=YES& set remove_600=YES& set remove_1000=YES

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

:: make and set temp folder
if exist "%temp_folder%temp.folder5_new" if exist "%temp_folder%temp.folder5" rmdir /Q /S "%temp_folder%temp.folder5_new" & rmdir /Q /S "%temp_folder%temp.folder5"
if exist "%temp_folder%temp.folder5" set E1=_new
MD "%temp_folder%temp.folder5%E1%"
set TEMP=%temp_folder%temp.folder5%E1%\

if /i "%same_input_output%"=="YES" set output_path=%filepath%

if /i "%fileext%"==".hevc" set container=none& set MUX=NO& set HDR="%filepath%%filename%%fileext%"& goto :skip
if /i "%fileext%"==".h265" set container=none& set MUX=NO& set HDR="%filepath%%filename%%fileext%"& goto :skip
if /i "%fileext%"==".bin" set container=none& set MUX=NO& set RPU="%filepath%%filename%%fileext%"& goto :read
if /i "%fileext%"==".xml" set container=none& set MUX=NO& set XML="%filepath%%filename%%fileext%"& goto :XML

if /i "%encode_DDP%"=="NO" goto :skip1
if /i "%container%"=="MP4" goto :skip1

:: check if lossless audio present, if not skip the user prompt.
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Audio;%%Format%% --LogFile="%TEMP%audio.format.txt" >Nul
findstr /c:"MLP" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm.au=n
if "%mlp%"=="n" if "%dts%"=="n"  if "%pcm.au%"=="n" goto :skip1
echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
:: check audio tracks info
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath%%filename%%fileext%"
echo.
:: user input for triggering audio encoding
echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n
:skip1

set job=job.2.1.4& goto :tracks.info
:job.2.1.4

echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.

if not "%fileext%"==".mkv" goto :notmkv
     "%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
	 set HDR="%TEMP%BL.hevc"
	 goto :skip
 
:notmkv
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=%T1.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath%%filename%%fileext%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath%%filename%%fileext%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
	 "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
	 set HDR="%TEMP%%filename%.track_%T1.ID%.hevc"

:skip

if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"

"%dovi_tool_path%" -m 0 extract-rpu %HDR% -o "%TEMP%%filename%.bin"
set RPU="%TEMP%%filename%.bin"

:read

if /i "%action%"=="r" goto :skip.overwrite
"%dovi_tool_path%" info -s %RPU% >"%TEMP%xml.rpu.json"
type "%TEMP%xml.rpu.json" | findstr Frames: > "%TEMP%frames.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%frames.txt"') do (
    set "framecount=%%a"
)

echo { > "%TEMP%gen.default.l2.json"
echo     "cm_version": "V29", >> "%TEMP%gen.default.l2.json"
echo     "length": %framecount%, >> "%TEMP%gen.default.l2.json"
echo     "default_metadata_blocks": [ >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level2": { >> "%TEMP%gen.default.l2.json"
echo                 "target_max_pq": 2081 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         }, >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level2": { >> "%TEMP%gen.default.l2.json"
echo                "target_max_pq": 2851 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         }, >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level2": { >> "%TEMP%gen.default.l2.json"
echo                 "target_max_pq": 3079 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         } >> "%TEMP%gen.default.l2.json"
echo     ] >> "%TEMP%gen.default.l2.json"
echo } >> "%TEMP%gen.default.l2.json"

echo { > "%TEMP%overwrite.l2.json"
echo 	"source_rpu": "RPU_generated.bin", >> "%TEMP%overwrite.l2.json"
echo 	"rpu_levels": [2] >> "%TEMP%overwrite.l2.json"
echo } >> "%TEMP%overwrite.l2.json"

"%dovi_tool_path%" generate -j "%TEMP%gen.default.l2.json"
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%overwrite.l2.json" -o "%output_path%%filename%_L2.overwritten.bin"
set RPU="%output_path%%filename%_L2.overwritten.bin"
if exist "%letterpath%RPU_generated.bin" del "%letterpath%RPU_generated.bin"
goto :done 

:skip.overwrite
Setlocal EnableDelayedExpansion
for %%i in (!RPU!) do set filename2=%%~ni
for %%i in (!RPU!) do set filepath2=%%~di%%~pi
for %%i in (!RPU!) do set fileext2=%%~xi

"%RPU.to.XML%" convert %RPU% "%TEMP%%filename%_DV.xml"
set XML="%TEMP%%filename%_DV.xml"

:XML
if /i "%remove_100%"=="YES" set L2.100=,1
if /i "%remove_600%"=="YES" set L2.600=,27,28
if /i "%remove_1000%"=="YES" set L2.1000=,48,49

echo Removing L2 trims.
"%metafier_path%"  -o "%output_path%%filename%_L2_removed.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% %XML%
if /i "%fileext%"==".xml" goto :MUXER

echo Generate RPU from XML
"%dovi_tool_path%" generate --xml "%output_path%%filename%_L2_removed.xml" --rpu-out "%TEMP%rpu.bin"

cd /d "%filepath2%"
(
echo {
echo 	"source_rpu": "%filename2%.bin",
echo 	"rpu_levels": [5]
echo }
) > "%TEMP%transfer.json"

"%dovi_tool_path%" editor -i "%TEMP%rpu.bin" -j "%TEMP%transfer.json" --rpu-out "%output_path%%filename%_L2_removed.bin" >Nul
set RPU="%output_path%%filename%_L2_removed.bin"

:done
if "%fileext%"==".bin" goto :MUXER

echo.
echo \033[36m          ============== | "%cmdcolor%"
echo \033[36m          - INJECTING - | "%cmdcolor%"
echo \033[36m          ============== | "%cmdcolor%"
echo.

"%dovi_tool_path%" %dropH% inject-rpu -i %HDR% --rpu-in %RPU% -o "%output_path%%filename%_DV.hevc"
if NOT ["%errorlevel%"]==["0"] pause
set HDR="%output_path%%filename%_DV.hevc"

:skip
"%dovi_tool_path%" info --input %RPU% -f 10 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "DVprofile=%%a"
)
set "DVprofile=%DVprofile: =%"

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
if "%DVprofile%"=="5" set MBOX=& set dv.profile=5& set ID=0

goto :MUXER

::##################################################################################################################################################################################################
::################################################################# BATCH  INFO #######################################################################################################################
::##################################################################################################################################################################################################

:Workflow.7

echo.
echo \033[36m       ================== | "%cmdcolor%"
echo \033[36m       -   BATCH INFO  - | "%cmdcolor%"
echo \033[36m       ================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------| "%cmdcolor%"
echo -- This workflow batch info any HDR/DV files
echo \033[92m-------------------------------------------------------| "%cmdcolor%"
echo.

echo   Drag and drop a folder and press enter... & set /p folder_path=

set batch.info=y
cd /d "%output_path%"
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %folder_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if [%fileext1%]==[] (
     for %%i in (!folder_path!) do set filename1=%%~ni
     for %%i in (!folder_path!) do set filepath1=%%~di%%~pi
     for %%i in (!folder_path!) do set fileext1=%%~xi
)

::--------------------------------------------------------------LOOP------------------------------------------------------------------------------------

:LOOP.info
:: make and set temp folder
if exist "%temp_folder%temp.folder49" rmdir /Q /S "%temp_folder%temp.folder49"
MD "%temp_folder%temp.folder49"
set TEMP=%temp_folder%temp.folder49\
if "%fileext1%"==".txt" if "%filename1%"=="batch.info.result" goto :end

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" if not "%fileext1%"==".h265" if not "%fileext1%"==".hevc" echo Invalid extension, skipping file...& goto :end

echo.
echo \033[92m Processing... "%filepath1%%filename1%%fileext1%" | "%cmdcolor%"
echo.
set DVprofile=& set t81=& set t84=& set t82=& set t83=& set cmv4.0=& set level9=& set left=& set right=& set top=& set bottom=& set subprofile=& set MDL=& set DT=
set first_line=& set scenecuts0=& set second_line=& set consecutiveSC=& set video.count=& set DVinput=NO& set RPU=& set framerate=& set maxcll=& set maxfall=& set col=
set Height=& set Width=

if /i "%fileext1%"==".bin" set RPU="%filepath1%%filename1%.bin"& set DVinput=YES& goto :skip.demux
if /i "%fileext1%"==".xml" (
     "%dovi_tool_path%" generate --xml "%filepath1%%filename1%%fileext1%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%%filename1%_RPU.bin" >Nul
	 set RPU="%TEMP%%filename1%_RPU.bin"
	 set DVinput=YES
	 goto :skip.demux
)

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.bl.input.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%col.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
"%JQ_path%" .media.track[0].FileSize "%TEMP%mediainfo.JSON" > "%TEMP%FileSize.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"

for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%FileSize.txt"') do (
    set "FileSize=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "framerate=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxcll.txt"') do (
    set "maxcll=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxfall.txt"') do (
    set "maxfall=%%a"
)
set "maxfall=%maxfall: =%"
set "maxcll=%maxcll: =%"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
if "%maxcll%"==" =" set maxcll=0
if "%maxfall%"==" =" set maxfall=0
if "%maxcll%"=="" set maxcll=0
if "%maxfall%"=="" set maxfall=0

for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set MDL=%MDL:~1,-1%& set col=%col:~1,-1%
set video.count=%video.count:~1,-1%
set FileSize=%FileSize:"=%
if not exist "%~dp0tools\filesize.py" set FileSize=
if exist "%~dp0tools\filesize.py" for /f "tokens=*" %%i in ('python "%~dp0tools\filesize.py" %FileSize%') do set FileSize=%%i >Nul
if exist "%~dp0tools\filesize.py" set FileSize=(%FileSize%GB)

if /i "%fileext1%"==".hevc" set DVinput=YES
if /i "%fileext1%"==".h265" set DVinput=YES
findstr /c:"07" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set DVinput=YES
if "%video.count%"=="2" set DVinput=YES& set DT=-map 0:1
findstr /c:"05" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set DVinput=YES
findstr /c:"08" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set DVinput=YES
findstr /c:"04" "%TEMP%check.bl.input.txt" >Nul
if %errorlevel%==0 set DVinput=YES
if "%DVinput%"=="NO" goto :exportdata

"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" %DT% -c:v copy -to 3 -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%TEMP%%filename1%_RPU.bin" - 
set RPU="%TEMP%%filename1%_rpu.bin"

:skip.demux

"%dovi_tool_path%" info --input %RPU% -f 40 > "%TEMP%temp.rpu.json"

type "%TEMP%temp.rpu.json" | findstr dovi_profile > "%TEMP%DVprofile.json"
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%DVprofile.json"') do (
    set "DVprofile=%%a"
)
set "DVprofile=%DVprofile: =%"

"%dovi_tool_path%" export -i %RPU% -o "%TEMP%full.json" > Nul
"%dovi_tool_path%" export -i %RPU% -d scenes="%TEMP%scene.cuts.txt" > Nul

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":24" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":25" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=P3
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=BT2020

type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"
if "%left%"==" =" set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.

findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=MEL

for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^1:"') do (
    set "first_line=%%a"
)
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^2:"') do (
    set "second_line=%%a"
)

if "%first_line%"=="1:0" (
    set scenecuts0=YES (good^)
) else (
    set scenecuts0=NO
)

set consecutiveSC=NO (good)
if "%first_line%"=="1:0" if "%second_line%"=="2:1" set consecutiveSC=YES

:exportdata

echo ======================================================= >> "%output_path%batch.info.result.txt"
echo   Input: "%filepath1%%filename1%%fileext1%" >> "%output_path%batch.info.result.txt"
echo ======================================================= >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="YES" "%dovi_tool_path%" info -s %RPU% >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="YES" echo   1st Frame is a Scene Cut: %scenecuts0% >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="YES" echo   Consecutive Scene Cuts: %consecutiveSC% >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="YES" if "%DVprofile%"=="5" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer: ICtCp (DoVi P5) >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="YES" if "%DVprofile%"=="7" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer (HDR10^+P7): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="YES" if "%DVprofile%"=="8" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Base Layer (HDR10^+P8): %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits >> "%output_path%batch.info.result.txt"
if /i "%DVinput%"=="NO" echo   HDR10: %MDL%(%col%), MaxCLL: %maxcll%nits, MaxFALL: %maxfall%nits >> "%output_path%batch.info.result.txt"
if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" echo   Resolution\FPS: %Width% x %Height% ^@ %framerate%  %FileSize% >> "%output_path%batch.info.result.txt"
echo. >> "%output_path%batch.info.result.txt"

:end
rmdir /Q /S "%TEMP%"

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :LOOP.info
)
setlocal disabledelayedexpansion

::Use PowerShell to count occurrences of the word "FEL" (case-insensitive)
for /f %%a in ('powershell -command "(Get-Content -Path '"%output_path%batch.info.result.txt"') -join [environment]::NewLine | Select-String -Pattern 'FEL' -AllMatches | %%{$_.Matches.Count}"') do set FELcount=%%a
for /f %%a in ('powershell -command "(Get-Content -Path '"%output_path%batch.info.result.txt"') -join [environment]::NewLine | Select-String -Pattern 'MEL' -AllMatches | %%{$_.Matches.Count}"') do set MELcount=%%a
for /f %%a in ('powershell -command "(Get-Content -Path '"%output_path%batch.info.result.txt"') -join [environment]::NewLine | Select-String -Pattern 'v4' -AllMatches | %%{$_.Matches.Count}"') do set CM4count=%%a
for /f %%a in ('powershell -command "(Get-Content -Path '"%output_path%batch.info.result.txt"') -join [environment]::NewLine | Select-String -Pattern 'v2' -AllMatches | %%{$_.Matches.Count}"') do set CM2count=%%a
for /f %%a in ('powershell -command "(Get-Content -Path '"%output_path%batch.info.result.txt"') -join [environment]::NewLine | Select-String -Pattern 'Profile: 8' -AllMatches | %%{$_.Matches.Count}"') do set P8count=%%a
for /f %%a in ('powershell -command "(Get-Content -Path '"%output_path%batch.info.result.txt"') -join [environment]::NewLine | Select-String -Pattern 'Profile: 5' -AllMatches | %%{$_.Matches.Count}"') do set P5count=%%a
set /a TotalFiles=%CM4count% + %CM2count%
if not "%FELcount%"=="0" if not "%FELcount%"=="" set /a felpercent=(%FELcount% * 100) / %TotalFiles%
if not "%MELcount%"=="0" if not "%MELcount%"=="" set /a melpercent=(%MELcount% * 100) / %TotalFiles%
if not "%P8count%"=="0" if not "%P8count%"=="" set /a P8percent=(%P8count% * 100) / %TotalFiles%
if not "%P5count%"=="0" if not "%P5count%"=="" set /a P5percent=(%P5count% * 100) / %TotalFiles%
if not "%CM4count%"=="0" if not "%CM4count%"=="" set /a cm4percent=(%CM4count% * 100) / %TotalFiles%
if not "%CM2count%"=="0" if not "%CM2count%"=="" set /a cm2percent=(%CM2count% * 100) / %TotalFiles%

echo ========= >> "%output_path%batch.info.result.txt"
echo RESULT: >> "%output_path%batch.info.result.txt"
echo ========= >> "%output_path%batch.info.result.txt"
if not "%FELcount%"=="0" if not "%FELcount%"=="" echo Profile 7 FEL total: %FELcount% (%felpercent% percent) >> "%output_path%batch.info.result.txt"
if not "%MELcount%"=="0" if not "%MELcount%"=="" echo Profile 7 MEL total: %MELcount% (%melpercent% percent) >> "%output_path%batch.info.result.txt"
if not "%P8count%"=="0" if not "%P8count%"=="" echo Profile 8 total: %P8count% (%P8percent% percent) >> "%output_path%batch.info.result.txt"
if not "%P5count%"=="0" if not "%P5count%"=="" echo Profile 5 total: %P5count% (%P5percent% percent) >> "%output_path%batch.info.result.txt"
if not "%CM4count%"=="0" if not "%CM4count%"=="" echo CMv4.0 total: %CM4count% (%CM4percent% percent) >> "%output_path%batch.info.result.txt"
if not "%CM2count%"=="0" if not "%CM2count%"=="" echo CMv2.9 total: %CM2count% (%CM2percent% percent) >> "%output_path%batch.info.result.txt"
echo DoVi Files Total: %TotalFiles% >> "%output_path%batch.info.result.txt"

echo.
echo \033[92mRESULT:| "%cmdcolor%"
if not "%FELcount%"=="0" if not "%FELcount%"=="" echo Profile 7 FEL Total: %FELcount% (%felpercent% percent)
if not "%MELcount%"=="0" if not "%MELcount%"=="" echo Profile 7 MEL Total: %MELcount% (%melpercent% percent)
if not "%P8count%"=="0" if not "%P8count%"=="" echo Profile 8 Total: %P8count% (%P8percent% percent)
if not "%P5count%"=="0" if not "%P5count%"=="" echo Profile 5 Total: %P5count% (%P5percent% percent)
if not "%CM4count%"=="0" if not "%CM4count%"=="" echo CMv4.0 Total: %CM4count% (%CM4percent% percent)
if not "%CM2count%"=="0" if not "%CM2count%"=="" echo CMv2.9 Total: %CM2count% (%CM2percent% percent)
echo DoVi Files Total: %TotalFiles%
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu

exit

::##################################################################################################################################################################################################
::################################################################# scene cut difference ####################################################################################################################
::##################################################################################################################################################################################################

:Workflow.8
:checkcutdiff2

echo.
echo \033[36m       =========================== | "%cmdcolor%"
echo \033[36m       -  SCENE_CUTS_DIFFERENCE  - | "%cmdcolor%"
echo \033[36m       =========================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow find scene cuts difference between two sources
echo -- Input must be XML/RPU/JSON/TXT
echo \033[92m-------------------------------------------------------------------| "%cmdcolor%"
echo.

echo   Drag and drop file 1 and press enter... & set /p  input1=
echo   Drag and drop file 2 and press enter... & set /p  input2=

Setlocal EnableDelayedExpansion
for %%i in (!input1!) do set filename=%%~ni
for %%i in (!input1!) do set filepath=%%~di%%~pi
for %%i in (!input1!) do set fileext=%%~xi
for %%i in (!input2!) do set filename2=%%~ni
for %%i in (!input2!) do set filepath2=%%~di%%~pi
for %%i in (!input2!) do set fileext2=%%~xi
Setlocal DisableDelayedExpansion

if "%fileext%"==".txt" if "%fileext2%"==".txt" goto :TEXT

if exist "%temp_folder%temp.folder71" rmdir /Q /S "%temp_folder%temp.folder71"
MD "%temp_folder%temp.folder71"
set TEMP=%temp_folder%temp.folder71\

if not "%fileext%"==".txt" if not "%fileext%"==".bin" if not "%fileext%"==".json" if not "%fileext%"==".xml" echo Invalid input 1 type... & pause & goto :checkcutdiff2
if not "%fileext2%"==".txt" if not "%fileext2%"==".bin" if not "%fileext2%"==".json" if not "%fileext2%"==".xml" echo Invalid input 2 type... & pause & goto :checkcutdiff2

(
echo {
echo    "min_pq": 7,
echo    "max_pq": 3079,
echo	"remove_cmv4": true,
echo    "level6": {
echo        "max_display_mastering_luminance": 1000,
echo        "min_display_mastering_luminance": 50,
echo        "max_content_light_level": 0,
echo        "max_frame_average_light_level": 0
echo    }
echo }
) > "%TEMP%L6.json"

if /i  "%fileext%"==".bin" set RPU="%filepath%%filename%%fileext%"
if /i  "%fileext2%"==".bin" set RPU2="%filepath2%%filename2%%fileext2%"
if /i  "%fileext%"==".xml" "%dovi_tool_nofloor%" generate --xml "%filepath%%filename%%fileext%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%%filename%.bin" & set RPU="%TEMP%%filename%.bin"
if /i  "%fileext2%"==".xml" "%dovi_tool_nofloor%" generate --xml "%filepath2%%filename2%%fileext2%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%%filename2%.bin" & set RPU2="%TEMP%%filename2%.bin"
if /i  "%fileext%"==".json" "%dovi_tool_nofloor%" generate --hdr10plus-json "%filepath%%filename%%fileext%" --json "%TEMP%L6.json" --rpu-out "%TEMP%%filename%.bin" & set RPU="%TEMP%%filename%.bin"
if /i  "%fileext2%"==".json" "%dovi_tool_nofloor%" generate --hdr10plus-json "%filepath2%%filename2%%fileext2%" --json "%TEMP%L6.json" --rpu-out "%TEMP%%filename2%.bin" & set RPU2="%TEMP%%filename2%.bin"

::rpu to text file
if not "%fileext%"==".txt" "%dovi_tool_path%" export -i %RPU% -d scenes="%filepath%%filename%.txt"
if not "%fileext2%"==".txt" "%dovi_tool_path%" export -i %RPU2% -d scenes="%filepath2%%filename2%.txt"

:TEXT

echo.
echo \033[92mCalculating the difference....| "%cmdcolor%"
python "%~dp0tools\Scene_Cut_Difference.py" -i "%filepath%%filename%.txt"  -i "%filepath2%%filename2%.txt" -o "%output_path%Scene_Cuts_Difference.txt" > nul
echo done.
echo.
set filename2=&set filepath2=& set fileext2=&set filename=&set filepath=& set fileext=
rmdir /Q /S "%TEMP%"
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu

exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
:: ---------------------------------------------------------------MODE.DV maker----------------------------------------------------------------------------------------------------------------------------
:MODE.H

echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= CM_analyzer HDR10 to DoVi maker (can batch) (Professional CM v4.0 Dolby Algo)
echo 2) Workflow.2= Convert HDR10plus videos to DoVi (can batch) (^Not Recommended)
echo 3) Workflow.3= Back to main menu
echo.
choice /C:123 /M Choice?
if ERRORLEVEL 3 (
goto :Main.Menu
)

if ERRORLEVEL 2 (
goto :Workflow.2
)

if ERRORLEVEL 1 (
goto :Workflow.1
)

:Workflow.1

 ::batch generate dv with cm analyze
 echo.
 echo.
echo \033[36m          ============== | "%cmdcolor%"
echo \033[36m          - CM_ANALYZE - | "%cmdcolor%"
echo \033[36m          ============== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------------------------------------- | "%cmdcolor%"
echo -- This workflow will convert an HDR10 video to DoVi using official Dolby Vision tools
echo -- Require Dolby metafier.exe , cm_analyze.exe, lavfilter, madvr and avisynth^+
echo -- https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools
echo -- Input must be HDR MKV/TS/M2TS/MP4/MOV(prores) ^for the video and ^for the external files: MDL5-bat/xml/rpu/json/txt
echo -- Input can be a folder with files or a single file (must be ^in a container)
echo -- Input with ")" ^in the filename will ^NOT work and ^[^] ^in the filename is ^not allowed by dolby tools
echo -- if no external shotlist and ^if input has dynamic metadata, it will use its scene cuts.
echo -- If input has no dynamic metadata and no external list, madvr will be used for the shot list
echo -- You can perform frame by frame analysis at line 251
echo -- if you dont provide external external config, the same L5/MDL will be used (see example ^in tool folder)
echo -- External files: must be same path/filename as input. (bat/xml/rpu/json/txt) external files are prioritized.
echo -- "IGNORERPU" ^in the filename will ignore the rpu within the video and force madvr for the scene cuts
echo -- Workaround (faster): https://youtu.be/FVSh3oGqfXY^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m--------------------------------------------------------------------------------------------------------------------- | "%cmdcolor%"
echo.
set batch.info=y
if not exist "%~dp0tools\cm_analyze.exe" echo \033[31m cm_analyze.exe is missing from the tools folder, download it here: https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools| "%cmdcolor%" & pause & exit
if not exist "%~dp0tools\metafier.exe" echo \033[31m metafier.exe is missing from the tools folder, download it here: https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools| "%cmdcolor%"& pause & exit

if exist "%temp_folder%temp.folder77" rmdir /Q /S "%temp_folder%temp.folder77"
MD "%temp_folder%temp.folder77"
set TEMP=%temp_folder%temp.folder77\

:: folder with files input
echo Drag and drop folder with HEVC video files or a single file and press enter...
set /p folder=

setlocal enabledelayedexpansion
set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

set single.file=n
if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
	 set single.file=y
)

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%col.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"

for /f "delims=" %%x in (%TEMP%masteringDL.txt) do set MDL3=%%x
for /f "delims=" %%x in (%TEMP%col.txt) do set col=%%x
set col=%col:~1,-1%& set MDL3=%MDL3:~1,-1%& set HLG=n& set P5BL=n

type "%TEMP%mediainfo.JSON" | findstr HLG >"%TEMP%pq.txt"
findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set HLG=y& set col=& set MDL3=Hybrid Log Gamma

findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P5BL=y& set col=& set MDL3=Profile 5 DV

::check for raw input and disable muxing.
if /i "%fileext1%"==".hevc" echo raw hevc not supported. Input must be: MKV/TS/M2TS/MP4/MOV(prores) ... & pause & exit
if /i "%fileext1%"==".h265" echo raw h265 not supported. Input must be: MKV/TS/M2TS/MP4/MOV(prores) ... & pause & exit
if /i "%fileext1%"==".mov" set MUX=NO& set container=none& goto :LL5
if /i "%encode_DDP%"=="NO" goto :skip
if /i "%container%"=="MP4" goto :skip
if "%fileext1%"==".bin" if /i "%encode_DDP%"=="YES" goto :convertaudio
if "%fileext1%"==".json" if /i "%encode_DDP%"=="YES" goto :convertaudio

:: check if lossless audio present, if not skip the user prompt.
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Audio;%%Format%% --LogFile="%TEMP%audio.format.txt" >Nul
findstr /c:"MLP" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm.au=n
if "%mlp%"=="n" if "%dts%"=="n"  if "%pcm.au%"=="n" goto :skip
echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
:: check audio tracks info
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath1%%filename1%%fileext1%"
echo.
:convertaudio
:: user input for triggering audio encoding
echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n
:skip

if exist "%filepath1%%filename1%.bat" goto :skip.manual.l5
if "%fileext1%"==".bin"  goto :LL5
if "%fileext1%"==".json"  goto :LL5
if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".mov" goto :skip.manual.l5
echo.
echo \033[92m ------------------------------------------------ | "%cmdcolor%"
echo    BL Mastering Display Luminance and Colors:
echo --^> %MDL3% %col%
echo \033[92m ------------------------------------------------ | "%cmdcolor%"
echo.
:LL5
echo What is the Mastering Display Luminance/primaries^? (default=20)
echo.

echo --^> 1000nits(P3)= 20
echo --^> 2000nits(P3)= 30
echo --^> 4000nits(P3)= 7
echo.
echo --^> 1000nits(BT2020)= 21
echo --^> 2000nits(BT2020)= 31
echo --^> 4000nits(BT2020)= 8

set /p MDL=
if not "%MDL%"=="20" if not "%MDL%"=="21" if not "%MDL%"=="30" if not "%MDL%"=="31" if not "%MDL%"=="7" if not "%MDL%"=="8" set MDL=20
echo.

if "%fileext1%"==".bin" set autoL5=m& goto :manualL5
if "%fileext1%"==".json" set autoL5=m& goto :manualL5
if /i "%auto.crop%"=="NO" goto :skip.crop
::check bl resolution and crop if nescessary
"%JQ_path%" .media.track[1].Height "%TEMP%mediainfo.JSON" > "%TEMP%Height.c.txt"
for /f "delims=" %%x in (%TEMP%Height.c.txt) do set H=%%x
set H=%H:~1,-1%
if not "%H%"=="2160" if not "%H%"=="1080" set cropped=YES& set autoL5=m& set left=0& set right=0& set top=0& set bottom=0& goto :skip.manual.l5

:skip.crop

echo   Manual or Auto Level 5^? (default= m)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p autoL5=
if /i "%autoL5%"=="" set autoL5=m
if /i "%autoL5%"=="m" set autoL5=m
if /i "%autoL5%"=="a" set autoL5=a
if not "%autoL5%"=="a" if not "%autoL5%"=="m" set autoL5=m
if "%autoL5%"=="a" goto :skip.manual.l5

set cropcheck="%filepath1%%filename1%%fileext1%"
if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" goto :skip.sample

echo.
echo Raw HEVC or TS/M2TS input, making a MKV sample to allow avspmod to read the input...
"%mkvmerge_path%" --output ^"%TEMP%sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set cropcheck="%TEMP%sample.mkv"

:skip.sample
echo DirectShowSource(%cropcheck%) > "%TEMP%%filename1%.avs"
echo Levels(0, 2.5, 255, 0, 255, coring=false) >> "%TEMP%%filename1%.avs"

start "" "%AvsPmod_path%" "%TEMP%%filename1%.avs"

:manualL5
set left=0& set right=0& set top=0& set bottom=0
echo Enter the Left L5 offset (default = 0) & set /p left=
if [%left%]==[] set left=0
echo Enter the Right L5 offset (default = 0) & set /p right=
if [%right%]==[] set right=0
echo Enter the Top L5 offset (default = 0) & set /p top=
if [%top%]==[] set top=0
echo Enter the Bottom L5 offset (default = 0) & set /p bottom=
if [%bottom%]==[] set bottom=0

:skip.manual.l5

echo Which Tuning do you want to use^? (default=3) (0= darkest / 5= brightest)
echo.
echo --^>  0 = Old legacy mode  (^not recommended)
echo --^>  1= Most Highlight Detail/Most Mapping
echo --^>  2= More Highlight Detail/More Mapping
echo --^>  3= Balanced (default)
echo --^>  4= Less Highlight Detail/Less Mapping
echo --^>  5= Least Highlight Detail/Least Mapping

echo.
set /p L1_Tuning=
if /i "%L1_Tuning%"=="" set L1_Tuning=3
if not "%L1_Tuning%"=="0" if not "%L1_Tuning%"=="1" if not "%L1_Tuning%"=="2" if not "%L1_Tuning%"=="3" if not "%L1_Tuning%"=="4" if not "%L1_Tuning%"=="5" set L1_Tuning=3

::----------------------------------------------------------------------------------------------------------------------------------------------FILE 1 -------------------------------------------------------------------------------------------------------------------------------------------------------------

:loop.CM
if exist "%temp_folder%temp.folder77" rmdir /Q /S "%temp_folder%temp.folder77"
MD "%temp_folder%temp.folder77"
set TEMP=%temp_folder%temp.folder77\

echo Processing:  "%filename1%%fileext1%"
if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".mov" echo Invalid extension, skipping file...& goto :end
if /i "%same_input_output%"=="YES" set output_path=%filepath1%


"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
echo "%filename1%" > "%TEMP%filename1.txt"
findstr /c:")" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set spe.char=y& set disable_indexing=YES

::check if BL has keywords in the filename
findstr /c:"KEEPTRIMS" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set rem_trims=n& set overwrite.L2=NO
findstr /c:"KEEPAUDIO" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"DONTMUX" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set MUX=NO
findstr /c:"KEEPPRORES" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set keep_prores=YES
findstr /c:"REMOVECMV4" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set rem_cmv4=YES
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"

set HLG=n
type "%TEMP%mediainfo.JSON" | findstr HLG >"%TEMP%pq.txt"
findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set HLG=y
set P5BL=n
findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P5BL=y

set job=job.3.1& goto :tracks.Info
:job.3.1
::----------------------------------------------------------------------------------L5-------------------------------------------------------------------------------------------------

if exist "%filepath1%%filename1%.bat" goto :skip.measure
if not "%autoL5%"=="a" goto :skip.measure
echo.
echo Making a small sample from the input...
echo.

::make a 3 min sample. (in case input is ts/m2ts which doesnt work in detect borders)
"%mkvmerge_path%" --output ^"%TEMP%chunk.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
echo Done!
echo.
:: measure letterbox with detectborders
echo Measuring the letterbox...
echo.

"%detectborders_path%" --ffmpeg-path="%ffmpeg_path%" --input-file="%TEMP%chunk.mkv" --log-file="%TEMP%\borders.txt"
echo.
echo Done!
:: read borders detection results
for /f "tokens=2 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "left=%%a"
)
for /f "tokens=4 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "right=%%a"
)
for /f "tokens=3 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "top=%%a"
)
for /f "tokens=5 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "bottom=%%a"
)

:: set borders to 0 in case l5 variables are empty (better than having wrong value).
if [%right%]==[] set right=0
if [%left%]==[] set left=0
if [%right%]==[] set right=0
if [%bottom%]==[] set bottom=0
if "%bottom%"=="278" set bottom=277
if "%top%"=="278" set top=277
if "%bottom%"=="264" set bottom=263
if "%top%"=="264" set top=263

echo.
::echo borders measurements for verification.
echo ---------------------------------
echo --^> left border: %left%
echo --^> right border: %right%
echo --^> top border: %top%
echo --^> bottom border: %bottom%
echo ---------------------------------
echo.

:skip.measure
set DV=n
if /i "%fileext1%"==".mov" set MUX=NO& set container=none& goto :skipdemux

findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 (
     cd /d "%TEMP%"
     "%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -
	 if "%container%"=="TS" if "%mlp%"=="y" set MUX=NO
	 set HDR="%TEMP%BL.hevc"
	 cd /d "%output_path%"
	 goto :skipdemux
)

if not "%fileext1%"==".mkv" goto :notmkv
if /i "%container%"=="MKV" if /i "%export.subs%"=="NO" if /i "%mux_all_audio%"=="YES" if /i "%mux_all_sub%"=="YES" "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc" & set HDR="%TEMP%BL.hevc"& goto :skipdemux
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26%
set HDR="%TEMP%BL.hevc"& goto :skipdemux
	 
:notmkv
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"

::-----------------------------------------------------------------------------------------------------------------------------
:skipdemux

if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"

echo { > "%TEMP%L66.json"
echo    "min_pq": 3079, >> "%TEMP%L66.json"
echo    "max_pq": 7, >> "%TEMP%L66.json"
echo	"remove_cmv4": true, >> "%TEMP%L66.json"
echo    "level6": { >> "%TEMP%L66.json"
echo        "max_display_mastering_luminance": 1000, >> "%TEMP%L66.json"
echo        "min_display_mastering_luminance": 50, >> "%TEMP%L66.json"
echo        "max_content_light_level": 0, >> "%TEMP%L66.json"
echo        "max_frame_average_light_level": 0 >> "%TEMP%L66.json"
echo    } >> "%TEMP%L66.json"
echo } >> "%TEMP%L66.json"


if "%HLG%"=="y" goto :skip
if /i "%force.FBF%"=="YES" set shotlist=--longplay-analysis& goto :prores
if exist "%filepath1%%filename1%.txt" goto :prores

::external rpu
if exist "%filepath1%%filename1%.bin" (
     "%dovi_tool_path%" export -i "%filepath1%%filename1%.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
	 set RPU="%filepath1%%filename1%.bin"
     set DV=y& echo Exporting shots list from an external RPU to a text file...
	 set OSC=_OSC
	 goto :skip
)

:: external json hdr10plus
if exist "%filepath1%%filename1%.json" (
	 "%dovi_tool_path%" generate --hdr10plus-json "%filepath1%%filename1%.json" --json "%TEMP%L66.json" --rpu-out "%TEMP%rpu.hdr10plus.bin" >Nul
	 "%dovi_tool_path%" export -i "%TEMP%rpu.hdr10plus.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
     set RPU="%TEMP%rpu.hdr10plus.bin"
	 set DV=y& echo Exporting shots list from an external HDR10plus JSON to a text file...
	 set OSC=_OSC
	 goto :skip
)

if exist "%filepath1%%filename1%.xml" (
     "%dovi_tool_path%" generate --xml "%filepath1%%filename1%.xml" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%rpu.xml.bin" >Nul
	 "%dovi_tool_path%" export -i "%TEMP%rpu.xml.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
     set RPU="%TEMP%rpu.xml.bin"
     set DV=y& echo Exporting shots list from a XML to a text file...
	 goto :skip
)

findstr /c:"IGNORERPU" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 del "%TEMP%check.DV.txt"

findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 (
     "%dovi_tool_path%" extract-rpu -i "%TEMP%EL.hevc" -o "%TEMP%RPU.original.bin" 
     "%dovi_tool_path%" export -i "%TEMP%RPU.original.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
	 set RPU="%TEMP%RPU.original.bin"
     set DV=y& echo Exporting shots list from a RPU to a text file...
	 set OSC=_OSC
	 goto :skip
)

findstr /c:"dvhe" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 (
     "%dovi_tool_path%" extract-rpu -i %HDR% -o "%TEMP%RPU.original.bin" 
     "%dovi_tool_path%" export -i "%TEMP%RPU.original.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
	 set RPU="%TEMP%RPU.original.bin"
	 set RPUORI="%TEMP%RPU.original.bin"
     set DV=y& echo Exporting shots list from a RPU to a text file...
	 set OSC=_OSC
	 goto :skip
)

findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 (
	 "%hdr10plus_parser_path%" --skip-validation extract -i %HDR% -o "%TEMP%HDR10plus.json"
	 set HDR="%TEMP%BL.hevc"
	 "%dovi_tool_path%" generate --hdr10plus-json "%TEMP%HDR10plus.json" --json "%TEMP%L66.json" --rpu-out "%TEMP%rpu.h.bin" >Nul
     "%dovi_tool_path%" export -i "%TEMP%rpu.h.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
	 set RPU="%TEMP%rpu.h.bin"
     set DV=y&echo Exporting shots list from a HDR10plus JSON to a text file...
	 set OSC=_OSC
	 goto :skip
)

if not "%madvr_workaround%"=="YES" goto :skipworkaround

:tryworkaround9
set madvr_workaround=YES
echo.
"%ffmsindex%" "%filepath1%%filename1%%fileext1%" "%TEMP%index.ffindex"
echo.
echo LoadPlugin("%ffms2%") > "%TEMP%script.avs"
echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%index.ffindex") >> "%TEMP%script.avs"
"%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -pix_fmt yuv422p10le -an -y -hide_banner  "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"
set prores="%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"
echo.
"%madvr_path%" "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"
"%dovi_tool_path%" generate -j "%TEMP%L66.json" --madvr-file "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov.measurements" -o "%TEMP%generated_rpu.bin"
move "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov.measurements" "%output_path%"

"%dovi_tool_path%" export -i "%TEMP%generated_rpu.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
if NOT ["%errorlevel%"]==["0"] pause & exit
set RPU="%TEMP%generated_rpu.bin"& goto :skip

:skipworkaround

if /i "%fileext1%"==".mov" rename "%filepath1%%filename1%%fileext1%" "%filename1%_transfer=hdr_matrix=2020.mov"
if /i "%fileext1%"==".mov" set filename1=%filename1%_transfer=hdr_matrix=2020

:: generate scene cuts with madvr
"%madvr_path%" "%filepath1%%filename1%%fileext1%"
"%dovi_tool_path%" generate -j "%TEMP%L66.json" --madvr-file "%filepath1%%filename1%%fileext1%.measurements" -o "%TEMP%generated_rpu.bin"
move "%filepath1%%filename1%%fileext1%.measurements" "%output_path%"

"%dovi_tool_path%" export -i "%TEMP%generated_rpu.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
if NOT ["%errorlevel%"]==["0"] echo. & echo MadVR failed to make the scene cuts, will conver to prores first... & goto :tryworkaround9
set RPU="%TEMP%generated_rpu.bin"

::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:skip

::HLG or P5 input
if not "%HLG%"=="y" if not "%P5BL%"=="y" goto :skipHLG
if "%spe.char%"=="y" echo Special character found in input, skipping P5/HLG file... & goto :end
if "%P5BL%"=="y" set source=3
if "%HLG%"=="y" set source=2

"%ffmsindex%" "%filepath1%%filename1%%fileext1%" "%TEMP%index.ffindex"

echo import os, sys > "%TEMP%script.vpy"
echo import vapoursynth as vs >> "%TEMP%script.vpy"
echo core = vs.core >> "%TEMP%script.vpy"
echo core.std.LoadPlugin(r"%ffms2%", altsearchpath=True) >> "%TEMP%script.vpy"
echo core.avs.LoadPlugin(r"%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.vpy"
echo core.std.LoadPlugin(r"%~dp0tools\vs_libplacebo.dll", altsearchpath=True) >> "%TEMP%script.vpy"

echo clip = core.ffms2.Source(r"%filepath1%%filename1%%fileext1%", cachefile=r"%TEMP%indexed.video.ffindex") >> "%TEMP%script.vpy"
echo clip = vs.core.resize.Bicubic(clip=clip, format=vs.YUV444P16) >> "%TEMP%script.vpy"
echo clip = core.placebo.Tonemap(clip, src_csp=%source%, dst_csp=1, dynamic_peak_detection=1, tone_mapping_function=0, tone_mapping_mode=0) >> "%TEMP%script.vpy"
if "%P5BL%"=="y" echo clip = core.avs.z_ConvertFormat(clip, pixel_type='YUV420P10', colorspace_op='2020ncl:st2084:2020:full=^>2020ncl:st2084:2020:limited', dither_type='error_diffusion',chromaloc_op='left=^>top_left') >> "%TEMP%script.vpy"
echo clip.set_output() >> "%TEMP%script.vpy"

"%vspipe_path%" -c y4m "%TEMP%script.vpy" - | "%ffmpeg_path%" -i pipe: -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -pix_fmt yuv422p10le -an -y -hide_banner "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"
set prores="%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"

if /i "%force.FBF%"=="YES" set shotlist=--longplay-analysis& goto :prores

if "%DV%"=="y" goto :skipHLG
if "%P5BL%"=="y" if "%DV%"=="n" "%madvr_path%" "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"
if "%HLG%"=="y" "%madvr_path%" "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov"

"%dovi_tool_path%" generate -j "%TEMP%L66.json" --madvr-file "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov.measurements" -o "%TEMP%generated_rpu.bin"
move "%TEMP%%filename1%_prores.422_transfer=HDR.matrix=2020.mov.measurements" "%output_path%"

"%dovi_tool_path%" export -i "%TEMP%generated_rpu.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt"
if NOT ["%errorlevel%"]==["0"] echo madvr failed to make the scene cuts & pause & exit
set RPU="%TEMP%generated_rpu.bin"

::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:skipHLG

if "%DV%"=="y" (
     del "%TEMP%%filename1%.scene.cuts.txt"
	 type nul > "%TEMP%%filename1%.scene.cuts.txt"
     echo { > "%TEMP%scene.json"
	 echo     "mode": 0, >> "%TEMP%scene.json"
	 echo     "scene_cuts": { >> "%TEMP%scene.json"
	 echo         "0-0": true >> "%TEMP%scene.json"
	 echo 		} >> "%TEMP%scene.json"
	 echo } >> "%TEMP%scene.json"
	 "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%scene.json" --rpu-out "%TEMP%RPU-flag.added.bin" >Nul
	 "%dovi_tool_path%" export -i "%TEMP%RPU-flag.added.bin" -d scenes="%TEMP%%filename1%.scene.cuts.txt" >Nul 
	 set RPU="%TEMP%RPU-flag.added.bin"
)
set shotlist=--shot-list "%TEMP%%filename1%.scene.cuts.txt"

:prores
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
if "%FPS%"=="23.976" set FPS=24000/1001
if "%FPS%"=="24.000" set FPS=24
if "%FPS%"=="25.000" set FPS=25
if "%FPS%"=="29.970" set FPS=30000/1001
if "%FPS%"=="30.000" set FPS=30
if "%FPS%"=="50.000" set FPS=50
if "%FPS%"=="59.940" set FPS=60000/1001
if "%FPS%"=="60.000" set FPS=60

if "%fileext1%"==".mov" set prores="%filepath1%%filename1%%fileext1%"& goto :skip.prores
set cropped=NO
if "%madvr_workaround%"=="YES" goto :skip.prores
if "%P5BL%"=="y" goto :skip.prores
if "%HLG%"=="y" goto :skip.prores
if /i "%auto.crop%"=="NO" goto :skip.cropped

::check bl resolution and crop if nescessary
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.2.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.2.txt"') do (
    set "H=%%a"
)
if "%H%"=="2160" goto :skip.cropped
if "%H%"=="1080" goto :skip.cropped

set cropped=YES
if not %H% lss 1080 set /a total.BB=2160 - %H%
if %H% lss 1080 set /a total.BB=1080 - %H%
set /a "half=%total.BB% / 2"
set left=0
set right=0
set top=%half%
set bottom=%half%

:skip.cropped

if /i "%disable_indexing%"=="YES" set index="%filepath1%%filename1%%fileext1%"& goto :skip.indexing

"%ffmsindex%" "%filepath1%%filename1%%fileext1%" "%TEMP%index.ffindex"
echo LoadPlugin("%ffms2%") > "%TEMP%script.avs"
echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%index.ffindex") >> "%TEMP%script.avs"
if /i "%cropped%"=="YES" echo AddBorders(%left%, %top%, %right%, %bottom%) >> "%TEMP%script.avs"
set index="%TEMP%script.avs"

:skip.indexing
:: encode to prores
"%ffmpeg_path%" -i %index% -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -pix_fmt yuv422p10le -an -y -hide_banner "%TEMP%%filename1%_prores.422.mov"
set prores="%TEMP%%filename1%_prores.422.mov"

:skip.prores
if /i "%force.FBF%"=="YES" goto :skipframecount

"%mediainfo_path%" %prores% --output=JSON > "%TEMP%mediainfoprores.JSON"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfoprores.JSON" > "%TEMP%FrameCountprores.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCountprores.txt"') do (
    set "frameCount=%%a"
)
set frameCount=%frameCount:"=%

if exist "%filepath1%%filename1%.txt" (
     echo %frameCount% >> "%filepath1%%filename1%.txt"
     set shotlist=--shot-list "%filepath1%%filename1%.txt"
	 goto :skipframecount
)

echo %frameCount% >> "%TEMP%%filename1%.scene.cuts.txt"

:skipframecount
if /i "%CM_CPU%"=="YES" set cpu.only=--cpu-only
if exist "%filepath1%%filename1%.bat" call "%filepath1%%filename1%.bat"

if "%P5BL%"=="y" goto :skip.cropped
if "%HLG%"=="y" goto :skip.cropped
if /i "%auto.crop%"=="NO" goto :skip.cropped
if "%H%"=="2160" goto :skip.cropped
if "%H%"=="1080" goto :skip.cropped
if "%fileext1%"==".mov" goto :skip.cropped

set cropped=YES
if not %H% lss 1080 set /a total.BB=2160 - %H%
if %H% lss 1080 set /a total.BB=1080 - %H%
set /a "half=%total.BB% / 2"
set left=0
set right=0
set top=%half%
set bottom=%half%

:skip.cropped

if [%MDL%]==[] set MDL=20
if "%MDL%"=="21" set min=1& set MDL1=1000& set maxpq=3079& set minpq=7
if "%MDL%"=="7" set min=50& set MDL1=4000& set maxpq=3696& set minpq=62
if "%MDL%"=="20" set min=1& set MDL1=1000& set maxpq=3079& set minpq=7
if "%MDL%"=="8" set min=50& set MDL1=4000& set maxpq=3696& set minpq=62
if "%MDL%"=="30" set min=50& set MDL1=2000& set maxpq=3388& set minpq=62
if "%MDL%"=="31" set min=50& set MDL1=2000& set maxpq=3388& set minpq=62
if [%right%]==[] set right=0
if [%left%]==[] set left=0
if [%right%]==[] set right=0
if [%bottom%]==[] set bottom=0

:: cm analyze, dv generation
"%cm_analyzer_path%" %shotlist% -m %MDL% -r %FPS% --source-format "pq bt2020" --letterbox %left% %right% %top% %bottom% --bda --analysis-tuning %L1_Tuning% %cpu.only% %prores% "%TEMP%%filename1%_DV.xml"

:: Read BL input resolution for xml to rpu generation (support variable L5)
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width_path=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height_path=%%a"
)

set rem_trims=n
if /i "%remove_100%"=="YES" set rem_trims=y& set L2.100=,1
if /i "%remove_600%"=="YES" set rem_trims=y& set L2.600=,27,28
if /i "%remove_1000%"=="YES" set rem_trims=y& set L2.1000=,48,49

::removes 600 and 1000nits trims from xml with the dolby metafier
if /i "%rem_trims%"=="n" goto :keeptrims
     echo Removing L2 trims.
     "%metafier_path%"  -o "%TEMP%%filename1%_DV_trims_removed.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% "%TEMP%%filename1%_DV.xml"
     echo Generate RPU from XML
     "%dovi_tool_path%" generate --xml "%TEMP%%filename1%_DV_trims_removed.xml" --canvas-width %Width_path% --canvas-height %Height_path% --rpu-out "%TEMP%rpu.bin"
	 set RPU="%TEMP%rpu.bin"
	 goto :skiptrims
	 
:keeptrims
	 "%dovi_tool_path%" generate --xml "%TEMP%%filename1%_DV.xml" --canvas-width %Width_path% --canvas-height %Height_path% --rpu-out "%TEMP%rpu.bin"
     set RPU="%TEMP%rpu.bin"
	 
:skiptrims
xcopy /s /f "%TEMP%%filename1%_DV.xml" "%output_path%" >Nul
rename "%output_path%%filename1%_DV.xml" "%filename1%_Generated_T%L1_Tuning%%OSC%.xml" >Nul

if "%fileext1%"==".mov" goto :skipmast
if "%P5BL%"=="y" set min=1& goto :skipmast
if "%HLG%"=="y" set min=1& goto :skipmast
findstr /m "0.0050" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set min=50
findstr /m "0.0001" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set min=1
findstr /m "0.0020" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set min=20
findstr /m "0.0010" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set min=10
findstr /m "0.0000" "%TEMP%masteringDL.txt" >Nul
if %errorlevel%==0 set min=0

:skipmast

::check for maxcll fall and framecount
"%dovi_tool_path%" info -s %RPU% >"%TEMP%sum.rpu.json"
type "%TEMP%sum.rpu.json" | findstr Frames: > "%TEMP%frames.txt"
type "%TEMP%sum.rpu.json" | findstr L1 > "%TEMP%L1.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%frames.txt"') do (
    set "framecount=%%a"
)
for /f "tokens=4 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=6 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxfall_path=%%a"
)
set maxcll_path=%maxcll_path: =%
set maxfall_path=%maxfall_path: =%

if /i "%cropped%"=="YES" set left=0& set right=0& set top=0& set bottom=0
set mode=0
if "%HLG%"=="y" set mode=4
(
    echo {
    echo    "mode": %mode%,
    echo    "active_area": {
    echo        "crop": false,
    echo        "presets": [
    echo            {
    echo                "id": 0,
    echo                "left": %left%,
    echo                "right": %right%,
    echo                "top": %top%,
    echo                "bottom": %bottom%
    echo            }
    echo        ],
    echo        "edits": {
    echo            "all": 0
    echo        }
    echo    }
    echo }
) > "%TEMP%L5L6.json"

:: generate json template to generate 100nits L8
echo { > "%TEMP%gen.default.l2.json"
echo     "cm_version": "V40", >> "%TEMP%gen.default.l2.json"
echo     "length": %frameCount%, >> "%TEMP%gen.default.l2.json"
echo     "default_metadata_blocks": [ >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level2": { >> "%TEMP%gen.default.l2.json"
echo                 "target_max_pq": 2081 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         }, >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level2": { >> "%TEMP%gen.default.l2.json"
echo                "target_max_pq": 2851 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         }, >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level2": { >> "%TEMP%gen.default.l2.json"
echo                 "target_max_pq": 3079 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         }, >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level3": { >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         }, >> "%TEMP%gen.default.l2.json"
echo         { >> "%TEMP%gen.default.l2.json"
echo             "Level8": { >> "%TEMP%gen.default.l2.json"
echo                "target_display_index": 1 >> "%TEMP%gen.default.l2.json"
echo             } >> "%TEMP%gen.default.l2.json"
echo         } >> "%TEMP%gen.default.l2.json
echo     ] >> "%TEMP%gen.default.l2.json"
echo } >> "%TEMP%gen.default.l2.json"

if "%P5BL%"=="y" set L2=2,  

echo { > "%TEMP%overwrite.l2.json"
echo 	"source_rpu": "RPU_generated.bin", >> "%TEMP%overwrite.l2.json"
echo 	"rpu_levels": [%L2%8] >> "%TEMP%overwrite.l2.json"
echo } >> "%TEMP%overwrite.l2.json"

"%dovi_tool_path%" generate -j "%TEMP%gen.default.l2.json"

"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L5L6.json" --rpu-out "%TEMP%L5L6.bin" > nul

"%dovi_tool_path%" editor -i "%TEMP%L5L6.bin" -j "%TEMP%overwrite.l2.json" -o "%output_path%%filename1%_Generated_T%L1_Tuning%%OSC%.bin" > nul
set RPU="%output_path%%filename1%_Generated_T%L1_Tuning%%OSC%.bin"
if exist "%output_path%RPU_generated.bin" del "%output_path%RPU_generated.bin"

::remove cmv4.0
if /i "%rem_cmv4%"=="NO" goto :skipcmv4
	 Echo ---^> Removing cmv4.0 metadata block...
     echo { > "%TEMP%CM4.json"
     echo 	"remove_cmv4": true >> "%TEMP%CM4.json"
     echo } >> "%TEMP%CM4.json"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%CM4.json" --rpu-out "%output_path%%filename1%_Generated_cmv4.0_removed_T%L1_Tuning%%OSC%.bin" > nul
	 set RPU="%output_path%%filename1%_Generated_cmv4.0_removed_T%L1_Tuning%%OSC%.bin"
	 
::-----------------------------------------------------P5----------------------------------------------------------------------
:skipcmv4
if "%fileext1%"==".mov" goto :end
if not "%P5BL%"=="y" goto :skipP5BL

echo { > "%TEMP%sourcepq.json"
echo     "remove_mapping": false, >> "%TEMP%sourcepq.json"
echo 	 "min_pq": %minpq%, >> "%TEMP%sourcepq.json"
echo     "max_pq": %maxpq% >> "%TEMP%sourcepq.json"
echo } >> "%TEMP%sourcepq.json"

echo { > "%TEMP%transferRPU.json"
echo 	"source_rpu": "%filename1%_Generated.bin", >> "%TEMP%transferRPU.json"
echo 	"rpu_levels": [1, 2, 5] >> "%TEMP%transferRPU.json"
echo } >> "%TEMP%transferRPU.json"

"%dovi_tool_path%" editor -i "%TEMP%RPU.original.bin" -j "%TEMP%transferRPU.json" -o "%TEMP%l1.transfered.bin" > nul
"%dovi_tool_path%" editor -i "%TEMP%l1.transfered.bin" -j "%TEMP%sourcepq.json" -o "%output_path%%filename1%_Generated_P5_T%L1_Tuning%.bin" > nul
set RPU="%output_path%%filename1%_Generated_P5_T%L1_Tuning%.bin"

::---------------------------------------------------inject-------------------------------------------------------------------------
:skipP5BL
"%dovi_tool_path%" %dropH% inject-rpu -i %HDR% --rpu-in %RPU% -o "%output_path%%filename1%_Generated.hevc"
if NOT ["%errorlevel%"]==["0"] pause

if /i "%keep_prores%"=="YES" if exist "%TEMP%%filename1%_prores.422.mov" move "%TEMP%%filename1%_prores.422.mov" "%output_path%"
set HDR="%output_path%%filename1%_Generated.hevc"

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
if "%P5BL%"=="y" set MBOX=& set dv.profile=5& set ID=0

goto :MUXER
:job.3.1.done

::--------------------------------------------------------------------------------------------------------------------------------------
:end

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=
if "%spe.char%"=="y" set disable_indexing=NO
set spe.char=n
:: go to next file or end the script
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.CM
)
setlocal disabledelayedexpansion
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::********************************************************************************************************************************************************************************************************************************
::********************************************************************************************************************************************************************************************************************************
::********************************************************************************************************************************************************************************************************************************
::********************************************************************************************************************************************************************************************************************************
::********************************************************************************************************************************************************************************************************************************

:: ---------------------------------------------------------MODE.HDR10plus.1.video.workflow.2----------------------------------------------------------------------------------------------------------------
:Workflow.2

echo.
echo --------------------------------------------------------------------------------------------------
echo -- ^THIS WORKFLOW IS NOT RECOMMENDED: you'll get better DV if you use 3-1. 
echo -- See: https://drive.google.com/file/d/1IXR60nWe2Ylb7CTRjZ3_tpI5RsAajU5G/view^?usp=drive_link
echo -- This script will batch convert HDR10plus or HDR10 video to DoVi with dynamic metadata or madVR
echo -- Can use external L5 json if filepath/name is the same as the BL input
echo -- MadVR may fails to measure some file. Usually TS and M2TS files, so remux it to MKV
echo --------------------------------------------------------------------------------------------------
echo.
set batch.info=y

if not exist "%~dp0tools\dovi_tool_HDR10plus_tuning.exe" echo "%~dp0tools\dovi_tool_HDR10plus_tuning.exe" is missing from the tools folder, update it or hdr10plus input will not work...  & pause

setlocal enabledelayedexpansion
:: folder with files input
echo Drag and drop folder with files or a single file and press enter...
set /p folder=

set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
)

if exist "%filepath1%%filename1%.bat" set borders=m& goto :skip.l5
if exist "%filepath1%%filename1%.json" set borders=m& goto :skip.l5

echo.
echo Auto or Manual Active Area L5 edit^?  (Default = m)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p borders=
if /i "%borders%"=="" set borders=m
if /i "%borders%"=="m" set borders=m
if /i "%borders%"=="a" set borders=a
if not "%borders%"=="a" if not "%borders%"=="m" set borders=m
if /i "%borders%"=="a" goto :skip.l5

echo   Set the left border... choose a number and press enter...& set /p left=
if "%left%"=="" set left=0
echo   Set the right border... choose a number and press enter...& set /p right=
if "%right%"=="" set right=0
echo   Set the top border... choose a number and press enter...& set /p top=
if "%top%"=="" set top=0
echo   Set the bottom border... choose a number and press enter...& set /p bottom=
if "%bottom%"=="" set bottom=0
:skip.l5

:: ---------------------------------------------------------------------------------------------------------------------------------------------------------------1st FILE-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

:loop.HDR10plus
if exist "%temp_folder%temp.folder34" rmdir /Q /S "%temp_folder%temp.folder34"
MD "%temp_folder%temp.folder34"
set TEMP=%temp_folder%temp.folder34\

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" echo Invalid extension, skipping file...& goto :end
if /i "%same_input_output%"=="YES" set output_path=%filepath1%
echo processing..."%filename1%%fileext1%"

if "%borders%"=="m" goto :skip.measure

::detect borders
echo Measuring letterbox of "%filepath1%%filename1%%fileext1%"
"%detectborders_path%" --ffmpeg-path="%ffmpeg_path%" --input-file="%filepath1%%filename1%%fileext1%"  --log-file="%TEMP%\borders.txt"
:: set L5
for /f "tokens=2 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "left=%%a"
)
for /f "tokens=4 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "right=%%a"
)
for /f "tokens=3 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "top=%%a"
)
for /f "tokens=5 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "bottom=%%a"
)
if "%left%"=="" set left=0
if "%right_%"=="" set right=0
if "%top%"=="" set top=0
if "%bottom%"=="" set bottom=0
echo left border: %left%
echo right border: %right%
echo top border: %top%
echo bottom border: %bottom%

:skip.measure
if exist "%filepath1%%filename1%.bat" call "%filepath1%%filename1%.bat"
:: Edit active area: generate L5 active area json
echo { > "%TEMP%L5.json"
echo    "mode": 0, >> "%TEMP%L5.json"
if /i "%Force.DV.NOFLOOR%"=="YES" echo    "remove_cmv4": true, >> "%TEMP%L5.json"
echo    "active_area": { >> "%TEMP%L5.json"
echo        "crop": false, >> "%TEMP%L5.json"
echo        "presets": [ >> "%TEMP%L5.json"
echo            { >> "%TEMP%L5.json"
echo                "id": 0, >> "%TEMP%L5.json"
echo                "left": %left%, >> "%TEMP%L5.json"
echo                "right": %right%, >> "%TEMP%L5.json"
echo                "top": %top%, >> "%TEMP%L5.json"
echo                "bottom": %bottom% >> "%TEMP%L5.json"
echo            } >> "%TEMP%L5.json"
echo        ], >> "%TEMP%L5.json"
echo        "edits": { >> "%TEMP%L5.json"
echo            "all": 0 >> "%TEMP%L5.json"
echo        } >> "%TEMP%L5.json"
echo    } >> "%TEMP%L5.json"
echo } >> "%TEMP%L5.json"

set l5json="%TEMP%L5.json"

if exist "%filepath1%%filename1%.json" set l5json="%filepath1%%filename1%.json"
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:: read input file metadata with mediainfo
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%MasteringDisplay_Luminance%% --LogFile="%TEMP%MDL.txt" >Nul

:: read and set L6 static metadata
set max=3079
set min=7
set maxcll_path=0
set maxfall_path=0
set MDL.max_path=1000
set MDL.min_path=1
findstr /m "1000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=1000
set max=3079
)
findstr /m "4000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=4000
set max=3696
)
findstr /m "10000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=10000
set max=4095
)
findstr /m "2000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.max_path=2000
set max=3388
)
findstr /m "0.0050" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=50
set min=62
)
findstr /m "0.0001" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=1
set min=7
)
findstr /m "0.0020" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=20
set min=38
)
findstr /m "0.0010" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=10
set min=19
)
findstr /m "0.0000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 (
set MDL.min_path=0
set min=0
)
:: Edit static metadata: generate L6 json
echo { > "%TEMP%L6.json"
echo    "min_pq": %min%, >> "%TEMP%L6.json"
echo    "max_pq": %max%, >> "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %MDL.max_path%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %MDL.min_path%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"

set job=job.3.2& goto :tracks.info
:job.3.2

 ::------------------------------------------------------------------------Demuxing------------------------------------------------------------------------------------------------------------------------
:: demux MKV
echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.

if not "%fileext1%"==".mkv" goto :notmkv
     "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%hdr.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
	 set HDR="%TEMP%hdr.hevc"
	 goto :skip
	 
:notmkv
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"

for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"

:skip

if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"

:: check if HDR10plus is present
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 set Hplus=y

set dovi_tool.temp="%dovi_tool_Hplus%"
if /i "%Force.DV.NOFLOOR%"=="YES" set dovi_tool.temp="%dovi_tool_nofloor%"

if not "%Hplus%"=="y" (
     "%madvr_path%" "%filepath1%%filename1%%fileext1%"
	 echo.
	 echo \033[92m Generating DoVi from a MadVR measurement file... | "%cmdcolor%"
	 %dovi_tool.temp% generate -j "%TEMP%L6.json" --madvr-file "%filepath1%%filename1%%fileext1%.measurements" -o "%TEMP%RPU.bin"
	 echo Done.
	 set from=madVR& goto :L5.edit
)

:: Extract HDR10+ from HEVC
echo.&echo.
echo \033[36m       =========================== | "%cmdcolor%"
echo \033[36m       -    EXTRACTING HDR10plus     - | "%cmdcolor%"
echo \033[36m       =========================== | "%cmdcolor%"
echo.
"%hdr10plus_parser_path%" extract %HDR% -o "%TEMP%HDR10plus.JSON"
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%hdr10plus_parser_path%" --skip-validation extract %HDR% -o "%TEMP%hdr10plus.JSON"
set from=HDR10plus

 ::------------------------------------------------------------------------GENERATE-----------------------------------------------------------------------------------------------------------------------
 :: generate rpu 
echo.
echo \033[92m Generating DoVi from HDR10plus... | "%cmdcolor%"
%dovi_tool.temp% generate --hdr10plus-json "%TEMP%HDR10plus.JSON" --json "%TEMP%L6.json" --rpu-out "%TEMP%RPU.bin" >Nul
if NOT ["%errorlevel%"]==["0"]  pause
echo Done.

:L5.edit
:: edit L5 
echo.
echo \033[92m Editing L5 (active area) to left=%left%, right= %right%, top= %top%, bottom= %bottom% | "%cmdcolor%"
%dovi_tool.temp% editor -i "%TEMP%RPU.bin" -j %l5json% --rpu-out "%TEMP%RPUL5.bin" >Nul
if NOT ["%errorlevel%"]==["0"]  pause
echo Done.

:: edit L6
echo.
"%dovi_tool_path%" info -s "%TEMP%RPUL5.bin" >"%TEMP%sum.rpu.json"
type "%TEMP%sum.rpu.json" | findstr L1 > "%TEMP%L1.txt"
for /f "tokens=4 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=6 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxfall_path=%%a"
)
if "%maxcll_path%"==" =" set maxcll_path=0
if "%maxfall_path%"==" =" set maxfall_path=0
if "%maxcll_path%"=="" set maxcll_path=0
if "%maxfall_path%"=="" set maxfall_path=0
:: final L6 metadata edit
del "%TEMP%L6.json"
echo { > "%TEMP%L6.json"
echo    "min_pq": %min%, >> "%TEMP%L6.json"
echo    "max_pq": %max%, >> "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %MDL.max_path%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %MDL.min_path%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"

echo \033[92m Editing L6 to MDL=%MDL.max_path%/%MDL.min_path%,  MaxCLL/FALL=%maxcll_path%/%maxfall_path% | "%cmdcolor%"
%dovi_tool.temp% editor -i "%TEMP%RPUL5.bin" -j "%TEMP%L6.json" --rpu-out "%output_path%%filename1%_Generated_%from%.bin" >Nul
if NOT ["%errorlevel%"]==["0"]  pause
echo Done.

:: inject rpu  
echo.&echo.
echo \033[36m         ================ | "%cmdcolor%"
echo \033[36m         - INJECTING DV - | "%cmdcolor%"
echo \033[36m         ================ | "%cmdcolor%"
echo.
%dovi_tool.temp% %dropH% inject-rpu -i %HDR% --rpu-in "%output_path%%filename1%_Generated_%from%.bin" -o "%output_path%%filename1%_DV.hevc"
if NOT ["%errorlevel%"]==["0"]  pause
set HDR="%output_path%%filename1%_DV.hevc"
set RPU="%output_path%%filename1%_Generated_%from%.bin"

if exist "%filepath1%%filename1%%fileext1%.measurements" del "%filepath1%%filename1%%fileext1%.measurements"
set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1

 ::------------------------------------------------------------------------MUX----------------------------------------------------------------------------------------------------------------------------
goto :MUXER

:job.3.2.done

:end
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%" 

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=
:: go to next file or end the script
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.HDR10plus
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

::-----------------------------------------------------------------DV.inject.P7.input.Workflow.7----------------------------------------------------------------------------------------------------------------------------
:Mode.P7 
 ::P7 input

echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= Convert to P8 Single-Layer P8 (STSL)
echo 2) Workflow.2= Convert to P7 Dual-Layer Single-Track (STDL)
echo 3) Workflow.3= Convert to P7 Dual-Track Dual-Layer (DTDL)
echo 4) MODE.4= Back to main menu
echo.
choice /C:1234 /M Choice?
if ERRORLEVEL 4 (
goto :Main.Menu
)

if ERRORLEVEL 3 (
goto :Workflow.3
)

if ERRORLEVEL 2 (
goto :Workflow.2
)

if ERRORLEVEL 1 (
goto :Workflow.1
)

 ::--------------------------------------------------------------------MODE.1.Workflow.1--------------------------------------------------------------------------------------------------------------------
:Workflow.1
echo.
echo.
echo \033[36m          ============ | "%cmdcolor%"
echo \033[36m          - P7 TO P8 - | "%cmdcolor%"
echo \033[36m          ============ | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo --Convert any P7 file to profile 8 
echo --Input can be MKV/TS/M2TS/MP4/BDMV/MPLS/RPU
echo --Tutorial: https://youtu.be/sBUL2gjhqEE^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
if "%container%"=="MP4" echo -- External subs must be SRT
echo \033[92m------------------------------------------------------------------------------------- | "%cmdcolor%"
echo.
set p7from1=n
set batch.info=y
echo   Drag and drop a P7 DV file (BDMV folder/mpls or m2ts/ts/mkv/mp4) and press enter... 
set /p video_path=

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename1=%%~ni
for %%i in (!video_path!) do set filepath1=%%~di%%~pi
for %%i in (!video_path!) do set fileext1=%%~xi

:: make and set temp folder
if exist "%temp_folder%temp.folder16_new" rmdir /Q /S "%temp_folder%temp.folder16_new"
if exist "%temp_folder%temp.folder16" set E1=_new
MD "%temp_folder%temp.folder16%E1%"
set TEMP=%temp_folder%temp.folder16%E1%\

if /i "%checkoutputspace%"=="NO" goto :p7from1
::Use PowerShell to get disk space information
for /f "tokens=*" %%A in ('powershell -command "(Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DeviceID -eq '%letterpath%' }).FreeSpace"') do set "free=%%A"
for /f "tokens=*" %%A in ('powershell -command "(Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DeviceID -eq '%letterpath%' }).Size"') do set "total=%%A"
::Calculate used space
for /f %%A in ('powershell -command "[math]::Floor([long]%free% / 1GB)"') do set "free_gb=%%A"
if %free_gb% leq 200 echo \033[31m WARNING: Output path "%output_path%" has only %free_gb%GB of free space. Processing large file may not work.... | "%cmdcolor%"

:p7from1

::------------------------------------------------------RPU input---------------------------------------------------------
if not "%fileext1%"==".bin" goto :skiprpuinput
echo { > "%TEMP%p7top8.json"
echo     "mode": 2 >> "%TEMP%p7top8.json"
echo } >> "%TEMP%p7top8.json"
echo Converting Profile 7 RPU to Profile 8...
"%dovi_tool_path%" editor -i "%filepath1%%filename1%%fileext1%"  -j  "%TEMP%p7top8.json" --rpu-out "%output_path%%filename1%_P7_to_P8.bin" >Nul
echo Done.
rmdir /Q /S "%TEMP%" 
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit
::------------------------------------------------------------------------------------------------------------------------

:skiprpuinput

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "vt=%%a"
)

set vt=%vt:~1,-1%
if %vt% GEQ 3 set vt=2

set bdinput=n
if /i "%fileext1%"==".ts" goto :skip.BD
if /i "%fileext1%"==".m2ts" goto :skip.BD
if /i "%fileext1%"==".mkv" goto :skip.BD
if /i "%fileext1%"==".mp4" goto :skip.BD

set bdinput=y
"%DGDemux_path%" -d "%filepath1%%filename1%%fileext1%"
echo   Drag and drop the main movie playlist (MPLS) and press enter... & set /p mpls_path=

for %%i in (!mpls_path!) do set filename1=%%~ni
for %%i in (!mpls_path!) do set filepath1=%%~di%%~pi
for %%i in (!mpls_path!) do set fileext1=%%~xi
Setlocal DisableDelayedExpansion

if /i "%fileext1%"==".m2ts" echo You must input a MPLS file...& pause & exit
if /i "%container%"=="MP4" echo   External .SRT subtitle file(optional)^? and/or press enter... & set /p subtitles_path=

:skip.BD
if /i "%bdinput%"=="n" if /i "%same_input_output%"=="YES" set output_path=%filepath1%
if /i "%container%"=="MP4" goto :skip
::if /i "%encode_DDP%"=="NO" goto :skip

echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n
:skip

set job=job.4.1.1& goto :tracks.info
:job.4.1.1

::--------------------------------------------------------quick info-----------------------------------------------------------------
if "%p7from1%"=="y" goto :skipquickinfo
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --demux --vbr --cut-end=30000ms --vbv-len=500 --start-time=27000000 > "%TEMP%1.meta"
if not "%vt%"=="2" echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta" 
if "%vt%"=="2" echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T2.ID% >> "%TEMP%1.meta" 
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
 
if "%vt%"=="2" "%dovi_tool_path%" -m 0 extract-rpu "%TEMP%%filename1%.track_%T2.ID%.hevc" -o "%TEMP%chunk.RPU.bin" >Nul
if not "%vt%"=="2" "%dovi_tool_path%" -m 0 extract-rpu "%TEMP%%filename1%.track_%T1.ID%.hevc" -o "%TEMP%chunk.RPU.bin" >Nul

set temp.rpu="%TEMP%chunk.RPU.bin"
"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"
type "%TEMP%temp.rpu.json" | findstr target_max_pq > "%TEMP%trims.json"
type "%TEMP%temp.rpu.json" | findstr source_min_pq > "%TEMP%min_pq.json"
type "%TEMP%temp.rpu.json" | findstr source_max_pq > "%TEMP%max_pq.json"
type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"

"%dovi_tool_path%" export -i %temp.rpu% -o "%TEMP%full.json"

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":24" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":25" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y

findstr /c:"2081" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T1=100 nits& set trims=YES
findstr /c:"2851" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T2=, 600 nits& set trims=YES
findstr /c:"3079" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T3=, 1000 nits& set trims=YES
findstr /c:"3388" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T4=, 2000 nits& set trims=YES
if "%trims%"=="" set trims=NO

findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=1000 nits
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=2000 nits
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4000 nits
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=10 000 nits
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=1 nits
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=50 nits
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=20 nits
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0 nits

findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=MEL

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"

"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%col.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"

for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "fps=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
set MDL=%MDL:~1,-1%& set col=%col:~1,-1%
set cmdcolortype=92
if "%left%"==" =" set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=31

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
echo \033[%cmdcolortype%m L5 Left offset: %left%| "%cmdcolor%"
echo \033[%cmdcolortype%m L5 Right offset: %right%| "%cmdcolor%"
echo \033[%cmdcolortype%m L5 Top offset: %top%| "%cmdcolor%"
echo \033[%cmdcolortype%m L5 Bottom offset: %bottom%| "%cmdcolor%"
echo \033[92m Enhancement Layer: %subprofile%| "%cmdcolor%"
echo \033[92m L2 trims: %T1%%T2%%T3%%T4%| "%cmdcolor%"
if "%cmv4.0%"=="y" echo \033[92m L8 trims: %t81%%t84%%t82%%t83% | "%cmdcolor%"
echo \033[92m DoVi source min_pq: %min_pq%| "%cmdcolor%"
echo \033[92m DoVi source max_pq: %max_pq%| "%cmdcolor%"
echo \033[92m HDR10 BL input MDL: %MDL%| "%cmdcolor%"
echo \033[92m HDR10 BL MDP: %col%| "%cmdcolor%"
echo \033[92m Resolution: %Width% x %Height% ^@ %fps%| "%cmdcolor%"
if /i "%checkoutputspace%"=="NO" goto :skipquickinfo
if %free_gb% leq 200 echo \033[31m Output Path Free Space: %free_gb%gb | "%cmdcolor%"
if not %free_gb% leq 200 echo \033[92m Output Path Free Space: %free_gb%gb  | "%cmdcolor%"
echo.&echo.

:skipquickinfo
if "%subprofile%"=="FEL" (
     echo.
     echo \033[31mWARNING. WARNING. WARNING. | "%cmdcolor%"
	 echo \033[31mProfile 7 with Full Enhancement Layer (FEL^) detected... | "%cmdcolor%"
	 echo \033[31mThe output could be wrong if FEL expand the brightness...  | "%cmdcolor%"
	 echo SEE: https://docs.google.com/spreadsheets/d/15i0a84uiBtWiHZ5CXZZ7wygLFXwYOd84/edit^?gid=828864432#gid=828864432
	 echo.&echo.
	 pause
)

::-------------------------------------------------------demux---------------------------------------------------------------------------
cd /d "%TEMP%"
::remove hdr10plus
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR10plus.txt"
findstr /c:"2094" "%TEMP%check.HDR10plus.txt" >Nul
if %errorlevel%==0 (
     if /i "%drop.HDR10plus%"=="YES" set dropH=--drop-hdr10plus
)
::remove cmv4.0
echo { > "%TEMP%remove.40.json"
echo     "mode": 2, >> "%TEMP%remove.40.json"
echo     "remove_cmv4": true >> "%TEMP%remove.40.json"
echo } >> "%TEMP%remove.40.json"
if /i "%rem_cmv4%"=="YES" set remove.4.0=--edit-config "%TEMP%remove.40.json"

:: conditions to skip ffmpeg piping
if not "%ffmpeg_pipe%"=="YES"  goto :skippipe
if "%bdinput%"=="y" goto :skippipe
if "%vt%"=="2"  goto :skippipe
if not "%container%"=="MKV"  goto :skippipe
if /i "%mux_all_audio%"=="NO"  goto :skippipe
if /i "%mux_all_sub%"=="NO"  goto :skippipe
if /i "%export.subs%"=="YES"  goto :skippipe

"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" %dropH% %remove.4.0% -m 2 convert --discard - -o "%output_path%%filename1%_P8.hevc"
set HDR="%output_path%%filename1%_P8.hevc"& goto :skip.demux

:skippipe

:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 --start-time=27000000 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", fps=%FPS%, track=%T1.ID% >> "%TEMP%1.meta"
if "%vt%"=="2" echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", insertSEI, contSPS, fps=%FPS%, track=%T2.ID% >> "%TEMP%1.meta"
for /L %%i in (1,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="VobSub" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
if NOT ["%errorlevel%"]==["0"] pause & echo Failed to demux...

set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"
if "%vt%"=="2" set EL="%TEMP%%filename1%.track_%T2.ID%.hevc"

if not "%bdinput%"=="y" if not "%vt%"=="2" (
     "%dovi_tool_path%" demux -i %HDR%
	 set HDR="%TEMP%BL.hevc"& set EL="%TEMP%EL.hevc"
)

:: convert/inject 
echo converting and injecting RPU...
"%dovi_tool_path%" %dropH% %remove.4.0% -m 2 mux --bl %HDR% --el %EL% --discard -o "%output_path%%filename1%_P8.hevc"
if NOT ["%errorlevel%"]==["0"]  echo Input file doesnt contain a Dolby Vision track & rmdir /Q /S "%TEMP%" & pause & exit
set HDR="%output_path%%filename1%_P8.hevc"
if /i "%keep_EL%"=="YES" move %EL% "%output_path%"

:skip.demux
cd /d "%output_path%" 

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
goto :MUXER

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

 ::--------------------------------------------------------------------MODE.4.Workflow.2--------------------------------------------------------------------------------------------------------------------
:Workflow.2
::P7 Bluray MPLS to P7 ST-DL
echo.
echo.
echo \033[36m          ========= | "%cmdcolor%"
echo \033[36m          - ST-DL - | "%cmdcolor%"
echo \033[36m          ========= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo --This workflow will remux a dual-track dual-layer DV to ST-DL P7 
echo --Input must be: BDMV folder/ mpls / or m2ts/ts/hevc/h265
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
echo   Drag and drop a dual-track dual-layer DV file (BDMV folder/ mpls / or m2ts/ts/hevc/h265) and press enter... & set /p BD_path=

Setlocal EnableDelayedExpansion
for %%i in (!BD_path!) do set filename=%%~ni
for %%i in (!BD_path!) do set filepath=%%~di%%~pi
for %%i in (!BD_path!) do set fileext=%%~xi

:: make and set temp folder
if exist "%temp_folder%temp.folder17_new" rmdir /Q /S "%temp_folder%temp.folder17_new"
if exist "%temp_folder%temp.folder17" set E1=_new
MD "%temp_folder%temp.folder17%E1%"
set TEMP=%temp_folder%temp.folder17%E1%\

if /i "%checkoutputspace%"=="NO" goto :skiphddcheck
::Use PowerShell to get disk space information
for /f "tokens=*" %%A in ('powershell -command "(Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DeviceID -eq '%letterpath%' }).FreeSpace"') do set "free=%%A"
for /f "tokens=*" %%A in ('powershell -command "(Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DeviceID -eq '%letterpath%' }).Size"') do set "total=%%A"
::Calculate used space
for /f %%A in ('powershell -command "[math]::Floor([long]%free% / 1GB)"') do set "free_gb=%%A"
if %free_gb% leq 200 echo \033[31m WARNING: Output path "%output_path%" has only %free_gb%GB of free space. Processing large file may not work.... | "%cmdcolor%"
:skiphddcheck

if /i "%fileext%"==".ts" goto :skip.BD
if /i "%fileext%"==".m2ts" goto :skip.BD
if /i "%fileext%"==".mkv" goto :skip.BD
if /i "%fileext%"==".mp4" goto :skip.BD
if not "%fileext%"==".hevc" if not "%fileext%"==".h265" if not "%fileext%"==".HEVC" if not "%fileext%"==".H265" goto :skip.raw

echo   Drag and drop the EL file (must be raw hevc/h265) and press enter... & set /p EL_path=

for %%i in (!EL_path!) do set filename2=%%~ni
for %%i in (!EL_path!) do set filepath2=%%~di%%~pi
for %%i in (!EL_path!) do set fileext2=%%~xi
set raw.input=y& set HDR="%filepath%%filename%%fileext%"& set EL="%filepath2%%filename2%%fileext2%"& goto :inject

:skip.raw
"%DGDemux_path%" -d %BD_path%
echo   Drag and drop the main movie playlist (MPLS) and press enter... & set /p mpls_path=

for %%i in (!mpls_path!) do set filename=%%~ni
for %%i in (!mpls_path!) do set filepath=%%~di%%~pi
for %%i in (!mpls_path!) do set fileext=%%~xi

:skip.BD
if not "%container%"=="MKV" goto :skipmkv
"%mkvmerge_path%" --output ^"%output_path%%filename%_P7.mkv^" --compression 0:none ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^"
echo.
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

:skipmkv
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2

if /i "%container%"=="MP4" goto :skip
if /i "%encode_DDP%"=="NO" goto :skip

echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n

:skip
::check if BL has keywords in the filename
echo "%filename%" > "%TEMP%filename.txt"
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"DONTMUX" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set MUX=NO
findstr /c:"REMOVECMV4" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set rem_cmv4=YES

::--------------------------------------------------------quick info-----------------------------------------------------------------
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --cut-end=30000ms --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=4117 >> "%TEMP%1.meta"
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%1.ts" >Nul
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --demux --vbr  --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%TEMP%1.ts", track=4117 >> "%TEMP%1.meta"
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%" >Nul
"%dovi_tool_path%" -m 0 extract-rpu "%TEMP%1.track_4117.hevc" -o "%TEMP%chunk.RPU.bin" >Nul
set temp.rpu="%TEMP%chunk.RPU.bin"
"%dovi_tool_path%" info --input %temp.rpu% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"
type "%TEMP%temp.rpu.json" | findstr target_max_pq > "%TEMP%trims.json"
type "%TEMP%temp.rpu.json" | findstr source_min_pq > "%TEMP%min_pq.json"
type "%TEMP%temp.rpu.json" | findstr source_max_pq > "%TEMP%max_pq.json"
type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"

"%dovi_tool_path%" export -i %temp.rpu% -o "%TEMP%full.json"

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":24" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":25" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t84=, 300 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=, 600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=, 1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y

findstr /c:"2081" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T1=100 nits& set trims=YES
findstr /c:"2851" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T2=, 600 nits& set trims=YES
findstr /c:"3079" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T3=, 1000 nits& set trims=YES
findstr /c:"3388" "%TEMP%trims.json" >Nul
if %errorlevel%==0 set T4=, 2000 nits& set trims=YES
if "%trims%"=="" set trims=NO

findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=1000 nits
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=2000 nits
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4000 nits
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=10 000 nits
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=1 nits
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=50 nits
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=20 nits
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0 nits

findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=MEL

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"

"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%col.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
	"%mediainfo_path%" "%filepath1%%filename1%%fileext1%"  --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"

for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "fps=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
set MDL=%MDL:~1,-1%& set col=%col:~1,-1%
set cmdcolortype=92
if "%left%"==" =" set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=31

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
echo \033[%cmdcolortype%m L5 Left offset: %left%| "%cmdcolor%"
echo \033[%cmdcolortype%m L5 Right offset: %right%| "%cmdcolor%"
echo \033[%cmdcolortype%m L5 Top offset: %top%| "%cmdcolor%"
echo \033[%cmdcolortype%m L5 Bottom offset: %bottom%| "%cmdcolor%"
echo \033[92m Enhancement Layer: %subprofile%| "%cmdcolor%"
echo \033[92m L2 trims: %T1%%T2%%T3%%T4%| "%cmdcolor%"
if "%cmv4.0%"=="y" echo \033[92m L8 trims: %t81%%t84%%t82%%t83% | "%cmdcolor%"
echo \033[92m DoVi source min_pq: %min_pq%| "%cmdcolor%"
echo \033[92m DoVi source max_pq: %max_pq%| "%cmdcolor%"
echo \033[92m HDR10 BL input MDL: %MDL%| "%cmdcolor%"
echo \033[92m HDR10 BL MDP: %col%| "%cmdcolor%"
echo \033[92m Resolution: %Width% x %Height% ^@ %fps%| "%cmdcolor%"
if /i "%checkoutputspace%"=="NO" goto :skipquickinfo
if %free_gb% leq 200 echo \033[31m Output Path Free Space: %free_gb%gb | "%cmdcolor%"
if not %free_gb% leq 200 echo \033[92m Output Path Free Space: %free_gb%gb  | "%cmdcolor%"
:skipquickinfo
echo.&echo.

::-------------------------------------------------------------------------------------------------------------------------------------------------------------------
set job=job.4.1.2& goto :tracks.Info

:job.4.1.2

:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=%T1.ID%, fps=%FPS% >> "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", insertSEI, contSPS, track=%T2.ID%, fps=%FPS% >> "%TEMP%1.meta"
for /L %%i in (1,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath%%filename%%fileext%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath%%filename%%fileext%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
if NOT ["%errorlevel%"]==["0"] pause & echo Failed to demux...
set HDR="%TEMP%%filename%.track_%T1.ID%.hevc"& set EL="%TEMP%%filename%.track_%T2.ID%.hevc"

echo { > "%TEMP%remove.40.json"
echo     "mode": 0, >> "%TEMP%remove.40.json"
echo     "remove_cmv4": true >> "%TEMP%remove.40.json"
echo } >> "%TEMP%remove.40.json"

if /i "%rem_cmv4%"=="YES" set remove.4.0=--edit-config "%TEMP%remove.40.json"

:inject
echo.
echo \033[92mMuxing BL^+ EL^+ RPU...| "%cmdcolor%"
echo.
"%dovi_tool_path%" %remove.4.0% mux --bl %HDR% --el %EL% -o "%output_path%%filename%_ST-DL.hevc"
set HDR="%output_path%%filename%_ST-DL.hevc"
echo Done.

if "%raw.input%"=="y" echo \033[92mThe script has been completed... | "%cmdcolor%" & pause & exit
if /i "%keep_EL%"=="YES" move %EL% "%output_path%"

set MBOX=:hdr=none:dvp=7.6& set dv.profile=7& set ID=1
goto :MUXER

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

 ::--------------------------------------------------------------------MODE.P7.MODE.3-----------------------------------------------------------------------------------------------------------------------------
:Workflow.3

:DL1
echo.
echo \033[36m          ========= | "%cmdcolor%"
echo \033[36m          - DT-DL - | "%cmdcolor%"
echo \033[36m          ========= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
if not "%container%"=="MP4" echo --This workflow will demux single track P7 to DT-DL (can batch)
if "%container%"=="MP4" echo --This workflow will mux any P7 source (BDMV or mkv rip) to DT-DL
if /i "%container%"=="MKV" echo Dual track DV not supported with the MKV container... & pause & exit
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
cd /d "%output_path%"
set batch.info=y

if not "%container%"=="MP4" goto :skip.BD
echo   Drag and drop a P7 DV file (BDMV folder/ mpls / or mkv/m2ts/ts) and press enter... 
set /p video_path=

setlocal enabledelayedexpansion

set count=1
for %%i in (!video_path!) do set filename1=%%~ni
for %%i in (!video_path!) do set filepath1=%%~di%%~pi
for %%i in (!video_path!) do set fileext1=%%~xi


if /i "%fileext1%"==".ts" goto :skipnonmp4
if /i "%fileext1%"==".m2ts" goto :skipnonmp4
if /i "%fileext1%"==".mkv" goto :skipnonmp4
if /i "%fileext1%"==".mp4" goto :skipnonmp4

"%DGDemux_path%" -d %video_path%
echo   Drag and drop the main movie playlist (MPLS) and press enter...
set /p mpls_path=


for %%i in (!mpls_path!) do set filename1=%%~ni
for %%i in (!mpls_path!) do set filepath1=%%~di%%~pi
for %%i in (!mpls_path!) do set fileext1=%%~xi

goto :skipnonmp4

::------------------------------------------------non-mp4-------------------------------------------------------------------------------------------------------------------------------

:skip.BD
echo   Drag and drop a ST-DL P7 file or a folder with files and press enter... 
set /p folder_path=

setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %folder_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)

:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if [%fileext1%]==[] (
     for %%i in (!folder_path!) do set filename1=%%~ni
     for %%i in (!folder_path!) do set filepath1=%%~di%%~pi
     for %%i in (!folder_path!) do set fileext1=%%~xi
)

:skipnonmp4
if /i "%same_input_output%"=="YES" set output_path=%filepath1%

::----------------------------------------------------------------------------loop--------------------------------------------------------------------------------------------------------------------------

:LOOP_DTDL
:: make and set temp folder
if exist "%temp_folder%temp.folder18" rmdir /Q /S "%temp_folder%temp.folder18"
MD "%temp_folder%temp.folder18"
set TEMP=%temp_folder%temp.folder18\

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".mpls" if not "%fileext1%"==".hevc" if not "%fileext1%"==".h265" echo Invalid extension, skipping file...& goto :end

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" goto :skipdvcheck

"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if not %errorlevel%==0 echo No Profile 7 metadata detected, skipping file...& goto :end

:skipdvcheck
if /i "%fileext1%"==".hevc" set HDR="%filepath1%%filename1%%fileext1%"& goto :demux
if /i "%fileext1%"==".h265" set HDR="%filepath1%%filename1%%fileext1%"& goto :demux

set job=4.3.1& goto :tracks.info

:job.4.3.1

echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.
::--------------------------------------------------------------DEMUX-----------------------------------------------------------------------------------------------------------------------------------------

cd /d "%output_path%"
if "%video.count%"=="2" goto :notmkv
::DEMUX 
if /i  "%ffmpeg_pipe%"=="YES" if not "%THD%"=="y" if not "%container%"=="MP4" if not "%export.subs%"=="YES" if /i "%mux_all_audio%"=="YES" if /i "%mux_all_sub%"=="YES" "%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux - & goto :nodemux

if not "%fileext1%"==".mkv" goto :notmkv
     "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%hdr.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
	 set HDR="%TEMP%hdr.hevc"
	 goto :demux
	 
:notmkv
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
	 if "%video.count%"=="2" echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T2.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"

if "%video.count%"=="2" (
     set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"
	 move "%TEMP%%filename1%.track_%T2.ID%.hevc" "%output_path%"
	 rename "%output_path%%filename1%.track_%T2.ID%.hevc" "%filename1%_EL.hevc"
	 set DTDV=--input-file "%output_path%%filename1%_EL.hevc"
	 set mp4_version=OLD
	 set MBOX=:hdr=none:dvp=7.6& set dv.profile=7& set ID=1
	 goto :MUXER
)
set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"

:demux
"%dovi_tool_path%" demux -i %HDR%
:nodemux

rename "%output_path%BL.hevc" "%filename1%_BL.hevc"
rename "%output_path%EL.hevc" "%filename1%_EL.hevc"
set HDR="%output_path%%filename1%_BL.hevc"

set DTDV=--input-file "%output_path%%filename1%_EL.hevc"
set mp4_version=OLD
set MBOX=:hdr=none:dvp=7.6& set dv.profile=7& set ID=1
goto :MUXER

:jobdtdl4.3
::-----------------------------------------------------------------------------------------end--------------------------------------------------------------------------------------------------------------
:end
echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)

set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set p7_bl=& set p5_bl=& set dropH=& set mlp=& set dts=& set pcm.au=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set trims=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set dv.profile=
set final.vid=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=
set upal2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :LOOP_DTDL
)

setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:tracks.info
Setlocal EnableDelayedExpansion

set temp.path=%filepath%& set temp.name=%filename%& set temp.ext=%fileext%
if "%batch.info%"=="y" set temp.path=%filepath1%& set temp.name=%filename1%& set temp.ext=%fileext1%

:: find the track count and set a variable for the loops
"%mkvmerge_path%" -i "%temp.path%%temp.name%%temp.ext%" > "%TEMP%input.track.count.txt"
for /f %%i in ('python "%~dp0tools\trackcount.py" -i "%TEMP%input.track.count.txt"') do set count2=%%i
if "%count2%"=="0" set count2=20
if "%count2%"=="" set count2=20

:: export input mediainfo
"%mediainfo_path%" "%temp.path%%temp.name%%temp.ext%" --output=JSON > "%TEMP%mediainfo.JSON"
:: set framerate
"%mediainfo_path%" "%temp.path%%temp.name%%temp.ext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul

:: check format/language/forced/delay/channels
echo.
echo \033[92mReading input tracks format/id/language... | "%cmdcolor%"
for /L %%i in (1,1,%count2%) do (
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Format "%TEMP%mediainfo.JSON"`) do set T%%i.Format=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].ID "%TEMP%mediainfo.JSON"`) do set T%%i.ID=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Language "%TEMP%mediainfo.JSON"`) do set T%%i.Lang=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Forced "%TEMP%mediainfo.JSON"`) do set T%%i.Forced=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Delay "%TEMP%mediainfo.JSON"`) do set T%%i.Delay=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Title "%TEMP%mediainfo.JSON"`) do set Title%%i=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Channels "%TEMP%mediainfo.JSON"`) do set T%%i.Channels=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].BitRate "%TEMP%mediainfo.JSON"`) do set T%%i.BitRate=%%~a
)
rmdir /Q /S  "%letterpath%\JQ\" > nul
echo Done.

set T1.Lang=und
:: check for forced flags, fix absent title, remove space from title, check for 768kbps dts tracks, change 2 letters audio tags
for /L %%i in (2,1,%count2%) do (
	 if /i "!Title%%i!"=="forced" set T%%i.forced=Yes& set forced=y
	 if /i "!T%%i.Forced!"=="yes" set T%%i.forced=Yes& set forced=y
	 set Title%%i=!Title%%i: =.!
	 if /i "!Title%%i!"=="null" set Title%%i=
	 if "!T%%i.Lang!"=="null" set T%%i.Lang=und
	 if "!T%%i.Lang!"=="en" set T%%i.Lang=eng
	 if "!T%%i.Lang!"=="fr" set T%%i.Lang=fre
	 if "!T%%i.Lang!"=="it" set T%%i.Lang=ita
	 if "!T%%i.Lang!"=="ru" set T%%i.Lang=rus
	 if "!T%%i.Lang!"=="de" set T%%i.Lang=deu
	 if "!T%%i.Lang!"=="zh" set T%%i.Lang=chi
	 if "!T%%i.Lang!"=="es" set T%%i.Lang=spa
	 if "!T%%i.Lang!"=="ja" set T%%i.Lang=jpn
	 if "!T%%i.Lang!"=="pt" set T%%i.Lang=por
	 if "!T%%i.Lang!"=="ar" set T%%i.Lang=ara
	 if "!T%%i.Lang!"=="hi" set T%%i.Lang=hin
	 if "!T%%i.Lang!"=="bn" set T%%i.Lang=ben
	 if "!T%%i.Lang!"=="ms" set T%%i.Lang=msa
	 if "!T%%i.Lang!"=="ko" set T%%i.Lang=kor
	 if "!T%%i.Lang!"=="tr" set T%%i.Lang=tur
	 if "!T%%i.Lang!"=="vi" set T%%i.Lang=vie
	 if "!T%%i.Lang!"=="th" set T%%i.Lang=tha
	 if "!T%%i.Lang!"=="nl" set T%%i.Lang=nld
	 if "!T%%i.Lang!"=="pl" set T%%i.Lang=pol
	 if "!T%%i.Lang!"=="sv" set T%%i.Lang=swe
	 if "!T%%i.Lang!"=="da" set T%%i.Lang=dan
	 if "!T%%i.Lang!"=="fi" set T%%i.Lang=fin
	 set bitrate%%i=%DDP_bitrate%
	 if "!T%%i.BitRate!"=="768000" set bitrate%%i=768
	 if not "!T%%i.Format!"=="PGS" if not "!T%%i.Format!"=="UTF-8" if "!T%%i.Lang!"=="%langDG%" set main.audio.found=y
)

::removes dot from delay
for /L %%i in (1,1,%count2%) do set T%%i.Delay=!T%%i.Delay:.=!

:: if input doesnt have the language set in the script
if not "%main.audio.found%"=="y" set mux_all_audio=YES& set mux_all_sub=YES

:: exclude some tracks and enable encoding for flac + ts container
for /l %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="HEVC" set T%%i.Format=null
	 if "!T%%i.Format!"=="QuickTime TC" set T%%i.Format=null

)
:: set id to minus one for mkvextract
for /L %%i in (1,1,%count2%) do set /A m.id%%i=%%i-1

:: disable foreign tracks
for /l %%i in (1,1,%count2%) do (
     if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="MLP FBA"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="DTS"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="PCM"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="LPCM"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="E-AC-3"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="AC-3"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="AAC"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_audio%"=="NO" if "!T%%i.Format!"=="FLAC"  if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_sub%"=="NO" if "!T%%i.Format!"=="UTF-8" if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_sub%"=="NO" if "!T%%i.Format!"=="PGS" if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
	 if /i "%mux_all_sub%"=="NO" if "!T%%i.Format!"=="Timed Text" if not "!T%%i.Lang!"=="%langDG%" set T%%i.Format=null
)

:: set tracks to extract
for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="MLP FBA" if "%temp.ext%"==".mkv" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd"& set lossless.input=y& set mkvthd%%i=y& set THD=y& set TSmuxer%%i.Format=A_MLP
	 if "!T%%i.Format!"=="MLP FBA" if not "%temp.ext%"==".mkv" if not "%temp.ext%"==".mp4"  set TSmuxer%%i.Format=A_AC3& set lossless.input=y
	 if "!T%%i.Format!"=="DTS" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts"& set TSmuxer%%i.Format=A_DTS& set lossless.input=y
	 if "!T%%i.Format!"=="PCM" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav"& set TSmuxer%%i.Format=A_LPCM& set lossless.input=y
	 if "!T%%i.Format!"=="LPCM" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav"& set TSmuxer%%i.Format=A_LPCM& set lossless.input=y
	 if "!T%%i.Format!"=="E-AC-3" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3"& set TSmuxer%%i.Format=A_AC3
	 if "!T%%i.Format!"=="AC-3" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3"& set TSmuxer%%i.Format=A_AC3
	 if "!T%%i.Format!"=="AAC" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.aac"& set TSmuxer%%i.Format=A_AAC
	 if "!T%%i.Format!"=="FLAC" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.flac"
     if "!T%%i.Format!"=="UTF-8" set SM%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt"& set t%%i.sub=y& set SRT=y& set TSmuxer%%i.Format=S_TEXT/UTF8
	 if "!T%%i.Format!"=="PGS" set SM%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup"& set t%%i.sub=y& set SRT=y& set TSmuxer%%i.Format=S_HDMV/PGS
	 if "!T%%i.Format!"=="Timed Text" set SM%%i=tracks !m.id%%i!:"%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt"& set t%%i.sub=y& set SRT=y& set TSmuxer%%i.Format=S_TEXT/UTF8
)

:: go to jobs
if "%job%"=="1.1" goto :job.1.1
if "%job%"=="2.1.1" goto :job.2.1.1
if "%job%"=="job.2.1.3" goto :job.2.1.3
if "%job%"=="job.2.1.4" goto :job.2.1.4
if "%job%"=="4.2" goto :job.4.2
if "%job%"=="job.4.1.1" goto :job.4.1.1
if "%job%"=="job.4.1.2" goto :job.4.1.2
if "%job%"=="4.3.1" goto :job.4.3.1
if "%job%"=="job.2.2" goto :job.2.2

if "%job%"=="1.2" goto :job.1.2
if "%job%"=="2.1.2" goto :job.2.1.2
if "%job%"=="job.2.1.5" goto :job.2.1.5
if "%job%"=="job.3.1" goto :job.3.1
if "%job%"=="job.3.2" goto :job.3.2
if "%job%"=="5.batch" goto :5.batch
if "%job%"=="job.5.mp4" goto :job.5.mp4
if "%job.encoder%"=="job8.2" goto :job8.2.start

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:MUXER

:: set variables for final hevc filename and path to handle special characters better
for %%i in (!HDR!) do set FINALname=%%~ni
for %%i in (!HDR!) do set FINALpath=%%~di%%~pi
for %%i in (!HDR!) do set FINALext=%%~xi

if exist "%output_path%%temp.name%.avs" del "%output_path%%temp.name%.avs"
if "%p7_bl%"=="y" if exist "%output_path%BL.hevc" del "%output_path%BL.hevc"

if /i "%container%"=="MP4" goto :MUX.TO.MP4
if /i "%temp.ext%"==".bin" goto ::main.job
if /i "%temp.ext%"==".hevc" goto :main.job
if /i "%temp.ext%"==".h265" goto :main.job

:: EC3 encoding job
if /i "%convert_audio%"=="y" if /i "%bdinput%"=="y" set joba=main.job& goto :MUX.TO.MP4
if /i "%encode_LL%"=="YES" if /i "%bdinput%"=="y" set joba=main.job& goto :MUX.TO.MP4
if /i "%convert_audio%"=="y" if not "%bdinput%"=="y" set joba=main.job& goto :audioCM
if /i "%encode_LL%"=="YES" if not "%bdinput%"=="y" set joba=main.job& goto :audioCM

:main.job

:: extract subs
if /i "%export.subs%"=="NO" goto :no.sub.export
:: export and convert sup to srt to output path
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" (
     copy /y "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" "%output_path%" >Nul
	 if /i "%convert.SUPTOSRT%"=="YES" "%subtitle.edit%" /convert "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" srt
	 if /i "%convert.SUPTOSRT%"=="YES" if not "!T%%i.Forced!"=="Yes" rename "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%temp.name%.%langDG%.t%%i.srt" >Nul
	 if /i "%convert.SUPTOSRT%"=="YES" if "!T%%i.Forced!"=="Yes" rename "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%temp.name%.%langDG%.forced.t%%i.srt" >Nul
	 )
)
:: export srt to output path
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" (
     copy /y "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%output_path%" >Nul
	 if not "!T%%i.Forced!"=="Yes" rename "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%temp.name%.%langDG%.t%%i.srt" >Nul
	 if "!T%%i.Forced!"=="Yes" rename "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%temp.name%.%langDG%.forced.t%%i.srt" >Nul
	 )
)

:no.sub.export
if /i "%MUX%"=="NO" goto :END
if /i "%container%"=="none" goto :END
if /i "%container%"=="TS" goto :MUX.TO.TS
if /i "%container%"=="MKV" goto :MUX.TO.MKV

::---------------------------------------------------------------TS muxing-----------------------------------------------------------------------------------------------------------------------------------------

:MUX.TO.TS

echo.
echo \033[36m        ================== | "%cmdcolor%"
echo \033[36m        -  MUXING TO TS  - | "%cmdcolor%"
echo \033[36m        ================== | "%cmdcolor%"
echo. 
:: add core to truehd if present
for /l %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" (
     echo \033[92m Merging a silent AC3 core with TrueHD for "%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" ... | "%cmdcolor%"
     "%thdmerge_path%" "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" "%AC3.64kbps_path%" "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"
	 echo Done.
     )
)
::convert flac to pcm
for /l %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.flac" (
     echo \033[92m tsMuxer doesnt support FLAC, will convert "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.flac" to PCM... | "%cmdcolor%"
     "%ffmpeg_path%" -drc_scale 0 -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.flac" -c pcm_s24le -y "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav"
	 echo Done.
     )
)

if /i "%input.delay%"=="YES" goto :BDdelayinput
if "%temp.ext%"==".ts"  goto :skip.delay
if "%temp.ext%"==".m2ts" goto :skip.delay
if "%temp.ext%"==".mpls" goto :skip.delay

:BDdelayinput
:: set delay if needed
for /l %%i in (1,1,%count2%) do (
     if not "!T%%i.Delay!"=="0000" if not "!T%%i.Delay!"=="null" set delay%%i=, timeshift=!T%%i.Delay!ms
)
:skip.delay

:: set framerate
"%mediainfo_path%" "%temp.path%%temp.name%%temp.ext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

::MUX to TS
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr  --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%FINALpath%%FINALname%%FINALext%", fps=%FPS%>> "%TEMP%1.meta"
if "%job%"=="4.3.1" echo V_MPEGH/ISO/HEVC, "%output_path%%filename1%_EL.hevc", insertSEI, contSPS, fps=%FPS%>> "%TEMP%1.meta"
if exist "%output_path%%temp.name%_pcm.%mcont%" echo A_LPCM, "%output_path%%temp.name%_pcm.wav"%delay%, lang=%langDG%>> "%TEMP%1.meta"
if exist "%output_path%%temp.name%_EC3.mkv" echo A_AC3, "%output_path%%temp.name%_EC3.mkv"%delay%, track=1, lang=%langDG%>> "%TEMP%1.meta"
if exist "%output_path%%temp.name%_EAE%DELAYB%.eac3" echo A_AC3, "%output_path%%temp.name%_EAE%DELAYB%.eac3"%delay%, lang=%langDG%>> "%TEMP%1.meta"
if exist "%temp.path%%temp.name%.ec3" echo A_AC3, "%temp.path%%temp.name%.ec3", lang=%langDG%>> "%TEMP%1.meta"
if exist "%temp.path%%temp.name%.ac3" echo A_AC3, "%temp.path%%temp.name%.ac3", lang=%langDG%>> "%TEMP%1.meta"

:: set audio and subtitles for muxing
for /L %%i in (2,1,%count2%) do (
     if exist "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3" echo A_AC3, "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"!delay%%i!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" echo A_LPCM, "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav"!delay%%i!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if exist "%TEMP%pcm%%i.wav" echo A_LPCM, "%TEMP%pcm%%i.wav"!delay%%i!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if exist "%TEMP%lossy%%i.ec3" echo A_AC3, "%TEMP%lossy%%i.ec3"!delay%%i!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
     if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" if not "!T%%i.Format!"=="FLAC" if not "!mkvthd%%i!"=="y" echo !TSmuxer%%i.Format!, "%temp.path%%temp.name%%temp.ext%"!delay%%i!, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
     if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%temp.path%%temp.name%%temp.ext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%temp.path%%temp.name%%temp.ext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%temp.path%%temp.name%%temp.ext%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)

::mux to ts and delete files if succesfull
"%tsmuxer_path%" "%TEMP%1.meta" "%output_path%%temp.name%_DV.ts"
if ["%errorlevel%"]==["0"] set muxing.succes=y

for /L %%i in (2,1,%count2%) do (
     if "%muxing.succes%"=="y" (
	 if exist "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3" del "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"	 
     )
)

     if /i "%dualinject%"=="y" if exist "%output_path%%filename%_HDR10plus_injected.hevc" del "%output_path%%filename%_HDR10plus_injected.hevc"
	 if exist "%output_path%%temp.name%_pcm.%mcont%" del "%output_path%%temp.name%_pcm.%mcont%"
	 if exist "%output_path%%temp.name%_EC3.mkv" del "%output_path%%temp.name%_EC3.mkv"
	 if exist "%output_path%%temp.name%_EAE%DELAYB%.eac3" del "%output_path%%temp.name%_EAE%DELAYB%.eac3"
	 if exist "%FINALpath%%FINALname%%FINALext%" del "%FINALpath%%FINALname%%FINALext%"
goto :END

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:MUX.TO.MKV

echo.
echo \033[36m        ================= | "%cmdcolor%"
echo \033[36m        - MUXING TO MKV - | "%cmdcolor%"
echo \033[36m        ================= | "%cmdcolor%"
echo. 

if /i "%input.delay%"=="YES" goto :BDdelayinput
if "%temp.ext%"==".ts"  goto :skip.delay
if "%temp.ext%"==".m2ts" goto :skip.delay
if "%temp.ext%"==".mpls" goto :skip.delay
:BDdelayinput

for /L %%i in (1,1,%count2%) do (
     if not "!T%%i.Delay!"=="0000" if not "!T%%i.Delay!"=="null" set delay%%i=--sync 0:!T%%i.Delay!
)

:skip.delay

:: check and set frame rate
"%mediainfo_path%" "%temp.path%%temp.name%%temp.ext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
set properfps=n

if "%FPS%"=="23.974" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.975" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.979" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.978" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.977" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.976" set FPS=24000/1001p& set properfps=y
if "%FPS%"=="24.000" set FPS=24p& set properfps=y
if "%FPS%"=="25.000" set FPS=25p& set properfps=y
if "%FPS%"=="29.970" set FPS=30000/1001p& set properfps=y
if "%FPS%"=="30.000" set FPS=30p& set properfps=y
if "%FPS%"=="50.000" set FPS=50p& set properfps=y
if "%FPS%"=="59.940" set FPS=60000/1001p& set properfps=y
if "%FPS%"=="60.000" set FPS=60p& set properfps=y
if "%properfps%"=="n" set FPS=24000/1001p

if /i "%removeDialogueNorm%"=="YES" set rem.dailn=--remove-dialog-normalization-gain 0
set PCM=& set DDP=
::encoded EC3 or PCM/flac or external audio
if exist "%temp.path%%temp.name%.ec3" set DDP2=--language 0:%langDG% --track-name 0:DDP --compression 0:none --default-track-flag 0:yes %rem.dailn% ^"^(^" ^"%temp.path%%temp.name%.ec3^" ^"^)^"
if exist "%temp.path%%temp.name%.ac3" set DDP3=--language 0:%langDG% --track-name 0:DD --compression 0:none --default-track-flag 0:yes %rem.dailn% ^"^(^" ^"%temp.path%%temp.name%.ac3^" ^"^)^"
if exist "%output_path%%temp.name%_EC3.mkv" set DDP=--compression 0:none --default-track-flag 0:yes ^"^(^" ^"%output_path%%temp.name%_EC3.mkv^" ^"^)^"
if exist "%output_path%%temp.name%_pcm.%mcont%" set PCM=--language 0:%langDG% --track-name 0:Lossless --compression 0:none %delay% --default-track-flag 0:yes ^"^(^" ^"%output_path%%temp.name%_pcm.%mcont%^" ^"^)^"
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%pcm%%i.%mcont%" set PCM=--language 0:!T%%i.Lang! --track-name 0:Lossless --compression 0:none !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%pcm%%i.%mcont%^" ^"^)^"
     if exist "%TEMP%lossy%%i.ec3" set DDP=--language 0:!T%%i.Lang! --track-name 0:DDP --compression 0:none !delay%%i! %rem.dailn% ^"^(^" ^"%TEMP%lossy%%i.ec3^" ^"^)^" 
)

::-------------------------------------------------------select main subs-----------------------------------------------------------------------

if /i "%mux_all_sub%"=="YES" goto :mux.allsubs
set NOSUB=--no-subtitles

for /L %%i in (2,1,%count2%) do (
if "!T%%i.Forced!"=="Yes" set tforced%%i=--forced-display-flag 0:yes --default-track-flag 0:yes --track-name ^"0:FORCED^"
)
for /L %%i in (2,1,%count2%) do (
     if exist "%TEMP%%temp.name%.%langDG%.forced.t%%i.sup" (
	 rename "%TEMP%%temp.name%.%langDG%.forced.t%%i.sup" "sub%%i.sup"
     set SF%%i=--language 0:%langDG% --forced-display-flag 0:yes --default-track-flag 0:yes --track-name ^"0:FORCED^" ^"^(^" ^"%TEMP%sub%%i.sup^" ^"^)^"
	 )
)
for /L %%i in (2,1,%count2%) do (
     if exist "%TEMP%%temp.name%.%langDG%.forced.t%%i.srt" (
	 rename "%TEMP%%temp.name%.%langDG%.forced.t%%i.srt" "sub%%i.srt"
     set SF%%i=--sub-charset 0:UTF-8 --language 0:%langDG% --forced-display-flag 0:yes --default-track-flag 0:yes --track-name ^"0:FORCED^" ^"^(^" ^"%TEMP%sub%%i.srt^" ^"^)^"
	 )
)
for /L %%i in (2,1,%count2%) do (
     if exist "%TEMP%%temp.name%.%langDG%.t%%i.sup" (
	 rename "%TEMP%%temp.name%.%langDG%.t%%i.sup" "sub%%i.sup"
     set SF%%i=--language 0:%langDG% --default-track-flag 0:no ^"^(^" ^"%TEMP%sub%%i.sup^" ^"^)^"
	 )
)
for /L %%i in (2,1,%count2%) do (
     if exist "%TEMP%%temp.name%.%langDG%.t%%i.srt" (
	 rename "%TEMP%%temp.name%.%langDG%.t%%i.srt" "sub%%i.srt"
     set SF%%i=--sub-charset 0:UTF-8 --language 0:%langDG% --default-track-flag 0:no ^"^(^" ^"%TEMP%sub%%i.srt^" ^"^)^"
	 )
)
for /L %%i in (2,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" "sub%%i.sup"
	 set SF%%i=--language 0:%langDG% !tforced%%i! ^"^(^" ^"%TEMP%sub%%i.sup^" ^"^)^"
	 )
)
for /L %%i in (2,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "sub%%i.srt"
	 set SF%%i=--language 0:%langDG% !tforced%%i! ^"^(^" ^"%TEMP%sub%%i.srt^" ^"^)^"
	 )
)
::-------------------------------------------------------select main audio-----------------------------------------------------------------------

:mux.allsubs
if /i  "%convert_audio%"=="y" if /i "%keep_lossless%"=="NO" set NOAUDIO=--no-audio& goto :mux.allaudio
if /i "%mux_all_audio%"=="YES" goto :mux.allaudio
set NOAUDIO=--no-audio

if /i "%keep_lossless%"=="NO" goto :skiplosslessaudio
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3+thd" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3+thd" "au%%i.ac3+thd"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%au%%i.ac3+thd^" ^"^)^"
	 )
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" "au%%i.thd"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%au%%i.thd^" ^"^)^"
	 )
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" "au%%i.dts"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%au%%i.dts^" ^"^)^"
	 )
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" "au%%i.wav"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%au%%i.wav^" ^"^)^"
	 )
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.flac" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.flac" "au%%i.flac"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%au%%i.flac^" ^"^)^"
	 )
)
:skiplosslessaudio
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3" "au%%i.ac3"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no %rem.dailn% ^"^(^" ^"%TEMP%au%%i.ac3^" ^"^)^"
	 )
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3" "au%%i.ec3"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no %rem.dailn% ^"^(^" ^"%TEMP%au%%i.ec3^" ^"^)^"
	 )
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.aac" (
	 rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.aac" "au%%i.aac"
     set AE%%i=--audio-tracks 0 --language 0:%langDG% !delay%%i! --default-track-flag 0:no ^"^(^" ^"%TEMP%au%%i.aac^" ^"^)^"
	 )
)
::----------------------------------------------------------------MUX----------------------------------------------------------------------------

:mux.allaudio

"%mkvmerge_path%" --output ^"%output_path%%temp.name%_DV.mkv^" %mkvtoolnix_settings% --default-duration 0:%FPS% ^"^(^" ^"%FINALpath%%FINALname%%FINALext%^" ^"^)^" %PCM% --no-video %NOAUDIO% %NOSUB% ^"^(^" ^"%temp.path%%temp.name%%temp.ext%^" ^"^)^" %AE1% %AE2% %AE3% %AE4% %AE5% %AE6% %AE7% %AE8% %AE9% %AE10% %AE11% %AE12% %AE13% %AE14% %AE15% %AE16% %AE17% %AE18% %AE19% %AE20% %DDP% %DDP2% %DDP3% %SF1% %SF2% %SF3% %SF4% %SF5% %SF6% %SF7% %SF8% %SF9% %SF10% %SF11% %SF12% %SF13% %SF14% %SF15% %SF16% %SF17% %SF18%
if ["%errorlevel%"]==["0"] set muxing.succes=y

for /L %%i in (2,1,%count2%) do (
     if "%muxing.succes%"=="y" (
     	 if exist "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3" del "%output_path%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"	 
     )
)
	 if exist "%output_path%%temp.name%_pcm.%mcont%" del "%output_path%%temp.name%_pcm.%mcont%"
	 if exist "%output_path%%temp.name%_EC3.mkv" del "%output_path%%temp.name%_EC3.mkv"
	 if exist "%output_path%%temp.name%_EAE%DELAYB%.eac3" del "%output_path%%temp.name%_EAE%DELAYB%.eac3"
	 if exist "%FINALpath%%FINALname%%FINALext%" del "%FINALpath%%FINALname%%FINALext%"
     if /i "%dualinject%"=="y" if exist "%output_path%%filename%_HDR10plus_injected.hevc" del "%output_path%%filename%_HDR10plus_injected.hevc"
goto :END

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:MUX.TO.MP4

echo.
echo \033[36m        ================= | "%cmdcolor%"
echo \033[36m        - MUXING TO MP4 - | "%cmdcolor%"
echo \033[36m        ================= | "%cmdcolor%"
echo. 
:: if /i "%convert_audio%"=="n" goto :skip.lossless
if /i "%force.mp4muxer%"=="YES" set keep_lossless=NO
if /i "%encode_DDP_MP4%"=="NO" goto :skip.lossless

if /i "%input.delay%"=="YES" goto :BDdelayinput
if /i "%temp.ext%"==".ts"  goto :skip.delay
if /i "%temp.ext%"==".m2ts" goto :skip.delay
if /i "%temp.ext%"==".mpls" goto :skip.delay

:BDdelayinput
::remove dot from delay variables
for /L %%i in (1,1,%count2%) do set T%%i.Delay=!T%%i.Delay:.=!

:skip.delay
"%mediainfo_path%" "%temp.path%%temp.name%%temp.ext%" --output=Audio;%%Format%% --LogFile="%TEMP%audio.format.txt" >Nul
findstr /c:"MLP" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm=n
if "%mlp%"=="n" if "%dts%"=="n" if "%pcm%"=="n"  goto :skip.lossless

set encodeEAE=n
::check for 8 channels audio
for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Channels!"=="8" set ch%%i=y& set encodeEAE=y& set ffmpeg_channels=-channel_layout 5.1
     if "!T%%i.Channels!"=="Object Based" set ch%%i=y& set encodeEAE=y& set ffmpeg_channels=-channel_layout 5.1
)

for /L %%i in (1,1,%count2%) do (
if /i "%encode_7.1%"=="NO" set ch%%i=n
)

if "%lossless.input%"=="y" if "%encodeEAE%"=="y" (
	 xcopy "%EAE_path%" "%output_path%\EAE" /E /I /Y > nul
     cd "%output_path%\EAE" & start "" "%EAE%"
)
for /L %%i in (1,1,%count2%) do (
if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3+thd" rename "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3+thd" "au%%i.ac3+thd"
)

::THD encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
	 if exist "%TEMP%au%%i.ac3+thd" "%mkvmerge_path%" --output ^"%TEMP%au%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%au%%i.ac3+thd^" ^"^)^"
	 if exist "%TEMP%au%%i.ac3+thd" "%mkvextract_path%" "%TEMP%au%%i.mkv" tracks 0:"%TEMP%au%%i.thd"
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%au%%i.ac3+thd" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%TEMP%au%%i.thd" -map 0:0 -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)
:: encode 7.1
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%au%%i.ac3+thd" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%TEMP%lossy%%i.eac3"
)

::encode 5.1
for /L %%i in (1,1,%count2%) do ( 
	 if exist "%TEMP%au%%i.ac3+thd" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%TEMP%au%%i.thd" -map 0:0 -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%TEMP%EC3%%i.mkv"
)

for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" -map 0:0 -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" -map 0:0 -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%TEMP%EC3%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%TEMP%lossy%%i.eac3"
)

::DTS encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" if "!ch%%i!"=="y" if not "!T%%i.BitRate!"=="768000" "%ffmpeg_path%" -drc_scale 0 -y -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" -map 0:0 -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" -map 0:0 -c:a eac3 -b:a !bitrate%%i!k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%TEMP%EC3%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%TEMP%lossy%%i.eac3"
)

::PCM encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" -map 0:0 -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" -map 0:0 -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%TEMP%EC3%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%TEMP%lossy%%i.eac3"
)

::fix ec3 or extract it from MKV---------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do ( 
	 if exist "%TEMP%EC3%%i.mkv" "%mkvextract_path%" "%TEMP%EC3%%i.mkv" tracks 0:"%TEMP%lossy%%i.ec3"
	 if exist "%TEMP%EC3%%i.mkv" if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
	 if exist "%TEMP%EC3%%i.mkv" set A%%i=-add "%TEMP%lossy%%i.ec3#audio:lang=!T%%i.Lang!:name=DDP!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%lossy%%i.ec3" --media-lang !T%%i.Lang!
)
for /L %%i in (1,1,%count2%) do ( 
	 if exist "%TEMP%lossy%%i.eac3" (
	 rename "%TEMP%lossy%%i.eac3" lossy%%i.ec3
	 if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
	 set A%%i=-add "%TEMP%lossy%%i.ec3#audio:lang=!T%%i.Lang!:name=DDP!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%lossy%%i.ec3" --media-lang !T%%i.Lang!
	 )
)
for /L %%i in (1,1,%count2%) do (
     if "%temp.ext%"==".mkv" if exist "%TEMP%lossy%%i.ec3" if not "!T%%i.Delay!"=="0000" if not "!T%%i.Delay!"=="null" "%delaycut%" -delay !T%%i.Delay! -i "%TEMP%lossy%%i.ec3" -o "%TEMP%lossy%%i.fixed.ec3" & set A%%i=-add "%TEMP%lossy%%i.fixed.ec3#audio:lang=!T%%i.Lang!:name=DDP!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%A%%i.fixed.ec3" --media-lang !T%%i.Lang!
)

:skip.lossless
if "%encodeEAE%"=="y" (
	 taskkill /F /IM EasyAudioEncoder.exe > nul
	 cd /d "%output_path%" & rmdir /Q /S "%output_path%EAE"
)

::encode pcm and mux lossless audio--------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do ( 
     if /i "%encode_LL%"=="YES" if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" "%ffmpeg_path%" -drc_scale 0 -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" -map 0:0 -c %llcodec% "%TEMP%pcm%%i.%mcont%"& set ALL%%i=-add "%TEMP%pcm%%i.%mcont%#audio:lang=!T%%i.Lang!:name=%mname%!FORCED%%i!"
)
for /L %%i in (1,1,%count2%) do ( 
     if /i "%encode_LL%"=="YES" if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" "%ffmpeg_path%" -drc_scale 0 -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" -map 0:0 -c %llcodec% "%TEMP%pcm%%i.%mcont%"& set ALL%%i=-add "%TEMP%pcm%%i.%mcont%#audio:lang=!T%%i.Lang!:name=%mname%!FORCED%%i!"
)

if "%joba%"=="main.job" goto :main.job

for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" if /i "%keep_lossless%"=="YES" "%ffmpeg_path%" -y -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.thd" -map 0:0 -c copy -strict -2 "%TEMP%lossless%%i.mp4" & set AL%%i=-add "%TEMP%lossless%%i.mp4#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%au%%i.thd"	if /i "%keep_lossless%"=="YES" "%ffmpeg_path%" -y -i "%TEMP%au%%i.thd" -map 0:0 -c copy -strict -2 "%TEMP%lossless%%i.mp4" & set AL%%i=-add "%TEMP%lossless%%i.mp4#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" if /i "%keep_lossless%"=="YES" "%ffmpeg_path%" -y -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.dts" -map 0:0 -c copy "%TEMP%lossless%%i.mp4" & set AL%%i=-add "%TEMP%lossless%%i.mp4#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"
)
for /L %%i in (1,1,%count2%) do (
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" if /i "%keep_lossless%"=="YES" "%ffmpeg_path%" -y -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.wav" -map 0:0 -c copy "%TEMP%lossless%%i.mov" & set AL%%i=-add "%TEMP%lossless%%i.mov#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"
)

::Lossy------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3"	(
	 if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
	 set A%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3" --media-lang !T%%i.Lang!
	 if "%temp.ext%"==".mkv" if not "!T%%i.Delay!"=="0000" if not "!T%%i.Delay!"=="null" "%delaycut%" -delay !T%%i.Delay! -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ec3" -o "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.fixed.ec3" & set A%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.fixed.ec3#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.fixed.ec3" --media-lang !T%%i.Lang!
    )
)

for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3"	(
	 if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
	 set A%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3" --media-lang !T%%i.Lang!
	 if "%temp.ext%"==".mkv" if not "!T%%i.Delay!"=="0000" if not "!T%%i.Delay!"=="null" "%delaycut%" -delay !T%%i.Delay! -i "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.ac3" -o "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.fixed.ac3" & set A%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.fixed.ac3#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.fixed.ac3" --media-lang !T%%i.Lang!
    )
)
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.aac"	(
	 if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
	 set A%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.aac#audio:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"& set LOSSY%%i=--input-file "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.aac" --media-lang !T%%i.Lang!
	    )
)

::subtitles
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" (
	 if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
     set SUB%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt#subtitle:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"
	 if /i "%export.subs%"=="YES" copy /y "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%output_path%" > nul
	 )
)
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" (
	 if /i "%convert.SUPTOSRT%"=="YES" %subtitle.edit% /convert "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.sup" srt
	 if /i "%convert.SUPTOSRT%"=="YES" if "!T%%i.Forced!"=="Yes" set FORCED%%i=:txtflags=0xC0000000
     if /i "%convert.SUPTOSRT%"=="YES" set SUB%%i=-add "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt#subtitle:lang=!T%%i.Lang!:name=!Title%%i!!FORCED%%i!"
	 if /i "%convert.SUPTOSRT%"=="YES" if /i "%export.subs%"=="YES" copy /y "%TEMP%%temp.name%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%output_path%" > nul
	 )
)

if exist "%temp.path%%temp.name%.srt" (
     set SRT=y
	 set SUBext=-add "%temp.path%%temp.name%.srt#subtitle:lang=%langDG%:name=SRT"
)

if exist "%temp.path%%temp.name%.ac3" (
	 set AUext=-add "%temp.path%%temp.name%.ac3#audio:lang=%langDG%:name=DD"
	 set AUextMP4=--input-file "%temp.path%%temp.name%.ac3" --media-lang %langDG%
)
if exist "%temp.path%%temp.name%.ec3" (
	 set AUext=-add "%temp.path%%temp.name%.ec3#audio:lang=%langDG%:name=DDP"
	 set AUextMP4=--input-file "%temp.path%%temp.name%.ec3" --media-lang %langDG%
)
if exist "%temp.path%%temp.name%.aac" (
	 set AUext=-add "%temp.path%%temp.name%.aac#audio:lang=%langDG%:name=AAC"
	 set AUextMP4=--input-file "%temp.path%%temp.name%.aac" --media-lang %langDG%
)

if "%temp.ext%"==".mp4" set SRT=n
if /i "%force.mp4muxer%"=="YES" set SRT=n& set lossless.input=n
for /L %%i in (1,1,%count2%) do (
     if "%SRT%"=="y" set LOSSY%%i=
)
if "%SRT%"=="y" set AUextMP4=
if /i "%MUX%"=="NO" goto :END
if /i "%mp4_version%"=="OLD" goto :oldmuxer

::check framerate
"%mediainfo_path%" "%temp.path%%temp.name%%temp.ext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
set properfps=n

if "%FPS%"=="23.974" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.975" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.979" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.978" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.977" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.976" set FPS=24000/1001p& set properfps=y
if "%FPS%"=="24.000" set FPS=24p& set properfps=y
if "%FPS%"=="25.000" set FPS=25p& set properfps=y
if "%FPS%"=="29.970" set FPS=30000/1001p& set properfps=y
if "%FPS%"=="30.000" set FPS=30p& set properfps=y
if "%FPS%"=="50.000" set FPS=50p& set properfps=y
if "%FPS%"=="59.940" set FPS=60000/1001p& set properfps=y
if "%FPS%"=="60.000" set FPS=60p& set properfps=y
if "%properfps%"=="n" set FPS=24000/1001p

if not "%lossless.input%"=="y" if not "%SRT%"=="y" if /i "%forcemp4box2%"=="NO" if /i "%mp4_version%"=="NEW" (
echo \033[92m Muxing into a DoVi MP4 file. Be patient, it can take a while. 40min^+ on slow HDD! | "%cmdcolor%"
     "%mp4muxerNEW_path%" --dv-profile %dv.profile% --dv-bl-compatible-id %ID% --input-file %HDR% %AUextMP4% %LOSSY1% %LOSSY2% %LOSSY3% %LOSSY4% %LOSSY5% %LOSSY6% %LOSSY7% %LOSSY8% %LOSSY9% %LOSSY10% %LOSSY11% %LOSSY12% %LOSSY13% %LOSSY14% %LOSSY15% %LOSSY16% %LOSSY17% %LOSSY18% %LOSSY19% %LOSSY20% --output-file "%output_path%%temp.name%_DV.mp4"
     if ["%errorlevel%"]==["0"] if not "%raw%"=="y" del %HDR%
	 goto :END
)

:: mux subtitles
"%mp4box2_path%" -add %HDR%:name=%MBOX%:fps=%FPS% %AUext% %ALL1% %A1% %AL1% %ALL2% %A2% %AL2% %ALL3% %A3% %AL3% %ALL4% %A4% %AL4% %ALL5% %A5% %AL5% %ALL6% %A6% %AL6% %ALL7% %A7% %AL7% %ALL8% %A8% %AL8% %ALL9% %A9% %AL9% %ALL10% %A10% %AL10% %subtitles_path% %SUBext% %SUB1% %SUB2% %SUB3% %SUB4% %SUB5% %SUB6% %SUB7% %SUB8% %SUB9% %SUB10% %SUB11% %SUB12% %SUB13% %SUB14% %SUB15% %SUB16% %SUB17% %SUB18% %SUB19% %SUB20% %SUB21% %SUB22% %SUB23% %SUB24% %SUB25% %SUB26% %SUB27% %SUB28% %SUB29% %SUB30% %SUB31% %SUB32% %SUB33% %SUB34% %SUB35% %SUB36% %SUB37% %SUB38% %SUB39% %SUB40% %SUB41% %SUB42% %SUB43% %SUB44% %SUB45% %SUB46% %SUB47% %SUB48% %SUB49% %SUB50% -tmp "%TEMP:~0,-1%" -brand mp43isom -ab dby1 "%output_path%%temp.name%_DV.mp4"
if ["%errorlevel%"]==["0"] if not "%raw%"=="y" del %HDR%

goto :END

::--------------------------------------------------------------old muxer-----------------------------------------------------------------------------------------------------------------------

:oldmuxer

if "%lossless.input%"=="y" goto :muxlossless
if  "%SRT%"=="y" goto :muxlossless
      echo \033[92m Muxing into a DoVi MP4 file. Be patient, it can take a while. 40min^+ on slow HDD! | "%cmdcolor%"
     "%mp4muxer_path%" --dv-profile %dv.profile% --dv-bl-compatible-id %ID% --input-file %HDR% %DTDV% %AUextMP4% %LOSSY1% %LOSSY2% %LOSSY3% %LOSSY4% %LOSSY5% %LOSSY6% %LOSSY7% %LOSSY8% %LOSSY9% %LOSSY10% %LOSSY11% %LOSSY12% %LOSSY13% %LOSSY14% %LOSSY15% %LOSSY16% %LOSSY17% %LOSSY18% %LOSSY19% %LOSSY20% --output-file "%output_path%%temp.name%_DV.mp4"
     if ["%errorlevel%"]==["0"] if not "%raw%"=="y" del %HDR%
	 goto :END
:muxlossless

echo \033[92m Muxing into a DoVi MP4 file. Be patient, it can take a while. 40min^+ on slow HDD! | "%cmdcolor%"
"%mp4muxer_path%" --dv-profile %dv.profile% --dv-bl-compatible-id %ID% --input-file %HDR% %DTDV% --output-file "%TEMP%temp.mp4"

:: mux subtitles
"%mp4box_path%" -add "%TEMP%temp.mp4" %AUext% %ALL1% %A1% %AL1% %ALL2% %A2% %AL2% %ALL3% %A3% %AL3% %ALL4% %A4% %AL4% %ALL5% %A5% %AL5% %ALL6% %A6% %AL6% %ALL7% %A7% %AL7% %ALL8% %A8% %AL8% %ALL9% %A9% %AL9% %ALL10% %A10% %AL10% %subtitles_path% %SUBext% %SUB1% %SUB2% %SUB3% %SUB4% %SUB5% %SUB6% %SUB7% %SUB8% %SUB9% %SUB10% %SUB11% %SUB12% %SUB13% %SUB14% %SUB15% %SUB16% %SUB17% %SUB18% %SUB19% %SUB20% %SUB21% %SUB22% %SUB23% %SUB24% %SUB25% %SUB26% %SUB27% %SUB28% %SUB29% %SUB30% %SUB31% %SUB32% %SUB33% %SUB34% %SUB35% %SUB36% %SUB37% %SUB38% %SUB39% %SUB40% %SUB41% %SUB42% %SUB43% %SUB44% %SUB45% %SUB46% %SUB47% %SUB48% %SUB49% %SUB50% -tmp "%TEMP:~0,-1%" -brand mp43isom -ab dby1 "%output_path%%temp.name%_DV.mp4"
if ["%errorlevel%"]==["0"] if not "%raw%"=="y" del %HDR%

:END

:: go to jobs
if "%job%"=="1.2" goto :job.1.2.done
if "%job%"=="job.2.1.5" goto :job.2.1.5.done
if "%job%"=="job.3.1" goto :job.3.1.done
if "%job%"=="job.3.2" goto :job.3.2.done
if "%job%"=="job.5.mp4" goto :job.5.mp4.done
if "%job%"=="2.1.1" goto :job.2.1.1.done
if "%job%"=="4.3.1" goto :jobdtdl4.3
if "%job%"=="job.2.2" goto :job2.2.done

if /i "%fileext_dv%"==".json" goto :end
if "%job%"=="job.2.1.3" goto :end
if "%job%"=="4.2" goto :end
if "%job%"=="job.4.1.2" goto :end
if "%job%"=="job.4.1.1" goto :end
if "%job%"=="4.3.1" goto :end
if "%joba%"=="main.job" goto :end
if "%job.encoder%"=="job8.2" goto :end
if [%RPU%]==[] goto :end

set cmdcolortype=& set colorsoft=&set cmdcolortype2=& set colorsoft2=&set cmdcolortype3=& set colorsoft3=
:: rpu summary
"%dovi_tool_path%" info --input %RPU% -f %frame.to.read_path%
"%dovi_tool_path%" info --input %RPU% -f %frame.to.read_path% > "%TEMP%temp.rpu.json"
"%dovi_tool_path%" export -i %RPU% -o "%TEMP%full.json"
"%dovi_tool_path%" export -i %RPU% -d scenes="%TEMP%scene.cuts.txt"

type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"
if "%left%"==" =" set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.& set cmdcolortype=\033[31m& set colorsoft=^| "%cmdcolor%"

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t82=600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t83=1000 nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y

set first_line=
set second_line=
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^1:"') do (
    set "first_line=%%a"
)
for /f "delims=" %%a in ('type "%TEMP%scene.cuts.txt" ^| findstr /n "^" ^| findstr "^2:"') do (
    set "second_line=%%a"
)

if "%first_line%"=="1:0" (
    set scenecuts0=YES (good^)
) else (
    set scenecuts0=NO& set cmdcolortype2=\033[31m& set colorsoft2=^| "%cmdcolor%"
)

set consecutiveSC=NO (good)
if "%first_line%"=="1:0" if "%second_line%"=="2:1" set consecutiveSC=YES& set cmdcolortype3=\033[31m& set colorsoft3=^| "%cmdcolor%"

if /i "%validate_metadata%"=="YES" (
     "%RPU.to.XML%" convert %RPU% "%TEMP%%temp.name%_DV.xml" > nul
	 "%metafier_path%" --validate --with-lift "%TEMP%%temp.name%_DV.xml"
)

"%dovi_tool_path%" info -s %RPU%
if "%scenecuts0%"=="NO" echo %cmdcolortype2%  WARNING: 1st Frame is not a Scene Cut%colorsoft2%
if "%consecutiveSC%"=="YES" echo %cmdcolortype3%  WARNING: Consecutive Scene Cuts%colorsoft3%

:end
:: delete temp files
if not "%DEL_temp%"=="NO"   echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
::reset variables
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set left=& set top=& set right=& set bottom=& set DVprofile=
set cropped.input=& set EditL5=& set autoL5=& set crop_path=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=
set MDL.min_path=& set final.vid=& set editL5_path=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=&set filename=&set filepath=&set fileext=& set convert_audio=n
::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)

if "%properfps%"=="n" echo \033[31m WARNING. Input frame rate seems messed up, it was forced to 23.976 but you should fix it in 9-2...| "%cmdcolor%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ----------------------------------------------------------------------Batch..muxer-----------------------------------------------------------------------------------------------------------------------
:MODE.B
echo.
echo --------------------------------------------------------------------------------------
if /i "%container%"=="TS" ( 
     echo -- Will add a silent ac3 core to THD if present (may fail ^in some rare occasion^)
)
if /i "%container%"=="MP4" if /i "%mp4_version%"=="OLD" echo -- Delay for lossless audio not supported
if /i "%container%"=="MP4" if /i "%mp4_version%"=="NEW" echo -- DOES NOT WORK on older device such as LG 2016-2018 TVs (change the mp4 version to old)
if /i "%container%"=="MP4" if /i "%mp4_version%"=="NEW" echo -- 7.1 DDP disabled when latest mp4muxer is enabled (mp4box doesnt work with EAE 7.1 files)
echo -- Input can be a folder with files or a single file (p7 p8 p5) (MKV/TS/M2TS/HEVC)
echo -- Does not support H264, only H265 is supported
echo --------------------------------------------------------------------------------------
echo.
set batch.info=y

setlocal enabledelayedexpansion
:: folder with files input
echo Drag and drop folder with files or a single file and press enter...
set /p folder=

set count2=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count1+=1"
    set "file!count1!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count1%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count1%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
)


if /i "%container%"=="MKV" goto :loop.TS
if /i "%encode_DDP%"=="NO" goto :loop.TS
if /i "%container%"=="MP4" goto :loop.TS
set convert_audio=n

:: check for lossless audio
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Audio;%%Format%% --LogFile="%output_path%audio.format.txt" >Nul
findstr /c:"MLP" "%output_path%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%output_path%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%output_path%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm=n

if exist "%output_path%audio.format.txt" del "%output_path%audio.format.txt"
if "%mlp%"=="n" if "%dts%"=="n" if "%pcm%"=="n"  goto :loop.TS

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
:: check audio tracks info
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath1%%filename1%%fileext1%"

echo.
:: user prompt for audio EC3 encoding
echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n

::-----------------------------------------------------------------------LOOP------------------------------------------------------------------------------------------------------------
:loop.TS
if exist "%temp_folder%temp.folder66" rmdir /Q /S "%temp_folder%temp.folder66"
::make temp folder
MD "%temp_folder%temp.folder66"
set TEMP=%temp_folder%temp.folder66\

if /i "%same_input_output%"=="YES" set output_path=%filepath1%
if /i "%container%"=="MP4" goto :loop.MP4.old

::check if BL has keywords in the filename
echo "%filename1%" > "%TEMP%filename.txt"
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"FRENCH" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set lang=French& set langDG=fra

echo processing..."%filename1%%fileext1%"

if /i "%container%"=="TS" goto :mux.ts

::------------------------------------------------------------------MKV-----------------------------------------------------------------------------
if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".mov" goto :end

:: check and set frame rate
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
set properfps=n
if "%FPS%"=="23.974" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.975" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.979" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.978" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.977" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.976" set FPS=24000/1001p& set properfps=y
if "%FPS%"=="24.000" set FPS=24p& set properfps=y
if "%FPS%"=="25.000" set FPS=25p& set properfps=y
if "%FPS%"=="29.970" set FPS=30000/1001p& set properfps=y
if "%FPS%"=="30.000" set FPS=30p& set properfps=y
if "%FPS%"=="50.000" set FPS=50p& set properfps=y
if "%FPS%"=="59.940" set FPS=60000/1001p& set properfps=y
if "%FPS%"=="60.000" set FPS=60p& set properfps=y
if "%properfps%"=="n" set FPS=24000/1001p

"%mkvmerge_path%" --output ^"%output_path%%filename1%_NEW.mkv^" --compression 0:none --default-duration 0:%FPS% ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^"
echo.
if "%properfps%"=="n" echo At least one Input frame rate seems messed up, it was forced to 23.976 but you might want to fix it in 9-2...
goto :end

:mux.ts
if not "%fileext1%"==".mkv" if not "%fileext1%"==".mp4" goto :end

set job=5.batch& goto :tracks.info

::--------------------------------------------------------------------demux if THD mkv input----------------------------------------------------------------------------------------
:5.batch

if not "%THD%"=="y" goto :skipdemux

"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38%
set HDR="%TEMP%BL.hevc"

:: add core to truehd if present
for /l %%i in (1,1,%count2%) do (
     if exist "%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd" (
     echo merging a silent AC3 core with TrueHD for "%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd" ...
     "%thdmerge_path%" "%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd" "%AC3.64kbps_path%" "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"
     )
)

:skipdemux

if /i "%convert_audio%"=="y" set job=batch5.EC3& goto :audioCM

:batch5.EC3
::------------------------------------------------------------------------------------mux-----------------------------------------------------------------------------

if /i "%fileext1%"==".ts"  goto :skip.delay
if /i "%fileext1%"==".m2ts" goto :skip.delay

::remove dot from delay variables
for /L %%i in (1,1,%count2%) do set T%%i.Delay=!T%%i.Delay:.=!
:: set delay if needed
for /l %%i in (1,1,%count2%) do (
  if not "!T%%i.Delay!"=="0000" (
    set "delay%%i=, timeshift=!T%%i.Delay!ms"
  )
)

:skip.delay
:: set framerate
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

::MUX to TS
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr  --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=1, fps=%FPS% >> "%TEMP%1.meta"
::add encoded audio
if exist "%output_path%%filename1%_pcm.%mcont%" echo A_LPCM, "%output_path%%temp.name%_pcm.%mcont%"%delay%, lang=%langDG%>> "%TEMP%1.meta"
if exist "%output_path%%filename1%_EAE%DELAYB%.eac3" echo A_AC3, "%output_path%%filename1%_EAE%DELAYB%.eac3"%delay%, lang=%langDG% >> "%TEMP%1.meta"
if exist "%output_path%%filename1%_EC3.mkv" echo A_AC3, "%output_path%%filename1%_EC3.mkv"%delay%, track=1, lang=%langDG% >> "%TEMP%1.meta"

:: set audio and subtitles for muxing
for /L %%i in (2,1,%count2%) do (
     if exist "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3" echo A_AC3, "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"!delay%%i!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
     if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" if not "!T%%i.Format!"=="FLAC" if not "!mkvthd%%i!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%"!delay%%i!, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
     if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)


::mux to ts and delete temp files if succesfull
"%tsmuxer_path%" "%TEMP%1.meta" "%output_path%%filename1%.ts"
if ["%errorlevel%"]==["0"] set success=y

for /L %%i in (2,1,%count2%) do (
    if "%success%"=="y" (
	if exist "%output_path%%filename1%_pcm.%mcont%" del "%output_path%%filename1%_pcm.%mcont%"
    if exist "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3" del "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd+ac3"
	if exist "%output_path%%filename1%_EAE%DELAYB%.eac3" del "%output_path%%filename1%_EAE%DELAYB%.eac3"
	if exist "%output_path%%filename1%_EC3.mkv" del "%output_path%%filename1%_EC3.mkv"
	)
)

if /i "%export.subs%"=="NO" goto :end
if not "%THD%"=="y" if "%forced%"=="y" "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26%

:: move convert subs
for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.sup" (
     move "%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.sup" "%output_path%" >Nul
	 if /i "%convert.SUPTOSRT%"=="YES" "%subtitle.edit%" /convert "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.sup" srt
	 if /i "%convert.SUPTOSRT%"=="YES" if not "!T%%i.Forced!"=="Yes" rename "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%filename1%.%langDG%.t%%i.srt"
	 if /i "%convert.SUPTOSRT%"=="YES" if "!T%%i.Forced!"=="Yes" rename "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%filename1%.%langDG%.forced.t%%i.srt"
	 )
)

for /L %%i in (1,1,%count2%) do ( 
     if exist "%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.srt" (
     move "%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%output_path%" >Nul
	 if not "!T%%i.Forced!"=="Yes" rename "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%filename1%.%langDG%.t%%i.srt"
	 if "!T%%i.Forced!"=="Yes" rename "%output_path%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.srt" "%filename1%.%langDG%.forced.t%%i.srt"
	 )
)

:end
:: delete temp folder
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set THD%%i=& set A%%i=
)
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

:: go to next file or end the script
for /l %%i in (2,1,%count1%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.TS
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::---------------------------------------------------------------MP4-------------------------------------------------------------------------------------------------------

:loop.MP4.old

if exist "%temp_folder%temp.folder66" rmdir /Q /S "%temp_folder%temp.folder66"
::make temp folder
MD "%temp_folder%temp.folder66"
set TEMP=%temp_folder%temp.folder66\

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".h265" if not "%fileext1%"==".hevc" echo Invalid extension, skipping file...& goto :end

echo processing..."%filename1%%fileext1%"

::check if BL has keywords in the filename
echo "%filename1%" > "%TEMP%filename.txt"
findstr /c:"KEEPAUDIO" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"FRENCH" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set lang=French& set langDG=fra
findstr /c:"FIXAPPLE" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set FIXapple=YES

if /i "%fileext1%"==".hevc" set raw=y
if /i "%fileext1%"==".h265" set raw=y
if not "%raw%"=="y" goto :skip.raw
     "%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:00:23 >Nul
     "%mediainfo_path%" "%TEMP%1.mkv" --output=JSON > "%TEMP%mediainfo.JSON"
	 "%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
	 findstr /c:"05" "%TEMP%check.DV.txt" >Nul
     if %errorlevel%==0 (
	 set DV.profile=5& set ID=0
	 set mbox=
	 ) ELSE ( 
	 set DV.profile=8& set ID=1
	 set mbox=:hdr=none:dvp=8.1
)

set HDR="%filepath1%%filename1%%fileext1%"& goto :skip.non.mkv

:skip.raw
::------------------------------------------------------------------------------------------------------------------------------------------

set job=job.5.mp4& goto :tracks.info

:job.5.mp4

"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" goto :ts

:: demux
if "%fileext1%"==".mkv" (
     "%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%HDR.hevc" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %AUDIO16% %AUDIO17% %AUDIO18% %AUDIO19% %AUDIO20% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38% %SM39% %SM40% %SM41% %SM42% %SM43% %SM44% %SM45% %SM46% %SM47% %SM48% %SM49% %SM50%
     set HDR="%TEMP%HDR.hevc"& goto :skip.non.mkv
)

:ts
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
if "%video.count%"=="2" echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T2.ID% >> "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath1%%filename1%%fileext1%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath1%%filename1%%fileext1%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath1%%filename1%%fileext1%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
)
"%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
set HDR="%TEMP%%filename1%.track_%T1.ID%.hevc"

if "%video.count%"=="2" (
	 move "%TEMP%%filename1%.track_%T2.ID%.hevc" "%output_path%"
	 rename "%output_path%%filename1%.track_%T2.ID%.hevc" "%filename1%_EL.hevc"
	 set DTDV=--input-file "%output_path%%filename1%_EL.hevc"
	 set mp4_version=OLD& set MBOX=:hdr=none:dvp=7.6& set dv.profile=7& set ID=1
	 goto :MUXER
)

:skip.non.mkv

if /i "%FIXapple%"=="YES" "%ffmpeg_path%" -vsync drop -i %HDR% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%TEMP%HDR.fixed.hevc" & set HDR="%TEMP%HDR.fixed.hevc"
 ::--------------------------------------------------------------------------------------------RPU processing----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::check input file BL
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%HDR_Format_Profile%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%DV.txt"
	
findstr /m "dvhe.08" "%TEMP%DV.txt" >Nul
if %errorlevel%==0 (
     set dv.profile=8& set ID=1
	 set mbox=:hdr=none:dvp=8.1
)

findstr /m "dvhe.05" "%TEMP%DV.txt" >Nul
if %errorlevel%==0 (
     set dv.profile=5&set mbox=& set ID=0
)
	 
findstr /m "dvhe.07" "%TEMP%DV.txt" >Nul
if %errorlevel%==0 (
     set dv.profile=7& set ID=1
	 set mbox=:hdr=none:dvp=7.6
)

set temp.path=%filepath1%& set temp.name=%filename1%& set temp.ext=%fileext1%
set job=job.5.mp4
goto :MUXER
:job.5.mp4.done

:end
:: delete temp folder
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

::reset variables for loop
for /L %%i in (1,1,%count2%) do (
     set T%%i.Format=& set T%%i.Lang=& set T%%i.Forced=& set SM%%i=& set T%%i.Lang=& set AUDIO%%i=& set T%%i.Delay=& set delay%%i=& set T%%i.BitRate=& set T%%i.Channels=& set set AE%%i=& set Title%%i=& set T%%i.ID=& set mkvthd%%i=& set ALL%%i=& set AL%%i=& set SUB%%i=& set T%%i.sub=& set SF%%i=& set ch%%i=& set LOSSY%%i=& set FORCED%%i=& set A%%i=& set THD%%i=
)
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

:: go to next file or end the script
for /l %%i in (2,1,%count1%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.MP4.old
)
setlocal disabledelayedexpansion
if "%properfps%"=="n" echo At least one Input frame rate seems messed up, it was forced to 23.976 but you should fix it in 2-1-3...
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ------------------------------------------------------------MEASURER--------------------------------------------------------------------------------------------------
:MODE.P
echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= Measure Letterbox
echo 2) Workflow.2= Measure MadVR HDR (can batch)
echo 3) Workflow.3= Measure DoVi Level 1 (can batch)
echo 4) Workflow.4= Measure DoVi Level 1,2,3,8 (can batch)
echo 5) Workflow.5= Measure DoVi Level 4,5,6
echo 6) Workflow.6= Measure HDR10plus
echo 7) Workflow.7= Measure Bitrate
echo 8) Workflow.8= Measure Audio waveform
echo 9) Workflow.9= Go back to Main Menu
echo.
choice /C:123456789 /M Choice?
if ERRORLEVEL 9 (
goto :Main.Menu
)

if ERRORLEVEL 8 (
goto :Workflow.8
)

if ERRORLEVEL 7 (
goto :Workflow.7
)

if ERRORLEVEL 6 (
goto :Workflow.6
)

if ERRORLEVEL 5 (
goto :Workflow.5
)

if ERRORLEVEL 4 (
goto :Workflow.4
)

if ERRORLEVEL 3 (
goto :Workflow.3
)

if ERRORLEVEL 2 (
goto :Workflow.2
)

if ERRORLEVEL 1 (
goto :Workflow.1
)

:: -----------------------------------------------------------Measure Letterbox---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:Workflow.1
:border.again
echo.
echo.
echo \033[36m       ===================== | "%cmdcolor%"
echo \033[36m       - MEASURE LETTERBOX - | "%cmdcolor%"
echo \033[36m       ===================== | "%cmdcolor%"
echo.
echo \033[92m------------------------------------------------| "%cmdcolor%"
echo -- this script measure a video file letterbox
echo -- Auto mode might not be 100% accurate
echo -- Tip: zoom 400% ^in avspmod
echo \033[92m------------------------------------------------| "%cmdcolor%"
echo.

echo Drag and drop a video file and press enter...
set /p video_path=

echo.
echo Manual(m) or Auto(a) Measurement^? (default=m)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p level_5=
if [%level_5%]==[] set level_5=m
if /i "%level_5%"=="a" set level_5=a
if /i "%level_5%"=="m" set level_5=m

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

if /i "%same_input_output%"=="YES" set output_path=%filepath%

if /i "%level_5%"=="a" goto :skip.manual
if /i "%fileext%"==".hevc" set raw.in=y
if /i "%fileext%"==".h265" set raw.in=y

if exist "%output_path%%filename%.avs" del "%output_path%%filename%.avs"
set cropcheck="%filepath%%filename%%fileext%"
if not "%raw.in%"=="y" if not "%fileext%"==".ts" if not "%fileext%"==".m2ts" goto :skip.sample
echo.
echo Raw HEVC input, making a sample to allow avspmod to read the input...
"%mkvmerge_path%" --output ^"%output_path%%filename%_sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set cropcheck="%output_path%%filename%_sample.mkv"

:skip.sample
echo DirectShowSource(%cropcheck%) > "%output_path%%filename%.avs"
echo Levels(0, 2.5, 255, 0, 255, coring=false) >> "%output_path%%filename%.avs"

start "" "%AvsPmod_path%" "%output_path%%filename%.avs"
exit
::--------------------------------------------------------------------------------AUTO------------------------------------------------------------------------------------
:skip.manual

:: make and set temp folder
if exist "%temp_folder%temp.folder20_new" rmdir /Q /S "%temp_folder%temp.folder20_new"
if exist "%temp_folder%temp.folder20" set E1=_new
MD "%temp_folder%temp.folder20%E1%"
set TEMP=%temp_folder%temp.folder20%E1%\

if /i "%fileext%"==".mov" set chunk="%filepath%%filename%%fileext%"& goto :Skip
"%mkvmerge_path%" --output ^"%TEMP%chunk.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set chunk="%TEMP%chunk.mkv"
:Skip
echo Measuring the letterbox...
"%detectborders_path%" --ffmpeg-path="%ffmpeg_path%" --input-file=%chunk% --log-file="%TEMP%\borders.txt"
if NOT ["%errorlevel%"]==["0"]  echo input probably shorter than 8 minutes... & pause
for /f "tokens=2 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.left_path=%%a"
)
for /f "tokens=4 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.right_path=%%a"
)
for /f "tokens=3 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.top_path=%%a"
)
for /f "tokens=5 delims=(,-)" %%a in ('type "%TEMP%borders.txt"') do (
    set "L5.bottom_path=%%a"
)
echo.
echo Measurements(this may ^not be accurate):
echo left border: %L5.left_path%
echo right border: %L5.right_path%
echo top border: %L5.top_path%
echo bottom border: %L5.bottom_path%
echo.

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo done, press enter to measure another video ! & pause & goto :border.again

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################


:: MEASURE HDR10/SDR/P5/HLG with madvr
:Workflow.2
:measure.HDR.again
echo.
echo.
echo \033[36m       ====================== | "%cmdcolor%"
echo \033[36m       - MEASURE BRIGHTNESS - | "%cmdcolor%"
echo \033[36m       ====================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo --this script can measure videos brightness with madVR (HDR10 / SDR / DV-P5 / HLG)
echo --Input can be MKV/TS/M2TS/MP4/madVR_file/RPU/XML or a folder with files for batch plotting
echo --MadVR may fails to measure some TS/M2TS files. Workaround: remux it to MKV
echo --If input is profile 5, HLG or SDR, it will be converted to PQ 422 prores (take a while and require a lot of hdd space)
echo --Cropping produce more accurate MaxFALL but it's a lot slower. Must be mod2 and Cropping is disabled in batch mode
echo --Madvr and Lavfilters must be installed. The % stats data about maxcll fall require Python
echo --P5 input require a GPU that supports Vulkan
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

setlocal enabledelayedexpansion
:measureimageagain
:: folder with files input
echo Drag and drop folder with files or a single file and press enter...
set /p folder=

set crop=n
for %%i in (!folder!) do set fileext2=%%~xi
if not "%fileext2%"==".avs" goto :skip.avs
     set fileext1=.avs
	 for %%i in (!folder!) do set "filename1=%%~ni"
     for %%i in (!folder!) do set "filepath1=%%~di%%~pi"
	 set f2=n
	 goto :loop.HDR10.plot

:skip.avs

set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if not "%fileext1%"=="" goto :loop.HDR10.plot

for %%i in (!folder!) do set filename1=%%~ni
for %%i in (!folder!) do set filepath1=%%~di%%~pi
for %%i in (!folder!) do set fileext1=%%~xi
if /i "%same_input_output%"=="YES" set output_path=%filepath1%

if not "%fileext1%"==".png" goto :skipimageinput
echo.

echo.
set MaxCLL=
set MaxFALL=
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%filepath1%%filename1%%fileext1%"') do (
        if not defined MaxCLL set "MaxCLL=%%a"
        if defined MaxCLL set "MaxFALL=%%a"
    )
)
echo.

echo \033[92mINPUT: "%filepath1%%filename1%%fileext1%" | "%cmdcolor%"
echo MaxCLL= %MaxCLL% nits
echo MaxFALL= %MaxFALL% nits
echo.
set filepath1=& set filename1=& set fileext1=& set MaxCLL=& set MaxFALL=& set AR=
goto :measureimageagain
:skipimageinput

if /i "%fileext1%"==".hevc" echo Raw hevc video not supported. Input must be in a container. & pause & exit
if /i "%fileext1%"==".xml" goto :loop.HDR10.plot
if /i "%fileext1%"==".json" goto :loop.HDR10.plot
if /i "%fileext1%"==".bin" goto :loop.HDR10.plot
if /i "%fileext1%"==".measurements" goto :loop.HDR10.plot
if /i "%fileext1%"==".avs" goto :loop.HDR10.plot

if exist "%temp_folder%temp.folder81" rmdir /Q /S "%temp_folder%temp.folder81"
MD "%temp_folder%temp.folder81"
set TEMP=%temp_folder%temp.folder81\
cd /d "%output_path%"

if /i "%Measure_HDR_FBF%"=="YES" goto :slow.measure
::--------------------------------------------------------------------------------CROP-----------------------------------------------------------------------------------------------------
set crop=n& set crop.in=& set DV.input=n& set H=& set W=
set right=& set left=& set top=& set bottom=&set right_s=& set left_s=& set top_s=& set bottom_s=

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.c.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.c.txt"') do (
    set "H=%%a"
)
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.c.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.c.txt"') do (
    set "W=%%a"
)
set in.resolution=(%W%x%H%)
if %H% leq 1080 set downscaleHDRmeasure=NO

if /i "%auto.crop%"=="YES" if %H% leq 2159 if not %H% leq 1080 set crop=n& goto :loop.HDR10.plot
if /i "%auto.crop%"=="YES" if %H% leq 1079 set crop=n& goto :loop.HDR10.plot

echo.
echo ^* Cropping helps with MaxFALL accuracy but the process is a lot slower...
echo.
echo Do you want to exclude the letterbox^? (default=n)
echo.
echo --^> YES= y
echo --^> NO= n
set /p crop=
echo.
if "%crop%"=="" set crop=n
if /i "%crop%"=="y" set crop=y
if /i "%crop%"=="n" set crop=n
if not "%crop%"=="n" if not "%crop%"=="y" set crop=n
if /i "%crop%"=="n" goto :loop.HDR10.plot

::suggest value according to DV L5 ======================================================================

"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"

for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DV.input=y& set DT=-map 0:1

"%JQ_path%" ".media.track[1].HDR_Format_Profile" "%TEMP%mediainfo.JSON" | findstr /i "08 05 07" >nul && set "DV.input=y"

if /i "%DV.input%"=="n" goto :skipL5suggestion
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" %DT% -c:v copy -to 3 -bsf:v hevc_mp4toannexb -f hevc -loglevel error - | "%dovi_tool_path%" extract-rpu -o "%TEMP%sample_RPU.bin" - 

"%dovi_tool_path%" info --input "%TEMP%sample_RPU.bin" -f 40 > "%TEMP%temp.rpu.json"
:: Parse values
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%temp.rpu.json" ^| findstr "left"') do set "left_s=%%a"
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%temp.rpu.json" ^| findstr "right"') do set "right_s=%%a"
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%temp.rpu.json" ^| findstr "top"') do set "top_s=%%a"
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%temp.rpu.json" ^| findstr "bottom"') do set "bottom_s=%%a"
:: Remove spaces from values
set "left_s=%left_s: =%"
set "right_s=%right_s: =%"
set "top_s=%top_s: =%"
set "bottom_s=%bottom_s: =%"
if "%left_s%"==" =" set left_s=N.A.& set right_s=N.A.& set top_s=N.A.& set bottom_s=N.A.

if /i "%DV.input%"=="y" (
    echo.
    echo     ===============================
    echo     Level 5= R:%right_s%, L:%left_s%, T:%top_s%, B:%bottom_s%
    echo     ===============================
)
goto :skipavspmod
::=================================================================================

:skipL5suggestion
:: check for raw or ts/m2ts input in order to prepare crop readings in avspmod (ts/m2ts files are buggy and raw hevc cant be played in directshow)
set cropcheck="%filepath1%%filename1%%fileext1%"
if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" goto :skip.sample
:: make mkv sample if input is ts/m2ts
echo.
echo Raw HEVC or TS/M2TS input, making a MKV sample to allow avspmod to read the input...
"%mkvmerge_path%" --output ^"%TEMP%sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set cropcheck="%TEMP%sample.mkv"

::make script for avspmod with raised black for better letterbox reading
:skip.sample

echo DirectShowSource(%cropcheck%) > "%TEMP%crop.avs"
echo Levels(0, 2.5, 255, 0, 255, coring=false) >> "%TEMP%crop.avs"
:: launch avspmod
start "" "%AvsPmod_path%" "%TEMP%crop.avs"

:skipavspmod
echo.
echo ^* Odd numbers will be rounded...
echo.
echo Right border pixels offset...(default=0)& set /p right=
echo Left border pixels offset...(default=0)& set /p left=
echo Top border pixels offset...(default=0)& set /p top=
echo Bottom border pixels offset...(default=0)& set /p bottom=

::Adjust if odd number
set /a "check=left %% 2"
if %check% equ 1 (
    set /a "left+=1"
)
set /a "check=right %% 2"
if %check% equ 1 (
    set /a "right+=1"
)
set /a "check=top %% 2"
if %check% equ 1 (
    set /a "top+=1"
)
set /a "check=bottom %% 2"
if %check% equ 1 (
    set /a "bottom+=1"
)

if "%top%"=="" set top=0
if "%left%"=="" set left=0
if "%right%"=="" set right=0
if "%bottom%"=="" set bottom=0

set crop.in=(crop: B=%bottom%, T=%top%, R=%right%, L=%left%)

::----------------------------------------------------------------------------------LOOP-------------------------------------------------------------------------------------------------------------
:loop.HDR10.plot

if exist "%temp_folder%temp.folder81" rmdir /Q /S "%temp_folder%temp.folder81"
MD "%temp_folder%temp.folder81"
set TEMP=%temp_folder%temp.folder81\
cd "%output_path%"

if /i "%Measure_HDR_FBF%"=="YES" goto :slow.measure
(
echo {
echo    "min_pq": 7,
echo    "max_pq": 3079,
echo	"remove_cmv4": true,
echo    "level6": {
echo        "max_display_mastering_luminance": 1000,
echo        "min_display_mastering_luminance": 50,
echo        "max_content_light_level": 0,
echo        "max_frame_average_light_level": 0
echo    }
echo }
) > "%TEMP%L6.json"

if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".bin" if not "%fileext1%"==".avs" if not "%fileext1%"==".xml" if not "%fileext1%"==".json" if not "%fileext1%"==".measurements" if not "%fileext1%"==".mov" if not "%fileext1%"==".avi" echo Invalid extension, skipping file...& goto :end

echo.
echo \033[92mProcessing... "%filepath1%%filename1%%fileext1%" | "%cmdcolor%"
echo.

if /i "%fileext1%"==".bin" set RPU="%filepath1%%filename1%%fileext1%"& goto :read

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"

::get BL MDL
if /i "%fileext1%"==".xml" goto :skip
if /i "%fileext1%"==".json" goto :skip
if /i "%fileext1%"==".bin" goto :skip
if /i "%fileext1%"==".measurements" goto :skip
if /i "%fileext1%"==".mov" goto :skip
if /i "%fileext1%"==".avs" goto :skip

set MDL=& set MDC=& set MD=
     "%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
     "%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%colors.txt"
	 "%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%FrameCount1.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount1.txt"') do (
    set "FrameCount1=%%a"
)

set frameCount1=%frameCount1:"=%
for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%colors.txt"') do (
    set "MDC=%%a"
)
set MDC=%MDC:~1,-1%& set MDL=%MDL:~1,-1%
set MD=-annotate +120+120 "Mastering Display: %MDL% - %MDC%"

:skip

if /i "%fileext1%"==".mov" goto :skip709

if /i "%fileext1%"==".json" (
	 "%dovi_tool_nofloor%" generate --hdr10plus-json "%filepath1%%filename1%%fileext1%" --json "%TEMP%L6.json" --rpu-out "%output_path%%filename1%_generated_rpu.bin"
	 set RPU="%output_path%%filename1%_generated_rpu.bin"& goto :read
)

if /i "%fileext1%"==".xml" (
     "%dovi_tool_nofloor%" generate --xml "%filepath1%%filename1%%fileext1%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%output_path%%filename1%_generated_rpu.bin"
	 set RPU="%output_path%%filename1%_generated_rpu.bin"& goto :read
)

if /i "%fileext1%"==".measurements" (
     "%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%filepath1%%filename1%%fileext1%" -o "%output_path%%filename1%_generated_rpu.bin"
	 set RPU="%output_path%%filename1%_generated_rpu.bin"& goto :read
)

set rec709=n& set HLG=n& set P5=n
findstr /m "AVC" "%TEMP%mediainfo.JSON" >Nul
if %errorlevel%==0 set rec709=y
findstr /m "VC-1" "%TEMP%mediainfo.JSON" >Nul
if %errorlevel%==0 set rec709=y
findstr /m "V_MPEG2" "%TEMP%mediainfo.JSON" >Nul
if %errorlevel%==0 set rec709=y
findstr /m "BT.709" "%TEMP%mediainfo.JSON" >Nul
if %errorlevel%==0 set rec709=y

findstr /m "HEVC-126811" "%TEMP%mediainfo.JSON" >Nul
if %errorlevel%==0 set rec709=n
findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set rec709=n
findstr /c:"08" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set rec709=n

findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P5=y
findstr /m "HLG" "%TEMP%mediainfo.JSON" >Nul
if %errorlevel%==0 set HLG=y

if not "%P5%"=="y" if not "%rec709%"=="y" if not "%HLG%"=="y" goto :skipdownsize

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "W=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "H=%%a"
)

if %H% leq 1080 set downscaleHDRmeasure=NO

if /i "%crop%"=="n" goto :nocrop
set /a Hcrop=%top% + %bottom%
set /a Wcrop=%left% + %right%
set /a HafterC=%H% - %Hcrop%
set /a WafterC=%W% - %Wcrop%
set /a remainder1=%HafterC% %% 2
set /a remainder2=%WafterC% %% 2
if "%remainder1%"=="1" set /a HafterC=%HafterC% - 1
if "%remainder2%"=="1" set /a HafterW=%WafterC% - 1
set /a H=%HafterC% / 2
set /a W=%WafterC% / 2
goto :skipdownsize

:nocrop
set /a H=%H% / 2
set /a W=%W% / 2
set /a remainder1=%H% %% 2
set /a remainder2=%W% %% 2
if "%remainder1%"=="1" set /a H=%H% - 1
if "%remainder2%"=="1" set /a W=%W% - 1

:skipdownsize
::---------------------------------------------------------HLG-----------------------------------------------------------------------

if not "%HLG%"=="y" goto :skipHLG
     set HLG=y
     "%ffmsindex%" "%filepath1%%filename1%%fileext1%" -f "%TEMP%1.ffindex"
     echo LoadPlugin("%ffms2%") > "%TEMP%script.avs"
     echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%TEMP%script.avs"
	 echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs"
     echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex") >> "%TEMP%script.avs"
	 if /i "%crop%"=="y" echo Crop(%right%, %top%, -%left%, -%bottom%) >> "%TEMP%script.avs"
	 if /i "%downscaleHDRmeasure%"=="YES" echo BicubicResize(%W%, %H%) >> "%TEMP%script.avs"	
     echo ConvertBits(16) >> "%TEMP%script.avs" 
     echo libplacebo_Tonemap(src_csp=2, dst_csp=1) >> "%TEMP%script.avs" 
	 echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:limited=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"
	 echo Prefetch(2) >> "%TEMP%script.avs"
	 echo.
	 echo =============================SCRIPT==============================================================================
	 type  "%TEMP%script.avs"
	 echo =================================================================================================================
	 echo.
	 echo ============================COMMAND==============================================================================
	 echo "%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -qscale:v 8 -vendor apl0 -pix_fmt yuv422p10le -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -y -loglevel error -stats "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 echo ==================================================================================================================
	 echo.
	 echo frame=%frameCount1% (total)
	 "%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -qscale:v 8 -vendor apl0 -pix_fmt yuv422p10le -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -y -loglevel error -stats "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 echo.
	 echo \033[92m Measuring HLG video with MadVR... | "%cmdcolor%"
	 echo.
	 "%madvr_path%" "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 "%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" -o "%output_path%%filename1%_generated_from_HLG.bin"
     if NOT ["%errorlevel%"]==["0"] pause & exit
     set RPU="%output_path%%filename1%_generated_from_HLG.bin"	 
	 if /i "%keep_prores%"=="YES" if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" "%output_path%"
	 if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" "%output_path%"
	 set MDL=& set MDC=& set MD=
	 goto :read
	 
:skipHLG
::---------------------------------------------------------P5-----------------------------------------------------------------------

set p5.input=n
if not "%P5%"=="y" goto :skip.p5
set p5.input=y
"%ffmsindex%" "%filepath1%%filename1%%fileext1%" -f "%TEMP%1.ffindex"

     echo LoadPlugin("%ffms2%") > "%TEMP%script.avs"
     echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%TEMP%script.avs" 
	 echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs" 
     echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex") >> "%TEMP%script.avs"
	 if /i "%crop%"=="y" echo Crop(%right%, %top%, -%left%, -%bottom%) >> "%TEMP%script.avs"
	 if /i "%downscaleHDRmeasure%"=="YES" echo BicubicResize(%W%, %H%) >> "%TEMP%script.avs"	
     echo ConvertBits(16) >> "%TEMP%script.avs" 
     echo libplacebo_Tonemap(src_csp=3, dst_csp=1) >> "%TEMP%script.avs" 
	 echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"
	 echo Prefetch(2) >> "%TEMP%script.avs"

	 "%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:00:23 > Nul
     "%mkvextract_path%" "%TEMP%1.mkv" tracks 0:"%TEMP%BL.hevc "> Nul
	 "%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%TEMP%RPU.temp.bin" > Nul
	 "%dovi_tool_path%" export -i "%TEMP%RPU.temp.bin" -o "%TEMP%full.json"
	 
	 echo.
	 echo =============================SCRIPT==============================================================================
	 type  "%TEMP%script.avs"
	 echo =================================================================================================================
	 echo.
	 echo ============================COMMAND==============================================================================
	 echo "%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -qscale:v 8 -vendor apl0 -pix_fmt yuv422p10le -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -y -loglevel error -stats "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 echo =================================================================================================================
	 echo.
	 echo frame=%frameCount1% (total)
	 "%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -qscale:v 8 -vendor apl0 -pix_fmt yuv422p10le -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -y -loglevel error -stats "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 echo.
	 
	 echo \033[92m Measuring DV P5 video with MadVR... | "%cmdcolor%"
	 echo.
	 "%madvr_path%" "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 "%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" -o "%output_path%%filename1%_generated_from_P5.bin"
     if NOT ["%errorlevel%"]==["0"] pause & exit
     set RPU="%output_path%%filename1%_generated_from_P5.bin"
	 if /i "%keep_prores%"=="YES" if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" "%output_path%"
	 if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" "%output_path%"
	 set MDL=& set MDC=& set MD=
	 goto :read
	 
:skip.p5
::---------------------------------------------------------SDR------------------------------------------------------------------------
if not "%rec709%"=="y" goto :skip709

     "%ffmsindex%" "%filepath1%%filename1%%fileext1%" -f "%TEMP%1.ffindex"
     echo LoadPlugin("%ffms2%") > "%TEMP%script.avs"
     echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs" 
     echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex") >> "%TEMP%script.avs"
	 if /i "%crop%"=="y" echo Crop(%right%, %top%, -%left%, -%bottom%) >> "%TEMP%script.avs"
	 if /i "%downscaleHDRmeasure%"=="YES" echo BicubicResize(%W%, %H%) >> "%TEMP%script.avs"	
	 echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"
	 echo.
	 echo =============================SCRIPT==============================================================================
	 type  "%TEMP%script.avs"
	 echo =================================================================================================================
	 echo.
	 echo ============================COMMAND==============================================================================
	 echo "%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -qscale:v 8 -vendor apl0 -pix_fmt yuv422p10le -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -y -loglevel error -stats "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 echo =================================================================================================================
	 echo.
	 echo frame=%frameCount1% (total)
	 "%ffmpeg_path%" -i "%TEMP%script.avs" -c:v prores_ks -profile:v 3 -qscale:v 8 -vendor apl0 -pix_fmt yuv422p10le -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -y -loglevel error -stats "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"

	 echo.
	 echo \033[92m Measuring SDR video with MadVR... | "%cmdcolor%"
	 echo.
     "%madvr_path%" "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov"
	 "%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" -o "%output_path%%filename1%_generated_from_SDR.bin"
     if NOT ["%errorlevel%"]==["0"] pause & exit
     set RPU="%output_path%%filename1%_generated_from_SDR.bin"
	 if /i "%keep_prores%"=="YES" if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" "%output_path%"
	 if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov.measurements" "%output_path%"
	 set MDL=& set MDC=& set MD=
     goto :read

:skip709

::-----------------------------------------------downscale CROP-----------------------------------------------------------------------------------------------------
if /i "%crop%"=="n" goto :skipcrophdr
if /i "%crop.prores62%"=="NO" goto :skipdownscalehdr

set /a Hcrop=%top% + %bottom%
set /a Wcrop=%left% + %right%
set cuda.acc=-hwaccel cuda
if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, disabling HWaccel & set cuda.acc=
:nvidiacheck
if not "%Hcrop%"=="0" set prorescropping=-vf "crop=in_w:in_h-%Hcrop%:0:%top%"
if not "%Wcrop%"=="0" set prorescropping=-vf "crop=in_w-%Wcrop%:in_h:%right%:0"
if not "%Wcrop%"=="0" if not "%Hcrop%"=="0" set prorescropping=-vf "crop=in_w-%Wcrop%:in_h-%Hcrop%:%right%:%top%"

echo.
echo \033[92mInput is being encoded(crop) to Prores 422 PQ... | "%cmdcolor%"
echo.
echo ============================COMMAND==============================================================================
echo "%ffmpeg_path%" %cuda.acc% -i "%filepath1%%filename1%%fileext1%" %prorescropping% -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v 8 -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -pix_fmt yuv422p10le -an -y -hide_banner -loglevel error -stats "%TEMP%%filename1%_transfer=hdr.matrix=2020.mov"
echo =================================================================================================================
echo.
echo frame=%frameCount1% (total)
"%ffmpeg_path%" %cuda.acc% -i "%filepath1%%filename1%%fileext1%" %prorescropping% -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v 8 -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -pix_fmt yuv422p10le -an -y -hide_banner -loglevel error -stats "%TEMP%%filename1%_transfer=hdr.matrix=2020.mov"
echo.

"%madvr_path%" "%TEMP%%filename1%_transfer=hdr.matrix=2020.mov"
"%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%TEMP%%filename1%_transfer=hdr.matrix=2020.mov.measurements" -o "%output_path%%filename1%_Generated_Cropped.bin"
if NOT ["%errorlevel%"]==["0"] pause & exit
set RPU="%output_path%%filename1%_Generated_Cropped.bin"
if exist "%TEMP%%filename1%_transfer=hdr.matrix=2020.mov.measurements" move "%TEMP%%filename1%_transfer=hdr.matrix=2020.mov.measurements" "%output_path%"
if /i "%keep_prores%"=="YES" if exist "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" move "%TEMP%%filename1%_transfer=HDR.matrix=2020.mov" "%output_path%"
goto :read

:skipdownscalehdr
::----------------------------------------------- CROP-----------------------------------------------------------------------------------------------------------------
:: measure HDR PQ cropped
echo DirectShowSource("%filepath1%%filename1%%fileext1%") > "%TEMP%%filename1%_transfer=hdr.matrix=2020.avs"
echo Crop(%right%, %top%, -%left%, -%bottom%) >> "%TEMP%%filename1%_transfer=hdr.matrix=2020.avs"

	 echo.
echo \033[92m ^If you have a powerful CPU, it might be faster to enable prores encoding when you crop (line 262) ... | "%cmdcolor%"
	 echo.
"%madvr_path%" "%TEMP%%filename1%_transfer=hdr.matrix=2020.avs"

"%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%TEMP%%filename1%_transfer=hdr.matrix=2020.avs.measurements" -o "%output_path%%filename1%_Generated_Cropped.bin"
set RPU="%output_path%%filename1%_Generated_Cropped.bin"
if exist "%TEMP%%filename1%_transfer=hdr.matrix=2020.avs.measurements" move "%TEMP%%filename1%_transfer=hdr.matrix=2020.avs.measurements" "%output_path%"
goto :read

::-----------------------------------------------no downscale no CROP-----------------------------------------------------------------------------------------------------
:skipcrophdr
if not "%fileext1%"==".avs"  goto :skiprename1
        rename "%filepath1%%filename1%%fileext1%" "%filename1%_transfer=hdr_matrix=2020%fileext1%"
		set filename1=%filename1%_transfer=hdr_matrix=2020
		set nonhevcinput=y

:skiprename1
if not "%fileext1%"==".mov" goto :skiprename
        rename "%filepath1%%filename1%%fileext1%" "%filename1%_transfer=hdr_matrix=2020%fileext1%"
		set filename1old=%filename1%
		set filename1=%filename1%_transfer=hdr_matrix=2020
		set nonhevcinput=y
		
:skiprename
::measure with madvr
"%madvr_path%" "%filepath1%%filename1%%fileext1%"

if /i "%nonhevcinput%"=="y" rename "%filepath1%%filename1%%fileext1%" "%filename1old%%fileext1%"

:: generate RPU
"%dovi_tool_nofloor%" generate -j "%TEMP%L6.json" --madvr-file "%filepath1%%filename1%%fileext1%.measurements" -o "%output_path%%filename1%_Generated.bin"
set RPU="%output_path%%filename1%_Generated.bin"
if exist "%filepath1%%filename1%%fileext1%.measurements" move "%filepath1%%filename1%%fileext1%.measurements" "%output_path%" >Nul

:read
::plot dv
"%dovi_tool_path%" plot %RPU%  -t "HDR10 Plot"  -o "%TEMP%%filename1%_HDR10_plot.png"

"%dovi_tool_path%" info -s %RPU% >"%TEMP%sum.rpu.json"
"%dovi_tool_path%" info --input %RPU% -f 25 > "%TEMP%temp.rpu.json"
if "%p5.input%"=="y" "%dovi_tool_path%" info --input "%TEMP%RPU.temp.bin" -f 25 > "%TEMP%temp.rpu2.json"
if "%p5.input%"=="y" "%dovi_tool_path%" export -i "%TEMP%RPU.temp.bin" -o "%TEMP%RPUP5.json"

type "%TEMP%sum.rpu.json" | findstr Frames: > "%TEMP%frames.txt"
type "%TEMP%sum.rpu.json" | findstr count: > "%TEMP%shot.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%frames.txt"') do (
    set "framecount=%%a"
)
for /f "tokens=2 delims=(:.)" %%a in ('type "%TEMP%shot.txt"') do (
    set "shot=%%a"
)
set "framecount=%framecount: =%"

if "%rec709%"=="y" goto :skip.hdr
if "%HLG%"=="y" goto :skip.hdr
if "%p5.input%"=="y" type "%TEMP%temp.rpu2.json" | findstr source_min_pq > "%TEMP%min_pq.json"
if "%p5.input%"=="y" type "%TEMP%temp.rpu2.json" | findstr source_max_pq > "%TEMP%max_pq.json"
if not "%p5.input%"=="y" type "%TEMP%temp.rpu.json" | findstr source_min_pq > "%TEMP%min_pq.json"
if not "%p5.input%"=="y" type "%TEMP%temp.rpu.json" | findstr source_max_pq > "%TEMP%max_pq.json"
if "%p5.input%"=="y" findstr /c:"\"source_primary_index\":0" "%TEMP%RPUP5.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=(P3)
if "%p5.input%"=="y" findstr /c:"\"source_primary_index\":2" "%TEMP%RPUP5.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=(BT2020)

set max_pq=& set min_pq=
findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=1000 cd/m2
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=2000 cd/m2
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4000 cd/m2
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=10 000 cd/m2
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0001 cd/m2
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0050 cd/m2
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0020 cd/m2
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0000 cd/m2
if "%p5.input%"=="y" set MD=-annotate +120+120 "Mastering Display: min: %min_pq%, max: %max_pq% %MDP.RPU%"

:skip.hdr
if /i "%generate_stats%"=="NO" goto :skip.average

if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"
MD "%letterpath%\data.raw\"

:: export peaks only
"%dovi_tool_path%" export -i %RPU% -o "%TEMP%RPU.json"

echo.
echo \033[92mCalculating per shot MaxFALL threshold... | "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level1.avg_pq" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.avg.pq.txt"

::---------------------------------maxfall stats----------------------------------------------------------------------
set percentage2.5avg=& set percentage10avg=& set percentage25avg=& set percentage50avg=& set percentage91avg=& set percentage100avg=& set percentage150avg=& set percentage200avg=
set THRE1=819& set nit1=2.5& set THRE2=1229& set nit2=10& set THRE3=1542& set nit3=25& set THRE4=1803& set nit4=50& set THRE5=2048& set nit5=92& set THRE6=2081& set nit6=100& set THRE7=2249& set nit7=150& set THRE8=2372& set nit8=200
if "%rec709%"=="y" set THRE1=819& set nit1=2.5& set THRE2=1229& set nit2=10& set THRE3=1362& set nit3=15& set THRE4=1542& set nit4=25& set THRE5=1666& set nit5=35& set THRE6=1803& set nit6=50& set THRE7=1964& set nit7=75& set THRE8=2048& set nit8=92
set A1=& set A2=& set A3=& set A4=& set A5=& set A6=& set A7=& set A8=& set P1=& set P2=& set P3=& set P4=& set P5=& set P6=& set P7=& set P8=& set AM=& set AA=
::2.5nits 819
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE1% -m over > "%TEMP%2.5avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%2.5avg.txt") do (
    set "percentage2.5avg=!percentage2.5avg!%%a"
)
if "%percentage2.5avg%"=="0.00" set percentage2.5avg=0
if "%percentage2.5avg%"=="00.00" set percentage2.5avg=0
if "%percentage2.5avg%"=="" set percentage2.5avg=0
set A1=-annotate +2160+140 "MaxFALL Percentage Above  %nit1%nits: %percentage2.5avg%"

::10nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE2% -m over > "%TEMP%10avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%10avg.txt") do (
    set "percentage10avg=!percentage10avg!%%a"
)
if "%percentage10avg%"=="0.00" set percentage10avg=0
if "%percentage10avg%"=="00.00" set percentage10avg=0
if "%percentage10avg%"=="" set percentage10avg=0
set A2=-annotate +2160+120 "MaxFALL Percentage Above   %nit2%nits: %percentage10avg%"

::25nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE3% -m over > "%TEMP%25avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%25avg.txt") do (
    set "percentage25avg=!percentage25avg!%%a"
)
if "%percentage25avg%"=="0.00" set percentage25avg=0
if "%percentage25avg%"=="00.00" set percentage25avg=0
if "%percentage25avg%"=="" set percentage25avg=0
set A3=-annotate +2160+100 "MaxFALL Percentage Above   %nit3%nits: %percentage25avg%"

::50nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE4% -m over > "%TEMP%50avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%50avg.txt") do (
    set "percentage50avg=!percentage50avg!%%a"
)
if "%percentage50avg%"=="0.00" set percentage50avg=0
if "%percentage50avg%"=="00.00" set percentage50avg=0
if "%percentage50avg%"=="" set percentage50avg=0
set A4=-annotate +2160+80 "MaxFALL Percentage Above   %nit4%nits: %percentage50avg%"

::92nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE5% -m over > "%TEMP%91avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%91avg.txt") do (
    set "percentage91avg=!percentage91avg!%%a"
)
if "%percentage91avg%"=="0.00" set percentage91avg=0
if "%percentage91avg%"=="00.00" set percentage91avg=0
if "%percentage91avg%"=="" set percentage91avg=0
set A5=-annotate +2160+60 "MaxFALL Percentage Above   %nit5%nits: %percentage91avg%"

::100nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE6% -m over > "%TEMP%100avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%100avg.txt") do (
    set "percentage100avg=!percentage100avg!%%a"
)
if "%percentage100avg%"=="0.00" set percentage100avg=0
if "%percentage100avg%"=="00.00" set percentage100avg=0
if "%percentage100avg%"=="" set percentage100avg=0
set A6=-annotate +2160+40 "MaxFALL Percentage Above %nit6%nits: %percentage100avg%"

::150nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE7% -m over > "%TEMP%150avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%150avg.txt") do (
    set "percentage150avg=!percentage150avg!%%a"
)
if "%percentage150avg%"=="0.00" set percentage150avg=0
if "%percentage150avg%"=="00.00" set percentage150avg=0
if "%percentage150avg%"=="" set percentage150avg=0
set A7=-annotate +2160+20 "MaxFALL Percentage Above %nit7%nits: %percentage150avg%"

::200nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE8% -m over > "%TEMP%200avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%200avg.txt") do (
    set "percentage200avg=!percentage200avg!%%a"
)
if "%percentage200avg%"=="0.00" set percentage200avg=0
if "%percentage200avg%"=="00.00" set percentage200avg=0
if "%percentage200avg%"=="" set percentage200avg=0
set A8=-annotate +2160+0 "MaxFALL Percentage Above %nit8%nits: %percentage200avg%"
echo Done.
echo.
del "%TEMP%91avg.txt" & del "%TEMP%50avg.txt" & del "%TEMP%25avg.txt" & del "%TEMP%10avg.txt" & del "%TEMP%2.5avg.txt" & del "%TEMP%100avg.txt" & del "%TEMP%150avg.txt" & del "%TEMP%200avg.txt"

echo \033[92mCalculating per shot MaxCLL threshold... | "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level1.max_pq" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.max.pq.txt"

::---------------------------------maxcll stats----------------------------------------------------------------------

set percentage150max=& set percentage500max=& set percentage1000max=& set percentage2000max=& set percentage4000max=& set percentage200max=& set percentage800max=& set percentage1500max=
set THRE1=2081& set nit1=100& set THRE2=2372& set nit2=200& set THRE3=2771& set nit3=500& set THRE4=2979& set nit4=800& set THRE5=3079& set nit5=1000& set THRE6=3260& set nit6=1500& set THRE7=3388& set nit7=2000& set THRE8=3696& set nit8=4000
if "%rec709%"=="y" set THRE1=1229& set nit1=10& set THRE2=1362& set nit2=15& set THRE3=1542& set nit3=25& set THRE4=1666& set nit4=35& set THRE5=1803& set nit5=50& set THRE6=1964& set nit6=75& set THRE7=2048& set nit7=92& set THRE8=2081& set nit8=100

::150nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE1% -m over > "%TEMP%150max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%150max.txt") do (
    set "percentage150max=!percentage150max!%%a"
)
if "%percentage150max%"=="0.00" set percentage150max=0
if "%percentage150max%"=="00.00" set percentage150max=0
if "%percentage150max%"=="" set percentage150max=0
set P1=-annotate +2580+140 "MaxCLL Percentage Above   %nit1%nits: %percentage150max%"

::200nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE2% -m over > "%TEMP%200max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%200max.txt") do (
    set "percentage200max=!percentage200max!%%a"
)
if "%percentage200max%"=="0.00" set percentage200max=0
if "%percentage200max%"=="00.00" set percentage200max=0
if "%percentage200max%"=="" set percentage200max=0
set P2=-annotate +2580+120 "MaxCLL Percentage Above   %nit2%nits: %percentage200max%"

::500nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE3% -m over > "%TEMP%500max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%500max.txt") do (
    set "percentage500max=!percentage500max!%%a"
)
if "%percentage500max%"=="" set percentage500max=0
if "%percentage500max%"=="0.00" set percentage500max=0
if "%percentage500max%"=="00.00" set percentage500max=0
set P3=-annotate +2580+100 "MaxCLL Percentage Above   %nit3%nits: %percentage500max%"

::800nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE4% -m over > "%TEMP%800max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%800max.txt") do (
    set "percentage800max=!percentage800max!%%a"
)
if "%percentage800max%"=="0.00" set percentage800max=0
if "%percentage800max%"=="00.00" set percentage800max=0
if "%percentage800max%"=="" set percentage800max=0
set P4=-annotate +2580+80 "MaxCLL Percentage Above   %nit4%nits: %percentage800max%"

::1000nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE5% -m over > "%TEMP%1000max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%1000max.txt") do (
    set "percentage1000max=!percentage1000max!%%a"
)
if "%percentage1000max%"=="0.00" set percentage1000max=0
if "%percentage1000max%"=="00.00" set percentage1000max=0
if "%percentage1000max%"=="" set percentage1000max=0
set P5=-annotate +2580+60 "MaxCLL Percentage Above %nit5%nits: %percentage1000max%"

::1500nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE6% -m over > "%TEMP%1500max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%1500max.txt") do (
    set "percentage1500max=!percentage1500max!%%a"
)
if "%percentage1500max%"=="0.00" set percentage1500max=0
if "%percentage1500max%"=="00.00" set percentage1500max=0
if "%percentage1500max%"=="" set percentage1500max=0
set P6=-annotate +2580+40 "MaxCLL Percentage Above %nit6%nits: %percentage1500max%"

::2000nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE7% -m over > "%TEMP%2000max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%2000max.txt") do (
    set "percentage2000max=!percentage2000max!%%a"
)
if "%percentage2000max%"=="0.00" set percentage2000max=0
if "%percentage2000max%"=="00.00" set percentage2000max=0
if "%percentage2000max%"=="" set percentage2000max=0
set P7=-annotate +2580+20 "MaxCLL Percentage Above %nit7%nits: %percentage2000max%"

::4000nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE8% -m over > "%TEMP%4000max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%4000max.txt") do (
    set "percentage4000max=!percentage4000max!%%a"
)
if "%percentage4000max%"=="0.00" set percentage4000max=0
if "%percentage4000max%"=="00.00" set percentage4000max=0
if "%percentage4000max%"=="" set percentage4000max=0
set P8=-annotate +2580+0 "MaxCLL Percentage Above %nit8%nits: %percentage4000max%"

echo Done.
echo.

del "%TEMP%4000max.txt" & del "%TEMP%2000max.txt" & del "%TEMP%1000max.txt" & del "%TEMP%500max.txt" & del "%TEMP%150max.txt" & del "%TEMP%1500max.txt" & del "%TEMP%200max.txt" & del "%TEMP%800max.txt"
::-------------------------------------------------------------------------------------------------------------------------
set actualmax=& set actualavg=
::find the actual maxcll/fall shot, display the first frame
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\data.raw\.max.pq.txt" -m max > "%TEMP%actualmax.txt"
for /f "usebackq delims=" %%a in ("%TEMP%actualmax.txt") do (
    set "actualmax=!actualmax!%%a"
)

set AM=-annotate +1760+40 "MaxCLL Scene starts at frame %actualmax%"

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\data.raw\.avg.pq.txt" -m max > "%TEMP%actualavg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%actualavg.txt") do (
    set "actualavg=!actualavg!%%a"
)

set AA=-annotate +1760+15 "MaxFALL Scene starts at frame %actualavg%"

if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"
::-------------------------------------------------------------------------------------------------------------------------

:skip.average
if "%OSD.filename1%"=="" set OSD.filename1=%filename1%
set PT=HDR
set range.type=-annotate +1500+80 "HDR PLOT (per shot)"
if /i "%HLG%"=="y" set PT=HLG& set range.type=-annotate +1500+80 "HLG PLOT (per shot)"
if /i "%rec709%"=="y" set PT=SDR& set range.type=-annotate +1500+80 "SDR PLOT (per shot)"
if /i "%p5.input%"=="y" set PT=DVP5_madVR& set range.type=-annotate +1500+80 "DV P5 madVR PLOT (per shot)"
if /i "%fileext1%"==".bin" set PT=DoVi_L1& set range.type=-annotate +1500+80 "DoVi L1 PLOT"
if /i "%fileext1%"==".xml" set PT=DoVi_L1& set range.type=-annotate +1500+80 "DoVi L1 PLOT"
if /i "%fileext1%"==".json" set PT=HDR10plus& set range.type=-annotate +1500+80 "HDR10plus PLOT (per shot)"

"%imagemagick%" convert "%TEMP%%filename1%_HDR10_plot.png" -quality 100 -fill white -stroke none -draw "rectangle 0,0 3000,150" -gravity NorthWest -pointsize 20 -fill black -annotate +120+60 "%OSD.filename1% %in.resolution%%crop.in%" -annotate +120+90 "Shots: %shot%, Frames: %framecount%" %range.type% %A1% %A2% %A3% %A4% %A5% %A6% %A7% %A8% %P1% %P2% %P3% %P4% %P5% %P6% %P7% %P8% %MD% %AM% %AA% -annotate +2945+159  "4095" -annotate +2945+241  "3696"  -annotate +2945+316  "3388" -annotate +2945+386  "3079" -annotate +2945+436  "2851" -annotate +2945+481  "2672"  -annotate +2945+551  "2372"  -annotate +2945+616  "2081"  -annotate +2945+681  "1803" -annotate +2945+741  "1542" -annotate +2945+816  "1229" -annotate +2945+861  "1015"  -annotate +2945+906  "819"  -annotate +2945+956  "614" "%output_path%%OSD.filename1%.%PT%_plot.png"

if "%plotimage.res%"=="3000:1200"  goto :skipresizing
"%ffmpeg_path%" -i "%output_path%%OSD.filename1%.%PT%_plot.png" -vf "scale=%plotimage.res%:flags=spline" -q:v 0 "%output_path%%OSD.filename1%_%PT%_plot.png" 2>nul
del "%output_path%%OSD.filename1%.%PT%_plot.png"

:skipresizing

goto :end
::------------------------------------------------------------------------slow measure script----------------------------------------------------------------------------------------------
:slow.measure

echo.
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo4.JSON"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo4.JSON" > "%TEMP%FrameCount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount.txt"') do (
    set "framecount=%%a"
)
set framecount=%framecount:"=%

MD "%letterpath%\data.raw\"
python "%~dp0tools\Measure_HDR_VIDEO.py" -i "%filepath1%%filename1%%fileext1%" -o "%letterpath%\data.raw"

  echo set title "Frame by Frame HDR PLOT" > "%TEMP%1.gp"
  echo set logscale y 5 >> "%TEMP%1.gp"
  echo set yrange [1:10000] >> "%TEMP%1.gp"
  echo set ytics (0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 15, 20, 25, \>> "%TEMP%1.gp"
  echo               32, 40, 50, 60, 72, 85, 100, 125, 150, 180, 215, 265, 320, 400, 500, 650, 800, 1000, 1300, 1550, 1850, 2200, \>> "%TEMP%1.gp"
  echo 			 2550, 3150, 4000, 5000, 6000, 8000, 10000 ) >> "%TEMP%1.gp"
  echo set mytics 1 >> "%TEMP%1.gp"
  echo set xlabel "Frames (total=%framecount%)" >> "%TEMP%1.gp"
  echo set ylabel "Brightness (in nits)" >> "%TEMP%1.gp"
  echo set key bottom left >> "%TEMP%1.gp"
  echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
  echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
  echo set grid >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 5 to graph 1,first 5 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 10 to graph 1,first 10 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 25 to graph 1,first 25 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 50 to graph 1,first 50 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 100 to graph 1,first 100 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 250 to graph 1,first 250 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 500 to graph 1,first 500 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 1000 to graph 1,first 1000 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 2000 to graph 1,first 2000 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 4000 to graph 1,first 4000 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set arrow from graph 0,first 6000 to graph 1,first 6000 nohead lc rgb "#80808080" >> "%TEMP%1.gp"
  echo set term pngcairo size 3500,1500 enhanced font "Arial,18" >> "%TEMP%1.gp"
  echo set output "%OSD.filename1%.Per.frame.HDR_plot.png" >> "%TEMP%1.gp"
  echo plot "%letterpath%\\data.raw\\maxcll_data.txt" with lines title "Peak Brightness(MaxCLL)" lc rgb "red", "%letterpath%\\data.raw\\maxfall_data.txt" with lines title "Average Brightness (MaxFALL)" lc rgb "blue" >> "%TEMP%1.gp"

echo Plotting data...
"%gnuplot%" "%TEMP%1.gp" >Nul
echo Done.

:end
set OSD.filename1=
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%" 
if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"
set OSD.filename1=
set percentageA=&set percentageB=&set percentageC=&set percentageD=&set percentageE=&set percentageF=&set percentageG=&set percentageH=&set percentageI=& set crop=n& set rec709=n& set p5=n& set p5.input=n
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.HDR10.plot
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo \033[92mThe script has been completed, press a key to measure HDR again...| "%cmdcolor%"
pause & set fileext1=& goto :measure.HDR.again

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.3
set job=justL1
echo.
echo.
echo \033[36m          =========== | "%cmdcolor%"
echo \033[36m          - PLOT L1 - | "%cmdcolor%"
echo \033[36m          =========== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow can plot Dolby Vision Level 1  metadata
echo -- Input can be RPU/MKV/TS/M2TS/MP4/XML/HEVC
echo -- Input can be a folder with files or a single file
echo -- Example: https://youtu.be/KHXvjtHNdB8^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
goto :skip.infrom1

:: ------------------------------------------------------------MEASURE DoVi L2--------------------------------------------------------------------------------------------------
:Workflow.4
:plot.l2.again
echo.
echo.
echo \033[36m          ==================== | "%cmdcolor%"
echo \033[36m          - PLOT L1-L2-L3-L8 - | "%cmdcolor%"
echo \033[36m          ==================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow can plot Dolby Vision Level 1 / 2 / 3 / 8 metadata
echo -- Input can be RPU/MKV/TS/M2TS/MP4/XML/HEVC
echo -- Can batch: input can be a folder or a single file
echo -- Example: https://youtu.be/KHXvjtHNdB8^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
goto :skip.infrom1

:batchexfrom1
rmdir /Q /S "%TEMP%" 
cd "%output_path%"
set job=justL1& set folder=%video_path%
goto :skipjob6

:skip.infrom1
:: folder with files input
echo Drag and drop folder with files or a single file and press enter...
set /p folder=

:skipjob6
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
)

::--------------------------------------------------------------------------------------------------------------------------------------------

:loop.L2
:: make and set temp folder
if exist "%temp_folder%temp.folder41_new" rmdir /Q /S "%temp_folder%temp.folder41_new"
if exist "%temp_folder%temp.folder41" set E1=_new
MD "%temp_folder%temp.folder41%E1%"
set TEMP=%temp_folder%temp.folder41%E1%\

:plotfrom1
if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".bin" if not "%fileext1%"==".xml" if not "%fileext1%"==".h265" if not "%fileext1%"==".hevc" echo Invalid extension, skipping file...& goto :end
if /i "%same_input_output%"=="YES" set output_path=%filepath1%

echo.
echo \033[92m Processing... "%filepath1%%filename1%%fileext1%" | "%cmdcolor%"
echo.

if /i "%fileext1%"==".bin" set RPU="%filepath1%%filename1%.bin"& goto :skip.demux
if /i "%fileext1%"==".hevc" set HDR="%filepath1%%filename1%.hevc"& goto :demux
if /i "%fileext1%"==".h265" set HDR="%filepath1%%filename1%.h265"& goto :demux
if /i "%fileext1%"==".xml" (
     "%dovi_tool_path%" generate --xml "%filepath1%%filename1%%fileext1%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%output_path%%filename1%_RPU.bin" >Nul
	 set RPU="%output_path%%filename1%_RPU.bin"
	 goto :skip.demux
)

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DT=-map 0:1

if not "%fileext1%"==".mkv" set ffmpeg_pipe_secondary=YES
::demux / extract rpu
if /i  "%ffmpeg_pipe_secondary%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename1%_rpu.bin"
set RPU="%output_path%%filename1%_rpu.bin"
goto :skip.demux

:skip.mkvextract

"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename1%_RPU.bin" -
set RPU="%output_path%%filename1%_rpu.bin"& goto :skip.demux

:demux
"%dovi_tool_path%" extract-rpu %HDR% -o "%output_path%%filename1%_rpu.bin"
set RPU="%output_path%%filename1%_rpu.bin"

:skip.demux
set cmv4.0=n& set t8.1=& set t8.2=& set t8.3=& set left=& set right=& set top=& set bottom=& set t1=& set t2=& set t3=& set t4=
set L8_100=n&set L8_600=n& set L8_1000=n& set L8_300=n& set mid_con=n& set clip_trim=n&set vectorSAT=n&set vectorHUE=n

"%dovi_tool_path%" info --input %RPU% -f 25 > "%TEMP%temp.rpu.json"
"%dovi_tool_path%" export -i %RPU% -o "%TEMP%RPU.json"
"%dovi_tool_path%" info -s %RPU% > "%TEMP%rpu.info.txt"
echo.
type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"

findstr /c:"100 nits" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t1=100 nits
findstr /c:"600" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2=, 600 nits
findstr /c:"1000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t3=, 1000 nits
findstr /c:"2000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t4=, 2000 nits

findstr /c:"cmv40" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"target_display_index\":1" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_100=y&set t8.1=100 nits& set cmv4.0=y
findstr /c:"\"target_display_index\":24" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_300=y& set tar.id3=24&set t8.4=, 300 nits& set cmv4.0=y
findstr /c:"\"target_display_index\":25" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_300=y& set tar.id3=25&set t8.4=, 300 nits& set cmv4.0=y
findstr /c:"\"target_display_index\":27" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_600=y& set tar.id=27&set t8.2=, 600 nits& set cmv4.0=y
findstr /c:"\"target_display_index\":28" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_600=y& set tar.id=28&set t8.2=, 600 nits& set cmv4.0=y
findstr /c:"\"target_display_index\":48" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_1000=y& set tar.id2=48&set t8.3=, 1000 nits& set cmv4.0=y
findstr /c:"\"target_display_index\":49" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set L8_1000=y& set tar.id2=49&set t8.3=, 1000 nits& set cmv4.0=y
findstr /c:"target_mid_contrast" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set mid_con=y
findstr /c:"clip_trim" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set clip_trim=y
findstr /c:"saturation_vector" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set vectorSAT=y
findstr /c:"hue_vector" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set vectorHUE=y
findstr /c:"\"source_primary_index\":0" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=(P3)
findstr /c:"\"source_primary_index\":2" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=(BT2020)

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"
if "%left%"==" =" set left=N.A.& set right=N.A.& set top=N.A.& set bottom=N.A.

if "%OSD.filename1%"=="" set OSD.filename1=%filename1%

::-------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------STATS---------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------

if /i "%generate_stats%"=="NO" goto :skip.average

if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"
MD "%letterpath%\data.raw\"

:: export peaks only
"%dovi_tool_path%" export -i %RPU% -o "%TEMP%RPU.json"
if NOT ["%errorlevel%"]==["0"] pause

echo.
echo \033[92mCalculating per shot MaxFALL threshold... | "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level1.avg_pq" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.avg.pq.txt"

::---------------------------------maxfall stats----------------------------------------------------------------------
set percentage2.5avg=& set percentage10avg=& set percentage25avg=& set percentage50avg=& set percentage91avg=& set percentage100avg=& set percentage150avg=& set percentage200avg=
set THRE1=819& set nit1=2.5& set THRE2=1229& set nit2=10& set THRE3=1542& set nit3=25& set THRE4=1803& set nit4=50& set THRE5=2048& set nit5=92& set THRE6=2081& set nit6=100& set THRE7=2249& set nit7=150& set THRE8=2372& set nit8=200
if "%rec709%"=="y" set THRE1=819& set nit1=2.5& set THRE2=1229& set nit2=10& set THRE3=1362& set nit3=15& set THRE4=1542& set nit4=25& set THRE5=1666& set nit5=35& set THRE6=1803& set nit6=50& set THRE7=1964& set nit7=75& set THRE8=2048& set nit8=92
set A1=& set A2=& set A3=& set A4=& set A5=& set A6=& set A7=& set A8=& set P1=& set P2=& set P3=& set P4=& set P5=& set P6=& set P7=& set P8=& set AM=& set AA=
::2.5nits 819
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE1% -m over > "%TEMP%2.5avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%2.5avg.txt") do (
    set "percentage2.5avg=!percentage2.5avg!%%a"
)
if "%percentage2.5avg%"=="0.00" set percentage2.5avg=0
if "%percentage2.5avg%"=="00.00" set percentage2.5avg=0
if "%percentage2.5avg%"=="" set percentage2.5avg=0
set A1=-annotate +2160+140 "MaxFALL Percentage Above  %nit1%nits: %percentage2.5avg%"

::10nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE2% -m over > "%TEMP%10avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%10avg.txt") do (
    set "percentage10avg=!percentage10avg!%%a"
)
if "%percentage10avg%"=="0.00" set percentage10avg=0
if "%percentage10avg%"=="00.00" set percentage10avg=0
if "%percentage10avg%"=="" set percentage10avg=0
set A2=-annotate +2160+120 "MaxFALL Percentage Above   %nit2%nits: %percentage10avg%"

::25nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE3% -m over > "%TEMP%25avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%25avg.txt") do (
    set "percentage25avg=!percentage25avg!%%a"
)
if "%percentage25avg%"=="0.00" set percentage25avg=0
if "%percentage25avg%"=="00.00" set percentage25avg=0
if "%percentage25avg%"=="" set percentage25avg=0
set A3=-annotate +2160+100 "MaxFALL Percentage Above   %nit3%nits: %percentage25avg%"

::50nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE4% -m over > "%TEMP%50avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%50avg.txt") do (
    set "percentage50avg=!percentage50avg!%%a"
)
if "%percentage50avg%"=="0.00" set percentage50avg=0
if "%percentage50avg%"=="00.00" set percentage50avg=0
if "%percentage50avg%"=="" set percentage50avg=0
set A4=-annotate +2160+80 "MaxFALL Percentage Above   %nit4%nits: %percentage50avg%"

::92nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE5% -m over > "%TEMP%91avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%91avg.txt") do (
    set "percentage91avg=!percentage91avg!%%a"
)
if "%percentage91avg%"=="0.00" set percentage91avg=0
if "%percentage91avg%"=="00.00" set percentage91avg=0
if "%percentage91avg%"=="" set percentage91avg=0
set A5=-annotate +2160+60 "MaxFALL Percentage Above   %nit5%nits: %percentage91avg%"

::100nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE6% -m over > "%TEMP%100avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%100avg.txt") do (
    set "percentage100avg=!percentage100avg!%%a"
)
if "%percentage100avg%"=="0.00" set percentage100avg=0
if "%percentage100avg%"=="00.00" set percentage100avg=0
if "%percentage100avg%"=="" set percentage100avg=0
set A6=-annotate +2160+40 "MaxFALL Percentage Above %nit6%nits: %percentage100avg%"

::150nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE7% -m over > "%TEMP%150avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%150avg.txt") do (
    set "percentage150avg=!percentage150avg!%%a"
)
if "%percentage150avg%"=="0.00" set percentage150avg=0
if "%percentage150avg%"=="00.00" set percentage150avg=0
if "%percentage150avg%"=="" set percentage150avg=0
set A7=-annotate +2160+20 "MaxFALL Percentage Above %nit7%nits: %percentage150avg%"

::200nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.avg.pq.txt" -t %THRE8% -m over > "%TEMP%200avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%200avg.txt") do (
    set "percentage200avg=!percentage200avg!%%a"
)
if "%percentage200avg%"=="0.00" set percentage200avg=0
if "%percentage200avg%"=="00.00" set percentage200avg=0
if "%percentage200avg%"=="" set percentage200avg=0
set A8=-annotate +2160+0 "MaxFALL Percentage Above %nit8%nits: %percentage200avg%"
echo Done.
echo.
del "%TEMP%91avg.txt" & del "%TEMP%50avg.txt" & del "%TEMP%25avg.txt" & del "%TEMP%10avg.txt" & del "%TEMP%2.5avg.txt" & del "%TEMP%100avg.txt" & del "%TEMP%150avg.txt" & del "%TEMP%200avg.txt"

echo \033[92mCalculating per shot MaxCLL threshold... | "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level1.max_pq" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.max.pq.txt"

::-------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------

::---------------------------------maxcll stats----------------------------------------------------------------------

set percentage150max=& set percentage500max=& set percentage1000max=& set percentage2000max=& set percentage4000max=& set percentage200max=& set percentage800max=& set percentage1500max=
set THRE1=2081& set nit1=100& set THRE2=2372& set nit2=200& set THRE3=2771& set nit3=500& set THRE4=2979& set nit4=800& set THRE5=3079& set nit5=1000& set THRE6=3260& set nit6=1500& set THRE7=3388& set nit7=2000& set THRE8=3696& set nit8=4000
if "%rec709%"=="y" set THRE1=1229& set nit1=10& set THRE2=1362& set nit2=15& set THRE3=1542& set nit3=25& set THRE4=1666& set nit4=35& set THRE5=1803& set nit5=50& set THRE6=1964& set nit6=75& set THRE7=2048& set nit7=92& set THRE8=2081& set nit8=100

::150nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE1% -m over > "%TEMP%150max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%150max.txt") do (
    set "percentage150max=!percentage150max!%%a"
)
if "%percentage150max%"=="0.00" set percentage150max=0
if "%percentage150max%"=="00.00" set percentage150max=0
if "%percentage150max%"=="" set percentage150max=0
set P1=-annotate +2580+140 "MaxCLL Percentage Above   %nit1%nits: %percentage150max%"

::200nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE2% -m over > "%TEMP%200max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%200max.txt") do (
    set "percentage200max=!percentage200max!%%a"
)
if "%percentage200max%"=="0.00" set percentage200max=0
if "%percentage200max%"=="00.00" set percentage200max=0
if "%percentage200max%"=="" set percentage200max=0
set P2=-annotate +2580+120 "MaxCLL Percentage Above   %nit2%nits: %percentage200max%"

::500nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE3% -m over > "%TEMP%500max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%500max.txt") do (
    set "percentage500max=!percentage500max!%%a"
)
if "%percentage500max%"=="" set percentage500max=0
if "%percentage500max%"=="0.00" set percentage500max=0
if "%percentage500max%"=="00.00" set percentage500max=0
set P3=-annotate +2580+100 "MaxCLL Percentage Above   %nit3%nits: %percentage500max%"

::800nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE4% -m over > "%TEMP%800max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%800max.txt") do (
    set "percentage800max=!percentage800max!%%a"
)
if "%percentage800max%"=="0.00" set percentage800max=0
if "%percentage800max%"=="00.00" set percentage800max=0
if "%percentage800max%"=="" set percentage800max=0
set P4=-annotate +2580+80 "MaxCLL Percentage Above   %nit4%nits: %percentage800max%"

::1000nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE5% -m over > "%TEMP%1000max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%1000max.txt") do (
    set "percentage1000max=!percentage1000max!%%a"
)
if "%percentage1000max%"=="0.00" set percentage1000max=0
if "%percentage1000max%"=="00.00" set percentage1000max=0
if "%percentage1000max%"=="" set percentage1000max=0
set P5=-annotate +2580+60 "MaxCLL Percentage Above %nit5%nits: %percentage1000max%"

::1500nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE6% -m over > "%TEMP%1500max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%1500max.txt") do (
    set "percentage1500max=!percentage1500max!%%a"
)
if "%percentage1500max%"=="0.00" set percentage1500max=0
if "%percentage1500max%"=="00.00" set percentage1500max=0
if "%percentage1500max%"=="" set percentage1500max=0
set P6=-annotate +2580+40 "MaxCLL Percentage Above %nit6%nits: %percentage1500max%"

::2000nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE7% -m over > "%TEMP%2000max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%2000max.txt") do (
    set "percentage2000max=!percentage2000max!%%a"
)
if "%percentage2000max%"=="0.00" set percentage2000max=0
if "%percentage2000max%"=="00.00" set percentage2000max=0
if "%percentage2000max%"=="" set percentage2000max=0
set P7=-annotate +2580+20 "MaxCLL Percentage Above %nit7%nits: %percentage2000max%"

::4000nits
python "%~dp0tools\Percent.target.py" -i "%letterpath%\data.raw\.max.pq.txt" -t %THRE8% -m over > "%TEMP%4000max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%4000max.txt") do (
    set "percentage4000max=!percentage4000max!%%a"
)
if "%percentage4000max%"=="0.00" set percentage4000max=0
if "%percentage4000max%"=="00.00" set percentage4000max=0
if "%percentage4000max%"=="" set percentage4000max=0
set P8=-annotate +2580+0 "MaxCLL Percentage Above %nit8%nits: %percentage4000max%"

echo Done.
echo.

del "%TEMP%4000max.txt" & del "%TEMP%2000max.txt" & del "%TEMP%1000max.txt" & del "%TEMP%500max.txt" & del "%TEMP%150max.txt" & del "%TEMP%1500max.txt" & del "%TEMP%200max.txt" & del "%TEMP%800max.txt"
::-------------------------------------------------------------------------------------------------------------------------
set actualmax=& set actualavg=
::find the actual maxcll/fall shot, display the first frame
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\data.raw\.max.pq.txt" -m max > "%TEMP%actualmax.txt"
for /f "usebackq delims=" %%a in ("%TEMP%actualmax.txt") do (
    set "actualmax=!actualmax!%%a"
)

set AM=-annotate +1760+40 "MaxCLL Scene starts at frame %actualmax%"

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\data.raw\.avg.pq.txt" -m max > "%TEMP%actualavg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%actualavg.txt") do (
    set "actualavg=!actualavg!%%a"
)

set AA=-annotate +1760+15 "MaxFALL Scene starts at frame %actualavg%"

del "%TEMP%actualmax.txt" & del "%TEMP%actualavg.txt"

if exist "%letterpath%\data.raw\" rmdir /Q /S  "%letterpath%\data.raw\"
::-------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------

:skip.average
set L8trims=& set L9MDP=&set level5=& set blanksize=&set namepos=72&set L2trims=&set range.type=
if /i "%generate_stats%"=="NO" if /i "%cmv4.0%"=="y" set L8trims=-annotate +2623+118  "L8 trims: %t8.1%%t8.4%%t8.2%%t8.3%"
if /i "%generate_stats%"=="NO" set level5=-annotate +2623+88  "L5: R=%right%, L=%left%, T=%top%, B=%bottom%"
if /i "%generate_stats%"=="NO" if "%level9%"=="y" set L9MDP=-annotate +480+122  "%MDP.RPU%"

if /i "%generate_stats%"=="YES" if "%t1%"=="" if "%t2%"==""  if "%t3%"==""  if "%t4%"=="" set t1=NONE
if /i "%generate_stats%"=="YES" if "%t8.1%"=="" if "%t8.2%"==""  if "%t8.3%"==""  if "%t8.4%"=="" set t8.1=NONE
if /i "%generate_stats%"=="YES" if /i "%cmv4.0%"=="y" set L8trims=-annotate +1760+115  "L8 trim(s): %t8.1%%t8.4%%t8.2%%t8.3%"
if /i "%generate_stats%"=="YES" set L2trims=-annotate +1760+90  "L2 trim(s): %t1%%t2%%t3%%t4%"
if /i "%generate_stats%"=="YES" set level5=-annotate +1760+65  "L5: R=%right%, L=%left%, T=%top%, B=%bottom%"
if /i "%generate_stats%"=="YES" set blanksize=-fill white -stroke none -draw "rectangle 1243,0 3000,150" -gravity NorthWest
if /i "%generate_stats%"=="YES" if "%level9%"=="y" set L9MDP=-annotate +480+102  "%MDP.RPU%"
if /i "%generate_stats%"=="YES" set namepos=53
if /i "%generate_stats%"=="YES" set range.type=-annotate +1500+80 "DoVi L1 PLOT"

:plot
"%dovi_tool_path%" plot %RPU% -o "%TEMP%%filename1%_DoVi_L1_PLOT.png"
if exist "%output_path%scenes.txt" del "%output_path%scenes.txt"

if /i "%generate_stats%"=="NO" "%imagemagick%" convert "%TEMP%%filename1%_DoVi_L1_PLOT.png" -quality 100 -pointsize 20 -fill black -annotate +120+%namepos% "%OSD.filename1%" %level5% %L2trims% %L8trims% %range.type% %A1% %A2% %A3% %A4% %A5% %A6% %A7% %A8% %P1% %P2% %P3% %P4% %P5% %P6% %P7% %P8% %AM% %AA% -annotate +2945+178  "4095" -annotate +2945+260  "3696"  -annotate +2945+335  "3388" -annotate +2945+405  "3079" -annotate +2945+455  "2851" -annotate +2945+500  "2672"  -annotate +2945+570  "2372"  -annotate +2945+635  "2081"  -annotate +2945+700  "1803" -annotate +2945+760  "1542" -annotate +2945+835  "1229" -annotate +2945+880  "1015"  -annotate +2945+925  "819"  -annotate +2945+975  "614" "%output_path%%OSD.filename1%.DoVi_L1_PLOT.png"
if /i "%generate_stats%"=="YES" "%imagemagick%" convert "%TEMP%%filename1%_DoVi_L1_PLOT.png" %blanksize% -quality 100 -pointsize 20 -fill black -annotate +120+%namepos% "%OSD.filename1%" %level5% %L2trims% %L8trims% %range.type% %A1% %A2% %A3% %A4% %A5% %A6% %A7% %A8% %P1% %P2% %P3% %P4% %P5% %P6% %P7% %P8% %AM% %AA% -annotate +2945+159  "4095" -annotate +2945+241  "3696"  -annotate +2945+316  "3388" -annotate +2945+386  "3079" -annotate +2945+436  "2851" -annotate +2945+481  "2672"  -annotate +2945+551  "2372"  -annotate +2945+616  "2081"  -annotate +2945+681  "1803" -annotate +2945+741  "1542" -annotate +2945+816  "1229" -annotate +2945+861  "1015"  -annotate +2945+906  "819"  -annotate +2945+956  "614" "%output_path%%OSD.filename1%.DoVi_L1_PLOT.png"

if "%plotimage.res%"=="3000:1200"  goto :skipresizing
"%ffmpeg_path%" -i "%output_path%%OSD.filename1%.DoVi_L1_PLOT.png" -vf "scale=%plotimage.res%:flags=spline" -q:v 0 "%output_path%%OSD.filename1%_DoVi_L1_PLOT.png" 2>nul
del "%output_path%%OSD.filename1%.DoVi_L1_PLOT.png"

:skipresizing
if "%job%"=="justL1" goto :skipcmv4

::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------------------check trims--------------------------------------------------------------------------------------------------
::--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

set t6=n& set t1=n& set t0=n& set t2=n& set cmv4.0=n& set DM=& set profile=& set frames=& set shot=
"%dovi_tool_path%" info -s %RPU% >"%TEMP%rpu.info.txt"
type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"
type "%TEMP%rpu.info.txt" | findstr Frames: > "%TEMP%frames.txt"
type "%TEMP%rpu.info.txt" | findstr Profile: > "%TEMP%profile.txt"
type "%TEMP%rpu.info.txt" | findstr "DM" > "%TEMP%DM.txt"
type "%TEMP%rpu.info.txt" | findstr count: > "%TEMP%shot.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%shot.txt"') do (
    set "shot=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%frames.txt"') do (
    set "frames=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%profile.txt"') do (
    set "profile=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%DM.txt"') do (
    set "DM=%%a"
)

findstr /c:"100 nits" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t0=y
findstr /c:"600" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t6=y
findstr /c:"1000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t1=y
findstr /c:"2000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2=y
findstr /c:"4.0" "%TEMP%DM.txt" >Nul
if %errorlevel%==0 set cmv4.0=y

if /i "%trims_plot_mode%"=="OLD" goto :OLDTRIMSPLOT
if /i "%cmv4.0%"=="y" if /i "%cmv4.0.only%"=="YES" goto :plotcmv4only

if /i "%t0%"=="y" (
    echo.
    echo Plotting Level 2 100nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L2_100nits)" -p l2 --target-nits 100 -o "%output_path%%filename1%_DoVi_L2_100nits_PLOT.png"
)

if /i "%t6%"=="y" (
    echo.
    echo Plotting Level 2 600nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L2_600nits)" -p l2 --target-nits 600 -o "%output_path%%filename1%_DoVi_L2_600nits_PLOT.png"
)

if /i "%t1%"=="y" (
    echo.
    echo Plotting Level 2 1000nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L2_1000nits)" -p l2 --target-nits 1000 -o "%output_path%%filename1%_DoVi_L2_1000nits_PLOT.png"
)

if /i "%t2%"=="y" (
    echo.
    echo Plotting Level 2 2000nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L2_2000nits)" -p l2 --target-nits 2000 -o "%output_path%%filename1%_DoVi_L2_2000nits_PLOT.png"
)


:plotcmv4only
if /i "%L8_100%"=="y" (
    echo.
    echo Plotting Level 8 100nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L8_100nits)" -p l8 --target-nits 100 -o "%output_path%%filename1%_DoVi_L8_100nits_PLOT.png"
)

if /i "%L8_300%"=="y" (
    echo.
    echo Plotting Level 8 300nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L8_300nits)" -p l8 --target-nits 300 -o "%output_path%%filename1%_DoVi_L8_300nits_PLOT.png"
)

if /i "%L8_600%"=="y" (
    echo.
    echo Plotting Level 8 600nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L8_600nits)" -p l8 --target-nits 600 -o "%output_path%%filename1%_DoVi_L8_600nits_PLOT.png"
)

if /i "%L8_1000%"=="y" (
    echo.
    echo Plotting Level 8 1000nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L8_1000nits)" -p l8 --target-nits 1000 -o "%output_path%%filename1%_DoVi_L8_1000nits_PLOT.png"
)

if /i "%L8_2000%"=="y" (
    echo.
    echo Plotting Level 8 2000nits trim
    echo.
    "%dovi_tool_path%" plot %RPU% -t "%filename1% (L8_2000nits)" -p l8 --target-nits 2000 -o "%output_path%%filename1%_DoVi_L8_2000nits_PLOT.png"
)

goto :skipcmv4

:OLDTRIMSPLOT

::########################################################################################################
::-----------------------------------------------------------------------------------------------------L2 100 old-------------------------------------------------------------------------------------------
::########################################################################################################

if /i "%cmv4.0%"=="y" if /i "%cmv4.0.only%"=="YES"  goto :skipL2
if "%t0%"=="n" goto :600

MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     ================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 2 (100nits) - | "%cmdcolor%"
echo \033[36m     ================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2081)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2081) | .Level2.trim_slope" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2081)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2081) | .Level2.trim_offset" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2081)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2081) | .Level2.trim_power" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2081)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2081) | .Level2.trim_chroma_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2081)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2081) | .Level2.trim_saturation_gain" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2081)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2081) | .Level2.ms_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.ms.weight.txt"
echo Done.

::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1
::----------------------------------------------------------------------------------------------------------------------------------------------------------------
::plot data
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 2 100nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L2.PLOT.100nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta"  >> "%TEMP%1.gp
echo Plotting...
"%gnuplot%" "%TEMP%1.gp" >Nul
echo Done.

if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"
::-----------------------------------------------------------------------------------------------------L2 600-------------------------------------------------------------------------------------------

:600
if "%t6%"=="n" goto :1000
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     ================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 2 (600nits) - | "%cmdcolor%"
echo \033[36m     ================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2851)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2851) | .Level2.trim_slope" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2851)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2851) | .Level2.trim_offset" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2851)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2851) | .Level2.trim_power" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2851)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2851) | .Level2.trim_chroma_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2851)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2851) | .Level2.trim_saturation_gain" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 2851)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 2851) | .Level2.ms_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.ms.weight.txt"
echo Done.

::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1

::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 2 600nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L2.PLOT.600nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta"  >> "%TEMP%1.gp
echo Plotting...
"%gnuplot%" "%TEMP%1.gp" >Nul
echo Done.

if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"
::-----------------------------------------------------------------------------------------------------L2 1000-------------------------------------------------------------------------------------------

:1000
if "%t1%"=="n" goto :2000
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     =================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 2 (1000nits) - | "%cmdcolor%"
echo \033[36m     =================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3079)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3079) | .Level2.trim_slope" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3079)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3079) | .Level2.trim_offset" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3079)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3079) | .Level2.trim_power" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3079)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3079) | .Level2.trim_chroma_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3079)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3079) | .Level2.trim_saturation_gain" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3079)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3079) | .Level2.ms_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.ms.weight.txt"
echo Done.

::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1

::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 2 1000nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L2.PLOT.1000nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta"  >> "%TEMP%1.gp
echo Plotting...
"%gnuplot%" "%TEMP%1.gp" >Nul
echo Done.

if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

::-----------------------------------------------------------------------------------------------------L2 2000-------------------------------------------------------------------------------------------

:2000
if "%t2%"=="n" goto :skipL2

MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     =================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 2 (2000nits) - | "%cmdcolor%"
echo \033[36m     =================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3388)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3388) | .Level2.trim_slope" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3388)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3388) | .Level2.trim_offset" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3388)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3388) | .Level2.trim_power" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3388)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3388) | .Level2.trim_chroma_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3388)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3388) | .Level2.trim_saturation_gain" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level2.target_max_pq; . == 3388)) | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[] | select(.Level2.target_max_pq == 3388) | .Level2.ms_weight" "%TEMP%RPU.json" > "%letterpath%\trims.raw\.trim.ms.weight.txt"
echo Done.

::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1

::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 2 2000nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L2.PLOT.2000nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta"  >> "%TEMP%1.gp
echo Plotting...
"%gnuplot%" "%TEMP%1.gp" >Nul
echo Done.

if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

::----------------------------------------------------------------------------L3-----------------------------------------------------------------------------------------------------
:skipL2

if /i "%cmv4.0%"=="n" goto :skipcmv4
if /i "%plot_L3%"=="NO" goto :L8.100

MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     =======================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 3 - | "%cmdcolor%"
echo \033[36m     =======================| "%cmdcolor%"
echo.
echo ----^> Min.offset...
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level3.min_pq_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.min.offset.txt"
echo ----^> Max.offset...
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level3.max_pq_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.max.offset.txt"
echo ----^> Avg.offset...
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level3.avg_pq_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.avg.offset.txt"
echo Done.
echo.

::---------------------AVG stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set AVG_percentage_value_over_2048=& set AVG_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "AVG_percentage_value_over_2048=!AVG_percentage_value_over_2048!%%a"
)
if "%AVG_percentage_value_over_2048%"=="0.00" set AVG_percentage_value_over_2048=0.00
if "%AVG_percentage_value_over_2048%"=="00.00" set AVG_percentage_value_over_2048=0.00
if "%AVG_percentage_value_over_2048%"=="" set AVG_percentage_value_over_2048=0.00
if "%AVG_percentage_value_over_2048%"=="0" set AVG_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "AVG_percentage_value_under_2048=!AVG_percentage_value_under_2048!%%a"
)
if "%AVG_percentage_value_under_2048%"=="0.00" set AVG_percentage_value_under_2048=0.00
if "%AVG_percentage_value_under_2048%"=="00.00" set AVG_percentage_value_under_2048=0.00
if "%AVG_percentage_value_under_2048%"=="" set AVG_percentage_value_under_2048=0.00
if "%AVG_percentage_value_under_2048%"=="0" set AVG_percentage_value_under_2048=0.00

::total min max avg values
set AVG_Total=& set AVG_min=& set AVG_max=& set AVG_avg=& set AVGmaxline=& set AVGminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.avg.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "AVG_Total=!AVG_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "AVG_min=!AVG_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "AVG_max=!AVG_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "AVG_avg=!AVG_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "AVGmaxline=!AVGmaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.avg.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "AVGminline=!AVGminline!%%a"
)
set /a AVGmaxline=%AVGmaxline% - 1
set /a AVGminline=%AVGminline% - 1

::---------------------MAX stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set MAX_percentage_value_over_2048=& set MAX_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.max.offset.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "MAX_percentage_value_over_2048=!MAX_percentage_value_over_2048!%%a"
)
if "%MAX_percentage_value_over_2048%"=="0.00" set MAX_percentage_value_over_2048=0.00
if "%MAX_percentage_value_over_2048%"=="00.00" set MAX_percentage_value_over_2048=0.00
if "%MAX_percentage_value_over_2048%"=="" set MAX_percentage_value_over_2048=0.00
if "%MAX_percentage_value_over_2048%"=="0" set MAX_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.max.offset.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "MAX_percentage_value_under_2048=!MAX_percentage_value_under_2048!%%a"
)
if "%MAX_percentage_value_under_2048%"=="0.00" set MAX_percentage_value_under_2048=0.00
if "%MAX_percentage_value_under_2048%"=="00.00" set MAX_percentage_value_under_2048=0.00
if "%MAX_percentage_value_under_2048%"=="" set MAX_percentage_value_under_2048=0.00
if "%MAX_percentage_value_under_2048%"=="0" set MAX_percentage_value_under_2048=0.00

::total min max avg values
set MAX_Total=& set MAX_min=& set MAX_max=& set MAX_avg=& set MAXmaxline=& set MAXminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.max.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "MAX_Total=!MAX_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.max.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "MAX_min=!MAX_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.max.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "MAX_max=!MAX_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.max.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "MAX_avg=!MAX_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.max.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "MAXmaxline=!MAXmaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.max.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "MAXminline=!MAXminline!%%a"
)
set /a MAXmaxline=%MAXmaxline% - 1
set /a MAXminline=%MAXminline% - 1

::---------------------MIN stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set MIN_percentage_value_over_2048=& set MIN_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.min.offset.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "MIN_percentage_value_over_2048=!MIN_percentage_value_over_2048!%%a"
)
if "%MIN_percentage_value_over_2048%"=="0.00" set MIN_percentage_value_over_2048=0.00
if "%MIN_percentage_value_over_2048%"=="00.00" set MIN_percentage_value_over_2048=0.00
if "%MIN_percentage_value_over_2048%"=="" set MIN_percentage_value_over_2048=0.00
if "%MIN_percentage_value_over_2048%"=="0" set MIN_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.min.offset.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "MIN_percentage_value_under_2048=!MIN_percentage_value_under_2048!%%a"
)
if "%MIN_percentage_value_under_2048%"=="0.00" set MIN_percentage_value_under_2048=0.00
if "%MIN_percentage_value_under_2048%"=="00.00" set MIN_percentage_value_under_2048=0.00
if "%MIN_percentage_value_under_2048%"=="" set MIN_percentage_value_under_2048=0.00
if "%MIN_percentage_value_under_2048%"=="0" set MIN_percentage_value_under_2048=0.00

::total min max avg values
set MIN_Total=& set MIN_min=& set MIN_max=& set MIN_avg=& set MINmaxline=& set MINminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.min.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "MIN_Total=!MIN_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.min.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "MIN_min=!MIN_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.min.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "MIN_max=!MIN_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.min.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "MIN_avg=!MIN_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.min.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "MINmaxline=!MINmaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.min.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "MINminline=!MINminline!%%a"
)
set /a MINmaxline=%MINmaxline% - 1
set /a MINminline=%MINminline% - 1

echo set title "Dolby Vision Level 3 plot (2048=no effect)" > "%TEMP%1.gp"
echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Profile:%profile%. Shots:%shot%. DM version:%DM%" at screen 0.05,0.96 left >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: AVG-PQ: %AVGminline%/%AVGmaxline% MAX-PQ: %MAXminline%/%MAXmaxline% MIN-PQ: %MINminline%/%MINmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "AVG Bright/Dark(Total): %AVG_percentage_value_under_2048%/%AVG_percentage_value_over_2048%(%AVG_total%) - Min/Max/Avg:%AVG_min%/%AVG_max%(%AVG_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "MAX Bright/Dark(Total): %MAX_percentage_value_under_2048%/%MAX_percentage_value_over_2048%(%MAX_total%) - Min/Max/Avg:%MAX_min%/%MAX_max%(%MAX_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "MIN Bright/Dark(Total): %MIN_percentage_value_under_2048%/%MIN_percentage_value_over_2048%(%MIN_total%) - Min/Max/Avg:%MIN_min%/%MIN_max%(%MIN_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L3.PLOT.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.min.offset.txt" with lines title "min.offset" lc rgb "blue", "%letterpath%\\trims.raw\\.max.offset.txt" with lines title "max.offset" lc rgb "green", "%letterpath%\\trims.raw\\.avg.offset.txt" with lines title "avg.offset" lc rgb "red" >> "%TEMP%1.gp

echo Plotting...
%gnuplot% "%TEMP%1.gp"
echo Done.
if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

:L8.100
if not "%L8_100%"=="y" goto :L8.300
::------------------------------------------------------------------------L8 100----------------------------------------------------------------------------------------------------------------
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     ================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 8 (100nits) - | "%cmdcolor%"
echo \033[36m     ================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.trim_slope" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.trim_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.trim_power" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.trim_chroma_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.trim_saturation_gain" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.ms_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.ms.weight.txt"

if "%mid_con%"=="y" echo ----^> Mid_Contrast...
if "%mid_con%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.target_mid_contrast" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.target.mid.contrast.txt"
if "%clip_trim%"=="y" echo ----^> Clip_Trim (highlights clipping)...
if "%clip_trim%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.clip_trim" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.clip.trim.txt"

::---------------------mid contasts stats----------------------------------------------------------------------------------------------------------------------------------------------
if not "%clip_trim%"=="y" goto :skipcliptrim
if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set HC_percentage_value_over_2048=& set HC_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.clip.trim.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "HC_percentage_value_over_2048=!HC_percentage_value_over_2048!%%a"
)
if "%HC_percentage_value_over_2048%"=="0.00" set HC_percentage_value_over_2048=0.00
if "%HC_percentage_value_over_2048%"=="00.00" set HC_percentage_value_over_2048=0.00
if "%HC_percentage_value_over_2048%"=="" set HC_percentage_value_over_2048=0.00
if "%HC_percentage_value_over_2048%"=="0" set HC_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.clip.trim.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "HC_percentage_value_under_2048=!HC_percentage_value_under_2048!%%a"
)
if "%HC_percentage_value_under_2048%"=="0.00" set HC_percentage_value_under_2048=0.00
if "%HC_percentage_value_under_2048%"=="00.00" set HC_percentage_value_under_2048=0.00
if "%HC_percentage_value_under_2048%"=="" set HC_percentage_value_under_2048=0.00
if "%HC_percentage_value_under_2048%"=="0" set HC_percentage_value_under_2048=0.00

::total min max avg values
set HC_Total=& set HC_min=& set HC_max=& set HC_avg=& set HCmaxline=& set HCminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.clip.trim.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "HC_Total=!HC_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.clip.trim.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "HC_min=!HC_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.clip.trim.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "HC_max=!HC_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.clip.trim.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "HC_avg=!HC_avg!%%a"
)

:skipcliptrim
::---------------------mid contasts stats----------------------------------------------------------------------------------------------------------------------------------------------
if not "%mid_con%"=="y" goto :skipmidcon
if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set MC_percentage_value_over_2048=& set MC_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.target.mid.contrast.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "MC_percentage_value_over_2048=!MC_percentage_value_over_2048!%%a"
)
if "%MC_percentage_value_over_2048%"=="0.00" set MC_percentage_value_over_2048=0.00
if "%MC_percentage_value_over_2048%"=="00.00" set MC_percentage_value_over_2048=0.00
if "%MC_percentage_value_over_2048%"=="" set MC_percentage_value_over_2048=0.00
if "%MC_percentage_value_over_2048%"=="0" set MC_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.target.mid.contrast.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "MC_percentage_value_under_2048=!MC_percentage_value_under_2048!%%a"
)
if "%MC_percentage_value_under_2048%"=="0.00" set MC_percentage_value_under_2048=0.00
if "%MC_percentage_value_under_2048%"=="00.00" set MC_percentage_value_under_2048=0.00
if "%MC_percentage_value_under_2048%"=="" set MC_percentage_value_under_2048=0.00
if "%MC_percentage_value_under_2048%"=="0" set MC_percentage_value_under_2048=0.00

::total min max avg values
set MC_Total=& set MC_min=& set MC_max=& set MC_avg=& set MCmaxline=& set MCminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.target.mid.contrast.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "MC_Total=!MC_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.target.mid.contrast.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "MC_min=!MC_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.target.mid.contrast.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "MC_max=!MC_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.target.mid.contrast.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "MC_avg=!MC_avg!%%a"
)

:skipmidcon
::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1

::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 8 100nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
if "%clip_trim%"=="y" echo set label "Highlights Unclip/Clip(Total): %HC_percentage_value_over_2048%/%HC_percentage_value_under_2048%(%HC_total%) - Min/Max/Avg:%HC_min%/%HC_max%(%HC_avg%)" at screen 0.98,0.80 right font ",15" >> "%TEMP%1.gp"
if "%mid_con%"=="y" echo set label "Mid Contrast Bright/Dark(Total): %MC_percentage_value_over_2048%/%MC_percentage_value_under_2048%(%MC_total%) - Min/Max/Avg:%MC_min%/%MC_max%(%MC_avg%)" at screen 0.98,0.78 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L8.PLOT.100nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta", "%letterpath%\\trims.raw\\.target.mid.contrast.txt" with lines title "mid.contrast" lt rgb "cyan", "%letterpath%\\trims.raw\\.clip.trim.txt" with lines title "clip.trim" lt rgb "dark-orange" >> "%TEMP%1.gp
echo Plotting...
%gnuplot% "%TEMP%1.gp" >Nul
echo Done.
echo.
if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

::------------------------------------------------------------------------L8 300----------------------------------------------------------------------------------------------------------------
:L8.300
if not "%L8_300%"=="y" goto :600
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     ================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 8 (300nits) - | "%cmdcolor%"
echo \033[36m     ================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.trim_slope" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.trim_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.trim_power" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.trim_chroma_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.trim_saturation_gain" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.ms_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.ms.weight.txt"

if "%mid_con%"=="y" echo ----^> Mid_Contrast...
if "%mid_con%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.target_mid_contrast" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.target.mid.contrast.txt"
if "%clip_trim%"=="y" echo ----^> Clip_Trim (highlights clipping)...
if "%clip_trim%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id3%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id3%) | .Level8.clip_trim" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.clip.trim.txt"

::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1

::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 8 300nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L8.PLOT.300nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta", "%letterpath%\\trims.raw\\.target.mid.contrast.txt" with lines title "mid.contrast" lt rgb "cyan", "%letterpath%\\trims.raw\\.clip.trim.txt" with lines title "clip.trim" lt rgb "dark-orange" >> "%TEMP%1.gp
echo Plotting...
%gnuplot% "%TEMP%1.gp" >Nul
echo Done.
echo.
if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

::------------------------------------------------------------------------L8 600----------------------------------------------------------------------------------------------------------------

:600
if not "%L8_600%"=="y" goto :skip.6
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     ================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 8 (600nits) - | "%cmdcolor%"
echo \033[36m     ================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.trim_slope" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.trim_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.trim_power" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.trim_chroma_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.trim_saturation_gain" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.ms_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.ms.weight.txt"

if "%mid_con%"=="y" echo ----^> Mid_Contrast...
if "%mid_con%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.target_mid_contrast" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.target.mid.contrast.txt"
if "%clip_trim%"=="y" echo ----^> Clip_Trim (highlights clipping)...
if "%clip_trim%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id%) | .Level8.clip_trim" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.clip.trim.txt"


::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1

::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 8 600nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L8.PLOT.600nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta", "%letterpath%\\trims.raw\\.target.mid.contrast.txt" with lines title "mid.contrast" lt rgb "cyan", "%letterpath%\\trims.raw\\.clip.trim.txt" with lines title "clip.trim" lt rgb "dark-orange" >> "%TEMP%1.gp
echo Plotting...
%gnuplot% "%TEMP%1.gp" >Nul
echo Done.

if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"
:skip.6
::------------------------------------------------------------------------L8 1000----------------------------------------------------------------------------------------------------------------

if not "%L8_1000%"=="y" goto :skip1000L8
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m     =================================| "%cmdcolor%"
echo \033[36m     - EXTRACTING Level 8 (1000nits) - | "%cmdcolor%"
echo \033[36m     =================================| "%cmdcolor%"
echo.
echo ----^> Slope (gain)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.trim_slope" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.slope.txt"
echo ----^> Offset (lift)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.trim_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.offset.txt"
echo ----^> Power (gamma)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.trim_power" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.power.txt"
echo ----^> Chroma_Weight...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.trim_chroma_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.chroma.weight.txt"
echo ----^> Saturation_Gain...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.trim_saturation_gain" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.saturation.gain.txt"
echo ----^> Ms_Weight (tone details)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.ms_weight" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.trim.ms.weight.txt"

if "%mid_con%"=="y" echo ----^> Mid_Contrast...
if "%mid_con%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.target_mid_contrast" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.target.mid.contrast.txt"
if "%clip_trim%"=="y" echo ----^> Clip_Trim (highlights clipping)..
if "%clip_trim%"=="y" "%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == %tar.id2%)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == %tar.id2%) | .Level8.clip_trim" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.clip.trim.txt"

::---------------------slope stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Slope_percentage_value_over_2048=& set Slope_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Slope_percentage_value_over_2048=!Slope_percentage_value_over_2048!%%a"
)
if "%Slope_percentage_value_over_2048%"=="0.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="00.00" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="" set Slope_percentage_value_over_2048=0.00
if "%Slope_percentage_value_over_2048%"=="0" set Slope_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Slope_percentage_value_under_2048=!Slope_percentage_value_under_2048!%%a"
)
if "%Slope_percentage_value_under_2048%"=="0.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="00.00" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="" set Slope_percentage_value_under_2048=0.00
if "%Slope_percentage_value_under_2048%"=="0" set Slope_percentage_value_under_2048=0.00

::total min max avg values
set Slope_Total=& set Slope_min=& set Slope_max=& set Slope_avg=& set slopemaxline=& set slopeminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.slope.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Slope_Total=!Slope_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Slope_min=!Slope_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Slope_max=!Slope_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Slope_avg=!Slope_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "slopemaxline=!slopemaxline!%%a"
)

python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.slope.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "slopeminline=!slopeminline!%%a"
)
set /a slopemaxline=%slopemaxline% - 1
set /a slopeminline=%slopeminline% - 1
::---------------------power stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set Power_percentage_value_over_2048=& set Power_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m under > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "Power_percentage_value_over_2048=!Power_percentage_value_over_2048!%%a"
)
if "%Power_percentage_value_over_2048%"=="0.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="00.00" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="" set Power_percentage_value_over_2048=0.00
if "%Power_percentage_value_over_2048%"=="0" set Power_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.power.txt" -t 2048 -m over > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "Power_percentage_value_under_2048=!Power_percentage_value_under_2048!%%a"
)
if "%Power_percentage_value_under_2048%"=="0.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="00.00" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="" set Power_percentage_value_under_2048=0.00
if "%Power_percentage_value_under_2048%"=="0" set Power_percentage_value_under_2048=0.00

::total min max avg values
set Power_Total=& set Power_min=& set Power_max=& set Power_avg=& set powermaxline=& set powerminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.power.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Power_Total=!Power_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Power_min=!Power_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Power_max=!Power_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Power_avg=!Power_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "powermaxline=!powermaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.power.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "powerminline=!powerminline!%%a"
)
set /a powerminline=%powerminline% - 1
set /a powermaxline=%powermaxline% - 1
::---------------------saturation stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set sat_percentage_value_over_2048=& set sat_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "sat_percentage_value_over_2048=!sat_percentage_value_over_2048!%%a"
)
if "%sat_percentage_value_over_2048%"=="0.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="00.00" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="" set sat_percentage_value_over_2048=0.00
if "%sat_percentage_value_over_2048%"=="0" set sat_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "sat_percentage_value_under_2048=!sat_percentage_value_under_2048!%%a"
)
if "%sat_percentage_value_under_2048%"=="0.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="00.00" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="" set sat_percentage_value_under_2048=0.00
if "%sat_percentage_value_under_2048%"=="0" set sat_percentage_value_under_2048=0.00

::total min max avg values
set sat_Total=& set sat_min=& set sat_max=& set sat_avg=& set satmaxline=& set satminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "sat_Total=!sat_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "sat_min=!sat_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "sat_max=!sat_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "sat_avg=!sat_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "satmaxline=!satmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.saturation.gain.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "satminline=!satminline!%%a"
)
set /a satmaxline=%satmaxline% - 1
set /a satminline=%satminline% - 1
::---------------------ms weight stats----------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%percentage_value_over_2048.txt" del "%TEMP%percentage_value_over_2048.txt"
if exist "%TEMP%percentage_value_under_2048.txt" del "%TEMP%percentage_value_under_2048.txt"
set ms_percentage_value_over_2048=& set ms_percentage_value_under_2048=

::over 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m over > "%TEMP%percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2048.txt") do (
    set "ms_percentage_value_over_2048=!ms_percentage_value_over_2048!%%a"
)
if "%ms_percentage_value_over_2048%"=="0.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="00.00" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="" set ms_percentage_value_over_2048=0.00
if "%ms_percentage_value_over_2048%"=="0" set ms_percentage_value_over_2048=0.00

::under 2048
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -t 2048 -m under > "%TEMP%percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_under_2048.txt") do (
    set "ms_percentage_value_under_2048=!ms_percentage_value_under_2048!%%a"
)
if "%ms_percentage_value_under_2048%"=="0.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="00.00" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="" set ms_percentage_value_under_2048=0.00
if "%ms_percentage_value_under_2048%"=="0" set ms_percentage_value_under_2048=0.00

::total min max avg values
set ms_Total=& set ms_min=& set ms_max=& set ms_avg=& set msmaxline=& set msminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "ms_Total=!ms_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "ms_min=!ms_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "ms_max=!ms_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "ms_avg=!ms_avg!%%a"
)
::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "msmaxline=!msmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.ms.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "msminline=!msminline!%%a"
)
set /a msminline=%msminline% - 1
set /a msmaxline=%msmaxline% - 1
::---------------------offset stats--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%Offset_percentage_value_over_2048.txt" del "%TEMP%Offset_percentage_value_over_2048.txt"
if exist "%TEMP%Offset_percentage_value_under_2048.txt" del "%TEMP%Offset_percentage_value_under_2048.txt"
set Offset_percentage_value_over_2048=& set Offset_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m over > "%TEMP%Offset_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_over_2048.txt") do (
    set "Offset_percentage_value_over_2048=!Offset_percentage_value_over_2048!%%a"
)
if "%Offset_percentage_value_over_2048%"=="0.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="00.00" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="" set Offset_percentage_value_over_2048=0.00
if "%Offset_percentage_value_over_2048%"=="0" set Offset_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2048 -m under > "%TEMP%Offset_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%Offset_percentage_value_under_2048.txt") do (
    set "Offset_percentage_value_under_2048=!Offset_percentage_value_under_2048!%%a"
)
if "%Offset_percentage_value_under_2048%"=="0.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="00.00" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="" set Offset_percentage_value_under_2048=0.00
if "%Offset_percentage_value_under_2048%"=="0" set Offset_percentage_value_under_2048=0.00

::total min max avg values
set Offset_Total=& set Offset_min=& set Offset_max=& set Offset_avg=& set offsetmaxline=& set offsetminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.offset.txt" > "%TEMP%total.txt"
for /f "usebackq delims=" %%a in ("%TEMP%total.txt") do (
    set "Offset_Total=!Offset_Total!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "Offset_min=!Offset_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "Offset_max=!Offset_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "Offset_avg=!Offset_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "offsetmaxline=!offsetmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "offsetminline=!offsetminline!%%a"
)
set /a offsetminline=%offsetminline% - 1
set /a offsetmaxline=%offsetmaxline% - 1

::offset over 2100
set percentage_value_over_2100=
if exist "%TEMP%percentage_value_over_2100.txt" del "%TEMP%percentage_value_over_2100.txt"
python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.offset.txt" -t 2100 -m over > "%TEMP%percentage_value_over_2100.txt"
for /f "usebackq delims=" %%a in ("%TEMP%percentage_value_over_2100.txt") do (
    set "percentage_value_over_2100=!percentage_value_over_2100!%%a"
)
if "%percentage_value_over_2100%"=="0.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="00.00" set percentage_value_over_2100=0
if "%percentage_value_over_2100%"=="" set percentage_value_over_2100=0

::-----------------chroma weight--------------------------------------------------------------------------------------------------------------------------------------------

if exist "%TEMP%CW_percentage_value_over_2048.txt" del "%TEMP%CW_percentage_value_over_2048.txt"
if exist "%TEMP%CW_percentage_value_under_2048.txt" del "%TEMP%CW_percentage_value_under_2048.txt"
set CW_percentage_value_over_2048=& set CW_percentage_value_under_2048=

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m over > "%TEMP%CW_percentage_value_over_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_over_2048.txt") do (
    set "CW_percentage_value_over_2048=!CW_percentage_value_over_2048!%%a"
)
if "%CW_percentage_value_over_2048%"=="0.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="00.00" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="" set CW_percentage_value_over_2048=0.00
if "%CW_percentage_value_over_2048%"=="0" set CW_percentage_value_over_2048=0.00

python "%~dp0tools\Percent.target.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -t 2048 -m under > "%TEMP%CW_percentage_value_under_2048.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW_percentage_value_under_2048.txt") do (
    set "CW_percentage_value_under_2048=!CW_percentage_value_under_2048!%%a"
)
if "%CW_percentage_value_under_2048%"=="0.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="00.00" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="" set CW_percentage_value_under_2048=0.00
if "%CW_percentage_value_under_2048%"=="0" set CW_percentage_value_under_2048=0.00

::total min max avg values
if exist "%TEMP%CW.txt" del "%TEMP%CW.txt"
set CW.percent=& set CW_min=& set CW_max=& set CW_avg=& set cwmaxline=& set cwminline=
python "%~dp0tools\chroma.checker.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" > "%TEMP%CW.txt"
for /f "usebackq delims=" %%a in ("%TEMP%CW.txt") do (
    set "CW.percent=!CW.percent!%%a"
)
if "%CW.percent%"=="0.0" set CW.percent=0.0
if "%CW.percent%"=="0.00" set CW.percent=0.0
if "%CW.percent%"=="00.00" set CW.percent=0.0
if "%CW.percent%"=="" set CW.percent=0.0

python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "CW_min=!CW_min!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "CW_max=!CW_max!%%a"
)
python "%~dp0tools\min_max_finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m avg > "%TEMP%avg.txt"
for /f "usebackq delims=" %%a in ("%TEMP%avg.txt") do (
    set "CW_avg=!CW_avg!%%a"
)

::find first shot max and min values
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m max > "%TEMP%max.txt"
for /f "usebackq delims=" %%a in ("%TEMP%max.txt") do (
    set "cwmaxline=!cwmaxline!%%a"
)
python "%~dp0tools\maxcll.shot.finder.py" -i "%letterpath%\trims.raw\.trim.chroma.weight.txt" -m min > "%TEMP%min.txt"
for /f "usebackq delims=" %%a in ("%TEMP%min.txt") do (
    set "cwminline=!cwminline!%%a"
)
set /a cwminline=%cwminline% - 1
set /a cwmaxline=%cwmaxline% - 1
::--------------------------------------------------------------
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.trim.ms.weight.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 8 1000nits plot (2048=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left font ",17" >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Shots:%shot%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left font ",17" >> "%TEMP%1.gp"
echo set label "MIN/MAX Frames: Slope: %slopeminline%/%slopemaxline% Power: %powerminline%/%powermaxline% Offset: %offsetminline%/%offsetmaxline% CW: %cwminline%/%cwmaxline% Sat: %satminline%/%satmaxline% MS: %msminline%/%msmaxline%" at screen 0.98,0.99 right font ",14" >> "%TEMP%1.gp"
echo set label "Positive Lift Percentage over 0.025: %percentage_value_over_2100%" at screen 0.98,0.96 right font ",17" >> "%TEMP%1.gp"
echo set label "Offset Bright/Dark(Total): %Offset_percentage_value_over_2048%/%Offset_percentage_value_under_2048%(%Offset_total%) - Min/Max/Avg:%Offset_min%/%Offset_max%(%Offset_avg%)" at screen 0.98,0.92 right font ",15" >> "%TEMP%1.gp"
echo set label "Slope Bright/Dark(Total): %Slope_percentage_value_over_2048%/%Slope_percentage_value_under_2048%(%Slope_total%) - Min/Max/Avg:%Slope_min%/%Slope_max%(%Slope_avg%)" at screen 0.98,0.90 right font ",15" >> "%TEMP%1.gp"
echo set label "Power Bright/Dark(Total): %Power_percentage_value_over_2048%/%Power_percentage_value_under_2048%(%Power_total%) - Min/Max/Avg:%Power_min%/%Power_max%(%Power_avg%)" at screen 0.98,0.88 right font ",15" >> "%TEMP%1.gp"
echo set label "Chroma Weight Bright/Dark(Total): %CW_percentage_value_over_2048%/%CW_percentage_value_under_2048%(%CW.percent%) - Min/Max/Avg:%CW_min%/%CW_max%(%CW_avg%)" at screen 0.98,0.86 right font ",15" >> "%TEMP%1.gp"
echo set label "Saturation/Desat(Total): %sat_percentage_value_over_2048%/%sat_percentage_value_under_2048%(%sat_total%) - Min/Max/Avg:%sat_min%/%sat_max%(%sat_avg%)" at screen 0.98,0.84 right font ",15" >> "%TEMP%1.gp"
echo set label "Highlights Sharp/Soft(Total): %ms_percentage_value_over_2048%/%ms_percentage_value_under_2048%(%ms_total%) - Min/Max/Avg:%ms_min%/%ms_max%(%ms_avg%)" at screen 0.98,0.82 right font ",15" >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L8.PLOT.1000nits.trim.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.trim.slope.txt" with lines title "slope (gain)" lc rgb "green", "%letterpath%\\trims.raw\\.trim.offset.txt" with lines title "offset (lift)" lc rgb "blue", "%letterpath%\\trims.raw\\.trim.power.txt" with lines title "power (gamma)" lc rgb "red", "%letterpath%\\trims.raw\\.trim.chroma.weight.txt" with lines title "chroma.weight" lc rgb "#FFA500", "%letterpath%\\trims.raw\\.trim.saturation.gain.txt" with lines title "saturation.gain" lt rgb "black", "%letterpath%\\trims.raw\\.trim.ms.weight.txt" with lines title "ms.weight" lt rgb "magenta", "%letterpath%\\trims.raw\\.target.mid.contrast.txt" with lines title "mid.contrast" lt rgb "cyan", "%letterpath%\\trims.raw\\.clip.trim.txt" with lines title "clip.trim" lt rgb "dark-orange"  >> "%TEMP%1.gp
echo Plotting...
%gnuplot% "%TEMP%1.gp" >Nul
echo Done.
if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

::---------------------------------------------------SAT--------------------------------------------------------------------
:skip1000L8
if /i "%plotvector%"=="NO" goto :skipcmv4
echo.
MD "%letterpath%\trims.raw\"
echo.
echo \033[36m      ================================| "%cmdcolor%"
echo \033[36m      - EXTRACTING Saturation Fields - | "%cmdcolor%"
echo \033[36m      ================================| "%cmdcolor%"
echo.
echo ----^> Vector Field0 (RED)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.saturation_vector_field0" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.saturation_vector_field0.txt"
echo ----^> Vector Field1 (YELLOW)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.saturation_vector_field1" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.saturation_vector_field1.txt"
echo ----^> Vector Field2 (GREEN)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.saturation_vector_field2" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.saturation_vector_field2.txt"
echo ----^> Vector Field3 (CYAN)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.saturation_vector_field3" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.saturation_vector_field3.txt"
echo ----^> Vector Field4 (BLUE)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.saturation_vector_field4" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.saturation_vector_field4.txt"
echo ----^> Vector Field5 (MAGENTA)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.saturation_vector_field5" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.saturation_vector_field5.txt"

echo Done.
echo.

for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.saturation_vector_field0.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 8 Saturation Vector Fields plot (128=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L8.Saturation.Vector.Field.PLOT.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.saturation_vector_field0.txt" with lines title "Saturation Red" lc rgb "red", "%letterpath%\\trims.raw\\.saturation_vector_field1.txt" with lines title "Saturation Yellow" lc rgb "yellow", "%letterpath%\\trims.raw\\.saturation_vector_field2.txt" with lines title "Saturation Green" lc rgb "green", "%letterpath%\\trims.raw\\.saturation_vector_field3.txt" with lines title "Saturation Cyan" lt rgb "cyan", "%letterpath%\\trims.raw\\.saturation_vector_field4.txt" with lines title "Saturation Blue" lt rgb "blue", "%letterpath%\\trims.raw\\.saturation_vector_field5.txt" with lines title "Saturation Magenta" lt rgb "magenta"  >> "%TEMP%1.gp
echo Plotting...
%gnuplot% "%TEMP%1.gp" >Nul
echo Done.
if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"


::---------------------------------------------------HUE--------------------------------------------------------------------
if /i "%plotvector%"=="NO" goto :skipcmv4
MD "%letterpath%\trims.raw\"

echo.
echo \033[36m        =========================| "%cmdcolor%"
echo \033[36m        - EXTRACTING HUE Fields - | "%cmdcolor%"
echo \033[36m        =========================| "%cmdcolor%"
echo.
echo ----^> Vector Field0 (RED)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.hue_vector_field0" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.hue_vector_field0.txt"
echo ----^> Vector Field1 (YELLOW)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.hue_vector_field1" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.hue_vector_field1.txt"
echo ----^> Vector Field2 (GREEN)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.hue_vector_field2" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.hue_vector_field2.txt"
echo ----^> Vector Field3 (CYAN)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.hue_vector_field3" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.hue_vector_field3.txt"
echo ----^> Vector Field4 (BLUE)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.hue_vector_field4" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.hue_vector_field4.txt"
echo ----^> Vector Field5 (MAGENTA)...
"%JQ_path%" "to_entries[] | select(any(.value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[]?.Level8.target_display_index; . == 1)) | .value.vdr_dm_data.cmv40_metadata.ext_metadata_blocks[] | select(.Level8.target_display_index == 1) | .Level8.hue_vector_field5" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\trims.raw\.hue_vector_field5.txt"

echo Done.
echo.
for /f %%a in ('find /c /v "" ^< "%letterpath%\trims.raw\.hue_vector_field0.txt"') do set "lines=%%a"
echo set title "Dolby Vision Level 8 Hue Vector Field plot (128=no effect)" > "%TEMP%1.gp"
if /i "%auto_scale_plot%"=="NO" echo set yrange [0:4110] >> "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key bottom left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Profile:%profile%. Count:%lines%. DM version:%DM%" at screen 0.05,0.96 left >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L8.HUE.Vector.Field.PLOT.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\trims.raw\\.hue_vector_field0.txt" with lines title "hue Red" lc rgb "red", "%letterpath%\\trims.raw\\.hue_vector_field1.txt" with lines title "hue Yellow" lc rgb "yellow", "%letterpath%\\trims.raw\\.hue_vector_field2.txt" with lines title "hue Green" lc rgb "green", "%letterpath%\\trims.raw\\.hue_vector_field3.txt" with lines title "hue Cyan" lt rgb "cyan", "%letterpath%\\trims.raw\\.hue_vector_field4.txt" with lines title "hue Blue" lt rgb "blue", "%letterpath%\\trims.raw\\.hue_vector_field5.txt" with lines title "hue Magenta" lt rgb "magenta"  >> "%TEMP%1.gp
echo Plotting...
%gnuplot% "%TEMP%1.gp" >Nul
echo Done.
if exist "%letterpath%\trims.raw\" rmdir /Q /S "%letterpath%\trims.raw\"

:skipcmv4
set ID=& set lang_id=& set HDR=& set RPU=& set tt=& set left=& set right=& set top=& set bottom=& set tar.id=& set tar.id2=& set frames=& set profile=& set lines=& set DM=& set mid_con=& set clip_trim=& set L8_1000=& set L8_600=& set L8_100=& set shot=& set video.count=& set DT=&set cmv4.0=

:end
set OSD.filename1=
echo.
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.L2
)
setlocal disabledelayedexpansion

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
set OSD.filename1=
echo \033[92m "The script has been completed, press a key to plot again..."| "%cmdcolor%" & set fileext1=& pause & goto :Plot.L2.Again

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ------------------------------------------------------------MEASURE DoVi L5 L6--------------------------------------------------------------------------------------------------
:Workflow.5
:plot.l5.again
echo.
echo \033[36m          ================= | "%cmdcolor%"
echo \033[36m          - PLOT L4-L5-L6 - | "%cmdcolor%"
echo \033[36m          ================= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow can plot Dolby Vision Level 4/5/6 metadata
echo -- Input can be RPU/MKV/TS/M2TS/MP4/XML/hevc//h265/BDMV/xml
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
cd /d "%output_path%"

set /p input="Drag and drop your input and press enter..."

echo.
echo Which level(s) ^do you want to plot^? (default= a)
echo.
echo --^> All= a
echo --^> L4= 4
echo --^> L5= 5
echo --^> L6= 6
set /p plot_level=
if [%plot_level%]==[] set plot_level=a

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion
if "%OSD.filename1%"=="" set OSD.filename1=%filename%
:: make and set temp folder
if exist "%temp_folder%temp.folder21_new" rmdir /Q /S "%temp_folder%temp.folder21_new"
if exist "%temp_folder%temp.folder21" set E1=_new
MD "%temp_folder%temp.folder21%E1%"
set TEMP=%temp_folder%temp.folder21%E1%\

if /i "%same_input_output%"=="YES" set output_path=%filepath%

if /i "%fileext%"==".hevc" "%dovi_tool_path%" extract-rpu %input% -o "%output_path%%filename%_rpu.bin" & set RPU="%output_path%%filename%_rpu.bin"& goto :skip.demux
if /i "%fileext%"==".h265" "%dovi_tool_path%" extract-rpu %input% -o "%output_path%%filename%_rpu.bin" & set RPU="%output_path%%filename%_rpu.bin"& goto :skip.demux
if /i "%fileext%"==".bin" set RPU="%filepath%%filename%.bin"& goto :skip.demux
if /i "%fileext%"==".xml" (
     "%dovi_tool_path%" generate --xml "%filepath%%filename%%fileext%" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%.RPU.bin"
	 set RPU="%TEMP%.RPU.bin"
	 goto :skip.demux
)

::check for dual track dual layer p7 input
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%video.count%"=="2" set DT=-map 0:1 

if not "%fileext%"==".mkv" set ffmpeg_pipe_secondary=YES
if /i  "%ffmpeg_pipe_secondary%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o "%output_path%%filename%_RPU.bin"
set RPU="%output_path%%filename%_RPU.bin"
goto :skip.demux

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" %DT% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" extract-rpu -o "%output_path%%filename%_RPU.bin" -
set RPU="%output_path%%filename%_RPU.bin"

:skip.demux

"%dovi_tool_path%" info -s %RPU% >"%TEMP%rpu.info.txt"
"%dovi_tool_path%" export -i %RPU%  -o "%TEMP%full.json"
type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"
type "%TEMP%rpu.info.txt" | findstr Frames: > "%TEMP%frames.txt"
type "%TEMP%rpu.info.txt" | findstr Profile: > "%TEMP%profile.txt"
type "%TEMP%rpu.info.txt" | findstr "DM" > "%TEMP%DM.txt"
type "%TEMP%rpu.info.txt" | findstr count: > "%TEMP%shot.txt"

for /f "tokens=2 delims=:" %%a in ('type "%TEMP%shot.txt"') do (
    set "shot=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%frames.txt"') do (
    set "frames=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%profile.txt"') do (
    set "profile=%%a"
)
for /f "tokens=2 delims=:" %%a in ('type "%TEMP%DM.txt"') do (
    set "DM=%%a"
)

findstr /c:"4.0" "%TEMP%DM.txt" >Nul
if %errorlevel%==1 set cmv4.0=n

set Level5=y& set Level4=y
findstr /c:"Level4" "%TEMP%full.json" >Nul
if %errorlevel%==1 set Level4=n
findstr /c:"Level5" "%TEMP%full.json" >Nul
if %errorlevel%==1 set Level5=n

echo Exporting RPU metadata to a json file...
"%dovi_tool_path%" export -i %RPU% -o "%TEMP%RPU.json"

if /i "%plot_level%"=="a" goto :s
if not "%plot_level%"=="4" goto :L5
:s
if "%Level4%"=="n" echo \033[31m Input doesnt have L4 metadata, skipping...| "%cmdcolor%"& goto :L5

::------------------------------------------------------------L4-------------------------------------------------------------------------------------------------

MD "%letterpath%\data.raw\"
echo \033[92m Exporting the Level 4 anchor_pq metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level4.anchor_pq" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.anchor_pq.txt"
echo Done.
echo \033[92m Exporting the Level 4 anchor_power metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level4.anchor_power" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.anchor_power.txt"
echo Done. 

echo set title "Dolby Vision Level 4 plot" > "%TEMP%1.gp"
echo set ytics 128 >> "%TEMP%1.gp"
echo set mytics 2 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Values in 12bit " >> "%TEMP%1.gp"
echo set key top left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Profile:%profile%. Shots:%shot%. DM version:%DM%" at screen 0.05,0.96 left >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 2000,1000 enhanced font "Arial,14" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L4.PLOT.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\data.raw\\.anchor_power.txt" with lines title "anchor_power" lc rgb "red", "%letterpath%\\data.raw\\.anchor_pq.txt" with lines title "anchor_pq" lc rgb "green" >> "%TEMP%1.gp

echo Plotting...
"%gnuplot%" "%TEMP%1.gp"
echo Done.
if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"

::------------------------------------------------------------L5-------------------------------------------------------------------------------------------------
:L5
if /i "%plot_level%"=="a"  goto :s
if not "%plot_level%"=="5" goto :L6
:s
if "%Level5%"=="n" echo \033[31m Input doesnt have L5 metadata, skipping...| "%cmdcolor%"& goto :L6
MD "%letterpath%\data.raw\"
echo \033[92m Exporting the Level 5 Left offset metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level5.active_area_left_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.left.txt"
echo Done.
echo \033[92m Exporting the Level 5 Right offset metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level5.active_area_right_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.right.txt"
echo Done. 
echo \033[92m Exporting the Level 5 Top offset metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level5.active_area_top_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.top.txt"
echo Done. 
echo \033[92m Exporting the Level 5 Bottom offset metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level5.active_area_bottom_offset" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.bottom.txt"
echo Done.

echo set title "Dolby Vision Level 5 plot" > "%TEMP%1.gp"
echo set yrange [-20:400] >> "%TEMP%1.gp"
echo set ytics ("-20" -20, "0" 0, "21" 21, "42" 42, "60" 60, "120" 120, "132" 132, "140" 140, "160" 160, "180" 180, "263" 263, "280" 280, "340" 340, "400" 400) >> "%TEMP%1.gp"
echo set mytics 2 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "offset in pixels" >> "%TEMP%1.gp"
echo set key top left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Profile:%profile%. Shots:%shot%. DM version:%DM%" at screen 0.05,0.96 left >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 2000,1000 enhanced font "Arial,14" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L5.PLOT.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\data.raw\\.left.txt" with lines title "left" lc rgb "green", "%letterpath%\\data.raw\\.right.txt" with lines title "right" lc rgb "black", "%letterpath%\\data.raw\\.top.txt" with lines title "top" lc rgb "red", "%letterpath%\\data.raw\\.bottom.txt" with lines title "bottom" lc rgb "blue" >> "%TEMP%1.gp

echo Plotting...
"%gnuplot%" "%TEMP%1.gp"
echo Done.
if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"

::------------------------------------------------------------L6-------------------------------------------------------------------------------------------------
:L6
if /i "%plot_level%"=="a"  goto :s
if not "%plot_level%"=="6" goto :skip
:s
MD "%letterpath%\data.raw\"
echo \033[92m Exporting the L6 metadata...| "%cmdcolor%"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level6.max_content_light_level" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.maxcll.txt"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level6.max_frame_average_light_level" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.maxfall.txt"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level6.max_display_mastering_luminance" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.mdl.max.txt"
"%JQ_path%" "to_entries[] | .value.vdr_dm_data.cmv29_metadata.ext_metadata_blocks[]?.Level6.min_display_mastering_luminance" "%TEMP%RPU.json" | findstr /v "null" > "%letterpath%\data.raw\.mdl.min.txt"
echo Done.

echo set title "Dolby Vision Level 6 plot" > "%TEMP%1.gp"
echo set yrange [-20:10100] >> "%TEMP%1.gp"
echo set mytics 5 >> "%TEMP%1.gp"
echo set ytics 250 >> "%TEMP%1.gp"
echo set xlabel "Frames" >> "%TEMP%1.gp"
echo set ylabel "Metadata" >> "%TEMP%1.gp"
echo set key top left >> "%TEMP%1.gp"
echo set key box opaque width 1 height 1 >> "%TEMP%1.gp"
echo set label "%OSD.filename1%" at screen 0.05,0.98 left >> "%TEMP%1.gp"
echo set label "Frames:%frames%. Profile:%profile%. Shots:%shot%. DM version:%DM%" at screen 0.05,0.96 left >> "%TEMP%1.gp"
echo set grid >> "%TEMP%1.gp"
echo set term pngcairo size 3000,1500 enhanced font "Arial,20" >> "%TEMP%1.gp"
echo set output "%OSD.filename1%.DoVi.L6.PLOT.png" >> "%TEMP%1.gp"
echo plot "%letterpath%\\data.raw\\.mdl.max.txt" with lines title "Mastering Display Lum MAX" lc rgb "black", "%letterpath%\\data.raw\\.mdl.min.txt" with lines title "Mastering Display Lum MIN" lc rgb "blue", "%letterpath%\\data.raw\\.maxcll.txt" with lines title "MaxCLL" lc rgb "red", "%letterpath%\\data.raw\\.maxfall.txt" with lines title "MaxFall" lc rgb "green" >> "%TEMP%1.gp

echo Plotting...
"%gnuplot%" "%TEMP%1.gp"
echo Done.
if exist "%letterpath%\data.raw\" rmdir /Q /S "%letterpath%\data.raw\"
:skip

"%dovi_tool_path%" info -s %RPU%
if /i "%validate_metadata%"=="YES" (
     "%RPU.to.XML%" convert %RPU% "%TEMP%%filename%_DV.xml" > nul
	 "%metafier_path%" --validate --with-lift "%TEMP%%filename%_DV.xml"
)

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%" 
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
set input=
echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
set filename=& set filepath=& set fileext=& set plot_level=& set Level5=& set Level4=& set DM=& set shot=& set frames=& set profile=& set cmv4.0=& set OSD.filename1=
echo \033[92m"The script has been completed, press a key to plot again..."| "%cmdcolor%"& pause & goto :plot.l5.again

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ------------------------------------------------------------MEASURE HDR10plus--------------------------------------------------------------------------------------------------
:Workflow.6
echo.
echo ---------------------------------------------
echo --this script plot and extract HDR10plus
echo --Input can be JSON/MKV/TS/M2TS/HEVC/H265
echo ---------------------------------------------
echo.
:measure.HDRplus.again
cd "%output_path%"
echo Drag and drop an HDR10plus file and press enter..
set /p video_path=

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

:: make and set temp folder
if exist "%temp_folder%temp.folder22_new" rmdir /Q /S "%temp_folder%temp.folder22_new"
if exist "%temp_folder%temp.folder22" set E1=_new
MD "%temp_folder%temp.folder22%E1%"
set TEMP=%temp_folder%temp.folder22%E1%\

if /i "%same_input_output%"=="YES" set output_path=%filepath%

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%MasteringDisplay_Luminance%% --LogFile="%TEMP%MDL.txt" >Nul
set MDL.max_path=N.A.
set MDL.min_path=N.A.
findstr /m "1000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=1000
findstr /m "4000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=4000
findstr /m "10000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=10000
findstr /m "2000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=2000
findstr /m "0.0050" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=50
findstr /m "0.0001" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=1
findstr /m "0.0020" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=20
findstr /m "0.0010" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=10
findstr /m "0.0000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=0

if /i "%fileext%"==".hevc" set HDR="%filepath%%filename%.hevc"& goto :skip
if /i "%fileext%"==".h265" set HDR="%filepath%%filename%.h265"& goto :skip
if /i "%fileext%"==".json" set JSON="%filepath%%filename%.json"& goto :json.input

if not "%fileext%"==".mkv" set ffmpeg_pipe_secondary=YES
if /i  "%ffmpeg_pipe_secondary%"=="YES" goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%hdr10plus_parser_path%" extract "%TEMP%BL.hevc" -o "%output_path%%filename%_hdr10plus.json"
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%hdr10plus_parser_path%" --skip-validation extract "%TEMP%BL.hevc" -o "%output_path%%filename%_hdr10plus.json"
set JSON="%output_path%%filename%_hdr10plus.json"
goto :json.input

:skip.mkvextract

"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" extract -o "%output_path%%filename%_hdr10plus.json" -
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%hdr10plus_parser_path%" --skip-validation extract -o "%output_path%%filename%_hdr10plus.json" -
set JSON="%output_path%%filename%_hdr10plus.json"& goto :json.input

:skip
echo Extracting HDR10plus...
:: Extract HDR10+
"%hdr10plus_parser_path%" extract %HDR% -o "%output_path%%filename%_hdr10plus.json"& set JSON="%output_path%%filename%_hdr10plus.json"
if NOT ["%errorlevel%"]==["0"] echo VERSION 0 detected & "%hdr10plus_parser_path%" --skip-validation extract %HDR% -o "%output_path%%filename%_hdr10plus.json"& set JSON="%output_path%%filename%_hdr10plus.json"

:json.input
::get BL MDL
if /i "%fileext%"==".json" goto :skip

     "%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
     "%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"
     "%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo.JSON" > "%TEMP%colors.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%colors.txt"') do (
    set "MDC=%%a"
)
set MDC=%MDC:~1,-1%& set MDL=%MDL:~1,-1%
set MD=-annotate +120+98 "Mastering Display: %MDL% - %MDC%"
:skip

"%hdr10plus_parser_path%" plot %JSON% -t "HDR10plus Plot" -o "%TEMP%%filename%_HDR10plus_plot.png" 
"%imagemagick%" convert "%TEMP%%filename%_HDR10plus_plot.png" -pointsize 20  -quality 100 -fill black -annotate +120+72 "%filename%" %MD% "%output_path%%filename%.HDR10plus_plot.png" 

if "%plotimage.res%"=="3000:1200"  goto :skipresizing
"%ffmpeg_path%" -i "%output_path%%filename%.HDR10plus_plot.png"  -vf "scale=%plotimage.res%:flags=spline" -q:v 0 "%output_path%%filename%_HDR10plus_plot.png"  2>nul
del "%output_path%%filename%.HDR10plus_plot.png"

:skipresizing

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
ECHO.
set OSD.filename1=
set video_path=
echo \033[92m The script has been completed, press a key to plot again...| "%cmdcolor%"
pause & goto :measure.HDRplus.again

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ---------------------------------------------------------Measure bitrate-----------------------------------------------------------------------------------------------------------------------------------------
:Workflow.7
:measure.againnnn1
echo.
echo ----------------------------------------------------------------------
echo --- Just plot video bitrate
echo --- python library required: in cli type "pip install matplotlib"
echo --- python library required: in cli type "pip install PyQt5"
echo ----------------------------------------------------------------------
echo.
echo   Drag and drop a video file and press enter...& set /p input=

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
for %%i in (!input!) do set letterpath=%%~di
Setlocal DisableDelayedExpansion

:: make and set temp folder
if exist "%temp_folder%temp.folder24_new" rmdir /Q /S "%temp_folder%temp.folder24_new"
if exist "%temp_folder%temp.folder24" set E1=_new
MD "%temp_folder%temp.folder24%E1%"
set TEMP=%temp_folder%temp.folder24%E1%\

if /i "%same_input_output%"=="YES" set output_path=%filepath%

cd /d "%filepath%"
echo f | xcopy /s /f "%ffprobe_path%" "%filepath%" >Nul
echo Reading Video file...

:: old measure bitrate
:: python "%plotbitrate_path%" -o "%output_path%%filename%_bitrate_plot.png" -f png "%filepath%%filename%%fileext%"
python "%plotbitrate_path%" -f csv_raw -o "%TEMP%%filename%.csv" "%filepath%%filename%%fileext%"
if exist "%filepath%ffprobe.exe" del "%filepath%ffprobe.exe"
python "%~dp0tools\plot.bitrate.Dorian.py" "%TEMP%%filename%.csv"

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%
set input=
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo "The script has been completed, press a key to plot another file." & pause & goto :measure.againnnn1

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ---------------------------------------------------------Measure audio waveforms-----------------------------------------------------------------------------------------------------------------------------------------
:Workflow.8
echo.
echo ---------------------------------------------------------------------
echo -- This script just measure audio channels waveforms
echo -- Can downmix 7.1 to 5.1 , see line 290
echo ---------------------------------------------------------------------
echo.
:: make and set temp folder
if exist "%temp_folder%temp.folder88_new" rmdir /Q /S "%temp_folder%temp.folder88_new"
if exist "%temp_folder%temp.folder88" set E1=_new
MD "%temp_folder%temp.folder88%E1%"
set TEMP=%temp_folder%temp.folder88%E1%\
if /i "%audiowavedownmix%"=="YES" set ffmpeg_channels=-channel_layout 5.1

echo   Drag and drop an audio file and press enter... 
set /p video_path=

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

if /i "%same_input_output%"=="YES" set output_path=%filepath%

"%mkvmerge_path%" -i "%filepath%%filename%%fileext%"
echo What is the audio track id (inclusive 1=0, default=1) and press enter... & set /p ID=
if "%ID%"=="" set ID=1

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Audio;%%Duration%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Duration.txt"
for /f "delims=" %%x in (%TEMP%Duration.txt) do set duration=%%x

for /f "tokens=1 delims=" %%a in ('type "%TEMP%Duration.txt"') do (
    set "duration=%%a"
)

set zoom=100000
::15min
if %duration% leq 900000 set zoom=15000
::1h
if %duration% leq 3600000 set zoom=115000
::1h15
if %duration% geq 4500000 set zoom=155000
::1h30
if %duration% geq 5400000 set zoom=165000
::1h45
if %duration% geq 6300000 set zoom=175000
::2h
if %duration% geq 7200000 set zoom=185000

"%ffmpeg_path%" -drc_scale 0 -i "%filepath%%filename%%fileext%" -map 0:%ID% -c pcm_s24le %ffmpeg_channels% -ar 48000 -rf64 auto "%TEMP%1.wav"
echo duration=%duration%MS
%wave% --input-format wav --output-format png --split-channels --width 1920 --height 1080 -z %zoom% -i "%TEMP%1.wav" -o "%output_path%%filename%_waveform.png"

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set video_path=
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

::----------------------------------------------------------------screenshot comparisons------------------------------------------------------------------------------------------------------------
:MODE.S

echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= DoVi_baker: FEL ^+ BL PQ screenshots
echo 2) Workflow.2= MULTIPLE INPUTS: PQ screenshots DVP5/HDR10 or SDR vs SDR (Libplacebo)
echo 3) Workflow.3= Heatmap and Gamut Coverage
echo 4) Workflow.4= Metadata Video Comparison Maker
echo 5) Workflow.5= FEL vs BL Video Comparison Maker
echo 6) Workflow.6= Export all the scene cuts frames or every single frame
echo 7) Workflow.7= MPV and MPC-HC
echo 8) Workflow.8= Go back to the main menu

choice /C:12345678 /M Choice?
if ERRORLEVEL 8 (
goto :Main.menu
)

if ERRORLEVEL 7 (
goto :Workflow.7
)

if ERRORLEVEL 6 (
goto :Workflow.6
)

if ERRORLEVEL 5 (
goto :Workflow.5
)

if ERRORLEVEL 4 (
goto :Workflow.4
)

if ERRORLEVEL 3 (
goto :Workflow.3
)

if ERRORLEVEL 2 (
goto :Workflow.2
)

if ERRORLEVEL 1 (
goto :Workflow.1
)

::--------------------------------------------------------------------------------------DoVi_Baker--------------------------------------------------------------------------------------------------------------------------------
:Workflow.1
echo.
echo.
echo \033[36m          ============== | "%cmdcolor%"
echo \033[36m          - DoVi_BAKER - | "%cmdcolor%"
echo \033[36m          ============== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow can bake FEL into the BL and export screenshots automatically or manually.
echo -- Input must be profile 7 (ST or DT)
echo -- Screenshots settings at line 100-137
echo -- SDR tonemapping requires a GPU that support Vulkan
echo -- Without an Nvidia GPU it's very slow and quick mode will be activated
echo -- Example: https://youtu.be/ElJ1KvQMgzE^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"

if /i "%screenshot_OSD%"=="NO" set Measure_CAP=NO

echo.
echo Drag and drop a P7 FEL DV file and press enter& set /p input=
echo.

:: select manual or automatic mode
echo   Manual(m) or Auto(a) screenshots extraction^?  (default = a)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
set /p fel.mode=
if [%fel.mode%]==[] set fel.mode=a
if /i "%fel.mode%"=="m" set fel.mode=m
if /i "%fel.mode%"=="a" set fel.mode=a
if /i "%fel.mode%"=="auto" set fel.mode=a
if /i "%fel.mode%"=="manual" set fel.mode=m
if not "%fel.mode%"=="m" if not "%fel.mode%"=="a" set fel.mode=a
echo.

echo Quick(q) or Full(f) mode^? (default= f)
echo.
echo --^> FULL= f 
echo --^> QUICK= q
set /p quickFEL=
if [%quickFEL%]==[] set quickFEL=f
if /i "%quickFEL%"=="F" set quickFEL=f
if /i "%quickFEL%"=="Q" set quickFEL=q
echo.
echo HDR(1) or SDR(0) Tone Mapping^? (Default = 1)
echo.
echo --^> SDR= 0
echo --^> HDR= 1 
set /p tonemap=

if [%tonemap%]==[] set tonemap=1
if "%tonemap%"=="HDR" set tonemap=1
if "%tonemap%"=="SDR" set tonemap=0
if not "%tonemap%"=="0" if not "%tonemap%"=="1" set tonemap=1

if "%tonemap%"=="0" echo Which target nits value do you want to use for the SDR tone mapping^? (default = 125)& set /p SDR_target_nits=
if [%SDR_target_nits%]==[] set SDR_target_nits=125

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi

:: make and set temp folder
if exist "%temp_folder%temp.folder25_new" rmdir /Q /S "%temp_folder%temp.folder25_new"
if exist "%temp_folder%temp.folder25" set E1=_new
MD "%temp_folder%temp.folder25%E1%"
set TEMP=%temp_folder%temp.folder25%E1%\

if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
echo.
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, enabling FFMS2 decoding and forcing quick mode because otherwise the process is too slow & set force_ffms2=YES& set quickFEL=q
echo.
:nvidiacheck
::workaround for input with )
set oldfilename=%filename%
set newfilename=%filename:)=%
rename "%filepath%%filename%%fileext%" "%newfilename%%fileext%"
set filename=%newfilename%

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo4.JSON"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo4.JSON" > "%TEMP%FrameCount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount.txt"') do (
    set "FrameCount=%%a"
)
set FrameCount=%FrameCount:"=%

:: process only a sample instead of the full input
if /i "%quickFEL%"=="f" goto :skipfull
echo.
echo Quick mode: making a 10min sample...
"%mkvmerge_path%" --output ^"%TEMP%%filename%.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:10:00 > Nul
set input.sample="%TEMP%%filename%.mkv"
echo Done.
for %%i in (!input.sample!) do set filename=%%~ni
for %%i in (!input.sample!) do set filepath=%%~di%%~pi
for %%i in (!input.sample!) do set fileext=%%~xi

:skipfull

if /i "%fileext%"==".ts" set tsin=y
if /i "%fileext%"==".m2ts" set tsin=y

:: check for dual track input
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo3.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo3.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2
if "%tsin%"=="y" (
     if "%video.count%"=="2" (
         echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --demux --vbv-len=500> "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=4113>> "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", insertSEI, contSPS, track=4117>> "%TEMP%1.meta"
         "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
		 set BL="%TEMP%%filename%.track_4113.hevc"& set EL="%TEMP%%filename%.track_4117.hevc"
		 goto :skip
	 )
)

::demux dt mkv
if "%video.count%"=="2" "%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc" tracks 1:"%TEMP%EL.hevc" & goto :skip.ST

::demux st file
cd /d "%TEMP%"
if not "%fileext%"==".mkv" set ffmpeg_pipe_secondary=YES
if /i  "%ffmpeg_pipe_secondary%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.P7.hevc"
"%dovi_tool_path%" demux -i "%TEMP%BL.P7.hevc"
goto :skip.ST

:skip.mkvextract

"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -

:skip.ST
set BL="%TEMP%BL.hevc"& set EL="%TEMP%EL.hevc"
cd /d "%output_path%"

:skip

echo Extracting RPU...
::extract rpu
"%dovi_tool_path%" extract-rpu %EL% -o "%TEMP%%filename%_RPU_FEL.bin"
if /i "%keep_rpu%"=="YES" copy /y "%TEMP%%filename%_RPU_FEL.bin" "%output_path%" > nul
set RPU="%TEMP%%filename%_RPU_FEL.bin"

"%dovi_tool_path%" info --input "%TEMP%%filename%_RPU_FEL.bin" -f 200 > "%TEMP%temp.rpu.json"
"%dovi_tool_path%" info -s "%TEMP%%filename%_RPU_FEL.bin" > "%TEMP%rpu.info.txt"
"%dovi_tool_path%" export -i "%TEMP%%filename%_RPU_FEL.bin" -o "%TEMP%RPU.json" >Nul

type "%TEMP%rpu.info.txt" | findstr Frames: > "%TEMP%frames.txt"
type "%TEMP%temp.rpu.json" | findstr target_max_pq > "%TEMP%trims.json"
type "%TEMP%temp.rpu.json" | findstr source_min_pq > "%TEMP%min_pq.json"
type "%TEMP%temp.rpu.json" | findstr source_max_pq > "%TEMP%max_pq.json"
type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"
type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"

findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 echo Input is MEL, not FEL... & pause & exit

findstr /c:"100 nits" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t1=100 nits
findstr /c:"600" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2=600 nits
findstr /c:"1000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t3=1000 nits
findstr /c:"2000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t4=2000 nits

findstr /c:"\"target_display_index\":1" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set t81=100 nits
findstr /c:"\"target_display_index\":27" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set t82=600 nits
findstr /c:"\"target_display_index\":48" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set t83=1000 nits
findstr /c:"\"target_display_index\":28" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set t82=600 nits
findstr /c:"\"target_display_index\":49" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set t83=1000 nits
findstr /c:"cmv40" "%TEMP%RPU.json" >Nul
if %errorlevel%==0 set cmv4.0=y

findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=1000 nits
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=2000 nits
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4000 nits
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=10 000 nits
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0001 nits
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0050 nits
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0.0020 nits
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0 nits

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"
set left2=%left%
set right2=%right%
set top2=%top%
set bottom2=%bottom%
if "%left%"==" =" set right=0& set left=0& set top=0& set bottom=0& set right2=0& set left2=0& set top2=0& set bottom2=0

::Check and adjust left if odd number
set /a "check=left2 %% 2"
if %check% equ 1 (
    set /a "left2+=1"
)

::Check and adjust right if odd number
set /a "check=right2 %% 2"
if %check% equ 1 (
    set /a "right2+=1"
)

::Check and adjust top if odd number
set /a "check=top2 %% 2"
if %check% equ 1 (
    set /a "top2+=1"
)

::Check and adjust bottom if odd number
set /a "check=bottom2 %% 2"
if %check% equ 1 (
    set /a "bottom2+=1"
)

"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo3.JSON" > "%TEMP%masteringDL.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_ColorPrimaries "%TEMP%mediainfo3.JSON" > "%TEMP%col.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%col.txt"') do (
    set "col=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL.txt"') do (
    set "MDL=%%a"
)
set MDL=%MDL:~1,-1%& set col=%col:~1,-1%
if /i "%force_ffms2%"=="NO" goto :dgdemux
     echo.
     echo \033[92m Indexing the HDR10 base layer... | "%cmdcolor%"
     "%ffmsindex%" %BL% "%TEMP%BL.ffindex"
	 echo.
	 echo \033[92m Indexing the DV 12bits enhancement layer... | "%cmdcolor%"
     "%ffmsindex%" %EL% "%TEMP%EL.ffindex"
	 echo.
	 goto :skipdgdemux
     
	 :dgdemux
	 echo.
	 echo \033[92m Indexing the HDR10 base layer... | "%cmdcolor%"
	 "%DGIndexNV_path%" -i %BL% -o "%TEMP%BL.dgi" -h -a
	 echo Done.
	 echo \033[92m Indexing the DV 12bits enhancement layer... | "%cmdcolor%"
	 "%DGIndexNV_path%" -i %EL% -o "%TEMP%EL.dgi" -h -a
	 echo Done.
:skipdgdemux

if %FrameCount% leq 50000 if "%frame_interval%"=="000" set frame_number=24
if %FrameCount% leq 40000 if "%frame_interval%"=="000" set frame_number=19
if %FrameCount% leq 30000 if "%frame_interval%"=="000" set frame_number=14
if %FrameCount% leq 20000 if "%frame_interval%"=="000" set frame_number=9
if %FrameCount% leq 10000 if "%frame_interval%"=="000" set frame_number=4
if %FrameCount% leq 5000 if "%frame_interval%"=="000" set frame_number=2
if %FrameCount% leq 2000 if "%frame_interval%"=="000" set frame_number=1
if %FrameCount% leq 999 (
       if not "%fel.mode%"=="m" if "%frame_interval%"=="000" echo Input has less than 1000 frames, cant export any frame... & Pause & exit
)

if /i "%quickFEL%"=="q" set frame_number=14

echo "%filename%" > "%TEMP%filename.txt"
findstr /c:"FORCESDR" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 set tonemap=0

if "%OSD.filename1%"=="" set OSD.filename1=%filename%

set MAPPING1=PQ-HDR-2020
if "%tonemap%"=="0" set MAPPING1=Tone_Mapped_SDR @ %SDR_target_nits%nits

::================================================get rpu l1 values for each frame====================================================================================
:: export data to text file
for /L %%i in (1,1,%frame_number%) do (
    "%dovi_tool_path%" info --input "%TEMP%%filename%_RPU_FEL.bin" -f %%i%frame_interval% > "%TEMP%raw%%i.txt"
    
    :: find max_pq values for each frame
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw%%i.txt"') do (
        set "maxpq=%%a"
    )
    ::convert 12bit to nits and set final variable
    for /f "tokens=*" %%j in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !maxpq!') do set valueinnits=%%j
    set MC%%i=!valueinnits!
    
    :: find avg_pq values for each frame
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw%%i.txt"') do (
        set "avgpq=%%a"
    )
    ::convert 12bit to nits and set final variable
    for /f "tokens=*" %%j in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !avgpq!') do set valueinnits=%%j
    set MF%%i=!valueinnits!
)

if /i "%fel.mode%"=="a" goto :skipmanual

::-----------------------------------------------------------------------------manual-----------------------------------------------------------------------------------------
::run the FEL script in avspmod
start "" "%AvsPmod_path%" "%filepath%%filename%%fileext%"

echo.
echo.
echo \033[36m          ====================== | "%cmdcolor%"
echo \033[36m          - MANUAL SCREENSHOTS - | "%cmdcolor%"
echo \033[36m          ====================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo - Preview the frame you want to export^in AvsPmod
echo - The extracted image(s) will have HDR metadata(PQ 16bits)...
echo - The script will loop as long as you enter a frame number...
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"

:singleagainfel
ECHO.
set frame_number=1
echo \033[92mMANUAL MODE: which frame do you want to export^? (press enter to ^exit)| "%cmdcolor%" & set /p frametoexport=
echo.
if [%frametoexport%]==[] goto :end

:: export data to text file
    "%dovi_tool_path%" info --input "%TEMP%%filename%_RPU_FEL.bin" -f %frametoexport% > "%TEMP%raw.txt"
    
    :: find max_pq values for each frame
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw.txt"') do (
        set "maxpq1=%%a"
    )
    ::convert 12bit to nits and set final variable
    for /f "tokens=*" %%j in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq %maxpq1%') do set valueinnits=%%j
    set MC1=%valueinnits%
    
    :: find avg_pq values for each frame
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw.txt"') do (
        set "avgpq1=%%a"
    )
    ::convert 12bit to nits and set final variable
    for /f "tokens=*" %%j in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq %avgpq1%') do set valueinnits=%%j
    set MF1=%valueinnits%

:: Make a FEL/BL measure script-----------------------------------------------------------------------------------------------------------------------

:skipmanual
if /i "%Measure_CAP%"=="NO" goto :skipmeasurecap 
if /i "%screenshot_OSD%"=="NO" goto :skipmeasurecap 

for /L %%i in (1,1,%frame_number%) do (
     echo LoadPlugin("%DoViBaker%"^) > "%TEMP%%%i_FELtomeas.avs"
	 echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%%%i_FELtomeas.avs"
     if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i_FELtomeas.avs"
     if /i "%force_ffms2%"=="NO" echo bl = DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_FELtomeas.avs"
     if /i "%force_ffms2%"=="NO" echo el = DGSource("%TEMP%EL.dgi"^) >> "%TEMP%%%i_FELtomeas.avs"
	 if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%"^) >> "%TEMP%%%i_FELtomeas.avs"
	 if /i "%force_ffms2%"=="YES" echo bl = FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex"^) >> "%TEMP%%%i_FELtomeas.avs"
	 if /i "%force_ffms2%"=="YES" echo el = FFVideoSource(%EL%, cachefile="%TEMP%EL.ffindex"^) >> "%TEMP%%%i_FELtomeas.avs"
	 if /i "%force_ffms2%"=="YES" echo DoViBaker(bl, el^) >> "%TEMP%%%i_FELtomeas.avs"
     if /i "%force_ffms2%"=="NO" echo DoViBaker(bl, el, rpu= "%TEMP%%filename%_RPU_FEL.bin"^) >> "%TEMP%%%i_FELtomeas.avs"
     if "%tonemap%"=="1" if /i "%force_ffms2%"=="NO" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_FELtomeas.avs"
	 echo Crop(%right2%, %top2%, -%left2%, -%bottom2%^) >> "%TEMP%%%i_FELtomeas.avs"
	 if /i "%fel.mode%"=="a" echo trim(%%i%frame_interval%,%%i%frame_interval%^) >> "%TEMP%%%i_FELtomeas.avs"
	 if /i "%fel.mode%"=="m" echo trim(%frametoexport%,%frametoexport%^) >> "%TEMP%%%i_FELtomeas.avs"
)
::BL
for /L %%i in (1,1,%frame_number%) do (
     echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) > "%TEMP%%%i_BLtomeas.avs"
     if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i_BLtomeas.avs"
     if /i "%force_ffms2%"=="NO" echo DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_BLtomeas.avs"
	 if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%"^) >> "%TEMP%%%i_BLtomeas.avs"
	 if /i "%force_ffms2%"=="YES" echo FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex"^) >> "%TEMP%%%i_BLtomeas.avs"
     if "%tonemap%"=="1" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_BLtomeas.avs"
	 echo Crop(%right2%, %top2%, -%left2%, -%bottom2%^) >> "%TEMP%%%i_BLtomeas.avs"
	 if /i "%fel.mode%"=="a" echo trim(%%i%frame_interval%,%%i%frame_interval%^) >> "%TEMP%%%i_BLtomeas.avs"
	 if /i "%fel.mode%"=="m" echo trim(%frametoexport%,%frametoexport%^) >> "%TEMP%%%i_BLtomeas.avs"
)


for /L %%j in (1,1,%frame_number%) do (
       set "MaxCLL%%j="
        set "MaxFALL%%j="
)

for /L %%j in (1,1,%frame_number%) do (
       set "MaxCLLBL%%j="
        set "MaxFALLBL%%j="
)

if /i "%fel.mode%"=="a" goto :auto.mode
::----------------------------------------------------------------------------MEASURE---------------------------------------------------------------------------------------------------
:: measure FEL frames to export
for /L %%i in (1,1,%frame_number%) do (
    echo Measure FEL Frame: %frametoexport%
    "%ffmpeg_path%" -i "%TEMP%%%i_FELtomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%%frametoexport%_%filename%_FEL.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%%frametoexport%_%filename%_FEL.png"') do (
        if not defined MaxCLL%%i set "MaxCLL%%i=%%a"
        if defined MaxCLL%%i set "MaxFALL%%i=%%a"
    )
)
:: measure BL frames to export
for /L %%i in (1,1,%frame_number%) do (
    echo Measure BL Frame: %frametoexport%
    "%ffmpeg_path%" -i "%TEMP%%%i_BLtomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%%frametoexport%_%filename%_BL.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%%frametoexport%_%filename%_BL.png"') do (
        if not defined MaxCLLBL%%i set "MaxCLLBL%%i=%%a"
        if defined MaxCLLBL%%i set "MaxFALLBL%%i=%%a"
    )
)
goto :skipmeasurecap

:auto.mode
echo.
echo \033[36m========================== | "%cmdcolor%"
echo \033[36m- Calculating MaxCLL/FALL - | "%cmdcolor%"
echo \033[36m========================== | "%cmdcolor%"
echo.

:: measure FEL frames to export
for /L %%i in (1,1,%frame_number%) do (
    echo Measure FEL Frame: %%i%frame_interval% (%%i of %frame_number%^)
    "%ffmpeg_path%" -i "%TEMP%%%i_FELtomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%%%i%frame_interval%_%filename%_FEL.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%%%i%frame_interval%_%filename%_FEL.png"') do (
        if not defined MaxCLL%%i set "MaxCLL%%i=%%a"
        if defined MaxCLL%%i set "MaxFALL%%i=%%a"
    )
)
:: measure BL frames to export
echo.
for /L %%i in (1,1,%frame_number%) do (
    echo Measure BL Frame: %%i%frame_interval% (%%i of %frame_number%^)
    "%ffmpeg_path%" -i "%TEMP%%%i_BLtomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%%%i%frame_interval%_%filename%_BL.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%%%i%frame_interval%_%filename%_BL.png"') do (
        if not defined MaxCLLBL%%i set "MaxCLLBL%%i=%%a"
        if defined MaxCLLBL%%i set "MaxFALLBL%%i=%%a"
    )
)
::-

::------------------------------------------------------------------------------EXPORT-------------------------------------------------------------------------------------------------------

:skipmeasurecap 
set cm4osd=
if "%cmv4.0%"=="y" set cm4osd= - CM v4.0 L8: %t81% %t82% %t83%
:: Make a feL a script
for /L %%i in (1,1,%frame_number%) do (
     echo LoadPlugin("%DoViBaker%"^) > "%TEMP%%%i_FEL.avs"
	 echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%%%i_FEL.avs"
     if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i_FEL.avs"
     if /i "%force_ffms2%"=="NO" echo bl = DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_FEL.avs"
     if /i "%force_ffms2%"=="NO" echo el = DGSource("%TEMP%EL.dgi"^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%"^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%force_ffms2%"=="YES" echo bl = FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex"^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%force_ffms2%"=="YES" echo el = FFVideoSource(%EL%, cachefile="%TEMP%EL.ffindex"^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%force_ffms2%"=="YES" echo DoViBaker(bl, el^) >> "%TEMP%%%i_FEL.avs"
     if /i "%force_ffms2%"=="NO" echo DoViBaker(bl, el, rpu="%TEMP%%filename%_RPU_FEL.bin"^) >> "%TEMP%%%i_FEL.avs"
	 if "%tonemap%"=="0" echo libplacebo_Tonemap(src_csp=1, dst_csp=0, dst_max=%SDR_target_nits%, dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%"^) >> "%TEMP%%%i_FEL.avs"  
     if "%tonemap%"=="0" echo ConvertToYUV420(matrix="709"^) >> "%TEMP%%%i_FEL.avs" 
     if "%tonemap%"=="1" if /i "%force_ffms2%"=="NO" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_FEL.avs" 
     if /i "%screenshot_OSD%"=="YES" echo scriptClip(""^"  >> "%TEMP%%%i_FEL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("%OSD.filename1%_BL+FEL_12bits %MAPPING1%", size=18, align=7, x=40, y=15, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("RPU Source Min/Max_pq: %min_pq% / %max_pq%", size=18, align=7, x=40, y=34, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("HDR10 BL MDL: %MDL%  -  %col%", size=18, align=7, x=40, y=53, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle(string(width^) ^+ " x " ^+ string(height^) ^+ " @ " ^+ string(framerate^) ^+ " - L5: R:%right%, L:%left%, T:%top%, B:%bottom%", size=18, align=7, x=40, y=72, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("CM v2.9 L2: %t1% %t2% %t3% %t4%%cm4osd%", size=18, align=7, x=40, y=91, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
     if /i "%screenshot_OSD%"=="YES" if /i "%fel.mode%"=="a" echo     subtitle("Frame: %%i%frame_interval% of %FrameCount%" ^+ " - Picture type: " ^+ Chr(FFPICT_TYPE^), size=18, align=7, x=40, y=110, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%screenshot_OSD%"=="YES" if /i "%fel.mode%"=="m" echo     subtitle("Frame: %frametoexport% of %FrameCount%" ^+ " - Picture type: " ^+ Chr(FFPICT_TYPE^), size=18, align=7, x=40, y=110, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%screenshot_OSD%"=="YES" if /i "%Measure_CAP%"=="YES" echo     subtitle("Measurement MAX/AVG: !MaxCLL%%i!nits / !MaxFALL%%i!nits ", size=24, align=7, x=40, y=129, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%screenshot_OSD%"=="YES" echo     subtitle("DV RPU Level 1 MAX/AVG: !MC%%i!nits / !MF%%i!nits ", size=24, align=7, x=40, y=150, text_color=%osdcolor%^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%screenshot_OSD%"=="YES" echo ""^"^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%fel.mode%"=="a" echo trim(%%i%frame_interval%,%%i%frame_interval%^) >> "%TEMP%%%i_FEL.avs"
	 if /i "%fel.mode%"=="m" echo trim(%frametoexport%,%frametoexport%^) >> "%TEMP%%%i_FEL.avs"
)

:: Make a BL a script

for /L %%i in (1,1,%frame_number%) do (
     echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) > "%TEMP%%%i_BL.avs"
     if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i_BL.avs"
     if /i "%force_ffms2%"=="NO" echo DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_BL.avs"
	 if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%"^) >> "%TEMP%%%i_BL.avs"
	 if /i "%force_ffms2%"=="YES" echo FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex"^) >> "%TEMP%%%i_BL.avs"
	 if "%tonemap%"=="0" echo ConvertBits(16^)  >> "%TEMP%%%i_BL.avs"
	 if "%tonemap%"=="0" echo libplacebo_Tonemap(src_csp=1, dst_csp=0, dst_max=%SDR_target_nits%, dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%"^) >> "%TEMP%%%i_BL.avs"  
     if "%tonemap%"=="0" echo ConvertToYUV420(matrix="709"^) >> "%TEMP%%%i_BL.avs" 
     if "%tonemap%"=="1" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_BL.avs" 
     if /i "%screenshot_OSD%"=="YES" echo scriptClip(""^"  >> "%TEMP%%%i_BL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("%OSD.filename1%_BL_HDR10_10bits %MAPPING1%", size=18, align=7, x=40, y=15, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("RPU Source Min/Max_pq: %min_pq% / %max_pq%", size=18, align=7, x=40, y=34, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("HDR10 BL MDL: %MDL%  -  %col%", size=18, align=7, x=40, y=53, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle(string(width^) ^+ " x " ^+ string(height^) ^+ " @ " ^+ string(framerate^) ^+ " - L5: R:%right%, L:%left%, T:%top%, B:%bottom%", size=18, align=7, x=40, y=72, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
     if /i "%screenshot_OSD%"=="YES" echo     subtitle("CM v2.9 L2: %t1% %t2% %t3% %t4%%cm4osd%", size=18, align=7, x=40, y=91, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
     if /i "%screenshot_OSD%"=="YES" if /i "%fel.mode%"=="a" echo     subtitle("Frame: %%i%frame_interval% of %FrameCount%" ^+ " - Picture type: " ^+ Chr(FFPICT_TYPE^), size=18, align=7, x=40, y=110, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
	 if /i "%screenshot_OSD%"=="YES" if /i "%fel.mode%"=="m" echo     subtitle("Frame: %frametoexport% of %FrameCount%" ^+ " - Picture type: " ^+ Chr(FFPICT_TYPE^), size=18, align=7, x=40, y=110, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
	 if /i "%screenshot_OSD%"=="YES" if /i "%Measure_CAP%"=="YES" echo     subtitle("Measurement MAX/AVG: !MaxCLLBL%%i!nits / !MaxFALLBL%%i!nits ", size=24, align=7, x=40, y=129, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
	 if /i "%screenshot_OSD%"=="YES" echo     subtitle("DV RPU Level 1 MAX/AVG: !MC%%i!nits / !MF%%i!nits ", size=24, align=7, x=40, y=150, text_color=%osdcolor%^) >> "%TEMP%%%i_BL.avs"
	 if /i "%screenshot_OSD%"=="YES" echo ""^"^) >> "%TEMP%%%i_BL.avs"
	 if /i "%fel.mode%"=="a" echo trim(%%i%frame_interval%,%%i%frame_interval%^) >> "%TEMP%%%i_BL.avs"
	 if /i "%fel.mode%"=="m" echo trim(%frametoexport%,%frametoexport%^) >> "%TEMP%%%i_BL.avs"
)

if /i "%fel.mode%"=="a" goto :skipmanual

     echo Export FEL Frame: %frametoexport%
     "%ffmpeg_path%" -i "%TEMP%1_FEL.avs" -vf select='eq(n\,0)' -vframes 1 -compression_level %pic_compression% -y "%output_path%%frametoexport%_%OSD.filename1%_FEL.png" 2> nul
     echo Export BL Frame: %frametoexport%
     "%ffmpeg_path%" -i "%TEMP%1_BL.avs" -vf select='eq(n\,0)' -vframes 1 -compression_level %pic_compression% -y "%output_path%%frametoexport%_%OSD.filename1%_BL.png" 2> nul

del "%TEMP%1_FEL.avs"  & del "%TEMP%1_BL.avs"  & if exist "%TEMP%1_BLtomeas.avs" del "%TEMP%1_BLtomeas.avs" & if exist "%TEMP%1_FELtomeas.avs" del "%TEMP%1_FELtomeas.avs"
echo.
set frametoexport=
goto :singleagainfel

:skipmanual
MD "%output_path%\%filename%_FEL_VS_BL\"

echo.
echo ========================================BL_SCRIPT===========================================================================
type "%TEMP%1_BL.avs"
echo ==============================================================================================================================
echo.
echo ========================================FEL_SCRIPT==========================================================================
type "%TEMP%1_FEL.avs"
echo ==============================================================================================================================
echo.
echo \033[36m====================== | "%cmdcolor%"
echo \033[36m- Exporting Frames - | "%cmdcolor%"
echo \033[36m====================== | "%cmdcolor%"
echo.
echo Mapping: %MAPPING1%
echo.

:: export screenshots
for /L %%i in (1,1,%frame_number%) do (
     echo Export FEL Frame: %%i%frame_interval% (%%i of %frame_number%^)
     "%ffmpeg_path%" -i "%TEMP%%%i_FEL.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%\%filename%_FEL_VS_BL\%%i%frame_interval%_%OSD.filename1%_FEL.png" 2> nul
)
echo.
for /L %%i in (1,1,%frame_number%) do (
     echo Export BL Frame: %%i%frame_interval% (%%i of %frame_number%^)
     "%ffmpeg_path%" -i "%TEMP%%%i_BL.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%\%filename%_FEL_VS_BL\%%i%frame_interval%_%OSD.filename1%_BL.png" 2> nul
)
echo.
set fel.mode=m& set frametoexport=& goto :singleagainfel

:end
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.

echo "The script has been completed, press a key to start again..."& pause & goto :34534563425634

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.2
::screenshot comparisons
echo.
echo.
echo \033[36m          =============== | "%cmdcolor%"
echo \033[36m          - SCREENSHOTS - | "%cmdcolor%"
echo \033[36m          =============== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- Input can be HDR10/DV-P5,8,7/HLG/SDR - MKV/TS/M2TS/MP4
echo -- Export screenshots in PQ or SDR from up to 20 videos
echo -- Screenshots settings at line 100-137
echo -- SDR tonemapping and P5/HLG input require a GPU that support Vulkan(libplacebo)
echo -- Tutorial: https://youtu.be/SA-i1tZssIo^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"

if /i "%screenshot_OSD%"=="NO" set Measure_CAP=NO& set rpuvalues=NO
Setlocal EnableDelayedExpansion

::================================================================================================
::================================INPUT=========================================================
::================================================================================================
::input(s)
for /L %%i in (1,1,20) do (
    echo Drag and drop video %%i
    set /p "video%%i="
	echo.
    if "!video%%i!"=="" goto :breakloop
	set f%%i=y
    set /a "input_count+=1"
)
:breakloop

::make variable of input(s)
for /L %%n in (1,1,%input_count%) do (
    for %%i in (!video%%n!) do set filename%%n=%%~ni
    for %%i in (!video%%n!) do set filepath%%n=%%~di%%~pi
    for %%i in (!video%%n!) do set fileext%%n=%%~xi
)

::workaround for input with )
for /L %%n in (1,1,%input_count%) do (
    set "oldfilename%%n=!filename%%n!"
    set "newfilename%%n=!filename%%n:)=%%n!"
    rename "!filepath%%n!!filename%%n!!fileext%%n!" "!newfilename%%n!!fileext%%n!"
    set "filename%%n=!newfilename%%n!"
)

::Get delays from user
for /L %%i in (2,1,%input_count%) do (
    echo  "!filename%%i!" (E.G.: -24 or 24^)
    echo Is there a delay compared to %filename1%
    set /p "delay%%i="
    echo.
)   

::================================================================================================
::================================frame to export=================================================
::================================================================================================
set auto=n

echo Enter a frame (skip to use auto mode)& set /p frame1=
::auto frames
if /i "%frame1%"=="" (
    for /L %%i in (1,1,%frame_number%) do (
        if "!frame%%i!"=="" (
            set "frame%%i=%%i%frame_interval%"
        )
    )
    set auto=y& goto :skipmanual
)
::manual frames
for /L %%i in (2,1,%frame_number%) do (
    echo Enter frame %%i of %frame_number%: 
    set /p "frame%%i="
    if "!frame%%i!"=="" goto :breakloop
    set /a "frame_count+=1"
)
:breakloop
set /a frame_number=%frame_count% + 1

:skipmanual

:: make and set temp folder
if exist "%temp_folder%temp.folder26" rmdir /Q /S "%temp_folder%temp.folder26"
MD "%temp_folder%temp.folder26"
set TEMP=%temp_folder%temp.folder26\

if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, disabling FEL processing (ffms2 is too slow ^for this workflow)... & set bakefel7273=NO
:nvidiacheck
::================================================================================================
::================================check inputs=====================================================
::================================================================================================
set hdrinput=n
for /L %%i in (1,1,%input_count%) do (
     set v%%i=
	 set v11%%i=
     set v%%iDV=n
	 set subprofile%%i=
	 set measurevid%%i=n
	 set MDL%%i=
)

set hdrmdl=n& set hdrinput=n
for /L %%i in (1,1,%input_count%) do (

    "%mediainfo_path%" "!filepath%%i!!filename%%i!!fileext%%i!" --output=JSON > "%TEMP%mediainfo%%i.JSON"
    "%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo%%i.JSON" > "%TEMP%check.DV%%i.txt"
    "%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo%%i.JSON" > "%TEMP%check.HDR%%i.txt"
    type "%TEMP%mediainfo%%i.JSON" | findstr HLG >> "%TEMP%pq%%i.txt"

    findstr /m "2086" "%TEMP%check.HDR%%i.txt" >Nul
    if !errorlevel!==0 set "v%%i=HDR" & set "hdrinput=y" & set "hdrmdl%%i=y"
	
    findstr /m "2094" "%TEMP%check.HDR%%i.txt" >Nul
    if !errorlevel!==0 set "v%%i=HDR" & set "hdrinput=y" & set "hdrmdl%%i=y"

    findstr /c:"08" "%TEMP%check.DV%%i.txt" >Nul
    if !errorlevel!==0 set "v%%iDV=y" & set "hdrmdl=y" & set "hdrinput=y"

    findstr /c:"05" "%TEMP%check.DV%%i.txt" >Nul
    if !errorlevel!==0 set "v%%i=p5" & set "v%%iDV=y" & set "hdrinput=y"

    findstr /c:"07" "%TEMP%check.DV%%i.txt" >Nul
    if !errorlevel!==0 set v11%%i=p7& set hdrinput=y& set v%%iDV=y& set hdrmdl%%i=y

    findstr /m "HLG" "%TEMP%pq%%i.txt" >Nul
    if !errorlevel!==0 set "v%%i=HLG" & set "hdrinput=y"

    if not "!v%%i!"=="HDR" if not "!v%%i!"=="p5" if not "!v%%i!"=="HLG" set "v%%i=709"
	if /i "!fileext%%i!"==".avi" if /i "%avimode%"=="HDR" set "v%%i=HDR" & set "hdrinput=y" & set "hdrmdl%%i=y"
)

::====================================check resolution======================================================
for /L %%i in (1,1,%input_count%) do set v%%i_1080=n

for /L %%i in (1,1,%input_count%) do (
    "%JQ_path%" .media.track[1].FrameCount "%TEMP%\mediainfo%%i.JSON" > "%TEMP%FrameCount%%i.txt"
    "%JQ_path%" .media.track[0].VideoCount "%TEMP%\mediainfo%%i.JSON" > "%TEMP%video.count%%i.txt"
    "%mediainfo_path%" "!filepath%%i!!filename%%i!!fileext%%i!" --output=Video;%%Width%%\r\n ^
        *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.c%%i.txt"
    "%mediainfo_path%" "!filepath%%i!!filename%%i!!fileext%%i!" --output=Video;%%Height%%\r\n ^
        *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.c%%i.txt"

    for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count%%i.txt"') do (
        set "video.count%%i=%%a"
    )
    set "video.count%%i=!video.count%%i:~1,-1!"
    if "!video.count%%i!"=="3" set "video.count%%i=2"

    for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.c%%i.txt"') do (
        set "W%%i=%%a"
    )
    for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.c%%i.txt"') do (
        set "H%%i=%%a"
    )

    if !W%%i! leq 1920 (
        if /i "%upscale%"=="YES" set "v%%i_1080=y" & set "UP%%i=UPSCALED" & set "upal%%i=%upscale_algo%"
    )
)
::framecount
for /L %%i in (1,1,%input_count%) do (
    set "FrameCount%%i="
    for /f "usebackq delims=" %%a in ("%TEMP%FrameCount%%i.txt") do (
        set "FrameCount%%i=!FrameCount%%i!%%a"
    )
    set "FrameCount%%i=!FrameCount%%i:"=!"
)
::upscale osd
for /L %%i in (1,1,%input_count%) do (
    if "!video2!"=="" (
        set UP%%i=
        set upal%%i=
		set upscale=NO
    )
)  
::videocount
for /L %%i in (1,1,%input_count%) do (
    if "!video.count%%i!"=="2" (
        set "v11%%i=p7"
    )
)  
::==============================crop values for pixels measurement===============================================================

if /i "%Measure_CAP%"=="NO" goto :skipcrop

::skip crop (for measurement) if rec709 or already cropped
for /L %%i in (1,1,%input_count%) do (
    if  "!H%%i!"=="2160"  set measurevid%%i=y
    if "!H%%i!"=="1080" set measurevid%%i=y
    if  "!v%%i!"=="709" set measurevid%%i=n
)
:: crop values
for /L %%i in (1,1,%input_count%) do (
    if "!measurevid%%i!"=="y" (
        echo "!filename%%i!"
        echo Enter the Left border crop value (default = 0^) & set /p "left%%i="
		 if  "!left%%i!"=="" set "left%%i=0"
        echo Enter the Right border crop value (default = 0^) & set /p "right%%i="
		 if  "!right%%i!"=="" set "right%%i=0"
        echo Enter the Top border crop value (default = 0^) & set /p "top%%i="
		 if  "!top%%i!"=="" set "top%%i=0"
        echo Enter the Bottom border crop value (default = 0^) & set /p "bottom%%i="
		 if  "!bottom%%i!"=="" set "bottom%%i=0"
		set crop%%i=y
    )
)
::check if variables divisible by 2
for /L %%i in (1,1,%input_count%) do (
    if "!measurevid%%i!"=="y" (
        if not "!left%%i!"=="0" (
            set /a "check=left%%i %% 2"
            if !check! equ 1 (
                set /a "left%%i+=1"
            )
        )

        if not "!right%%i!"=="0" (
            set /a "check=right%%i %% 2"
            if !check! equ 1 (
                set /a "right%%i+=1"
            )
        )

        if not "!top%%i!"=="0" (
            set /a "check=top%%i %% 2"
            if !check! equ 1 (
                set /a "top%%i+=1"
            )
        )

        if not "!bottom%%i!"=="0" (
            set /a "check=bottom%%i %% 2"
            if !check! equ 1 (
                set /a "bottom%%i+=1"
            )
        )
    )
)


:skipcrop

::===============================check FEL=========================================================

if /i "%bakefel7273%"=="NO" goto :skipFEL

for /L %%i in (1,1,%input_count%) do (
    if "!v11%%i!"=="p7" (
        "%mkvmerge_path%" --output "%TEMP%!filename%%i!_sample.mkv" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"!filepath%%i!!filename%%i!!fileext%%i!^" ^"^)^" --split parts:00:00:00-00:00:10 >Nul
        "%mkvextract_path%" "%TEMP%!filename%%i!_sample.mkv" tracks 0:"%TEMP%!filename%%i!_sample.hevc" > Nul
        "%dovi_tool_path%" -m 0 extract-rpu "%TEMP%!filename%%i!_sample.hevc" -o "%TEMP%!filename%%i!_chunk.RPU.bin" >Nul
        "%dovi_tool_path%" info --input "%TEMP%!filename%%i!_chunk.RPU.bin" -f 48 > "%TEMP%temp.rpu%%i.json"
        type "%TEMP%temp.rpu%%i.json" | findstr el_type > "%TEMP%subprofile%%i.json"

        findstr /c:"FEL" "%TEMP%subprofile%%i.json" >Nul
        if !errorlevel! equ 0 set "subprofile%%i=FEL"

        findstr /c:"MEL" "%TEMP%subprofile%%i.json" >Nul
        if !errorlevel! equ 0 set "subprofile%%i=MEL"& set "v11%%i="
    )
)
:skipFEL

::===============================check HDR10 MDL=========================================================

for /L %%i in (1,1,%input_count%) do set MDL%%i=
for /L %%i in (1,1,%input_count%) do (
    if "!hdrmdl%%i!"=="y" (
        "%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo%%i.JSON" > "%TEMP%masteringDL%%i.txt"
            for /f "tokens=1 delims=" %%a in ('type "%TEMP%masteringDL%%i.txt"') do (
            set "MDL%%i=%%a"
        )
        set "MDL%%i=!MDL%%i:~1,-1!"
    )
)

::===============================check P5 MDL=========================================================

for /L %%i in (1,1,%input_count%) do (
    if "!v%%i!"=="p5" (
        "%ffmpeg_path%" -i "!filepath%%i!!filename%%i!!fileext%%i!" -c:v copy -to 3 -bsf:v hevc_mp4toannexb -f hevc -loglevel error - | "%dovi_tool_path%" extract-rpu -o "%TEMP%!filename%%i!_RPU.bin" -
		set RPU%%i="%TEMP%!filename%%i!_RPU.bin"
        "%dovi_tool_path%" info --input "%TEMP%!filename%%i!_RPU.bin" -f 24 > "%TEMP%temp.rpu%%i.json"
        type "%TEMP%temp.rpu%%i.json" | findstr source_max_pq > "%TEMP%max_pq%%i.json"
        type "%TEMP%temp.rpu%%i.json" | findstr source_min_pq > "%TEMP%min_pq%%i.json"
        set max_pq%%i=0
        set min_pq%%i=0
        findstr /c:"3079" "%TEMP%max_pq%%i.json" >Nul
        if !errorlevel!==0 set max_pq%%i=1000
        findstr /c:"3388" "%TEMP%max_pq%%i.json" >Nul
        if !errorlevel!==0 set max_pq%%i=2000
        findstr /c:"3696" "%TEMP%max_pq%%i.json" >Nul
        if !errorlevel!==0 set max_pq%%i=4000
        findstr /c:"4095" "%TEMP%max_pq%%i.json" >Nul
        if !errorlevel!==0 set max_pq%%i=10000
        findstr /c:"7" "%TEMP%min_pq%%i.json" >Nul
        if !errorlevel!==0 set min_pq%%i=0.0001
        findstr /c:"62" "%TEMP%min_pq%%i.json" >Nul
        if !errorlevel!==0 set min_pq%%i=0.0050
        findstr /c:"38" "%TEMP%min_pq%%i.json" >Nul
        if !errorlevel!==0 set min_pq%%i=0.0020
        findstr /c:"0" "%TEMP%min_pq%%i.json" >Nul
        if !errorlevel!==0 set min_pq%%i=0
        set MDL%%i=min: !min_pq%%i! cd/m2, max: !max_pq%%i! cd/m2
    )
)

::======================tone mapping prompt===================================================

if /i  "%hdrinput%"=="n" set tonemap=0& goto :skipmapping
echo.
echo   HDR or SDR Tone Mapping^?  (Default = 1) 
echo.
echo --^> SDR= 0 
echo --^> HDR= 1 
echo --^> Both= 2
set /p tonemap=

if [%tonemap%]==[] set tonemap=1
if "%tonemap%"=="HDR" set tonemap=1
if "%tonemap%"=="SDR" set tonemap=0
if "%tonemap%"=="2" set dualmapping=y& set tonemap=1
if not "%tonemap%"=="0" if not "%tonemap%"=="1" set tonemap=1

echo.
if "%tonemap%"=="0" echo   Which target nits value for the SDR tone mapping^? (default = 125)& set /p SDR_target_nits=
if "%dualmapping%"=="y" echo   Which target nits value for the SDR tone mapping^? (default = 125)& set /p SDR_target_nits=
if [%SDR_target_nits%]==[] set SDR_target_nits=125
echo.

:skipmapping

::================================DELAY=========================================================

::Apply delays to frames
for /L %%i in (2,1,%input_count%) do (
    if not "!delay%%i!"=="" if not "!delay%%i!"=="no" (
        if not "!delay%%i:~0,1!"=="-" set "delay%%i=+!delay%%i!"
		)
)

for /L %%i in (2,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
        if not "!delay%%i!"=="" set /a "V%%iAdjframe%%j=!frame%%j!!delay%%i!"
    )
)

::================================================================================================================================================
::================================INDEX=========================================================================================================
::================================================================================================================================================

::=================================================DT-DL========================================================================================
for /L %%i in (1,1,%input_count%) do (
        set T1.ID%%i=4113
		set T2.ID%%i=4117
)

for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
        set FELBAKED%%i=BL_FEL_Baked
    )
)

for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
        if /i "!fileext%%i!"==".mkv" (
            set T1.ID%%i=1
            set T2.ID%%i=2
			set FELBAKED%%i=BL_FEL_Baked
        )
    )
)

for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
        if /i "!fileext%%i!"==".mp4" (
            set T1.ID%%i=1
            set T2.ID%%i=2
        )
    )
)

for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
        if "!video.count%%i!"=="2" (
            echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --demux --vbv-len=500 > "%TEMP%%%i.meta"
            echo V_MPEGH/ISO/HEVC, "!filepath%%i!!filename%%i!!fileext%%i!", track=!T1.ID%%i! >> "%TEMP%%%i.meta"
            echo V_MPEGH/ISO/HEVC, "!filepath%%i!!filename%%i!!fileext%%i!", insertSEI, contSPS, track=!T2.ID%%i! >> "%TEMP%%%i.meta"
            "%tsmuxer_path%" "%TEMP%%%i.meta" "%TEMP%"
            set BL%%i="%TEMP%!filename%%i!.track_!T1.ID%%i!.hevc"
            set EL%%i="%TEMP%!filename%%i!.track_!T2.ID%%i!.hevc"
        )
    )
)

::=================================================ST-DL=======================================================================================
cd /d "%TEMP%"
for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
        if not "!video.count%%i!"=="2" (
        "%ffmpeg_path%" -i "!filepath%%i!!filename%%i!!fileext%%i!" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -
        rename "%TEMP%BL.hevc" "!filename%%i!_BL.hevc"
        rename "%TEMP%EL.hevc" "!filename%%i!_EL.hevc"
        set BL%%i="%TEMP%!filename%%i!_BL.hevc"
        set EL%%i="%TEMP%!filename%%i!_EL.hevc"
        )
    )
)
cd /d "%output_path%"

::=========================================RPU=================================================================================================
for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
     "%dovi_tool_path%" extract-rpu !EL%%i! -o "%TEMP%!filename%%i!_RPU_FEL.bin"
     set RPU%%i="%TEMP%!filename%%i!_RPU_FEL.bin"
    )
)

for /L %%i in (1,1,%input_count%) do (
    if /i "!subprofile%%i!"=="FEL" (
        echo \033[92m Indexing the HDR10 base layer of !filename%%i! | "%cmdcolor%"
        "%DGIndexNV_path%" -i !BL%%i! -o "%TEMP%BL%%i.dgi" -h -a
        echo.
        echo \033[92m Indexing the DV 12bits enhancement layer of !filename%%i! | "%cmdcolor%"
        "%DGIndexNV_path%" -i !EL%%i! -o "%TEMP%EL%%i.dgi" -h -a
    )
)
::=============================================NONE-FEL=====================================================================================

echo.
for /L %%i in (1,1,%input_count%) do (
    if not "!subprofile%%i!"=="FEL" (
    if not "!fileext%%i!"==".avi" echo \033[92m Indexing !filename%%i! | "%cmdcolor%"
    if not "!fileext%%i!"==".avi" "%ffmsindex%" "!filepath%%i!!filename%%i!!fileext%%i!" -f "%TEMP%%%i.ffindex"
    )
)
echo.
::=============================================extract RPU==================================================================================
for /L %%i in (1,1,%input_count%) do (
    if not "!subprofile%%i!"=="FEL" (
        if /i "%rpuvalues%"=="YES" (
            if /i "!v%%iDV!"=="y" (
			    echo Extracting RPU: !filename%%i!
                "%ffmpeg_path%" -i  "!filepath%%i!!filename%%i!!fileext%%i!" -c:v copy -bsf:v hevc_mp4toannexb -f hevc -y -loglevel error -stats - | "%dovi_tool_path%" extract-rpu -o "%TEMP%!filename%%i!_RPU.bin" -
                set RPU%%i="%TEMP%!filename%%i!_RPU.bin"
            )
        )
    )
)
goto :skipfirstmanual

:singleagain72
set frame_number=1
echo.
echo \033[92m Do you want to export more frames^? Enter a frame number or press enter to ^exit... | "%cmdcolor%" & set /p frame1=
echo.
if [%frame1%]==[] goto :END
if /i "%frame1%"=="n" goto :END
if /i "%frame1%"=="no" goto :END
for /L %%i in (2,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
        if not "!delay%%i!"=="" set /a "V%%iAdjframe%%j=!frame%%j!!delay%%i!"
    )
)

:skipfirstmanual
::export RPU L1 max avg values to variables
for /L %%i in (1,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
        if /i "%rpuvalues%"=="YES" (
            if /i "!v%%iDV!"=="y" (
                if "!delay%%i!"=="" (
                    "%dovi_tool_path%" info --input !RPU%%i! -f !frame%%j! > "%TEMP%raw%%j.txt"
                ) else (
                    "%dovi_tool_path%" info --input !RPU%%i! -f !V%%iAdjframe%%j! > "%TEMP%raw%%j.txt"
                )

                for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw%%j.txt"') do (
                    set "maxpq=%%a"
                )
                for /f "tokens=*" %%k in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !maxpq!') do (
                    set "valueinnits=%%k"
                )
                set "V%%iMC%%j=!valueinnits!"

                for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw%%j.txt"') do (
                    set "avgpq=%%a"
                )
                for /f "tokens=*" %%k in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !avgpq!') do (
                    set "valueinnits=%%k"
                )
                set "V%%iMF%%j=!valueinnits!"
            )
        )
    )
)

::=====================================================================================================================================================================================
::========================================================================measure HDR=================================================================================================
::=====================================================================================================================================================================================

if /i "%Measure_CAP%"=="NO" goto :skipmeasurecap72
if  "%dontmeasureagain%"=="y" goto :skipmeasurecap72
echo.
for /L %%i in (1,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
        if not "!v%%i!"=="709" (
	     	if /i "!fileext%%i!"==".avi" echo AVISource("!filepath%%i!!filename%%i!!fileext%%i!"^) > "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if not "!fileext%%i!"==".avi" if not "!subprofile%%i!"=="FEL" echo LoadPlugin("%ffms2%"^) > "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo LoadPlugin("%DGDecodeNV.dll%"^) > "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo LoadPlugin("%DoViBaker%"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"

            if not "!fileext%%i!"==".avi" if not "!subprofile%%i!"=="FEL" echo FFVideoSource("!filepath%%i!!filename%%i!!fileext%%i!", cachefile="%TEMP%%%i.ffindex"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo bl = DGSource("%TEMP%BL%%i.dgi"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo el = DGSource("%TEMP%EL%%i.dgi"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo DoViBaker(bl, el, rpu="%TEMP%!filename%%i!_RPU_FEL.bin"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
			if /i "!fileext%%i!"==".avi" if /i "%avimode%"=="HDR" echo ConvertToYUV420(matrix="2020"^)  >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"

            if not "!subprofile%%i!"=="FEL" echo ConvertBits(16^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!v%%i!"=="HDR" if not "!subprofile%%i!"=="FEL" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"

            if /i "!v%%i!"=="p5" echo libplacebo_Tonemap(src_csp=3, dst_csp=1^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!v%%i!"=="p5" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:full=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"

            if /i "!v%%i!"=="HLG" echo libplacebo_Tonemap(src_csp=2, dst_csp=1^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if /i "!v%%i!"=="HLG" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"

            if /i "!crop%%i!"=="y" echo Crop(!right%%i!, !top%%i!, -!left%%i!, -!bottom%%i!^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if "!v%%i_1080!"=="y" echo %upscale_algo%Resize(width ^* %Xup%, height ^* %Xup%^) >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
			if  "!delay%%i!"=="" echo Trim(!frame%%j!, !frame%%j!^)  >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
            if  not "!delay%%i!"=="" echo Trim(!V%%iAdjframe%%j!, !V%%iAdjframe%%j!^)  >> "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs"
		  )
    )
)

for /L %%i in (1,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
       set "V%%iMaxCLL%%j="
        set "V%%iMaxFALL%%j="
    )
)

for /L %%i in (1,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
        if not "!v%%i!"=="709" (
            if "!delay%%i!"=="" (
			     ECHO  Measuring "!filename%%i!"
                echo Frame: !frame%%j! (%%j of %frame_number%^)
                "%ffmpeg_path%" -i "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level 0 -y "%TEMP%!filename%%i!.tomeasure_!frame%%j!.png" 2>nul
            ) else (
			    ECHO  Measuring "!filename%%i!"
                echo Frame: !V%%iAdjframe%%j! (%%j of %frame_number%^)
                "%ffmpeg_path%" -i "%TEMP%!filename%%i!.tomeasure_!frame%%j!.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level 0 -y "%TEMP%!filename%%i!.tomeasure_!frame%%j!.png" 2>nul
            )
            for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%!filename%%i!.tomeasure_!frame%%j!.png"') do (
                if not defined V%%iMaxCLL%%j set "V%%iMaxCLL%%j=%%a"
                if defined V%%iMaxCLL%%j set "V%%iMaxFALL%%j=%%a"
				echo.
            )
        )
    )
)
echo.

:skipmeasurecap72

::=====================================================================Mapping========================================================================================================

for /L %%i in (1,1,%input_count%) do if "%!v%%i!%"=="709" set tonemap=1
for /L %%i in (1,1,%input_count%)  do (
       if /i "!v%%i!"=="p5" set incolor%%i=DV-P5-ICtCp-10bits
	   if /i "!v%%i!"=="HDR" set incolor%%i=PQ-HDR-2020-YUV-10bits
	   if /i "!v%%i!"=="HLG" set incolor%%i=PQ-HLG-2020-YUV-10bits
	   if /i "!v%%i!"=="FEL" set incolor%%i=PQ-HDR-2020-YUV-12bits
	   if /i "!v%%i!"=="709" set incolor%%i=SDR-709-YUV
	   if not "!v%%i!"=="709" if "%tonemap%"=="1" set MAPPING%%i=PQ-HDR-2020-RGB-16bits
	   if "%tonemap%"=="1" if /i "!v%%i!"=="709" set MAPPING%%i=PQ-HDR-2020-RGB-16bits
	   if "%tonemap%"=="0" if not "!v%%i!"=="709" set MAPPING%%i=Libplacebo_SDR-709& set TMM%%i=TMM:%gamut_mapping_mode%& set TMF%%i=TMF:%tone_mapping_function%& set DTM%%i=DTM:%peak_detect%& set target%%i=@ %SDR_target_nits%nits& set targetnits%%i=dst_max=%SDR_target_nits%,
	   if "%tonemap%"=="0" if /i "!v%%i!"=="709" set MAPPING%%i=SDR-709-RGB
)

::=====================================================================================================================================================================================
::====================================================================SCRIPT==========================================================================================================
::=====================================================================================================================================================================================

if not exist "%output_path%%filename1%_VS_%filename2%\" MD "%output_path%%filename1%_VS_%filename2%\"

for /L %%i in (1,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
            if not  "!fileext%%i!"==".avi" if not "!subprofile%%i!"=="FEL" echo LoadPlugin("%ffms2%"^) > "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo LoadPlugin("%DGDecodeNV.dll%"^) > "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo LoadPlugin("%DoViBaker%"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!fileext%%i!"==".avi" echo AVISource("!filepath%%i!!filename%%i!!fileext%%i!"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"

            if not "!subprofile%%i!"=="FEL" if not "!fileext%%i!"==".avi" echo FFVideoSource("!filepath%%i!!filename%%i!!fileext%%i!", cachefile="%TEMP%%%i.ffindex"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!subprofile%%i!"=="FEL" echo bl = DGSource("%TEMP%BL%%i.dgi"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo el = DGSource("%TEMP%EL%%i.dgi"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo DoViBaker(bl, el, rpu="%TEMP%!filename%%i!_RPU_FEL.bin"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!subprofile%%i!"=="FEL" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!fileext%%i!"==".avi" if /i "%avimode%"=="HDR" echo ConvertToYUV420(matrix="2020"^)  >> "%TEMP%!filename%%i!_!frame%%j!.avs"
							
            if not "!subprofile%%i!"=="FEL" if not "%!v%%i!%"=="709" echo ConvertBits(16^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if "!v%%i!"=="709" if "%tonemap%"=="1" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if "!v%%i!"=="709" if "%tonemap%"=="0" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			
			if /i "!v%%i!"=="HDR" if "%tonemap%"=="0" echo libplacebo_Tonemap(src_csp=1, dst_csp=0, %targetnits% dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!v%%i!"=="HDR" if "%tonemap%"=="0" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!v%%i!"=="HDR" if not "!subprofile%%i!"=="FEL" if "%tonemap%"=="1" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"

            if /i "!v%%i!"=="p5" echo libplacebo_Tonemap(src_csp=3, dst_csp=%tonemap%, %targetnits% dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!v%%i!"=="p5" if "%tonemap%"=="1" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:full=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!v%%i!"=="p5" if "%tonemap%"=="0" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:full=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"

            if /i "!v%%i!"=="HLG" echo libplacebo_Tonemap(src_csp=2, dst_csp=%tonemap%, %targetnits% dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%"^)  >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            if /i "!v%%i!"=="HLG" if "%tonemap%"=="1" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "!v%%i!"=="HLG" if "%tonemap%"=="0" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"

            if /i "!v%%i_1080!"=="y" echo %upscale_algo%Resize(width ^* %Xup%, height ^* %Xup%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if "!delay%%i!"=="" echo Trim(!frame%%j!, !frame%%j!^)  >> "%TEMP%!filename%%i!_!frame%%j!.avs"
            if not "!delay%%i!"=="" echo Trim(!V%%iAdjframe%%j!, !V%%iAdjframe%%j!^)  >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			
			if /i "%screenshot_OSD%"=="YES" echo scriptClip(""^"  >> "%TEMP%!filename%%i!_!frame%%j!.avs"  
			if /i "%screenshot_OSD%"=="YES" echo     subtitle("!filename%%i! !FELBAKED%%i!", size=18, align=7, x=40, y=15, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs" 
			if /i "%screenshot_OSD%"=="YES" echo     subtitle(string(width^) ^+ " x " ^+ string(height^) ^+ " @ " ^+ string(framerate^) ^+ " !UP%%i! !upal%%i!", size=18, align=7, x=40, y=34, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs" 
			if /i "%screenshot_OSD%"=="YES"  if not "!delay%%i!"=="" if not "!fileext%%i!"==".avi" echo    subtitle("Frame: !V%%iAdjframe%%j!" ^+ " of " ^+ "!frameCount%%i!" ^+ " - Picture type: " ^+ Chr(FFPICT_TYPE^) , size=18, align=7, x=40, y=53, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs" 
			if /i "%screenshot_OSD%"=="YES" if "!delay%%i!"=="" if not "!fileext%%i!"==".avi" echo     subtitle("Frame: !frame%%j!" ^+ " of " ^+ "!frameCount%%i!" ^+ " - Picture type: " ^+ Chr(FFPICT_TYPE^), size=18, align=7, x=40, y=53, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs" 
			if /i "%screenshot_OSD%"=="YES"  if not "!delay%%i!"=="" if /i "!fileext%%i!"==".avi" echo    subtitle("Frame: !V%%iAdjframe%%j!" ^+ " of " ^+ "!frameCount%%i!" ^+ " - Picture type: I - Lossless Codec " , size=18, align=7, x=40, y=53, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs" 
			if /i "%screenshot_OSD%"=="YES" if "!delay%%i!"=="" if /i "!fileext%%i!"==".avi" echo     subtitle("Frame: !frame%%j!" ^+ " of " ^+ "!frameCount%%i!" ^+ " - Picture type: I - Lossless Codec " , size=18, align=7, x=40, y=53, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs" 
			if /i "%screenshot_OSD%"=="YES" echo     subtitle("Input: !incolor%%i!", size=18, align=7, x=40, y=72, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "%screenshot_OSD%"=="YES" echo     subtitle("Output: !MAPPING%%i! !DTM%%i! !TMM%%i! !TMF%%i! !target%%i!", size=18, align=7, x=40, y=91, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "%screenshot_OSD%"=="YES" if not "!v%%i!"=="709" if not  "!fileext%%i!"==".avi" echo     subtitle("MDL: !MDL%%i!", size=18, align=7, x=40, y=110, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "%screenshot_OSD%"=="YES" if /i "%Measure_CAP%"=="YES" if not "!v%%i!"=="709" echo     subtitle("Measurement MAX/AVG: !V%%iMaxCLL%%j!nits / !V%%iMaxFALL%%j!nits", size=24, align=7, x=40, y=129, text_color=%osdcolor%^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "%screenshot_OSD%"=="YES" if /i "%rpuvalues%"=="YES" if /i "!v%%iDV!"=="y" echo     subtitle("DV RPU Level 1 MAX/AVG: !V%%iMC%%j!nits / !V%%iMF%%j!nits ", size=24, align=7, x=40, y=149, text_color=%osdcolor%^)  >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			if /i "%screenshot_OSD%"=="YES" echo ""^"^) >> "%TEMP%!filename%%i!_!frame%%j!.avs"
			)
)

echo.
for /L %%i in (1,1,%input_count%) do (
echo =========!filename%%i! SCRIPT===========
type "%TEMP%!filename%%i!_%frame1%.avs"
echo ========================================
echo.
)

for /L %%i in (1,1,%input_count%) do (
    for /L %%j in (1,1,%frame_number%) do (
            if "!delay%%i!"=="" (
			     ECHO  Exporting "!filename%%i!" in !MAPPING%%i!
                echo  Frame: !frame%%j! (%%j of %frame_number%^)
                "%ffmpeg_path%" -i "%TEMP%!filename%%i!_!frame%%j!.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%%filename1%_VS_%filename2%\!frame%%j!_!filename%%i!_!MAPPING%%i!.png" 2>nul
				echo.
            ) else (
			    ECHO  Exporting "!filename%%i!" in !MAPPING%%i!
                echo  Frame: !V%%iAdjframe%%j! (%%j of %frame_number%^)
                "%ffmpeg_path%" -i "%TEMP%!filename%%i!_!frame%%j!.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%%filename1%_VS_%filename2%\!V%%iAdjframe%%j!_!filename%%i!_!MAPPING%%i!.png" 2>nul
				echo.
            )
        )
    )
)

if "%dualmapping%"=="y" if "%tonemap%"=="1" set tonemap=0& set dualmapping=n& goto :skipmeasurecap72
if "%dualmapping%"=="y" if "%tonemap%"=="0" set tonemap=1& set dualmapping=n& goto :skipmeasurecap72

set frame1=& goto :singleagain72

:END

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.

for /L %%i in (1,1,%input_count%) do (
     set filename%%i=&set filepath%%i=& set fileext%%i=& set frame%%i=& set delay%%i=& set v%%i=& set right%%i=& set left%%i=& set top%%i=& set bottom%%i=& set v%%i_1080p=& set up%%i=& set ups%%i=& set MAPPING%%i=
)

echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit


::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

::----------------------------------------------------------------HEAT MAP-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:again456456456
:Workflow.3
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- Measure and create heat and gamut map for HDR
echo -- Input can be a png or a video file (batch mode only supported ^for folder with png images)
echo -- Video input can be P5-P8-P7-DV, HDR10, HLG or SDR and  Image input must be PNG
echo -- P5/HLG input require a gpu with vulkan support
echo -- PNG images input must be 3840x2160: Cropped PNG does not work but cropped video is works
echo -- Screenshots settings at line 100-137
echo -- Required Python libraries: numpy, colour, matplotlib, scikit-image,
echo -- and colour-science,  opencv-python, headless (command window: pip install scikit-image)
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

echo Drag and drop folder with PNG images or a single image/video and press enter...
set /p folder=
echo.

echo Set the input aspect ratio and press enter... EG: 1.78 / 1.85 / 2.40 / 2.39 / 2.35 / 2.00 (default = 1.78) & set /p AR=
if [%AR%]==[] set AR=1.78
echo.

setlocal enabledelayedexpansion
set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

set single.file=n

if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
	 set single.file=y
)

if /i "%fileext1%"==".mkv" set input=%folder%& goto :heat.gamut.video
if /i "%fileext1%"==".ts" set input=%folder%& goto :heat.gamut.video
if /i "%fileext1%"==".m2ts" set input=%folder%& goto :heat.gamut.video
if /i "%fileext1%"==".mp4" set input=%folder%& goto :heat.gamut.video

if /i "%single.file%"=="n" set output_path=%filepath1%
:loop.heatmap
if not "%fileext1%"==".png" if not "%fileext1%"==".PNG" goto :END

if exist "%temp_folder%temp.folder29" rmdir /Q /S "%temp_folder%temp.folder29"
MD "%temp_folder%temp.folder29"
set TEMP=%temp_folder%temp.folder29\

::------------------------------------------------------------------------HEATMAP---------------------------------------------------------------

echo Creating the HEAT map of %filename1%
python "%~dp0tools\heatmap.py" -l "%~dp0tools\heatmap_HDR.cube" -c "%~dp0tools\heatmap_colourbar.png" -i "%filepath1%%filename1%%fileext1%" -ar %AR% -o "%output_path%%filename1%_Heatmap.png" >Nul 2>&1

::------------------------------------------------------------------------GAMUT----------------------------------------------------------------

echo Creating the GAMUT map of %filename1%
python "%~dp0tools\gamut.py" -l "%~dp0tools\gamut_HDR_SDR_LM.cube" -i "%filepath1%%filename1%%fileext1%"  -o "%output_path%%filename1%_Gamut.png" >Nul 2>&1

::---------------------------------------------------------------------MAP images to HDR 100nits--------------------------------------------

if /i "%maptohdr7.3%"=="NO" goto :END
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%scriptgamut.avs" 
echo ImageSource( "%output_path%%filename1%_Gamut.png") >> "%TEMP%scriptgamut.avs" 
echo ConvertToYUV420(matrix="709") >> "%TEMP%scriptgamut.avs" 
echo ConvertBits(10) >> "%TEMP%scriptgamut.avs"  
echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:l",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%scriptgamut.avs"  

echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%scriptheat.avs" 
echo ImageSource( "%output_path%%filename1%_Heatmap.png") >> "%TEMP%scriptheat.avs" 
echo ConvertToYUV420(matrix="709") >> "%TEMP%scriptheat.avs" 
echo ConvertBits(10) >> "%TEMP%scriptheat.avs"  
echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:l",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%scriptheat.avs"  

::export screenshots
echo Mapping to HDR
"%ffmpeg_path%" -i "%TEMP%scriptgamut.avs" -vf select='eq(n,0)' -vframes 1 -compression_level 0 -y "%output_path%%filename1%_Gamut_mapped.HDR.png" 2>nul
"%ffmpeg_path%" -i "%TEMP%scriptheat.avs" -vf select='eq(n,0)' -vframes 1 -compression_level 0 -y "%output_path%%filename1%_Heatmap_mapped.HDR.png" 2>nul

if exist "%output_path%%filename1%_Gamut.png" del "%output_path%%filename1%_Gamut.png"
if exist "%output_path%%filename1%_Heatmap.png" del "%output_path%%filename1%_Heatmap.png"
echo.

:END
rmdir /Q /S "%TEMP%"
:: go to next file or end the script
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.heatmap
)

Setlocal DisableDelayedExpansion
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=

:: delete temp files
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"
echo.
 goto :again456456456
 
::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------------------------------------------------video input----------------------------------------------------------------------------------------------
::-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:heat.gamut.video

echo Manual(m) or Auto(a) mode^? (default= a)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p modemap=
if [%modemap%]==[] set modemap=a
if /i "%modemap%"=="a" set modemap=a
if /i "%modemap%"=="m" set modemap=m

:: make and set temp folder
if exist "%temp_folder%temp.folder27_new" rmdir /Q /S "%temp_folder%temp.folder27_new"
if exist "%temp_folder%temp.folder27" set E1=_new
MD "%temp_folder%temp.folder27%E1%"
set TEMP=%temp_folder%temp.folder27%E1%\

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

::workaround for input with )
set oldfilename=%filename%
set newfilename=%filename:)=%
rename "%filepath%%filename%%fileext%" "%newfilename%%fileext%"
set filename=%newfilename%

if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
echo.
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, will process P7 FEL has HDR10 & set bakefel7273=NO
echo.
:nvidiacheck

echo "%filename%" > "%TEMP%filename.txt"
findstr /c:")" "%TEMP%filename.txt" >Nul
if %errorlevel%==0 echo Remove any special character from path/filename from input and try again...&pause&exit

::------------------------check input type---------------------------------------------------------------------------------------------------

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
type "%TEMP%mediainfo.JSON" | findstr HLG >"%TEMP%pq.txt"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%

set SDR=y& set p5=n& set HLG=n& set p7=n
findstr /m "2086" "%TEMP%check.HDR.txt" >Nul
if %errorlevel%==0 set SDR=n
findstr /m "2094" "%TEMP%check.HDR.txt" >Nul
if %errorlevel%==0 set SDR=n
findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set p5=y& set SDR=n
findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set HLG=y& set SDR=n
findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P7=y
if "%video.count%"=="2" set P7=y

set subprofile=MEL
if /i "%bakefel7273%"=="NO" goto :skipP7.1
if /i "%fileext%"==".mp4" if "%video.count%"=="2" set subprofile=FEL& goto :skipP7.1
if not "%p7%"=="y" goto :skipP7.1

::check for FEL input 1
"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:00:10 > Nul
"%mkvextract_path%" "%TEMP%1.mkv" tracks 0:"%TEMP%temp.vid.hevc" > Nul
"%dovi_tool_path%" -m 0 extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" >Nul
"%dovi_tool_path%" info --input "%TEMP%chunk.RPU.bin" -f 48 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"
findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=MEL

::--------------------------------------------------------------FEL---------------------------------------------------------------------------------------------

if /i  "%subprofile%"=="MEL" goto :skipP7.1
set FELBAKED1=BL_FEL_Baked
set T1.ID=4113& set T2.ID=4117
if /i "%fileext%"==".mkv" set T1.ID=1& set T2.ID=2
if /i "%fileext%"==".mp4" set T1.ID=1& set T2.ID=2
if not "%video.count%"=="2" goto :skip2vid
         echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --demux --vbv-len=500 > "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=%T1.ID% >> "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", insertSEI, contSPS, track=%T2.ID% >> "%TEMP%1.meta"
         "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
		 set BL="%TEMP%%filename%.track_%T1.ID%.hevc"& set EL="%TEMP%%filename%.track_%T2.ID%.hevc"
		 goto :indexdg
:skip2vid

cd /d "%TEMP%"
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -
cd /d "%output_path%"
set BL="%TEMP%BL.hevc"& set EL="%TEMP%EL.hevc"

:indexdg
"%dovi_tool_path%" extract-rpu %EL% -o "%TEMP%%filename%_RPU_FEL.bin"
set RPU="%TEMP%%filename%_RPU_FEL.bin"

     ::index
	 echo Indexing the HDR10 base layer...
	 "%DGIndexNV_path%" -i %BL% -o "%TEMP%BL.dgi" -h -a
	 echo Done.
	 echo Indexing the DV 12bits enhancement layer...
	 "%DGIndexNV_path%" -i %EL% -o "%TEMP%EL.dgi" -h -a
	 echo Done.
	 goto :skipffms2
:skipP7.1

"%ffmsindex%" "%filepath%%filename%%fileext%" -f "%TEMP%1.ffindex"

:skipffms2
::-------------------------------------------------------------crop,upscale------------------------------------------------------------------------------------

if "%uncropheatmap%"=="NO" goto :skip.cropped
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "W=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "H=%%a"
)

set left=0& set right=0& set top=0& set bottom=0

set cropped.width=YES
::Width
if "%W%"=="3840" set cropped.width=NO& goto :skip.cropped1
if "%W%"=="1920" set cropped.width=NO& goto :skip.cropped1

if not %W% lss 1920 set /a total.BB1=3840 - %W%
if %W% lss 1920 (
      set /a total.BB1=1920 - %W%
)
set /a "half1=%total.BB1% / 2"
set left=%half1%
set right=%half1%

set /a remainder1=%half1% %% 2
if "%remainder1%"=="1" set /a left=%half1% - 1& set /a right=%half1% - 1& set upsize=y

:skip.cropped1

set cropped.height=YES
::Height
if "%H%"=="2160" set cropped.height=NO& goto :skip.cropped
if "%H%"=="1080" set cropped.height=NO& goto :skip.cropped

if not %H% lss 1080 set /a total.BB=2160 - %H%
if %H% lss 1080 (
     set /a total.BB=1080 - %H%
	 set not4K=y
)
set /a "half=%total.BB% / 2"
set top=%half%
set bottom=%half%
set /a remainder2=%half% %% 2
if "%remainder2%"=="1" set /a top=%half% - 1& set /a bottom=%half% - 1& set upsize=y

:skip.cropped

if /i "%cropped.height%"=="YES" set cropped=YES
if /i "%cropped.width%"=="YES" set cropped=YES

::------------------------------------------------------------------------------------------------------------------------------------------------------
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%FrameCount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount.txt"') do (
    set "frameCount=%%a"
)
set frameCount=%frameCount:"=%

if %frameCount% leq 68000 (
     if "%frame_number%"=="50" set frame_number=34
)
if %frameCount% leq 20000 (
     if "%frame_number%"=="25" set frame_number=12
)
if %frameCount% leq 10000 (
     if "%frame_number%"=="12" set frame_number=5
)


::--------------------------------------------------------------------manual--------------------------------------------------------------------------------------------------
if /i "%modemap%"=="a" MD "%output_path%%filename%\" & goto :skipmanual

start "" "%AvsPmod_path%" "%filepath%%filename%%fileext%"

echo.
echo.
echo \033[36m          ====================== | "%cmdcolor%"
echo \033[36m          - MANUAL SCREENSHOTS - | "%cmdcolor%"
echo \033[36m          ====================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -The script will loop as long as you enter a frame number...
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"

:singleagainHEAT
set frame_number=1
echo.
echo \033[92mMANUAL MODE: which frame do you want to export^? (press enter to ^exit)| "%cmdcolor%" & set /p frametoexport=
echo.
if [%frametoexport%]==[] goto :end
::---------------------------------------------------------------script---------------------------------------------------------------------------------------------------------
:skipmanual
for /L %%i in (1,1,%frame_number%) do (
if /i  "%subprofile%"=="MEL" echo LoadPlugin("%ffms2%"^) > "%TEMP%%%i.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%DoViBaker%"^) > "%TEMP%%%i.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i.avs"
  echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%%%i.avs" 
  echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%%%i.avs" 
if /i  "%subprofile%"=="MEL" echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%TEMP%1.ffindex"^) >> "%TEMP%%%i.avs"
if /i  "%subprofile%"=="FEL" echo bl = DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i.avs"
if /i  "%subprofile%"=="FEL" echo el = DGSource("%TEMP%EL.dgi"^) >> "%TEMP%%%i.avs"
if /i  "%subprofile%"=="FEL" echo DoViBaker(bl, el, rpu="%TEMP%%filename%_RPU_FEL.bin"^) >> "%TEMP%%%i.avs"
if /i  "%subprofile%"=="FEL" echo ConvertToYUV420(matrix="2020"^)  >> "%TEMP%%%i.avs"

  if "%SDR%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%%%i.avs"
  if "%SDR%"=="n" if /i  "%subprofile%"=="MEL" echo ConvertBits(16^) >> "%TEMP%%%i.avs"
  if "%SDR%"=="n" if "%p5%"=="n" if "%HLG%"=="n" if /i  "%subprofile%"=="MEL" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%%%i.avs"
  if "%p5%"=="y" echo libplacebo_Tonemap(src_csp=3, dst_csp=1^) >> "%TEMP%%%i.avs" 
  if "%HLG%"=="y" echo libplacebo_Tonemap(src_csp=2, dst_csp=1^) >> "%TEMP%%%i.avs"
 
 if /i "%cropped%"=="YES" echo AddBorders(%left%, %top%, %right%, %bottom%^) >> "%TEMP%%%i.avs"
 if /i "%upsize%"=="y" echo %upscale_algo%Resize(3840, 2160^) >> "%TEMP%%%i.avs"
  if "%not4K%"=="y" if not "%upsize%"=="y" echo %upscale_algo%Resize(Width ^* 2, Height ^* 2^) >> "%TEMP%%%i.avs" 
 
if /i "%screenshot_OSD%"=="YES" echo scriptClip(""^"  >> "%TEMP%%%i.avs" 
if /i "%screenshot_OSD%"=="YES" echo     subtitle("%filename% %FELBAKED1%", size=14, align=7, 4, 25, text_color=$606060^) >> "%TEMP%%%i.avs" 
if /i "%screenshot_OSD%"=="YES" echo     subtitle("Resolution: " + string(width^) + " x " + string(height^) + " @ " + string(framerate^), size=14, align=7, 4, 40, text_color=$606060^) >> "%TEMP%%%i.avs" 
if /i "%screenshot_OSD%"=="YES" if /i "%modemap%"=="a" echo     subtitle("Frame: %%i%frame_interval%", size=14, align=7, 4, 55, text_color=$606060^) >> "%TEMP%%%i.avs"
if /i "%screenshot_OSD%"=="YES" if /i "%modemap%"=="m" echo     subtitle("Frame: %frametoexport%", size=14, align=7, 4, 55, text_color=$606060^) >> "%TEMP%%%i.avs" 
if /i "%screenshot_OSD%"=="YES" echo     subtitle("Picture type: " + Chr(FFPICT_TYPE^), size=14, align=7, 4, 70, text_color=$606060^) >> "%TEMP%%%i.avs"
if /i "%screenshot_OSD%"=="YES" echo ""^"^) >> "%TEMP%%%i.avs"
if /i "%modemap%"=="a" echo trim(%%i%frame_interval%,%%i%frame_interval%^) >> "%TEMP%%%i.avs"
if /i "%modemap%"=="m" echo trim(%frametoexport%, %frametoexport%^) >> "%TEMP%%%i.avs"
)
echo.

if /i "%modemap%"=="a" goto :skipmanual
::----------------------------------------------------------------------------manual---------------------------------------------------------------------------------------------
echo.
     echo Exporting frame %frametoexport%
     "%ffmpeg_path%" -i "%TEMP%1.avs" -vf select='eq(n\,0)' -vframes 1 -compression_level %pic_compression% -y "%output_path%%frametoexport%_%filename%_PQ_HDR_16BITS.png" 2>nul
echo.

DEL "%TEMP%1.avs"
::------------------------------------------------------------------------HEAT MAP--------------------------------------------------------------------------------------------

echo Creating the HEAT map for Frame %frametoexport%
python "%~dp0tools\heatmap.py" -l "%~dp0tools\heatmap_HDR.cube" -c "%~dp0tools\heatmap_colourbar.png" -i "%output_path%%frametoexport%_%filename%_PQ_HDR_16BITS.png" -ar %AR% -o "%output_path%%frametoexport%_%filename%_Heatmap.png" >Nul 2>&1

echo.
if "%SDR%"=="y" goto :skipGAMUT

::------------------------------------------------------------------------GAMUT----------------------------------------------------------------------------------------------------

echo Creating the GAMUT map for Frame %frametoexport%
python "%~dp0tools\gamut.py" -l "%~dp0tools\gamut_HDR_SDR_LM.cube" -i "%output_path%%frametoexport%_%filename%_PQ_HDR_16BITS.png" -o "%output_path%%frametoexport%_%filename%_Gamut.png" >Nul 2>&1

echo.
:skipGAMUT
set frametoexport=
goto :singleagainHEAT

::--------------------------------------------------------------------------auto--------------------------------------------------------------------
:skipmanual
for /L %%i in (1,1,%frame_number%) do (
     echo Exporting frame %%i%frame_interval% of %filename%
     "%ffmpeg_path%" -i "%TEMP%%%i.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%%filename%\%%i%frame_interval%_%filename%.png" 2>nul
)
echo.
::------------------------------------------------------------------------HEAT MAP----------------------------------------------------------------

for /L %%i in (1,1,%frame_number%) do (
echo Creating the HEAT map for Frame %%i%frame_interval%...
python "%~dp0tools\heatmap.py" -l "%~dp0tools\heatmap_HDR.cube" -c "%~dp0tools\heatmap_colourbar.png" -i "%output_path%%filename%\%%i%frame_interval%_%filename%.png" -ar %AR% -o "%output_path%%filename%\%%i%frame_interval%_%filename%_Heatmap.png" >Nul 2>&1
)
echo.

::------------------------------------------------------------------------GAMUT----------------------------------------------------------------

for /L %%i in (1,1,%frame_number%) do (
echo Creating the GAMUT map for Frame %%i%frame_interval%...
python "%~dp0tools\gamut.py" -l "%~dp0tools\gamut_HDR_SDR_LM.cube" -i "%output_path%%filename%\%%i%frame_interval%_%filename%.png" -o "%output_path%%filename%\%%i%frame_interval%_%filename%_Gamut.png" >Nul 2>&1
)
echo.

::---------------------------------------------------------------------MAP images to HDR 100nits--------------------------------------------

if /i "%maptohdr7.3%"=="NO" goto :done
for /L %%i in (1,1,%frame_number%) do (
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%scriptgamut%%i.avs" 
echo ImageSource("%output_path%%filename%\%%i%frame_interval%_%filename%_Gamut.png"^) >> "%TEMP%scriptgamut%%i.avs" 
echo ConvertToYUV420(matrix="709"^) >> "%TEMP%scriptgamut%%i.avs" 
echo ConvertBits(10^) >> "%TEMP%scriptgamut%%i.avs"  
echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:l",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%scriptgamut%%i.avs"  
)
for /L %%i in (1,1,%frame_number%) do (
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%scriptheat%%i.avs" 
echo ImageSource("%output_path%%filename%\%%i%frame_interval%_%filename%_Heatmap.png"^) >> "%TEMP%scriptheat%%i.avs" 
echo ConvertToYUV420(matrix="709"^) >> "%TEMP%scriptheat%%i.avs" 
echo ConvertBits(10^) >> "%TEMP%scriptheat%%i.avs"  
echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:l",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%scriptheat%%i.avs"  
)
::export screenshots
for /L %%i in (1,1,%frame_number%) do (
echo Mapping %%i%frame_interval%_%filename% to HDR...
"%ffmpeg_path%" -i "%TEMP%scriptgamut%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level 0 -y "%output_path%%filename%\%%i%frame_interval%_%filename%_Gamut_Mapped_HDR.png" 2>nul
"%ffmpeg_path%" -i "%TEMP%scriptheat%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level 0 -y "%output_path%%filename%\%%i%frame_interval%_%filename%_Heatmap_Mapped_HDR.png" 2>nul
)
for /L %%i in (1,1,%frame_number%) do (
if exist "%output_path%%filename%\%%i%frame_interval%_%filename%_Gamut.png" del "%output_path%%filename%\%%i%frame_interval%_%filename%_Gamut.png"
if exist "%output_path%%filename%\%%i%frame_interval%_%filename%_Heatmap.png" del "%output_path%%filename%\%%i%frame_interval%_%filename%_Heatmap.png"
)

:done
set modemap=m& set frametoexport=& goto :singleagainHEAT

:end
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.4
echo.
echo.
echo \033[36m          ============================= | "%cmdcolor%"
echo \033[36m          - DoVi_METADATA_COMPARISONS - | "%cmdcolor%"
echo \033[36m          ============================= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- Creates a DV metadata comparison video of 10 frames
echo -- Input can be a folder with files or a single file (MKV MP4 TS M2TS)
echo -- Require python opencv. Type in a cmd window: pip install opencv-python
echo -- Examples: https://drive.google.com/drive/folders/1g5I-z_sJmVu-SAIPNiiSlcdMiy2ka0mf^?usp=drive_link
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
if not exist "%~dp0tools\generate_sample_template_cmv29.json" echo "tools\generate_sample_template_cmv29.json" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\generate_sample_template_cmv40.json" echo "tools\generate_sample_template_cmv40.json" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\generate_sample.py" echo "tools\generate_sample.py" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\find_trim_metadata.py" echo "tools\find_trim_metadata.py" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\metafier.exe" echo \033[31m metafier.exe is missing from the tools folder, download it here: https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools| "%cmdcolor%"& pause & exit

echo Drag and drop a DoVi file or a folder with files and press enter...
set /p video_path=

:skipsample
cd /d "%output_path%"
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %video_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
set singlefileinput=n
if [%fileext1%]==[] (
     for %%i in (!video_path!) do set filename1=%%~ni
     for %%i in (!video_path!) do set filepath1=%%~di%%~pi
     for %%i in (!video_path!) do set fileext1=%%~xi
	 set singlefileinput=y
)

if /i "%same_input_output%"=="YES" set output_path=%filepath1%

if /i "%singlefileinput%"=="n" (
        set mode=a& set quickmode=q& set frame1=2000& set frame2=5000& set frame3=10000& set frame4=15000& set frame5=20000& set frame6=25000& set frame7=27000& set frame8=23000& set frame9=17000& set frame10=7500
        goto :LOOP.metadata.SAMPLES
)

echo.
echo Manual(m) or Auto(a) mode^? (default= a)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p mode=
if "%mode%"=="" set mode=a
if /i "%mode%"=="M" set mode=m
if /i "%mode%"=="manual" set mode=m
if /i "%mode%"=="auto" set mode=a
if  not "%mode%"=="m" if not "%mode%"=="a" set mode=a

if /i "%mode%"=="a" set quickmode=q& set frame1=2000& set frame2=5000& set frame3=10000& set frame4=15000& set frame5=20000& set frame6=25000& set frame7=27000& set frame8=23000& set frame9=17000& set frame10=7500& goto :LOOP.metadata.SAMPLES

echo   Quick(q) or Full(f) mode^? (default= q)
echo.
echo --^> FULL= f 
echo --^> QUICK= q
set /p quickmode=
if [%quickmode%]==[] set quickmode=q
if /i "%quickmode%"=="f" set quickmode=f
if /i "%quickmode%"=="q" set quickmode=q
if /i "%quickmode%"=="quick" set quickmode=q
if /i "%quickmode%"=="full" set quickmode=f
if not "%quickmode%"=="q" if not "%quickmode%"=="f" set quickmode=q
echo.

echo ^*Default = 10 frames from 1000 - 10 000
Setlocal EnableDelayedExpansion
for /L %%i in (1,1,10) do (
    echo Enter frame %%i of 10:
	set /p frame%%i=
)

for /L %%i in (1,1,10) do (
    if "!frame%%i!"=="" set "frame%%i=%%i000"
)

::=========================================================================================================================================================================================================================================================

:LOOP.metadata.SAMPLES

echo.
echo Processing %filename1%...
echo.
if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" echo Invalid extension, skipping "%filename1%%fileext1%"...& goto :skipTS

:: make and set temp folder
if exist "%temp_folder%temp.folder216" rmdir /Q /S "%temp_folder%temp.folder216"
MD "%temp_folder%temp.folder216"
set TEMP=%temp_folder%temp.folder216\

if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, disabling FEL processing (ffms2 is too slow ^for this workflow). Some FEL rip wont be accurate... & set bakefel7273=NO
:nvidiacheck
::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------check input 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::set variables to 0
set v1=& set v11=
set subprofile=MEL

:: check input colorspace
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
type "%TEMP%mediainfo.JSON" | findstr HLG > "%TEMP%pq.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%FrameCount.txt"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.c.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.c.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MasteringDisplay_Luminance%% --LogFile="%TEMP%MDL.txt" >Nul
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2

::P8
findstr /c:"08" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set v1=p8
::P5
findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set v1=p5
::P7
findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set v11=p7
if "%video.count%"=="2" set v11=p7
::HLG
findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set v11=HLG
if not "%v1%"=="p8" if not "%v11%"=="p7" if not "%v1%"=="p5" echo Input doesnt have DV metadata, skipping "%filename1%%fileext1%"....& goto :skipTS

:: check framecount and frame to export mismatch
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo4.JSON"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo4.JSON" > "%TEMP%FrameCount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount.txt"') do (
    set "FrameCount=%%a"
)
set FrameCount=%FrameCount:"=%

if %FrameCount% leq %frame1% set /a frame1=%FrameCount% - 100
if %FrameCount% leq %frame2% set /a frame2=%FrameCount% - 200
if %FrameCount% leq %frame3% set /a frame3=%FrameCount% - 300
if %FrameCount% leq %frame4% set /a frame4=%FrameCount% - 400
if %FrameCount% leq %frame5% set /a frame5=%FrameCount% - 500
if %FrameCount% leq %frame6% set /a frame6=%FrameCount% - 600
if %FrameCount% leq %frame7% set /a frame7=%FrameCount% - 700
if %FrameCount% leq %frame8% set /a frame8=%FrameCount% - 800
if %FrameCount% leq %frame9% set /a frame9=%FrameCount% - 900
if %FrameCount% leq %frame10% set /a frame10=%FrameCount% - 1000

if not "%quickmode%"=="q" goto :skipsample
if %FrameCount% leq 29000 goto :skipsample

echo.
echo Quick mode: making a 19min sample to speed up demuxing and RPU processing...
echo.
"%mkvmerge_path%" --output ^"%TEMP%%filename1%.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:19:00 > Nul
set video_path="%TEMP%%filename%.mkv"
echo Done.
set filepath1=%TEMP%
set fileext1=.mkv

:skipsample

::-------------------------------------------------static metadata--------------------------------------------------------------------------------------------

set MDP=G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)& set maxcll_path=0& set maxfall_path=0& set MDL.min_path=1& set MDL.max_path=1000
type "%TEMP%mediainfo.JSON" | findstr MasteringDisplay_ColorPrimaries > "%TEMP%MCP.txt"
findstr /c:"BT.2020" "%TEMP%MCP.txt" >Nul
if %errorlevel%==0 set MDP=G(8500,39850)B(6550,2300)R(35400,14600)WP(15635,16450)

for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxcll.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxfall.txt"') do (
    set "maxfall_path=%%a"
)

set maxcll_path=%maxcll_path: =%
set maxfall_path=%maxfall_path: =%
if "%maxcll_path%"==" =" set maxcll_path=0
if "%maxfall_path%"==" =" set maxfall_path=0
if "%maxcll_path%"=="" set maxcll_path=0
if "%maxfall_path%"=="" set maxfall_path=0

findstr /m "1000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=1000
findstr /m "4000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=4000
findstr /m "10000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=10000
findstr /m "2000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.max_path=2000
findstr /m "0.0050" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=50
findstr /m "0.0001" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=1
findstr /m "0.0020" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=20
findstr /m "0.0010" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=10
findstr /m "0.0000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set MDL.min_path=0

set static_metadata=--master-display "%MDP%L(%MDL.max_path%0000,%MDL.min_path%)" --max-cll "%maxcll_path%,%maxfall_path%"

::------------------------FEL V1---------------------------------------------------------------------------------------------------

if /i "%bakefel7273%"=="NO" goto :skipP7.1
if not "%v11%"=="p7" goto :skipP7.1
if /i "%fileext1%"==".mp4" set subprofile=FEL& goto :skipP7.1

::check for FEL input 1
"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^")^" --split parts:00:00:00-00:00:10 > Nul
"%mkvextract_path%" "%TEMP%1.mkv" tracks 0:"%TEMP%temp.vid.hevc" > Nul
"%dovi_tool_path%" -m 0 extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" >Nul
"%dovi_tool_path%" info --input "%TEMP%chunk.RPU.bin" -f 48 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"

findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=MEL

:skipP7.1

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:: V1 Indexing--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::FEL
set FEL_BAKED=
if /i  "%subprofile%"=="MEL" goto :skipP7.1
set FEL_BAKED=_BL_FEL_Merged
set T1.ID=4113& set T2.ID=4117
if /i "%fileext1%"==".mkv" set T1.ID=1& set T2.ID=2
if /i "%fileext1%"==".mp4" set T1.ID=1& set T2.ID=2
if "%quickmode%"=="q" goto :skip2vid
if not "%video.count%"=="2" goto :skip2vid
         echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --demux --vbv-len=500 > "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", insertSEI, contSPS, track=%T2.ID% >> "%TEMP%1.meta"
         "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
		 set BL="%TEMP%%filename1%.track_%T1.ID%.hevc"& set EL="%TEMP%%filename1%.track_%T2.ID%.hevc"
		 goto :indexdg
:skip2vid

cd /d "%TEMP%"
echo.
echo \033[92m Demuxing %filename1% | "%cmdcolor%"
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc -loglevel error -stats - | "%dovi_tool_path%" demux -
cd /d "%output_path%"
set BL="%TEMP%BL.hevc"& set EL="%TEMP%EL.hevc"

:indexdg
echo.
echo \033[92m Extracting RPU of %filename1% | "%cmdcolor%"
"%dovi_tool_path%" extract-rpu %EL% -o "%TEMP%%filename1%_RPU_FEL.bin"
set RPU="%TEMP%%filename1%_RPU_FEL.bin"

if /i  "%subprofile2%"=="FEL" rename "%TEMP%BL.hevc" "BL1.hevc" & rename "%TEMP%EL.hevc" "EL1.hevc" & set BL="%TEMP%BL1.hevc"& set EL="%TEMP%EL1.hevc" 
	 
     ::index with dg
	 echo Indexing the HDR10 base layer...
	 "%DGIndexNV_path%" -i %BL% -o "%TEMP%BL.dgi" -h -a
	 echo Done.
	 echo.
	 echo Indexing the DV 12bits enhancement layer...
	 "%DGIndexNV_path%" -i %EL% -o "%TEMP%EL.dgi" -h -a
	 echo Done.
	 goto :skipffms2

:skipP7.1

::demux rpu
echo.
echo \033[92m Extracting RPU of %filename1% | "%cmdcolor%"
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc -loglevel error -stats - |  "%dovi_tool_path%" extract-rpu -o "%TEMP%RPU.bin" -
set RPU="%TEMP%RPU.bin"

:: index non-fel input with ffms2
echo.
echo \033[92m Indexing %filename1% | "%cmdcolor%"
"%ffmsindex%" "%filepath1%%filename1%%fileext1%" -f "%TEMP%1.ffindex"

:skipffms2

::--------------------------------------------------RPU info------------------------------------------------------------------------------------------------------------

"%dovi_tool_path%" export -i %RPU% -o "%TEMP%full.json" > Nul
"%dovi_tool_path%" info -s %RPU% > "%TEMP%rpu.info.txt"
"%dovi_tool_path%" info --input %RPU% -f 100 > "%TEMP%singleframe.json"

set t2.100=&set L2t100=&set t2.600=&set L2t600=&set t2.1000=&set L2t1000=&set t8.100=&set L8t100=&set t8.600=&set L8t600=&set t8.1000=&set L8t1000=
set level9=& set cmv4.0=& set MDP.RPU=
set max_pq=3079
set min_pq=7
set min_mdl=1
set max_mdl=1000

type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"
findstr /c:"100 nits" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.100=y& set L2t100=L2 100nits
findstr /c:"600" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.600=y& set L2t600=, 600nits
findstr /c:"1000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.1000=y& set L2t1000=, 1000nits

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.100=y& set L8t100=- L8 100nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.600=y& set L8t600=, 600nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.1000=y& set L8t1000=, 1000nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.600=y& set L8t600=, 600nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.1000=y& set L8t1000=, 1000nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=DCIP3D65
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=BT2020
if /i  "%rem_cmv4%"=="YES" set cmv4.0=n

type "%TEMP%singleframe.json" | findstr source_min_pq > "%TEMP%min_pq.json"
type "%TEMP%singleframe.json" | findstr source_max_pq > "%TEMP%max_pq.json"

findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=3079& set max_mdl=1000
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=3388& set max_mdl=2000
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=3696& set max_mdl=4000
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4095& set max_mdl=10000
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=7& set min_mdl=1
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=62& set min_mdl=50
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=38& set min_mdl=20
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0& set min_mdl=1

::---------------------------------------------------generate metadata--------------------------------------------------------------------------------------------
echo.
if /i "%t8.600%"=="y" set cmv4.0=n& echo WARNING... Input with 600nits L8 trim not supported yet and might never be... Will discard cmv4.0...
if /i "%t8.1000%"=="y" set cmv4.0=n& echo WARNING... Input with 1000nits L8 trim not supported yet and might never be... Will discard cmv4.0...
echo.
echo \033[92m Processing RPU data of %filename1% | "%cmdcolor%"
echo.
set template="%~dp0tools\generate_sample_template_cmv29.json"

if /i  "%cmv4.0%"=="y" set template="%~dp0tools\generate_sample_template_cmv40.json"
if /i  "%cmv4.0%"=="y" if /i  "%nofloor74%"=="YES" set template="%~dp0tools\generate_sample_template_cmv40_nofloor.json"& set dovi_tool_path=%dovi_tool_nofloor%
if /i  "%nofloor74%"=="YES" set template="%~dp0tools\generate_sample_template_cmv29_nofloor.json"& set dovi_tool_path=%dovi_tool_nofloor%

set f1.l3=& set f11.l3=& set f1.l8= 
if /i  "%cmv4.0%"=="y" set f1.l3=-l3 1& set f11.l3=-l3 2& set f1.l8=-l8 1
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f1.l8=

::first frame======================================================================================================
"%dovi_tool_path%" info --input %RPU% -f %frame1% > "%TEMP%raw1.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw1.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t %template% -s "%TEMP%raw.metadata.json" -o "%TEMP%1.json" -l1 2 %f1.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%1.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%2.json" -l1 4 %f11.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%2.json" -s "%TEMP%raw.metadata.json" -o  "%TEMP%3.json" -l2 1 %f1.l8%
::second frame======================================================================================================
set f2.l3=& set f22.l3=& set f2.l8= 
if /i  "%cmv4.0%"=="y" set f2.l3=-l3 3& set f22.l3=-l3 4& set f2.l8=-l8 2
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f2.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame2% > "%TEMP%raw2.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw2.txt" -o "%TEMP%raw.metadata2.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%3.json" -s "%TEMP%raw.metadata2.json" -o "%TEMP%4.json" -l1 6 %f2.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%4.json" -s "%TEMP%raw.metadata2.json" -o "%TEMP%5.json" -l1 8 %f22.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%5.json" -s "%TEMP%raw.metadata2.json" -o "%TEMP%6.json" -l2 2 %f2.l8%
::third frame======================================================================================================
set f3.l3=& set f33.l3=& set f3.l8= 
if /i  "%cmv4.0%"=="y" set f3.l3=-l3 5& set f33.l3=-l3 6& set f3.l8=-l8 3
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f3.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame3% > "%TEMP%raw3.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw3.txt" -o "%TEMP%raw.metadata3.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%6.json" -s "%TEMP%raw.metadata3.json" -o "%TEMP%7.json" -l1 10 %f3.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%7.json" -s "%TEMP%raw.metadata3.json" -o "%TEMP%8.json" -l1 12 %f33.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%8.json" -s "%TEMP%raw.metadata3.json" -o "%TEMP%9.json" -l2 3 %f3.l8%
::fourth frame======================================================================================================
set f4.l3=& set f44.l3=& set f4.l8= 
if /i  "%cmv4.0%"=="y" set f4.l3=-l3 7& set f44.l3=-l3 8& set f4.l8=-l8 4
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f4.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame4% > "%TEMP%raw4.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw4.txt" -o "%TEMP%raw.metadata4.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%9.json" -s "%TEMP%raw.metadata4.json" -o "%TEMP%10.json" -l1 14 %f4.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%10.json" -s "%TEMP%raw.metadata4.json" -o "%TEMP%11.json" -l1 16 %f44.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%11.json" -s "%TEMP%raw.metadata4.json" -o "%TEMP%12.json" -l2 4 %f4.l8%
::fifth frame======================================================================================================
set f5.l3=& set f55.l3=& set f5.l8= 
if /i  "%cmv4.0%"=="y" set f5.l3=-l3 9& set f55.l3=-l3 10& set f5.l8=-l8 5
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f5.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame5% > "%TEMP%raw5.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw5.txt" -o "%TEMP%raw.metadata5.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%12.json" -s "%TEMP%raw.metadata5.json" -o "%TEMP%13.json" -l1 18 %f5.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%13.json" -s "%TEMP%raw.metadata5.json" -o "%TEMP%14.json" -l1 20 %f55.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%14.json" -s "%TEMP%raw.metadata5.json" -o "%TEMP%15.json" -l2 5 %f5.l8%
::Six frame======================================================================================================
set f6.l3=& set f66.l3=& set f6.l8= 
if /i  "%cmv4.0%"=="y" set f6.l3=-l3 11& set f66.l3=-l3 12& set f6.l8=-l8 6
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f6.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame6% > "%TEMP%raw6.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw6.txt" -o "%TEMP%raw.metadata6.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%15.json" -s "%TEMP%raw.metadata6.json" -o "%TEMP%16.json" -l1 22 %f6.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%16.json" -s "%TEMP%raw.metadata6.json" -o "%TEMP%17.json" -l1 24 %f66.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%17.json" -s "%TEMP%raw.metadata6.json" -o "%TEMP%18.json" -l2 6 %f6.l8%
::Seven frame======================================================================================================
set f7.l3=& set f77.l3=& set f7.l8= 
if /i  "%cmv4.0%"=="y" set f7.l3=-l3 13& set f77.l3=-l3 14& set f7.l8=-l8 7
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f7.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame7% > "%TEMP%raw7.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw7.txt" -o "%TEMP%raw.metadata7.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%18.json" -s "%TEMP%raw.metadata7.json" -o "%TEMP%19.json" -l1 26 %f7.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%19.json" -s "%TEMP%raw.metadata7.json" -o "%TEMP%20.json" -l1 28 %f77.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%20.json" -s "%TEMP%raw.metadata7.json" -o "%TEMP%21.json" -l2 7 %f7.l8%
::Eight frame======================================================================================================
set f8.l3=& set f88.l3=& set f8.l8= 
if /i  "%cmv4.0%"=="y" set f8.l3=-l3 15& set f88.l3=-l3 16& set f8.l8=-l8 8
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f8.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame8% > "%TEMP%raw8.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw8.txt" -o "%TEMP%raw.metadata8.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%21.json" -s "%TEMP%raw.metadata8.json" -o "%TEMP%22.json" -l1 30 %f8.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%22.json" -s "%TEMP%raw.metadata8.json" -o "%TEMP%23.json" -l1 32 %f88.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%23.json" -s "%TEMP%raw.metadata8.json" -o "%TEMP%24.json" -l2 8 %f8.l8%
::nine frame======================================================================================================
set f9.l3=& set f99.l3=& set f9.l8= 
if /i  "%cmv4.0%"=="y" set f9.l3=-l3 17& set f99.l3=-l3 18& set f9.l8=-l8 9
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f9.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame9% > "%TEMP%raw9.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw9.txt" -o "%TEMP%raw.metadata9.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%24.json" -s "%TEMP%raw.metadata9.json" -o "%TEMP%25.json" -l1 34 %f9.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%25.json" -s "%TEMP%raw.metadata9.json" -o "%TEMP%26.json" -l1 36 %f99.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%26.json" -s "%TEMP%raw.metadata9.json" -o "%TEMP%27.json" -l2 9 %f9.l8%
::ten frame======================================================================================================
set f10.l3=& set f100.l3=& set f10.l8= 
if /i  "%cmv4.0%"=="y" set f10.l3=-l3 19& set f100.l3=-l3 20& set f10.l8=-l8 10
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f10.l8=
"%dovi_tool_path%" info --input %RPU% -f %frame10% > "%TEMP%raw10.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw10.txt" -o "%TEMP%raw.metadata10.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%27.json" -s "%TEMP%raw.metadata10.json" -o "%TEMP%28.json" -l1 38 %f10.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%28.json" -s "%TEMP%raw.metadata10.json" -o "%TEMP%29.json" -l1 40 %f100.l3%
python "%~dp0tools\generate_sample.py" -t "%TEMP%29.json" -s "%TEMP%raw.metadata10.json" -o "%TEMP%metadata.RAW.json" -l2 10 %f10.l8%

::============================================================================================================================================================
:: =========================================Generate  and edit RPU=============================================================================================
::============================================================================================================================================================

"%dovi_tool_path%" generate -j "%TEMP%metadata.RAW.json" -o "%TEMP%Generated_metadata.bin" > nul
set RPU="%TEMP%Generated_metadata.bin"

:: source pq
     echo { > "%TEMP%sourcepq.json"
     echo 	"min_pq": %min_pq%, >> "%TEMP%sourcepq.json"
     echo 	"max_pq": %max_pq% >> "%TEMP%sourcepq.json"
     echo } >> "%TEMP%sourcepq.json"

     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%sourcepq.json" --rpu-out "%TEMP%RPU.SPQ.bin" > nul
	 set RPU="%TEMP%RPU.SPQ.bin"
	 
:: level 6
echo { > "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %max_mdl%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %min_mdl%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L6.json" --rpu-out "%TEMP%RPU-L6.bin" > nul
set RPU="%TEMP%RPU-L6.bin"
 	
:: level 9
if not "%cmv4.0%"=="y" goto :skipL9
	 echo { > "%TEMP%l9.json"
     echo "mode": 0, >> "%TEMP%l9.json"
     echo "level9": "%MDP.RPU%" >> "%TEMP%l9.json"
     echo } >> "%TEMP%l9.json"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%l9.json" --rpu-out "%TEMP%RPU-L9.bin" > nul
     set RPU="%TEMP%RPU-L9.bin"
	 
:skipL9

set L2.100=& set L2.600=& set L2.1000=
::remove trims not present in original
if /i "%t2.100%"=="y" if /i "%t2.600%"=="y" if /i "%t2.1000%"=="y" goto :skiptrimsremoval

if not "%t2.100%"=="y" set L2.100=,1
if not "%t2.600%"=="y" set L2.600=,27,28
if not "%t2.1000%"=="y" set L2.1000=,48,49

"%RPU.to.XML%" convert %RPU% "%TEMP%trimstoremove.xml" > nul
"%metafier_path%"  -o "%TEMP%trimsremoved.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% "%TEMP%trimstoremove.xml" > nul
"%dovi_tool_path%" generate --xml  "%TEMP%trimsremoved.xml" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%final.bin" > nul
set RPU="%TEMP%final.bin"

:skiptrimsremoval

set RPUenc=--dolby-vision-profile 8.1 --dolby-vision-rpu %RPU%

::============================================================================================================================================================
::----------------------------------------------------------L1 L3 L2 L8 OSD---------------------------------------------------------------------------------------------------------------------
::============================================================================================================================================================
 set maxpq=
 set avgpq=
 set twopass=n
 for /L %%n in (1,1,10) do (
 set MC%%n=
 set MF%%n=
 )

 :: L1 values for OSD
for /L %%n in (1,1,10) do (
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw%%n.txt"') do (
        set "maxpq=%%a"
    )
    for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !maxpq!') do set valueinnits=%%i
    set MC%%n=!valueinnits!
    
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw%%n.txt"') do (
        set "avgpq=%%a"
    )
    for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !avgpq!') do set valueinnits=%%i
    set MF%%n=!valueinnits!
)
:: L3 values for OSD
if "%cmv4.0%"=="y" (
    for /L %%n in (1,1,10) do (
        for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq_offset\":" "%TEMP%\raw%%n.txt"') do (
            set "L3maxpq%%n=%%a"
        )
        for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"min_pq_offset\":" "%TEMP%\raw%%n.txt"') do (
            set "L3minpq%%n=%%a"
        )
        for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq_offset\":" "%TEMP%\raw%%n.txt"') do (
            set "L3avgpq%%n=%%a"
        )
    )
)
::L8 values for OSD
if "%cmv4.0%"=="y" (
    for /L %%n in (1,1,10) do (
        for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"target_display_index\": 1" "%TEMP%\raw%%n.txt"') do (
            for /f "tokens=2 delims=:, " %%b in ('findstr /c:"\"trim_slope\":" "%TEMP%\raw%%n.txt"') do set "Level8_trim_slope%%n=%%b"
            for /f "tokens=2 delims=:, " %%b in ('findstr /c:"\"trim_offset\":" "%TEMP%\raw%%n.txt"') do set "Level8_trim_offset%%n=%%b"
            for /f "tokens=2 delims=:, " %%b in ('findstr /c:"\"trim_power\":" "%TEMP%\raw%%n.txt"') do set "Level8_trim_power%%n=%%b"
            for /f "tokens=2 delims=:, " %%b in ('findstr /c:"\"trim_chroma_weight\":" "%TEMP%\raw%%n.txt"') do set "Level8_trim_chroma_weight%%n=%%b"
            for /f "tokens=2 delims=:, " %%b in ('findstr /c:"\"trim_saturation_gain\":" "%TEMP%\raw%%n.txt"') do set "Level8_trim_saturation_gain%%n=%%b"
            for /f "tokens=2 delims=:, " %%b in ('findstr /c:"\"ms_weight\":" "%TEMP%\raw%%n.txt"') do set "Level8_ms_weight%%n=%%b"
        )
    )
)

:2ndpass.cmv29

if /i "%twopass%"=="y" (
     echo { > "%TEMP%CM4.json"
     echo 	"remove_cmv4": true >> "%TEMP%CM4.json"
     echo } >> "%TEMP%CM4.json"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%CM4.json" --rpu-out "%TEMP%cmv29.bin" > nul
	 set RPU="%TEMP%cmv29.bin"
	 set RPUenc=--dolby-vision-profile 8.1 --dolby-vision-rpu "%TEMP%cmv29.bin"
)

:: L2 values for OSD
if not "%cmv4.0%"=="y" (
    if "%t2.100%"=="y" (
        for /L %%n in (1,1,10) do (
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2081 -m slope 2^>nul') do set "Level21_trim_slope%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2081 -m offset 2^>nul') do set "Level21_trim_offset%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2081 -m power 2^>nul') do set "Level21_trim_power%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2081 -m chroma_weight 2^>nul') do set "Level21_trim_chroma_weight%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2081 -m saturation_gain 2^>nul') do set "Level21_trim_saturation_gain%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2081 -m ms_weight 2^>nul') do set "Level21_ms_weight%%n=%%a"
        )
    )
)

if not "%cmv4.0%"=="y" (
    if "%t2.600%"=="y" (
        for /L %%n in (1,1,10) do (
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2851 -m slope 2^>nul') do set "Level26_trim_slope%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2851 -m offset 2^>nul') do set "Level26_trim_offset%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2851 -m power 2^>nul') do set "Level26_trim_power%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2851 -m chroma_weight 2^>nul') do set "Level26_trim_chroma_weight%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2851 -m saturation_gain 2^>nul') do set "Level26_trim_saturation_gain%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 2851 -m ms_weight 2^>nul') do set "Level26_ms_weight%%n=%%a"
        )
    )
)
if not "%cmv4.0%"=="y" (
    if "%t2.1000%"=="y" (
        for /L %%n in (1,1,10) do (
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 3079 -m slope 2^>nul') do set "Level210_trim_slope%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 3079 -m offset 2^>nul') do set "Level210_trim_offset%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 3079 -m power 2^>nul') do set "Level210_trim_power%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 3079 -m chroma_weight 2^>nul') do set "Level210_trim_chroma_weight%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 3079 -m saturation_gain 2^>nul') do set "Level210_trim_saturation_gain%%n=%%a"
            for /f "delims=" %%a in ('python "%~dp0tools\find_trim_metadata.py" -s "%TEMP%\raw%%n.txt" -t 3079 -m ms_weight 2^>nul') do set "Level210_ms_weight%%n=%%a"
        )
    )
)

if "%twopass%"=="y" goto :skipmeasureagain
::============================================================================================================================================================
::---------------------------------------------------------- Actual measurements ---------------------------------------------------------------------------------------------
::============================================================================================================================================================
echo.
echo \033[92m Measuring frames MaxCLL/FALL of %filename1% | "%cmdcolor%"
echo.
set right=0& set left=0& set top=0& set bottom=0
type "%TEMP%singleframe.json" | findstr left > "%TEMP%left.json"
type "%TEMP%singleframe.json" | findstr right > "%TEMP%right.json"
type "%TEMP%singleframe.json" | findstr top > "%TEMP%top.json"
type "%TEMP%singleframe.json" | findstr bottom > "%TEMP%bottom.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"
set left2=%left%
set right2=%right%
set top2=%top%
set bottom2=%bottom%
if "%left%"==" =" set right=0& set left=0& set top=0& set bottom=0& set right2=0& set left2=0& set top2=0& set bottom2=0

::Check and adjust left if odd number
set /a "check=left2 %% 2"
if %check% equ 1 (
    set /a "left2+=1"
)

::Check and adjust right if odd number
set /a "check=right2 %% 2"
if %check% equ 1 (
    set /a "right2+=1"
)

::Check and adjust top if odd number
set /a "check=top2 %% 2"
if %check% equ 1 (
    set /a "top2+=1"
)

::Check and adjust bottom if odd number
set /a "check=bottom2 %% 2"
if %check% equ 1 (
    set /a "bottom2+=1"
)

for /L %%i in (1,1,10) do (
if not  "%subprofile%"=="FEL" echo LoadPlugin("%ffms2%"^) > "%TEMP%%%i_tomeas.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%DGDecodeNV.dll%"^) > "%TEMP%%%i_tomeas.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%DoViBaker%"^) >> "%TEMP%%%i_tomeas.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%%%i_tomeas.avs"
if "%v1%"=="p5" echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%%%i_tomeas.avs"
if "%v11%"=="HLG" echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%%%i_tomeas.avs"

if not  "%subprofile%"=="FEL" echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex"^)  >> "%TEMP%%%i_tomeas.avs"
if /i  "%subprofile%"=="FEL" echo bl = DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_tomeas.avs"
if /i  "%subprofile%"=="FEL" echo el = DGSource("%TEMP%EL.dgi"^) >> "%TEMP%%%i_tomeas.avs"
if /i  "%subprofile%"=="FEL" echo DoViBaker(bl, el, rpu="%TEMP%%filename1%_RPU_FEL.bin"^) >> "%TEMP%%%i_tomeas.avs"
if /i  "%subprofile%"=="FEL" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_tomeas.avs"

if not  "%subprofile%"=="FEL" if not "%v1%"=="p5" if not "%v11%"=="HLG" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%%%i_tomeas.avs"
if "%v1%"=="p5" echo ConvertBits(16^) >>  "%TEMP%%%i_tomeas.avs"
if "%v1%"=="p5" echo libplacebo_Tonemap(src_csp=3, dst_csp=1^) >> "%TEMP%%%i_tomeas.avs"
if "%v1%"=="p5" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:full=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%%%i_tomeas.avs"

if "%v11%"=="HLG" echo ConvertBits(16^) >>  "%TEMP%%%i_tomeas.avs"
if "%v11%"=="HLG" echo libplacebo_Tonemap(src_csp=2, dst_csp=1^) >> "%TEMP%%%i_tomeas.avs"
if "%v11%"=="HLG" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%%%i_tomeas.avs"
echo Crop(%right2%, %top2%, -%left2%, -%bottom2%^) >> "%TEMP%%%i_tomeas.avs"
echo trim(!frame%%i!,!frame%%i!^) >> "%TEMP%%%i_tomeas.avs"
)
echo.
for /L %%i in (1,1,10) do (
set MaxCLL%%i=
set MaxFALL%%i=
)

for /L %%i in (1,1,10) do (
    echo Measure Frame: !frame%%i! (%%i of 10^)
    "%ffmpeg_path%" -i "%TEMP%%%i_tomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%!frame%%i!_measure.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%!frame%%i!_measure.png"') do (
        if not defined MaxCLL%%i set "MaxCLL%%i=%%a"
        if defined MaxCLL%%i set "MaxFALL%%i=%%a"
    )
)

:skipmeasureagain

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------Script-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if not "%subprofile%"=="FEL" echo LoadPlugin("%ffms2%") > "%TEMP%script.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%DGDecodeNV.dll%") > "%TEMP%script.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%DoViBaker%") >> "%TEMP%script.avs"
if /i  "%subprofile%"=="FEL" echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs"
if "%v1%"=="p5" echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%TEMP%script.avs"
if "%v1%"=="p5" echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs"
if "%v11%"=="HLG" echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%TEMP%script.avs"
if "%v11%"=="HLG" echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs"

if not "%subprofile%"=="FEL" echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex") >> "%TEMP%script.avs"
if not "%subprofile%"=="FEL" echo video = FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex") >> "%TEMP%script.avs"

if /i  "%subprofile%"=="FEL" echo bl = DGSource("%TEMP%BL.dgi") >> "%TEMP%script.avs" 
if /i  "%subprofile%"=="FEL" echo el = DGSource("%TEMP%EL.dgi") >> "%TEMP%script.avs" 
if /i  "%subprofile%"=="FEL" echo DoViBaker(bl, el, rpu="%TEMP%%filename1%_RPU_FEL.bin") >> "%TEMP%script.avs"
if /i  "%subprofile%"=="FEL" echo video = DoViBaker(bl, el, rpu="%TEMP%%filename1%_RPU_FEL.bin") >> "%TEMP%script.avs"

if /i  "%rem_cmv4%"=="YES" set cmv4.0=n
Set L1dmversion=Level 1
set L2dmversion=L1 ^+ L2
if /i  "%cmv4.0%"=="y" Set L1dmversion=Level 1 ^+ Level 3
if /i  "%cmv4.0%"=="y" Set L2dmversion=L1 ^+ L2 ^+ L3 ^+ L8
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" if not "%t8.600%"=="y" if not "%t8.1000%"=="y" Set L2dmversion=L1 ^+ L2 ^+ L3 ^ NO L8 in source
if not  "%cmv4.0%"=="y" if not "%t2.100%"=="y" if not "%t2.600%"=="y" if not "%t2.1000%"=="y" set L2dmversion=L1 NO L2 in source
if not "%t2.100%"=="y" if not "%t2.600%"=="y" if not "%t2.1000%"=="y" if not "%t8.100%"=="y" if not "%t8.600%"=="y" if not "%t8.1000%"=="y" Set L2dmversion=L1 ^+ L3 ^ NO L8L2 in source

set slash=
set slash2=
set slash3=
set firstloop=69
set CMversion=CMv2.9
if "%v1%"=="p5" set firstloop=189
if /i  "%cmv4.0%"=="y" set CMversion=CMv4.0& set slash=\
if not "%cmv4.0%"=="y" if "%t2.100%"=="y" set slash=\
if not "%cmv4.0%"=="y" if "%t2.100%"=="y" if "%t2.600%"=="y" set slash2=\
if not "%cmv4.0%"=="y" if "%t2.100%"=="y" if "%t2.1000%"=="y" set slash2=\
if not "%cmv4.0%"=="y" if "%t2.100%"=="y" if "%t2.600%"=="y" if "%t2.1000%"=="y" set slash3=\

::======================================================================================================================================================================

if not "%v1%"=="p5" echo black_frames = BlankClip(video, length=120)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("%filename1% - DV RPU %CMversion% Mastering Display Luminance= %max_mdl%nits", size=60, align=5, x=1860, y=650, text_color=$3366CC)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("The first 69 frames are displayed without tone mapping and clipping will be visible if the content exceed your TV capabilities...", size=60, align=5, x=1860, y=750, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("The next 69 frames feature only Level 1 metadata... This metadata is auto-generated by Dolby.", size=60, align=5, x=1860, y=850, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("The following 69 frames are again shown without tone mapping...", size=60, align=5, x=1860, y=950, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("The final 69 frames include Level 1 + Level 2 or 8 Artistic Trims (original)... Additionnal manual adjustements by the colorist", size=60, align=5, x=1860, y=1050, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("Level 8 and Level 3 requires a CMv4.0 Player & TV... Will fallback to the CMv2.9 metadata (L1-L2) otherwise.", size=60, align=5, x=1860, y=1150, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
if not "%v1%"=="p5" echo              .Subtitle("Created with DoVi_Scripts @RESET_9999", size=60, align=5, x=1860, y=1280, text_color=$FFFFFF)  >> "%TEMP%script.avs"

::======================================================================================================================================================================

echo v12 = video.Trim(%frame1%, %frame1%).Loop(%firstloop%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL1%nits / %MaxFALL1%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC1%nits / %MF1%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope1%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset1%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power1%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight1%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain1%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight1%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope1%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset1%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power1%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight1%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain1%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight1%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq1%/%L3maxpq1%/%L3avgpq1%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

::======================================================================================================================================================================
echo v13 = video.Trim(%frame1%, %frame1%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL1%nits / %MaxFALL1%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC1%nits / %MF1%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope1%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset1%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power1%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight1%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain1%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight1%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope1%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset1%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power1%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight1%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain1%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight1%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq1%/%L3maxpq1%/%L3avgpq1%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v14 = video.Trim(%frame1%, %frame1%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL1%nits / %MaxFALL1%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC1%nits / %MF1%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope1%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset1%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power1%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight1%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain1%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight1%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope1%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset1%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power1%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight1%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain1%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight1%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq1%/%L3maxpq1%/%L3avgpq1%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v15 = video.Trim(%frame1%, %frame1%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL1%nits / %MaxFALL1%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC1%nits / %MF1%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope1%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset1%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power1%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight1%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain1%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight1%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope1%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset1%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power1%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight1%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain1%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight1%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq1%/%L3maxpq1%/%L3avgpq1%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope1%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset1%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power1%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight1%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain1%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight1%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v21 = video.Trim(%frame2%, %frame2%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL2%nits / %MaxFALL2%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC2%nits / %MF2%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope2%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset2%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power2%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight2%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain2%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight2%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope2%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset2%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power2%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight2%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain2%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight2%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq2%/%L3maxpq2%/%L3avgpq2%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v22 = video.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL2%nits / %MaxFALL2%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC2%nits / %MF2%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope2%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset2%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power2%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight2%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain2%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight2%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope2%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset2%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power2%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight2%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain2%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight2%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq2%/%L3maxpq2%/%L3avgpq2%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v23 = video.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL2%nits / %MaxFALL2%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC2%nits / %MF2%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope2%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset2%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power2%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight2%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain2%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight2%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope2%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset2%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power2%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight2%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain2%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight2%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq2%/%L3maxpq2%/%L3avgpq2%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v24 = video.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL2%nits / %MaxFALL2%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC2%nits / %MF2%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope2%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset2%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power2%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight2%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain2%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight2%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope2%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset2%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power2%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight2%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain2%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight2%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq2%/%L3maxpq2%/%L3avgpq2%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v25 = video.Trim(%frame2%, %frame2%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL2%nits / %MaxFALL2%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC2%nits / %MF2%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope2%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset2%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power2%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight2%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain2%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight2%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope2%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset2%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power2%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight2%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain2%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight2%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq2%/%L3maxpq2%/%L3avgpq2%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope2%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset2%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power2%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight2%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain2%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight2%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v31 = video.Trim(%frame3%, %frame3%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL3%nits / %MaxFALL3%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC3%nits / %MF3%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope3%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset3%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power3%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight3%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain3%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight3%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope3%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset3%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power3%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight3%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain3%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight3%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq3%/%L3maxpq3%/%L3avgpq3%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v32 = video.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL3%nits / %MaxFALL3%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC3%nits / %MF3%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope3%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset3%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power3%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight3%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain3%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight3%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope3%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset3%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power3%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight3%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain3%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight3%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq3%/%L3maxpq3%/%L3avgpq3%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v33 = video.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL3%nits / %MaxFALL3%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC3%nits / %MF3%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope3%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset3%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power3%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight3%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain3%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight3%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope3%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset3%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power3%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight3%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain3%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight3%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq3%/%L3maxpq3%/%L3avgpq3%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v34 = video.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL3%nits / %MaxFALL3%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC3%nits / %MF3%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope3%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset3%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power3%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight3%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain3%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight3%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope3%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset3%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power3%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight3%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain3%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight3%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq3%/%L3maxpq3%/%L3avgpq3%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v35 = video.Trim(%frame3%, %frame3%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL3%nits / %MaxFALL3%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC3%nits / %MF3%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope3%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset3%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power3%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight3%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain3%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight3%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope3%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset3%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power3%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight3%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain3%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight3%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq3%/%L3maxpq3%/%L3avgpq3%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope3%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset3%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power3%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight3%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain3%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight3%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v41 = video.Trim(%frame4%, %frame4%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL4%nits / %MaxFALL4%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC4%nits / %MF4%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope4%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset4%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power4%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight4%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain4%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight4%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope4%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset4%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power4%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight4%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain4%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight4%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq4%/%L3maxpq4%/%L3avgpq4%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v42 = video.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL4%nits / %MaxFALL4%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC4%nits / %MF4%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope4%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset4%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power4%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight4%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain4%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight4%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope4%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset4%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power4%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight4%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain4%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight4%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq4%/%L3maxpq4%/%L3avgpq4%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v43 = video.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL4%nits / %MaxFALL4%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC4%nits / %MF4%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"

if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope4%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset4%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power4%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight4%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain4%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight4%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope4%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset4%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power4%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight4%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain4%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight4%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq4%/%L3maxpq4%/%L3avgpq4%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v44 = video.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL4%nits / %MaxFALL4%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC4%nits / %MF4%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"

if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope4%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset4%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power4%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight4%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain4%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight4%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope4%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset4%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power4%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight4%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain4%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight4%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq4%/%L3maxpq4%/%L3avgpq4%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v45 = video.Trim(%frame4%, %frame4%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL4%nits / %MaxFALL4%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC4%nits / %MF4%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"

if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope4%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset4%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power4%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight4%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain4%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight4%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope4%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset4%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power4%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight4%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain4%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight4%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq4%/%L3maxpq4%/%L3avgpq4%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope4%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset4%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power4%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight4%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain4%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight4%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v51 = video.Trim(%frame5%, %frame5%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL5%nits / %MaxFALL5%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC5%nits / %MF5%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"

if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope5%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset5%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power5%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight5%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain5%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight5%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope5%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset5%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power5%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight5%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain5%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight5%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq5%/%L3maxpq5%/%L3avgpq5%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v52 = video.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL5%nits / %MaxFALL5%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC5%nits / %MF5%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope5%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset5%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power5%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight5%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain5%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight5%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope5%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset5%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power5%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight5%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain5%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight5%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq5%/%L3maxpq5%/%L3avgpq5%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v53 = video.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL5%nits / %MaxFALL5%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC5%nits / %MF5%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope5%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset5%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power5%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight5%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain5%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight5%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope5%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset5%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power5%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight5%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain5%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight5%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq5%/%L3maxpq5%/%L3avgpq5%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v54 = video.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL5%nits / %MaxFALL5%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC5%nits / %MF5%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope5%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset5%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power5%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight5%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain5%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight5%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope5%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset5%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power5%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight5%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain5%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight5%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq5%/%L3maxpq5%/%L3avgpq5%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v55 = video.Trim(%frame5%, %frame5%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL5%nits / %MaxFALL5%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC5%nits / %MF5%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope5%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset5%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power5%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight5%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain5%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight5%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope5%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset5%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power5%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight5%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain5%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight5%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq5%/%L3maxpq5%/%L3avgpq5%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope5%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset5%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power5%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight5%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain5%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight5%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v61 = video.Trim(%frame6%, %frame6%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL6%nits / %MaxFALL6%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC6%nits / %MF6%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope6%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset6%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power6%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight6%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain6%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight6%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope6%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset6%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power6%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight6%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain6%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight6%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq6%/%L3maxpq6%/%L3avgpq6%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v62 = video.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL6%nits / %MaxFALL6%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC6%nits / %MF6%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope6%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset6%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power6%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight6%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain6%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight6%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope6%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset6%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power6%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight6%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain6%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight6%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq6%/%L3maxpq6%/%L3avgpq6%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v63 = video.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL6%nits / %MaxFALL6%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC6%nits / %MF6%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope6%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset6%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power6%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight6%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain6%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight6%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope6%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset6%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power6%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight6%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain6%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight6%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq6%/%L3maxpq6%/%L3avgpq6%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v64 = video.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL6%nits / %MaxFALL6%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC6%nits / %MF6%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope6%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset6%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power6%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight6%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain6%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight6%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope6%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset6%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power6%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight6%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain6%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight6%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq6%/%L3maxpq6%/%L3avgpq6%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v65 = video.Trim(%frame6%, %frame6%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL6%nits / %MaxFALL6%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC6%nits / %MF6%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope6%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset6%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power6%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight6%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain6%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight6%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope6%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset6%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power6%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight6%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain6%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight6%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq6%/%L3maxpq6%/%L3avgpq6%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope6%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset6%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power6%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight6%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain6%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight6%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v71 = video.Trim(%frame7%, %frame7%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL7%nits / %MaxFALL7%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC7%nits / %MF7%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope7%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset7%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power7%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight7%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain7%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight7%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope7%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset7%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power7%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight7%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain7%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight7%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq7%/%L3maxpq7%/%L3avgpq7%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v72 = video.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL7%nits / %MaxFALL7%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC7%nits / %MF7%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope7%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset7%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power7%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight7%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain7%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight7%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope7%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset7%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power7%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight7%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain7%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight7%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq7%/%L3maxpq7%/%L3avgpq7%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v73 = video.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL7%nits / %MaxFALL7%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC7%nits / %MF7%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope7%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset7%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power7%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight7%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain7%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight7%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope7%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset7%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power7%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight7%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain7%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight7%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq7%/%L3maxpq7%/%L3avgpq7%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v74 = video.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL7%nits / %MaxFALL7%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC7%nits / %MF7%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope7%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset7%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power7%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight7%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain7%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight7%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope7%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset7%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power7%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight7%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain7%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight7%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq7%/%L3maxpq7%/%L3avgpq7%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v75 = video.Trim(%frame7%, %frame7%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL7%nits / %MaxFALL7%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC7%nits / %MF7%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope7%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset7%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power7%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight7%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain7%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight7%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope7%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset7%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power7%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight7%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain7%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight7%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq7%/%L3maxpq7%/%L3avgpq7%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope7%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset7%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power7%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight7%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain7%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight7%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v81 = video.Trim(%frame8%, %frame8%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL8%nits / %MaxFALL8%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC8%nits / %MF8%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope8%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset8%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power8%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight8%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain8%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight8%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope8%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset8%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power8%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight8%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain8%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight8%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq8%/%L3maxpq8%/%L3avgpq8%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v82 = video.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL8%nits / %MaxFALL8%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC8%nits / %MF8%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope8%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset8%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power8%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight8%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain8%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight8%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope8%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset8%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power8%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight8%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain8%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight8%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq8%/%L3maxpq8%/%L3avgpq8%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v83 = video.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL8%nits / %MaxFALL8%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC8%nits / %MF8%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope8%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset8%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power8%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight8%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain8%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight8%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope8%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset8%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power8%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight8%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain8%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight8%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq8%/%L3maxpq8%/%L3avgpq8%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v84 = video.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL8%nits / %MaxFALL8%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC8%nits / %MF8%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope8%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset8%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power8%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight8%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain8%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight8%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope8%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset8%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power8%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight8%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain8%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight8%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq8%/%L3maxpq8%/%L3avgpq8%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v85 = video.Trim(%frame8%, %frame8%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL8%nits / %MaxFALL8%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC8%nits / %MF8%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope8%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset8%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power8%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight8%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain8%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight8%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope8%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset8%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power8%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight8%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain8%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight8%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq8%/%L3maxpq8%/%L3avgpq8%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope8%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset8%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power8%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight8%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain8%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight8%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v91 = video.Trim(%frame9%, %frame9%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL9%nits / %MaxFALL9%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC9%nits / %MF9%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope9%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset9%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power9%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight9%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain9%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight9%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope9%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset9%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power9%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight9%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain9%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight9%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq9%/%L3maxpq9%/%L3avgpq9%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v92 = video.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL9%nits / %MaxFALL9%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC9%nits / %MF9%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope9%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset9%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power9%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight9%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain9%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight9%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope9%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset9%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power9%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight9%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain9%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight9%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq9%/%L3maxpq9%/%L3avgpq9%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v93 = video.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL9%nits / %MaxFALL9%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC9%nits / %MF9%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope9%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset9%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power9%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight9%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain9%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight9%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope9%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset9%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power9%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight9%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain9%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight9%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq9%/%L3maxpq9%/%L3avgpq9%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v94 = video.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL9%nits / %MaxFALL9%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC9%nits / %MF9%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope9%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset9%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power9%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight9%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain9%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight9%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope9%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset9%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power9%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight9%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain9%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight9%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq9%/%L3maxpq9%/%L3avgpq9%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v95 = video.Trim(%frame9%, %frame9%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL9%nits / %MaxFALL9%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC9%nits / %MF9%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope9%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset9%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power9%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight9%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain9%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight9%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope9%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset9%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power9%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight9%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain9%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight9%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq9%/%L3maxpq9%/%L3avgpq9%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope9%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset9%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power9%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight9%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain9%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight9%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v101 = video.Trim(%frame10%, %frame10%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL10%nits / %MaxFALL10%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC10%nits / %MF10%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope10%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset10%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power10%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight10%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain10%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight10%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope10%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset10%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power10%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight10%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain10%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight10%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq10%/%L3maxpq10%/%L3avgpq10%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v102 = video.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L1dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(min-max-avg)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL10%nits / %MaxFALL10%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC10%nits / %MF10%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope10%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset10%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power10%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight10%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain10%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight10%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope10%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset10%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power10%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight10%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain10%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight10%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq10%/%L3maxpq10%/%L3avgpq10%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v103 = video.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL10%nits / %MaxFALL10%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC10%nits / %MF10%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope10%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset10%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power10%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight10%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain10%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight10%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope10%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset10%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power10%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight10%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain10%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight10%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq10%/%L3maxpq10%/%L3avgpq10%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v104 = video.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("%L2dmversion%", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Artistic Trim)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL10%nits / %MaxFALL10%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC10%nits / %MF10%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope10%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset10%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power10%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight10%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain10%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight10%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope10%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset10%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power10%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight10%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain10%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight10%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq10%/%L3maxpq10%/%L3avgpq10%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v105 = video.Trim(%frame10%, %frame10%).Loop(60)\  >> "%TEMP%script.avs"
echo           .Subtitle("No Metadata", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(L1 min, no trims)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=40, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=40, align=7, x=40, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements MAX/AVG:  %MaxCLL10%nits / %MaxFALL10%nits", size=40, align=7, x=40, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU L1 Frame MAX/AVG:  %MC10%nits / %MF10%nits", size=40, align=7, x=40, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"


if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 100nits: Slope:%Level21_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level21_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level21_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level21_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level21_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.100%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level21_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)%slash2%  >> "%TEMP%script.avs"

if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 600nits: Slope:%Level26_trim_slope10%", size=40, align=7, x=3020, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level26_trim_offset10%", size=40, align=7, x=3020, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level26_trim_power10%", size=40, align=7, x=3020, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level26_trim_chroma_weight10%", size=40, align=7, x=3020, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level26_trim_saturation_gain10%", size=40, align=7, x=3020, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.600%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level26_ms_weight10%", size=40, align=7, x=3020, y=240, text_color=%osdcolor%)%slash3%  >> "%TEMP%script.avs"

if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("L2 1000nits: Slope:%Level210_trim_slope10%", size=40, align=7, x=2580, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level210_trim_offset10%", size=40, align=7, x=2580, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level210_trim_power10%", size=40, align=7, x=2580, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level210_trim_chroma_weight10%", size=40, align=7, x=2580, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level210_trim_saturation_gain10%", size=40, align=7, x=2580, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%t2.1000%"=="y" if not "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level210_ms_weight10%", size=40, align=7, x=2580, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

if "%cmv4.0%"=="y" echo           .Subtitle("Level 3 MIN/MAX/AVG:  %L3minpq10%/%L3maxpq10%/%L3avgpq10%", size=40, align=7, x=40, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("L8 100nits: Slope:%Level8_trim_slope10%", size=40, align=7, x=3420, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Offset:%Level8_trim_offset10%", size=40, align=7, x=3420, y=60, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Power:%Level8_trim_power10%", size=40, align=7, x=3420, y=105, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Chroma Weight:%Level8_trim_chroma_weight10%", size=40, align=7, x=3420, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("Saturation:%Level8_trim_saturation_gain10%", size=40, align=7, x=3420, y=195, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
if "%cmv4.0%"=="y" echo           .Subtitle("MS Weight:%Level8_ms_weight10%", size=40, align=7, x=3420, y=240, text_color=%osdcolor%)  >> "%TEMP%script.avs"

set blfr=black_frames +
if "%v1%"=="p5" set blfr=
echo %blfr% v12 + v13 + v14 + v15 + v21 + v22 + v23 + v24 + v25 + v31 + v32 + v33 + v34 + v35 + v41 + v42 + v43 + v44 + v45 + v51 + v52 + v53 + v54 + v55 + v61 + v62 + v63 + v64 + v65 + v71 + v72 + v73 + v74 + v75 + v81 + v82 + v83 + v84 + v85 + v91 + v92 + v93 + v94 + v95 + v101 + v102 + v103 + v104 + v105 >> "%TEMP%script.avs"

if "%v1%"=="p5" echo ConvertBits(16) >> "%TEMP%script.avs"
if "%v1%"=="p5" echo libplacebo_Tonemap(src_csp=3, dst_csp=1) >> "%TEMP%script.avs"
if "%v1%"=="p5" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"
if "%v11%"=="HLG" echo ConvertBits(16) >> "%TEMP%script.avs"
if "%v11%"=="HLG" echo libplacebo_Tonemap(src_csp=2, dst_csp=1) >> "%TEMP%script.avs"
if "%v11%"=="HLG" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:limited=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"
if /i  "%subprofile%"=="FEL" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="rgb:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"

::======================================================================================================================================================================
::-------------------------------------------------------------------------------ENCODE--------------------------------------------------------------------------------------------------
::======================================================================================================================================================================
set container=MP4

::x265
echo on
"%x265_path%" --preset %x265x264_speed% --crf %x265x264_CRF% %X265_HDR_settings% %static_metadata% %RPUenc% --input "%TEMP%script.avs" --output "%output_path%%filename1%.hevc"
echo off
set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1

:skipx265

::======================================================================================================================================================================
::-------------------------------------------------------------------------------MUX------------------------------------------------------------------------------------------------------
::======================================================================================================================================================================

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
if "%FPS%"=="23.974" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.975" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.979" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.978" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.977" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.976" set FPS=24000/1001p& set properfps=y
if "%FPS%"=="24.000" set FPS=24p& set properfps=y
if "%FPS%"=="25.000" set FPS=25p& set properfps=y
if "%FPS%"=="29.970" set FPS=30000/1001p& set properfps=y
if "%FPS%"=="30.000" set FPS=30p& set properfps=y
if "%FPS%"=="50.000" set FPS=50p& set properfps=y
if "%FPS%"=="59.940" set FPS=60000/1001p& set properfps=y
if "%FPS%"=="60.000" set FPS=60p& set properfps=y
if "%properfps%"=="n" set FPS=24000/1001p

if /i "%container%"=="MKV" "%mkvmerge_path%" --output ^"%output_path%%filename1%__ DV_Metadata_Levels_Comparison_%CMversion%%FEL_BAKED%.mkv^" %mkvtoolnix_settings% --default-duration 0:%FPS% ^"^(^" ^"%output_path%%filename1%.hevc^" ^"^)^" & del "%output_path%%filename1%.hevc"

if /i "%container%"=="MP4" if /i "%mp4_version%"=="NEW" "%mp4box2_path%" -add "%output_path%%filename1%.hevc":name=%MBOX%:fps=%FPS% -tmp "%TEMP:~0,-1%" -brand mp43isom -ab dby1 "%output_path%%filename1%_ DV_Metadata_Levels_Comparison_%CMversion%%FEL_BAKED%.mp4" & del "%output_path%%filename1%.hevc"

if /i "%container%"=="MP4" if /i "%mp4_version%"=="OLD" "%mp4muxer_path%" --dv-profile %dv.profile% --dv-bl-compatible-id %ID% --input-file "%output_path%%filename1%.hevc" --output-file "%output_path%%filename1%_ DV_Metadata_Levels_Comparison_%CMversion%%FEL_BAKED%.mp4" & del "%output_path%%filename1%.hevc"

if not "%container%"=="TS" goto :skipTS

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr  --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%output_path%%filename1%.hevc", fps=%FPS%>> "%TEMP%1.meta"
"%tsmuxer_path%" "%TEMP%1.meta" "%output_path%%filename1%_ DV_Metadata_Levels_Comparison_%CMversion%%FEL_BAKED%.ts"
if ["%errorlevel%"]==["0"] del "%output_path%%filename1%.hevc"

:skipTS
if /i  "%two.sample%"=="YES" if /i  "%cmv4.0%"=="y" set twopass=y& set cmv4.0=n& goto :2ndpass.cmv29
set twopass=n

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set p7_bl=& set p5_bl=& set dropH=& set mlp=& set dts=& set pcm.au=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set trims=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set dv.profile=
set final.vid=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=
set upal2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :LOOP.metadata.SAMPLES
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.5

echo.
echo.
echo \033[36m          ============================ | "%cmdcolor%"
echo \033[36m          - DoVi_FEL_BL_COMPARISONS - | "%cmdcolor%"
echo \033[36m          ============================ | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- Creates a DV FEL vs BL comparison video of 10 frames
echo -- Like this: https://drive.google.com/drive/u/1/folders/1100OWrD7m9K9V4etEEpxILImias9GGKR
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
if not exist "%~dp0tools\generate_sample_template_cmv29.json" echo "%~dp0tools\generate_sample_template_cmv29.json" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\generate_sample_template_cmv40.json" echo "%~dp0tools\generate_sample_template_cmv40.json" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\generate_sample.py" echo "%~dp0tools\generate_sample.py" is missing... update your tool folder...& pause & exit
if not exist "%~dp0tools\metafier.exe" echo \033[31m metafier.exe is missing from the tools folder, download it here: https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools| "%cmdcolor%"& pause & exit

echo Drag and drop a P7 FEL DoVi file or a folder with files and press enter...
set /p video_path=

:skipsample
cd /d "%output_path%"
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %video_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
set singlefileinput=n
if [%fileext1%]==[] (
     for %%i in (!video_path!) do set filename1=%%~ni
     for %%i in (!video_path!) do set filepath1=%%~di%%~pi
     for %%i in (!video_path!) do set fileext1=%%~xi
	 set singlefileinput=y
)

if /i "%same_input_output%"=="YES" set output_path=%filepath1%

if /i "%singlefileinput%"=="n" (
        set mode=a& set quickmode=q& set frame1=2000& set frame2=5000& set frame3=10000& set frame4=15000& set frame5=20000& set frame6=25000& set frame7=27000& set frame8=23000& set frame9=17000& set frame10=7500
        goto :LOOP.FELBL.SAMPLES
)

echo.
echo Manual(m) or Auto(a) mode^? (default= a)
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p mode=
if "%mode%"=="" set mode=a
if /i "%mode%"=="M" set mode=m
if /i "%mode%"=="manual" set mode=m
if /i "%mode%"=="auto" set mode=a
if  not "%mode%"=="m" if not "%mode%"=="a" set mode=a

if /i "%mode%"=="a" set quickmode=q& set frame1=2000& set frame2=5000& set frame3=10000& set frame4=15000& set frame5=20000& set frame6=25000& set frame7=27000& set frame8=23000& set frame9=17000& set frame10=7500& goto :LOOP.FELBL.SAMPLES

echo   Quick(q) or Full(f) mode^? (default= q)
echo.
echo --^> FULL= f 
echo --^> QUICK= q
set /p quickmode=
if [%quickmode%]==[] set quickmode=q
if /i "%quickmode%"=="f" set quickmode=f
if /i "%quickmode%"=="q" set quickmode=q
if /i "%quickmode%"=="quick" set quickmode=q
if /i "%quickmode%"=="full" set quickmode=f
if not "%quickmode%"=="q" if not "%quickmode%"=="f" set quickmode=q
echo.

echo ^*Default = 10 frames from 1000 - 10 000
Setlocal EnableDelayedExpansion
for /L %%i in (1,1,10) do (
    echo Enter frame %%i of 10:
	set /p frame%%i=
)

for /L %%i in (1,1,10) do (
    if "!frame%%i!"=="" set "frame%%i=%%i000"
)

::=========================================================================================================================================================================================================================================================

:LOOP.FELBL.SAMPLES

echo.
echo Processing %filename1%...
echo.
if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" echo Invalid extension, skipping "%filename1%%fileext1%"... & goto :skipTS

:: make and set temp folder
if exist "%temp_folder%temp.folder76" rmdir /Q /S "%temp_folder%temp.folder76"
MD "%temp_folder%temp.folder76"
set TEMP=%temp_folder%temp.folder76\

if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, workflow not supported...& pause & exit
:nvidiacheck
::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------check input 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::set variables to 0
set v1=& set v11=
set subprofile=MEL
set video.count=
set FrameCount=

:: check input colorspace
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%FrameCount.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.c.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.c.txt"

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MasteringDisplay_Luminance%% --LogFile="%TEMP%MDL.txt" >Nul
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2

::P7
findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set v11=p7
if "%video.count%"=="2" set v11=p7

::------------------------FEL V1---------------------------------------------------------------------------------------------------

if not "%v11%"=="p7" echo Input is not profile 7, skipping file... & goto :skipTS

:: check framecount and frame to export mismatch
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo4.JSON"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo4.JSON" > "%TEMP%FrameCount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount.txt"') do (
    set "FrameCount=%%a"
)
set FrameCount=%FrameCount:"=%

if %FrameCount% leq %frame1% set /a frame1=%FrameCount%-100
if %FrameCount% leq %frame2% set /a frame2=%FrameCount%-200
if %FrameCount% leq %frame3% set /a frame3=%FrameCount%-300
if %FrameCount% leq %frame4% set /a frame4=%FrameCount%-400
if %FrameCount% leq %frame5% set /a frame5=%FrameCount%-500
if %FrameCount% leq %frame6% set /a frame6=%FrameCount%-600
if %FrameCount% leq %frame7% set /a frame7=%FrameCount%-700
if %FrameCount% leq %frame8% set /a frame8=%FrameCount%-800
if %FrameCount% leq %frame9% set /a frame9=%FrameCount%-900
if %FrameCount% leq %frame10% set /a frame10=%FrameCount%-1000

if not "%quickmode%"=="q" goto :skipsample
if %FrameCount% leq 29000 goto :skipsample

echo.
echo Quick mode: making a 19min sample to speed up demuxing and RPU processing...
echo.
"%mkvmerge_path%" --output ^"%TEMP%%filename1%.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^" --split parts:00:00:00-00:19:00 > Nul
set video_path="%TEMP%%filename1%.mkv"
echo Done.
set filepath1=%TEMP%
set fileext1=.mkv

:skipsample

::check for FEL input 1
"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^")^" --split parts:00:00:00-00:00:10 > Nul
"%mkvextract_path%" "%TEMP%1.mkv" tracks 0:"%TEMP%temp.vid.hevc" > Nul
"%dovi_tool_path%" -m 0 extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" >Nul
"%dovi_tool_path%" info --input "%TEMP%chunk.RPU.bin" -f 48 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"

findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 echo Input is not FEL... & pause & exit

:skipP7.1

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:: V1 Indexing--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo2.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo2.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
::FEL
if /i  "%subprofile%"=="MEL" echo Input is MEL, skipping file... & goto :skipTS
set FEL_BAKED=BL_FEL_Merged
set T1.ID=4113& set T2.ID=4117
if /i "%fileext1%"==".mkv" set T1.ID=1& set T2.ID=2
if /i "%fileext1%"==".mp4" set T1.ID=1& set T2.ID=2
if not "%video.count%"=="2" goto :skip2vid
         echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --demux --vbv-len=500 > "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", track=%T1.ID% >> "%TEMP%1.meta"
         echo V_MPEGH/ISO/HEVC, "%filepath1%%filename1%%fileext1%", insertSEI, contSPS, track=%T2.ID% >> "%TEMP%1.meta"
         "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"
		 set BL="%TEMP%%filename1%.track_%T1.ID%.hevc"& set EL="%TEMP%%filename1%.track_%T2.ID%.hevc"
		 goto :indexdg
:skip2vid

cd /d "%TEMP%"
"%ffmpeg_path%" -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc -loglevel error -stats - | "%dovi_tool_path%" demux -
cd /d "%output_path%"
set BL="%TEMP%BL.hevc"& set EL="%TEMP%EL.hevc"

:indexdg
"%dovi_tool_path%" extract-rpu %EL% -o "%TEMP%%filename1%_RPU_FEL.bin"
set RPU="%TEMP%%filename1%_RPU_FEL.bin"

if /i  "%subprofile2%"=="FEL" rename "%TEMP%BL.hevc" "BL1.hevc" & rename "%TEMP%EL.hevc" "EL1.hevc" & set BL="%TEMP%BL1.hevc"& set EL="%TEMP%EL1.hevc" 
	 
     ::index with dg
	 echo Indexing the HDR10 base layer...
	 "%DGIndexNV_path%" -i %BL% -o "%TEMP%BL.dgi" -h -a
	 echo Done.
	 echo.
	 echo Indexing the DV 12bits enhancement layer...
	 "%DGIndexNV_path%" -i %EL% -o "%TEMP%EL.dgi" -h -a
	 echo Done.
	 
 "%ffmsindex%" "%filepath1%%filename1%%fileext1%" -f "%TEMP%1.ffindex"

::--------------------------------------------------RPU info------------------------------------------------------------------------------------------------------------

"%dovi_tool_path%" export -i %RPU% -o "%TEMP%full.json" > Nul
"%dovi_tool_path%" info -s %RPU% > "%TEMP%rpu.info.txt"
"%dovi_tool_path%" info --input %RPU% -f 100 > "%TEMP%singleframe.json"

set t2.100=&set L2t100=&set t2.600=&set L2t600=&set t2.1000=&set L2t1000=&set t8.100=&set L8t100=&set t8.600=&set L8t600=&set t8.1000=&set L8t1000=
set level9=& set cmv4.0=& set MDP.RPU=
set max_pq=3079
set min_pq=7
set min_mdl=1
set max_mdl=1000

type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"
findstr /c:"100 nits" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.100=y& set L2t100=L2 100nits
findstr /c:"600" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.600=y& set L2t600=, 600nits
findstr /c:"1000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.1000=y& set L2t1000=, 1000nits

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.100=y& set L8t100=- L8 100nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.600=y& set L8t600=, 600nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.1000=y& set L8t1000=, 1000nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.600=y& set L8t600=, 600nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.1000=y& set L8t1000=, 1000nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=DCIP3D65
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=BT2020
if /i  "%rem_cmv4%"=="YES" set cmv4.0=n

type "%TEMP%singleframe.json" | findstr source_min_pq > "%TEMP%min_pq.json"
type "%TEMP%singleframe.json" | findstr source_max_pq > "%TEMP%max_pq.json"

findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=3079& set max_mdl=1000
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=3388& set max_mdl=2000
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=3696& set max_mdl=4000
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4095& set max_mdl=10000
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=7& set min_mdl=1
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=62& set min_mdl=50
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=38& set min_mdl=20
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0& set min_mdl=1

::-------------------------------------------------static metadata--------------------------------------------------------------------------------------------

set MDP=G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)& set maxcll_path=0& set maxfall_path=0& set MDL.min_path=7& set MDL.max_path=1000
type "%TEMP%mediainfo.JSON" | findstr MasteringDisplay_ColorPrimaries > "%TEMP%MCP.txt"
findstr /c:"BT.2020" "%TEMP%MCP.txt" >Nul
if %errorlevel%==0 set MDP=G(8500,39850)B(6550,2300)R(35400,14600)WP(15635,16450)

type "%TEMP%rpu.info.txt" | findstr L1 > "%TEMP%L1.txt"
for /f "tokens=4 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=6 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxfall_path=%%a"
)
set maxcll_path=%maxcll_path: =%
set maxfall_path=%maxfall_path: =%
if "%maxcll_path%"==" =" set maxcll_path=0
if "%maxfall_path%"==" =" set maxfall_path=0
if "%maxcll_path%"=="" set maxcll_path=0
if "%maxfall_path%"=="" set maxfall_path=0

set static_metadata=--master-display "%MDP%L(%max_mdl%0000,%min_mdl%)" --max-cll "%maxcll_path%,%maxfall_path%"

::---------------------------------------------------generate metadata--------------------------------------------------------------------------------------------
echo.
if /i "%t8.600%"=="y" set cmv4.0=n& echo WARNING... Input with 600nits L8 trim not supported yet and might never be... Will discard cmv4.0...
if /i "%t8.1000%"=="y" set cmv4.0=n& echo WARNING... Input with 1000nits L8 trim not supported yet and might never be... Will discard cmv4.0...
echo.

set template="%~dp0tools\generate_sample_template_FEL_BL_cmv29.json"
if /i  "%cmv4.0%"=="y" set template="%~dp0tools\generate_sample_template_FEL_BL_cmv40.json"

::1st frame======================================================================================================
set f1.l3=& set f11.l3=& set f1.l8= 
if /i  "%cmv4.0%"=="y" set f1.l3=-l3 1& set f1.l8=-l8 1
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f1.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame1% > "%TEMP%raw1.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw1.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t %template% -s "%TEMP%raw.metadata.json" -o "%TEMP%1.json" -l1 1 -l2 1 %f1.l3% %f1.l8%

::2nd frame======================================================================================================
set f2.l3=& set f21.l3=& set f2.l8= 
if /i  "%cmv4.0%"=="y" set f2.l3=-l3 2& set f2.l8=-l8 2
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f2.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame2% > "%TEMP%raw2.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw2.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%1.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%2.json" -l1 2 -l2 2 %f2.l3% %f2.l8%
::3rd frame======================================================================================================
set f3.l3=& set f31.l3=& set f3.l8= 
if /i  "%cmv4.0%"=="y" set f3.l3=-l3 3& set f3.l8=-l8 3
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f3.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame3% > "%TEMP%raw3.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw3.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%2.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%3.json" -l1 3 -l2 3 %f3.l3% %f3.l8%
::4 frame======================================================================================================
set f4.l3=& set f41.l3=& set f4.l8= 
if /i  "%cmv4.0%"=="y" set f4.l3=-l3 4& set f4.l8=-l8 4
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f4.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame4% > "%TEMP%raw4.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw4.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%3.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%4.json" -l1 4 -l2 4 %f4.l3% %f4.l8%
::5 frame======================================================================================================
set f5.l3=& set f51.l3=& set f5.l8= 
if /i  "%cmv4.0%"=="y" set f5.l3=-l3 5& set f5.l8=-l8 5
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f5.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame5% > "%TEMP%raw5.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw5.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%4.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%5.json" -l1 5 -l2 5 %f5.l3% %f5.l8%
::6 frame======================================================================================================
set f6.l3=& set f61.l3=& set f6.l8= 
if /i  "%cmv4.0%"=="y" set f6.l3=-l3 6& set f6.l8=-l8 6
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f6.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame6% > "%TEMP%raw6.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw6.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%5.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%6.json" -l1 6 -l2 6 %f6.l3% %f6.l8%
::7 frame======================================================================================================
set f7.l3=& set f71.l3=& set f7.l8= 
if /i  "%cmv4.0%"=="y" set f7.l3=-l3 7& set f7.l8=-l8 7
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f7.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame7% > "%TEMP%raw7.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw7.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%6.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%7.json" -l1 7 -l2 7 %f7.l3% %f7.l8%
::8 frame======================================================================================================
set f8.l3=& set f81.l3=& set f8.l8= 
if /i  "%cmv4.0%"=="y" set f8.l3=-l3 8& set f8.l8=-l8 8
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f8.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame8% > "%TEMP%raw8.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw8.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%7.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%8.json" -l1 8 -l2 8 %f8.l3% %f8.l8%
::9 frame======================================================================================================
set f9.l3=& set f91.l3=& set f9.l8= 
if /i  "%cmv4.0%"=="y" set f9.l3=-l3 9& set f9.l8=-l8 9
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f9.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame9% > "%TEMP%raw9.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw9.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%8.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%9.json" -l1 9 -l2 9 %f9.l3% %f9.l8%
::10 frame======================================================================================================
set f10.l3=& set f101.l3=& set f10.l8= 
if /i  "%cmv4.0%"=="y" set f10.l3=-l3 10& set f10.l8=-l8 10
if /i  "%cmv4.0%"=="y" if not "%t8.100%"=="y" set f10.l8=

"%dovi_tool_path%" info --input %RPU% -f %frame10% > "%TEMP%raw10.txt"
python "%~dp0tools\merge.data.py" -i "%TEMP%raw10.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t "%TEMP%9.json" -s "%TEMP%raw.metadata.json" -o "%TEMP%metadata.RAW.final.json" -l1 10 -l2 10 %f10.l3% %f10.l8%

::============================================================================================================================================================
:: =========================================Generate  and edit RPU=============================================================================================
::============================================================================================================================================================

"%dovi_tool_nofloor%" generate -j "%TEMP%metadata.RAW.final.json" -o "%TEMP%Generated_metadata.bin" > nul
set RPU="%TEMP%Generated_metadata.bin"

:: source pq
     echo { > "%TEMP%sourcepq.json"
     echo 	"min_pq": %min_pq%, >> "%TEMP%sourcepq.json"
     echo 	"max_pq": %max_pq% >> "%TEMP%sourcepq.json"
     echo } >> "%TEMP%sourcepq.json"

     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%sourcepq.json" --rpu-out "%TEMP%RPU.SPQ.bin" > nul
	 set RPU="%TEMP%RPU.SPQ.bin"
	 
:: level 6
echo { > "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %max_mdl%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %min_mdl%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"
"%dovi_tool_path%" editor -i %RPU% -j "%TEMP%L6.json" --rpu-out "%TEMP%RPU-L6.bin" > nul
set RPU="%TEMP%RPU-L6.bin"
 	
:: level 9
if not "%cmv4.0%"=="y" goto :skipL9
	 echo { > "%TEMP%l9.json"
     echo "mode": 0, >> "%TEMP%l9.json"
     echo "level9": "%MDP.RPU%" >> "%TEMP%l9.json"
     echo } >> "%TEMP%l9.json"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%l9.json" --rpu-out "%TEMP%RPU-L9.bin" > nul
     set RPU="%TEMP%RPU-L9.bin"
	 
:skipL9

::remove trims not present in original
if /i "%t2.100%"=="y" if /i "%t2.600%"=="y" if /i "%t2.1000%"=="y" goto :skiptrimsremoval

set L2.100=& set L2.600=& set L2.1000=
if not "%t2.100%"=="y" set L2.100=,1
if not "%t2.600%"=="y" set L2.600=,27,28
if not "%t2.1000%"=="y" set L2.1000=,48,49

"%RPU.to.XML%" convert %RPU% "%TEMP%trimstoremove.xml" > nul
"%metafier_path%"  -o "%TEMP%trimsremoved.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% "%TEMP%trimstoremove.xml" > nul
"%dovi_tool_path%" generate --xml  "%TEMP%trimsremoved.xml" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%final.bin" > nul
set RPU="%TEMP%final.bin"

:skiptrimsremoval

set RPUenc=--dolby-vision-profile 8.1 --dolby-vision-rpu %RPU%

::============================================================================================================================================================
::----------------------------------------------------------maxcll fall  Level 1 --------------------------------------------------------------------------------------------------
::============================================================================================================================================================
 set maxpq=
 set avgpq=
 for /L %%n in (1,1,10) do (
 set MC%%n=
 set MF%%n=
 )
 
for /L %%n in (1,1,10) do (
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw%%n.txt"') do (
        set "maxpq=%%a"
    )
    for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !maxpq!') do set valueinnits=%%i
    set MC%%n=!valueinnits!
    
    for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw%%n.txt"') do (
        set "avgpq=%%a"
    )
    for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq !avgpq!') do set valueinnits=%%i
    set MF%%n=!valueinnits!
)

::============================================================================================================================================================
::---------------------------------------------------------- Actual measurements ---------------------------------------------------------------------------------------------
::============================================================================================================================================================
set right=0& set left=0& set top=0& set bottom=0
type "%TEMP%singleframe.json" | findstr left > "%TEMP%left.json"
type "%TEMP%singleframe.json" | findstr right > "%TEMP%right.json"
type "%TEMP%singleframe.json" | findstr top > "%TEMP%top.json"
type "%TEMP%singleframe.json" | findstr bottom > "%TEMP%bottom.json"

for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom=%%a"
)
set "left=%left: =%"
set "right=%right: =%"
set "top=%top: =%"
set "bottom=%bottom: =%"
set left2=%left%
set right2=%right%
set top2=%top%
set bottom2=%bottom%
if "%left%"==" =" set right=0& set left=0& set top=0& set bottom=0& set right2=0& set left2=0& set top2=0& set bottom2=0

::Check and adjust left if odd number
set /a "check=left2 %% 2"
if %check% equ 1 (
    set /a "left2+=1"
)

::Check and adjust right if odd number
set /a "check=right2 %% 2"
if %check% equ 1 (
    set /a "right2+=1"
)

::Check and adjust top if odd number
set /a "check=top2 %% 2"
if %check% equ 1 (
    set /a "top2+=1"
)

::Check and adjust bottom if odd number
set /a "check=bottom2 %% 2"
if %check% equ 1 (
    set /a "bottom2+=1"
)

for /L %%i in (1,1,10) do (
     echo LoadPlugin("%DoViBaker%"^) > "%TEMP%%%i_FELtomeas.avs"
	 echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%%%i_FELtomeas.avs"
     echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i_FELtomeas.avs"
     echo bl = DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_FELtomeas.avs"
     echo el = DGSource("%TEMP%EL.dgi"^) >> "%TEMP%%%i_FELtomeas.avs"
    echo DoViBaker(bl, el, rpu= "%TEMP%%filename1%_RPU_FEL.bin"^) >> "%TEMP%%%i_FELtomeas.avs"
    echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_FELtomeas.avs"
	 echo Crop(%right2%, %top2%, -%left2%, -%bottom2%^) >> "%TEMP%%%i_FELtomeas.avs"
	 echo trim(!frame%%i!,!frame%%i!^) >> "%TEMP%%%i_FELtomeas.avs"
)
::BL
for /L %%i in (1,1,10) do (
     echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) > "%TEMP%%%i_BLtomeas.avs"
     echo LoadPlugin("%DGDecodeNV.dll%"^) >> "%TEMP%%%i_BLtomeas.avs"
     echo DGSource("%TEMP%BL.dgi"^) >> "%TEMP%%%i_BLtomeas.avs"
     echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%%%i_BLtomeas.avs"
	 echo Crop(%right2%, %top2%, -%left2%, -%bottom2%^) >> "%TEMP%%%i_BLtomeas.avs"
	 echo trim(!frame%%i!,!frame%%i!^) >> "%TEMP%%%i_BLtomeas.avs"

)
echo.
for /L %%i in (1,1,10) do (
set MaxCLL%%i=
set MaxFALL%%i=
set MaxCLLBL%%i=
set MaxFALLBL%%i=
)

:: measure FEL frames to export
for /L %%i in (1,1,10) do (
    echo Measure FEL Frame: !frame%%i!
    "%ffmpeg_path%" -i "%TEMP%%%i_FELtomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%!frame%%i!_FEL.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%!frame%%i!_FEL.png"') do (
        if not defined MaxCLL%%i set "MaxCLL%%i=%%a"
        if defined MaxCLL%%i set "MaxFALL%%i=%%a"
    )
)
echo.
:: measure BL frames to export
for /L %%i in (1,1,10) do (
    echo Measure BL Frame: !frame%%i!
    "%ffmpeg_path%" -i "%TEMP%%%i_BLtomeas.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%!frame%%i!_BL.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%!frame%%i!_BL.png"') do (
        if not defined MaxCLLBL%%i set "MaxCLLBL%%i=%%a"
        if defined MaxCLLBL%%i set "MaxFALLBL%%i=%%a"
    )
)

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------Script----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

echo LoadPlugin("%DGDecodeNV.dll%") > "%TEMP%script.avs"
echo LoadPlugin("%DoViBaker%") >> "%TEMP%script.avs"
echo LoadPlugin("%ffms2%"^) >> "%TEMP%script.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs"

echo FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex")  >> "%TEMP%script.avs" 
echo video2 = FFVideoSource("%filepath1%%filename1%%fileext1%", cachefile="%TEMP%1.ffindex") >> "%TEMP%script.avs"
echo bl = DGSource("%TEMP%BL.dgi") >> "%TEMP%script.avs" 
echo el = DGSource("%TEMP%EL.dgi") >> "%TEMP%script.avs" 
echo DoViBaker(bl, el, rpu="%TEMP%%filename1%_RPU_FEL.bin") >> "%TEMP%script.avs"
echo video = DoViBaker(bl, el, rpu="%TEMP%%filename1%_RPU_FEL.bin") >> "%TEMP%script.avs"
echo video = z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="rgb:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"

set CMversion=CMv2.9
if /i  "%cmv4.0%"=="y" set CMversion=CMv4.0
::======================================================================================================================================================================::======================================================================================================================================================================
echo black_frames = BlankClip(video, length=120)\  >> "%TEMP%script.avs"
echo              .Subtitle("%filename1% - FEL DV RPU %CMversion% Mastering Display Luminance= %max_mdl%nits", size=60, align=5, x=1860, y=650, text_color=$3366CC)\  >> "%TEMP%script.avs"
echo              .Subtitle("The first 69 frames are the HDR10 base layer with the RPU...", size=60, align=5, x=1860, y=750, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
echo              .Subtitle("The next 69 frames are the FEL and HDR10 base layer merged together with the RPU... ", size=60, align=5, x=1860, y=850, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
echo              .Subtitle("The OSD will show you the RPU Level 1 MAX/AVG values as well as the actual measurements of the frame...", size=60, align=5, x=1860, y=950, text_color=$FFFFFF)\  >> "%TEMP%script.avs"
echo              .Subtitle("Created with DoVi_Scripts @RESET_9999", size=60, align=5, x=1860, y=1100, text_color=$FFFFFF)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v13 = video.Trim(%frame1%, %frame1%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC1%nits / %MF1%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL1%nits / %MaxFALL1%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v14 = video2.Trim(%frame1%, %frame1%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC1%nits / %MF1%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL1%nits / %MaxFALLBL1%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v15 = video.Trim(%frame1%, %frame1%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame1%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC1%nits / %MF1%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL1%nits / %MaxFALL1%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"

::======================================================================================================================================================================::======================================================================================================================================================================
echo v21 = video2.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC2%nits / %MF2%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL2%nits / %MaxFALLBL2%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v22 = video.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC2%nits / %MF2%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL2%nits / %MaxFALL2%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v23 = video2.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC2%nits / %MF2%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL2%nits / %MaxFALLBL2%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v24 = video.Trim(%frame2%, %frame2%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame2%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC2%nits / %MF2%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL2%nits / %MaxFALL2%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"

::======================================================================================================================================================================::======================================================================================================================================================================
echo v31 = video2.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC3%nits / %MF3%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL3%nits / %MaxFALLBL3%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v32 = video.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC3%nits / %MF3%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL3%nits / %MaxFALL3%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v33 = video2.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC3%nits / %MF3%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL3%nits / %MaxFALLBL3%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v34 = video.Trim(%frame3%, %frame3%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame3%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC3%nits / %MF3%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL3%nits / %MaxFALL3%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"

::======================================================================================================================================================================::======================================================================================================================================================================
echo v41 = video2.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC4%nits / %MF4%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL4%nits / %MaxFALLBL4%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v42 = video.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC4%nits / %MF4%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL4%nits / %MaxFALL4%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v43 = video2.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC4%nits / %MF4%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL4%nits / %MaxFALLBL4%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v44 = video.Trim(%frame4%, %frame4%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame4%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC4%nits / %MF4%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL4%nits / %MaxFALL4%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================::======================================================================================================================================================================

echo v51 = video2.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC5%nits / %MF5%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL5%nits / %MaxFALLBL5%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v52 = video.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC5%nits / %MF5%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL5%nits / %MaxFALL5%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v53 = video2.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC5%nits / %MF5%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL5%nits / %MaxFALLBL5%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v54 = video.Trim(%frame5%, %frame5%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame5%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC5%nits / %MF5%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL5%nits / %MaxFALL5%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================::======================================================================================================================================================================

echo v61 = video2.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC6%nits / %MF6%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL6%nits / %MaxFALLBL6%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v62 = video.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC6%nits / %MF6%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL6%nits / %MaxFALL6%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v63 = video2.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC6%nits / %MF6%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL6%nits / %MaxFALLBL6%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v64 = video.Trim(%frame6%, %frame6%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame6%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC6%nits / %MF6%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL6%nits / %MaxFALL6%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================::======================================================================================================================================================================

echo v71 = video2.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC7%nits / %MF7%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL7%nits / %MaxFALLBL7%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v72 = video.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC7%nits / %MF7%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL7%nits / %MaxFALL7%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v73 = video2.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC7%nits / %MF7%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL7%nits / %MaxFALLBL7%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v74 = video.Trim(%frame7%, %frame7%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame7%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC7%nits / %MF7%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL7%nits / %MaxFALL7%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================::======================================================================================================================================================================

echo v81 = video2.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC8%nits / %MF8%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL8%nits / %MaxFALLBL8%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v82 = video.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC8%nits / %MF8%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL8%nits / %MaxFALL8%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v83 = video2.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC8%nits / %MF8%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL8%nits / %MaxFALLBL8%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v84 = video.Trim(%frame8%, %frame8%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame8%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC8%nits / %MF8%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL8%nits / %MaxFALL8%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================::======================================================================================================================================================================

echo v91 = video2.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC9%nits / %MF9%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL9%nits / %MaxFALLBL9%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v92 = video.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC9%nits / %MF9%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL9%nits / %MaxFALL9%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v93 = video2.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC9%nits / %MF9%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL9%nits / %MaxFALLBL9%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v94 = video.Trim(%frame9%, %frame9%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame9%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC9%nits / %MF9%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL9%nits / %MaxFALL9%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================::======================================================================================================================================================================

echo v101 = video2.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC10%nits / %MF10%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL10%nits / %MaxFALLBL10%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v102 = video.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC10%nits / %MF10%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL10%nits / %MaxFALL10%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v103 = video2.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(HDR10)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC10%nits / %MF10%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLLBL10%nits / %MaxFALLBL10%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"
::======================================================================================================================================================================
echo v104 = video.Trim(%frame10%, %frame10%).Loop(69)\  >> "%TEMP%script.avs"
echo           .Subtitle("BL + FEL + RPU", size=140, align=5, x=1860, y=150, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("(Full Enhancement)", size=80, align=5, x=1860, y=210, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("%filename1% %FEL_BAKED%", size=50, align=7, x=40, y=15, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Frame: %frame10%", size=50, align=7, x=40, y=65, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Trims: %L2t100% %L2t600% %L2t1000% %L8t100% %L8t600% %L8t1000%", size=50, align=7, x=40, y=115, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("RPU Level 1 frame max/avg:  %MC10%nits / %MF10%nits", size=50, align=7, x=40, y=165, text_color=%osdcolor%)\  >> "%TEMP%script.avs"
echo           .Subtitle("Measurements max/avg:  %MaxCLL10%nits / %MaxFALL10%nits", size=50, align=7, x=40, y=210, text_color=%osdcolor%)  >> "%TEMP%script.avs"

echo black_frames + v13 + v14 + v15 + v21 + v22 + v23 + v24 + v31 + v32 + v33 + v34 + v41 + v42 + v43 + v44 + v51 + v52 + v53 + v54 + v61 + v62 + v63 + v64 + v71 + v72 + v73 + v74 + v81 + v82 + v83 + v84 + v91 + v92 + v93 + v94 + v101 + v102 + v103 + v104 >> "%TEMP%script.avs"

::======================================================================================================================================================================
::-------------------------------------------------------------------------------ENCODE--------------------------------------------------------------------------------------------------
::======================================================================================================================================================================
set container=MP4

echo on
"%x265_path%" --preset %x265x264_speed% --crf %x265x264_CRF% %X265_HDR_settings% %static_metadata% %RPUenc% --input "%TEMP%script.avs" --output "%output_path%%filename1%.hevc"
echo off

:skipx265
::======================================================================================================================================================================
::-------------------------------------------------------------------------------MUX------------------------------------------------------------------------------------------------------
::======================================================================================================================================================================

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
if "%FPS%"=="23.974" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.975" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.979" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.978" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.977" set FPS=24000/1001p& set properfps=n
if "%FPS%"=="23.976" set FPS=24000/1001p& set properfps=y
if "%FPS%"=="24.000" set FPS=24p& set properfps=y
if "%FPS%"=="25.000" set FPS=25p& set properfps=y
if "%FPS%"=="29.970" set FPS=30000/1001p& set properfps=y
if "%FPS%"=="30.000" set FPS=30p& set properfps=y
if "%FPS%"=="50.000" set FPS=50p& set properfps=y
if "%FPS%"=="59.940" set FPS=60000/1001p& set properfps=y
if "%FPS%"=="60.000" set FPS=60p& set properfps=y
if "%properfps%"=="n" set FPS=24000/1001p

if /i "%container%"=="MKV" "%mkvmerge_path%" --output ^"%output_path%%filename1%_FEL_BL_Comparison.mkv^" %mkvtoolnix_settings% --default-duration 0:%FPS% ^"^(^" ^"%output_path%%filename1%.hevc^" ^"^)^" & del "%output_path%%filename1%.hevc"

if /i "%container%"=="MP4" if /i "%mp4_version%"=="NEW" "%mp4box2_path%" -add "%output_path%%filename1%.hevc":name=:hdr=none:dvp=8.1:fps=%FPS% -tmp "%TEMP:~0,-1%" -brand mp43isom -ab dby1 "%output_path%%filename1%_FEL_BL_Comparison.mp4" & del "%output_path%%filename1%.hevc"

if /i "%container%"=="MP4" if /i "%mp4_version%"=="OLD" "%mp4muxer_path%" --dv-profile 8 --dv-bl-compatible-id 1 --input-file "%output_path%%filename1%.hevc" --output-file "%output_path%%filename1%_FEL_BL_Comparison.mp4" & del "%output_path%%filename1%.hevc"

if not "%container%"=="TS" goto :skipTS

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr  --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%output_path%%filename1%.hevc", fps=%FPS%>> "%TEMP%1.meta"
"%tsmuxer_path%" "%TEMP%1.meta" "%output_path%%filename1%_DV_Comparison.ts"
if ["%errorlevel%"]==["0"] del "%output_path%%filename1%.hevc"

:skipTS

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set p7_bl=& set p5_bl=& set dropH=& set mlp=& set dts=& set pcm.au=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set trims=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set dv.profile=
set final.vid=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=
set upal2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=

for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :LOOP.FELBL.SAMPLES
)
setlocal disabledelayedexpansion

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo \033[92mThe script has been completed...| "%cmdcolor%"
pause
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:Workflow.6
::scene cut and frame extractor
echo.
echo ----------------------------------------------
echo -- Export scene cuts frame or all the frames
echo -- Require Python. Quite slow
echo ----------------------------------------------
echo.
::user input
echo   Drag and drop a video file and press enter...& set /p video=
echo.
echo   Export all the frames(f) or just try to detect the scene cut(s) (f or s default=f)& set /p type=
if "%type%"=="" set type=f

::split input path and filename into variables
Setlocal EnableDelayedExpansion
for %%i in (!video!) do set filename=%%~ni
for %%i in (!video!) do set filepath=%%~di%%~pi
for %%i in (!video!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

if /i "%same_input_output%"=="YES" set output_path=%filepath%

:: make and set temp folder
if exist "%temp_folder%temp.folder28_new" rmdir /Q /S "%temp_folder%temp.folder28_new"
if exist "%temp_folder%temp.folder28" set E1=_new
MD "%temp_folder%temp.folder28%E1%"
set TEMP=%temp_folder%temp.folder28%E1%\

:: index
echo %filename%
"%ffmsindex%" "%filepath%%filename%%fileext%" -f "%output_path%\%filename%\%filename%.ffindex"

:: export frames
if /i "%type%"=="f" "%ffmpeg_path%" -i "%filepath%%filename%%fileext%" "%output_path%%filename%\%%04d_%filename%.jpg" & goto :end
:: export scene cut frames
if /i "%type%"=="s" "%scenedetect_path%" --input "%filepath%%filename%%fileext%" detect-adaptive save-images -m 0 -p -c 0 -n 2 -f $FRAME_NUMBER-v1 --output "%output_path%%filename%" list-scenes --output "%output_path%%filename%" > "%output_path%%filename%_scene_cuts.txt"

:end
::make indexed avs file for avspmod
echo LoadPlugin("%ffms2%"^) >  "%output_path%\%filename%\%filename%_script.avs"
echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%output_path%\%filename%\%filename%.ffindex"^) >> "%output_path%\%filename%\%filename%_script.avs"

::start avspmod
start "" "%AvsPmod_path%" "%output_path%%filename%\%filename%_script.avs"

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ---------------------------------------------------------MPV MPC-HC player-----------------------------------------------------------------------------------------------------------------------------------------
:Workflow.7

echo.
echo \033[36m       ====================== | "%cmdcolor%"
echo \033[36m       -   SELECT A MODE    - | "%cmdcolor%"
echo \033[36m       ====================== | "%cmdcolor%"
echo. 
echo -----------------------------------------------------------------------------------------
echo -- MPV: can play FEL P5-DV / HDR10 / HLG  in PQ or SDR
echo -- MPV: Press "s" to export lossless screenshots. 
echo -- MadVR ^+ MPC-HC: can play fel and profile 5 video
echo -- MadVR ^+ MPC-HC: Press "f5" to export lossless screenshots. 
echo -- I'm not sure if this will work if your pc doesnt have a GPU
echo -----------------------------------------------------------------------------------------
echo.
echo 1) MODE.PQ= MPV Play HDR10/DV/HLG ^in PQ (HDR10)
echo 2) MODE.AUTO= MPV Play HDR10/DV/HLG ^in SDR
echo 3) MODE.FEL= MadVR ^+ MPC-HC play FEL DV
echo 4) MODE.P5= MadVR ^+ MPC-HC play Profile 5 DV
echo 5) MODE.5= Back to main menu 
echo.
choice /C:12345 /M Choice?
if ERRORLEVEL 5 (
goto :Main.Menu
)

if ERRORLEVEL 4 (
goto :MODE.P5
)

if ERRORLEVEL 3 (
goto :MODE.FEL
)

if ERRORLEVEL 2 (
goto :MODE.AUTO
)

if ERRORLEVEL 1 (
goto :MODE.PQ
)

:MODE.PQ
:againxxx

echo   Drag and drop an HDR10/DV MKV/MP4/TS file and press enter...& set /p input=
Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

"%MPV_path%" --target-trc=pq --target-prim=bt.2020 --vo=gpu-next --gpu-context=d3d11 --screenshot-format=png --screenshot-png-compression=1 --screenshot-directory=%output_path% --screenshot-template="%filename%" "%filepath%%filename%%fileext%"
goto :againxxx

::##################################################################################################################################################################################################

:MODE.AUTO
:againqqq
echo   Drag and drop a video file and press enter...& set /p input=

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi

Setlocal DisableDelayedExpansion
"%MPV_path%" --target-trc=auto --target-prim=auto --vo=gpu-next --gpu-context=d3d11 --screenshot-format=png --screenshot-png-compression=1 --screenshot-directory=%output_path% --screenshot-template="%filename%" "%filepath%%filename%%fileext%"
goto :againqqq

::##################################################################################################################################################################################################

:MODE.FEL

echo   Drag and drop a video file and press enter...& set /p input=

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

:: make and set temp folder
if exist "%temp_folder%temp.folder29_new" rmdir /Q /S "%temp_folder%temp.folder29_new"
if exist "%temp_folder%temp.folder29" set E1=_new
MD "%temp_folder%temp.folder29%E1%"
set TEMP=%temp_folder%temp.folder29%E1%\

::workaround for input with )
set oldfilename=%filename%
set newfilename=%filename:)=%
rename "%filepath%%filename%%fileext%" "%newfilename%%fileext%"
set filename=%newfilename%

MD "%output_path%\%filename%\"
:: find the track count and set a variable for the loops
"%mkvmerge_path%" -i "%filepath%%filename%%fileext%" > "%TEMP%input.track.count.txt"

for /f %%i in ('python "%~dp0tools\trackcount.py" -i "%TEMP%input.track.count.txt"') do set count=%%i

:: export input mediainfo
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"

MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul

:: check format/language/forced/delay/channels
echo \033[92mReading input tracks format/id/language...| "%cmdcolor%"
for /L %%i in (1,1,%count%) do (
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Format "%TEMP%mediainfo.JSON"`) do set T%%i.Format=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].ID "%TEMP%mediainfo.JSON"`) do set T%%i.ID=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Language "%TEMP%mediainfo.JSON"`) do set T%%i.Lang=%%~a
)
::check for dual track dual layer p7 input
for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[0].VideoCount "%TEMP%mediainfo.JSON"`) do set video.count=%%~a
rmdir /Q /S  "%letterpath%\JQ\" > nul
echo Done.

Setlocal EnableDelayedExpansion
for /L %%i in (1,1,%count%) do ( 
     if /i "%fileext%"==".mkv" if "!T%%i.Format!"=="MLP FBA" set T%%i.Format=A_MLP
	 if not "%fileext%"==".mkv" if "!T%%i.Format!"=="MLP FBA" set T%%i.Format=A_AC3
	 if "!T%%i.Format!"=="DTS" set T%%i.Format=A_DTS
	 if "!T%%i.Format!"=="PCM" set T%%i.Format=A_LPCM
	 if "!T%%i.Format!"=="LPCM" set T%%i.Format=A_LPCM
	 if "!T%%i.Format!"=="E-AC-3" set T%%i.Format=A_AC3
	 if "!T%%i.Format!"=="AC-3" set T%%i.Format=A_AC3
	 if "!T%%i.Format!"=="AAC" set T%%i.Format=A_AAC
)

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "fps=%%a"
)

::check for dual track dual layer p7 input
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[0].VideoCount "%TEMP%mediainfo.JSON" > "%TEMP%video.count.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%video.count.txt"') do (
    set "video.count=%%a"
)
set video.count=%video.count:~1,-1%
if "%video.count%"=="3" set video.count=2

echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=%T1.ID% >> "%TEMP%1.meta"
if "%video.count%"=="2" echo V_MPEGH/ISO/HEVC, "%filepath%%filename%%fileext%", track=%T2.ID% >> "%TEMP%1.meta"
for /L %%i in (2,1,%count%) do ( 
     if not "!T%%i.Format!"=="HEVC" if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.Format!"=="UTF-8" if not "!T%%i.Format!"=="PGS" echo !T%%i.Format!, "%filepath%%filename%%fileext%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath%%filename%%fileext%",fps=%fps%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
)
"%tsmuxer_path%" "%TEMP%1.meta" "%output_path%\%filename%\"

for %%F in ("%output_path%\%filename%\*.track*") do (
    set "name=%%~nF"
    set "extension=%%~xF"
   
    rem Check if the file contains ".track"
    echo !name! | find ".track" > nul
    if !errorlevel! equ 0 (
        rem Check if the file has a ".hevc" extension
        echo !extension! | find ".hevc" > nul
        if not !errorlevel! equ 0 (
            rem Rename the file
            set "new_name=!name:.track=_FEL_transfer=hdr.matrix=2020.track!"
            ren "%%F" "!new_name!!extension!"
        )
    )
)

Setlocal DisableDelayedExpansion

if "%video.count%"=="2" (
     set HDR="%output_path%\%filename%\%filename%.track_%T1.ID%.hevc"
	 set DV="%output_path%\%filename%\%filename%.track_%ID2%.hevc"
	 goto :DGindex
)

cd "%output_path%\%filename%\"
"%dovi_tool_path%" demux -i "%output_path%\%filename%\%filename%.track_%T1.ID%.hevc"
set HDR="%output_path%\%filename%\BL.hevc"
set DV="%output_path%\%filename%\EL.hevc"
del "%output_path%%filename%\%filename%.track_%T1.ID%.hevc"

cd "%output_path%"

:: Index bl el 
:DGindex
if /i "%force_ffms2%"=="YES" (
     echo \033[92m Indexing the HDR10 base layer... | "%cmdcolor%"
     "%ffmsindex%" %HDR% "%output_path%\%filename%\%filename%_BL.ffindex"
	 echo \033[92m Indexing the DV 12bits enhancement layer...
     "%ffmsindex%" %DV% "%output_path%\%filename%\%filename%_EL.ffindex"
     ) ELSE (
	 echo \033[92m Indexing the HDR10 base layer... | "%cmdcolor%"
	 "%DGIndexNV_path%" -i %HDR% -o "%output_path%\%filename%\%filename%_BL.dgi" -h -a
	 echo Done.
	 echo \033[92m Indexing the DV 12bits enhancement layer... | "%cmdcolor%"
	 "%DGIndexNV_path%" -i %DV% -o "%output_path%\%filename%\%filename%_EL.dgi" -h -a
	 echo Done.
     )
)

::extract FEL
echo \033[92m Extracting the RPU... | "%cmdcolor%"
"%dovi_tool_path%" extract-rpu %DV% -o "%output_path%\%filename%\%filename%_RPU_FEL.bin"

::---------------------------------------------------------------------------------------FEL-------------------------------------------------------------------------------------------

:: Make a FEL script dgdecodeNV
echo LoadPlugin("%DoViBaker%") > "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%") >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="NO" echo bl = DGSource("%output_path%\%filename%\%filename%_BL.dgi") >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="NO" echo el = DGSource("%output_path%\%filename%\%filename%_EL.dgi") >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%")  >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="YES" echo bl = FFVideoSource(%HDR%, cachefile="%output_path%\%filename%\%filename%_BL.ffindex")  >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="YES" echo el = FFVideoSource(%DV%, cachefile="%output_path%\%filename%\%filename%_EL.ffindex")  >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs" 

echo SetFilterMTMode("DoViBaker",2)  >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="YES" echo DoViBaker(bl, el) >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
if /i "%force_ffms2%"=="NO" echo DoViBaker(bl, el, rpu= "%output_path%\%filename%\%filename%_RPU_FEL.bin") >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
echo ConvertToYUV420(matrix="2020") >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
echo ConvertBits(10) >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"
echo %Prefetch% >> "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs"

set DelayedSelfDeleteCommand="timeout /t 5 >NUL &&
"%MPC_path%" "%output_path%\%filename%\%filename%_FEL_transfer=hdr.matrix=2020.avs" >NUL

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
pause & goto :MODE.FEL

::##################################################################################################################################################################################################

:MODE.P5

echo   Drag and drop a video file and press enter...& set /p input=

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi

:: make and set temp folder
if exist "%temp_folder%temp.folder30_new" rmdir /Q /S "%temp_folder%temp.folder30_new"
if exist "%temp_folder%temp.folder30" set E1=_new
MD "%temp_folder%temp.folder30%E1%"
set TEMP=%temp_folder%temp.folder30%E1%\

MD "%output_path%\%filename%\"

:: find the track count and set a variable for the loops
"%mkvmerge_path%" -i "%filepath%%filename%%fileext%" > "%TEMP%input.track.count.txt"

for /f %%i in ('python "%~dp0tools\trackcount.py" -i "%TEMP%input.track.count.txt"') do set count=%%i
if "%count%"=="0" set count=20
if "%count%"=="" set count=20
:: export input mediainfo
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"

MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul

:: check format/language/forced/delay/channels
echo \033[92mReading input tracks format/id/language...| "%cmdcolor%"
for /L %%i in (1,1,%count%) do (
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Format "%TEMP%mediainfo.JSON"`) do set T%%i.Format=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].ID "%TEMP%mediainfo.JSON"`) do set T%%i.ID=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Language "%TEMP%mediainfo.JSON"`) do set T%%i.Lang=%%~a
)
::check for dual track dual layer p7 input
for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[0].VideoCount "%TEMP%mediainfo.JSON"`) do set video.count=%%~a
rmdir /Q /S  "%letterpath%\JQ\" > nul
echo Done.

Setlocal EnableDelayedExpansion
for /L %%i in (1,1,%count%) do ( 
     if /i "%fileext%"==".mkv" if "!T%%i.Format!"=="MLP FBA" set T%%i.Format=A_MLP
	 if not "%fileext%"==".mkv" if "!T%%i.Format!"=="MLP FBA" set T%%i.Format=A_AC3
	 if "!T%%i.Format!"=="DTS" set T%%i.Format=A_DTS
	 if "!T%%i.Format!"=="PCM" set T%%i.Format=A_LPCM
	 if "!T%%i.Format!"=="LPCM" set T%%i.Format=A_LPCM
	 if "!T%%i.Format!"=="E-AC-3" set T%%i.Format=A_AC3
	 if "!T%%i.Format!"=="AC-3" set T%%i.Format=A_AC3
	 if "!T%%i.Format!"=="AAC" set T%%i.Format=A_AAC
)

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "fps=%%a"
)

echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
for /L %%i in (2,1,%count%) do ( 
     if not "!T%%i.Format!"=="HEVC" if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.Format!"=="UTF-8" if not "!T%%i.Format!"=="PGS" echo !T%%i.Format!, "%filepath%%filename%%fileext%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath%%filename%%fileext%",fps=%fps%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
)
"%tsmuxer_path%" "%TEMP%1.meta" "%output_path%\%filename%"

for %%F in ("%output_path%\%filename%\*.track*") do (
    set "name=%%~nF"
    set "extension=%%~xF"
    
    rem Check if the file contains ".track"
    echo !name! | find ".track" > nul
    if !errorlevel! equ 0 (
        rem Rename the file
        set "new_name=!name:.track=_transfer=hdr.matrix=2020.track!"
        ren "%%F" "!new_name!!extension!"
    )
)

Setlocal DisableDelayedExpansion

echo \033[92m Indexing Video %filename% | "%cmdcolor%"
"%ffmsindex%" "%filepath%%filename%%fileext%" -f "%output_path%\%filename%\%filename%.ffindex"

echo LoadPlugin("%ffms2%") > "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs"
echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs" 
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs" 
echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%output_path%\%filename%\%filename%.ffindex") >> "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs" 
echo ConvertBits(16) >> "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs" 
echo libplacebo_Tonemap(src_csp=3, dst_csp=1) >> "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs"
echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs"

set DelayedSelfDeleteCommand="timeout /t 5 >NUL &&
"%MPC_path%" "%output_path%\%filename%\%filename%_transfer=hdr.matrix=2020.avs" >NUL

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"

pause & goto :MODE.P5

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ----------------------------------------------------------------Encoders-------------------------------------------------------------------------------------------------
:MODE.E

echo.
echo \033[36m       ====================== | "%cmdcolor%"
echo \033[36m       -   SELECT A MODE    - | "%cmdcolor%"
echo \033[36m       ====================== | "%cmdcolor%"
echo.                                                             
echo 1) MODE.A= AUDIO Encoding (DDP, THDAC3, DEE)
echo 2) MODE.V= VIDEO Encoding (x265/Prores/dovi_baker/libplacebo/cm_offline)
echo.
choice /C:123 /M Choice?

if ERRORLEVEL 2 (
goto :MODE.V
)
if ERRORLEVEL 1 (
goto :MODE.A
)

:MODE.A
echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= Lossless Audio to DD^+ EC3 (can batch)
echo 2) Workflow.2= Add an AC3 Core to TrueHD (thdmerge or eac3to)(can batch)
echo 3) Workflow.3= DEE workflows(payware) (^not recomended)
echo.
choice /C:123 /M Choice?

if ERRORLEVEL 3 (
goto :Workflow.3
)

if ERRORLEVEL 2 (
goto :Workflow.2
)

if ERRORLEVEL 1 (
goto :Workflow.1
)

::##################################################################################################################################################################################################
::################################################################  AUDIO  #######################################################################################################################
::##################################################################################################################################################################################################

::-----------------------------------------------------------DD+ -------------------------------------------------------------------------------------------------------------------------
:Workflow.1
:eae.again
echo.
echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - AUDIO DDP - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This script encode lossless audio to EAC3 DD^+
echo -- Input can be a folder with files or a single file.
echo -- EAE folder needed for 7.1 encoding.
echo -- You can override lossy audio input bitrate target if you add IGNOREBITRATE in the filename
echo -- Example: https://youtu.be/m5_Bt2yGPhE^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
set batch.info=y
set currentjob=811

cd /d "%output_path%"

:: folder with files input
echo Drag and drop folder with files or a single file and press enter...
set /p folder=

setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
)
if "%lang%"=="" set auto.select.audio=YES
if /i "%auto.select.audio%"=="YES" goto :loop.EAE
set encode_7.1=NO
"%mkvmerge_path%" -i "%filepath1%%filename1%%fileext1%"
echo Select the track ID and press enter... & set /p manualFID=

::---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:loop.EAE
set convert_audio=y

if exist "%temp_folder%temp.folder78" rmdir /Q /S "%temp_folder%temp.folder78"
MD "%temp_folder%temp.folder78"
set TEMP=%temp_folder%temp.folder78\

if /i "%fileext1%"==".txt" goto :END
if /i "%fileext1%"==".nfo" goto :END
if /i "%fileext1%"==".bin" goto :END
if /i "%fileext1%"==".png" goto :END
if /i "%fileext1%"==".jpg" goto :END
if /i "%fileext1%"==".jpeg" goto :END
if /i "%fileext1%"==".tiff" goto :END
if /i "%fileext1%"==".tif" goto :END
if /i "%same_input_output%"=="YES" set output_path=%filepath1%

::workaround in case of raw aac
if not "%fileext1%"==".aac" goto :skipaac
echo Raw AAC, will remux to MKV first to get the correct bitrate...
"%mkvmerge_path%" --output ^"%filepath1%%filename1%.mkv^" --compression 0:none ^"^(^" ^"%filepath1%%filename1%%fileext1%^" ^"^)^"
set fileext1=.mkv& set aacin=y

:skipaac
:: find the track count and set a variable for the loops
"%mkvmerge_path%" -i "%filepath1%%filename1%%fileext1%" > "%TEMP%input.track.count.txt"

for /f %%i in ('python "%~dp0tools\trackcount.py" -i "%TEMP%input.track.count.txt"') do set count2=%%i
if "%count2%"=="0" set count2=20
if "%count2%"=="" set count2=20
"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"

MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul
:: check format/language/forced/delay/channels of input
echo \033[92mReading input tracks format/id/language...| "%cmdcolor%"
for /L %%i in (0,1,%count2%) do (
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Format "%TEMP%mediainfo.JSON"`) do set T%%i.Format=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Language "%TEMP%mediainfo.JSON"`) do set T%%i.Lang=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Channels "%TEMP%mediainfo.JSON"`) do set T%%i.Channels=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].BitRate "%TEMP%mediainfo.JSON"`) do set T%%i.BitRate=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Delay "%TEMP%mediainfo.JSON"`) do set T%%i.Delay=%%~a
)
rmdir /Q /S  "%letterpath%\JQ\" > nul
echo Done.
for /L %%i in (1,1,%count2%) do set T%%i.Delay=!T%%i.Delay:.=!

for /L %%i in (1,1,%count2%) do (
	 if "!T%%i.Lang!"=="null" set T%%i.Lang=und
	 if "!T%%i.Lang!"=="en" set T%%i.Lang=eng
	 if "!T%%i.Lang!"=="fr" set T%%i.Lang=fre
	 if "!T%%i.Lang!"=="it" set T%%i.Lang=ita
	 if "!T%%i.Lang!"=="ru" set T%%i.Lang=rus
	 if "!T%%i.Lang!"=="de" set T%%i.Lang=deu
	 if "!T%%i.Lang!"=="zh" set T%%i.Lang=chi
	 if "!T%%i.Lang!"=="es" set T%%i.Lang=spa
	 if "!T%%i.Lang!"=="ja" set T%%i.Lang=jpn
	 if "!T%%i.Lang!"=="pt" set T%%i.Lang=por
	 if "!T%%i.Lang!"=="ar" set T%%i.Lang=ara
	 if "!T%%i.Lang!"=="hi" set T%%i.Lang=hin
	 if "!T%%i.Lang!"=="bn" set T%%i.Lang=ben
	 if "!T%%i.Lang!"=="ms" set T%%i.Lang=msa
	 if "!T%%i.Lang!"=="ko" set T%%i.Lang=kor
	 if "!T%%i.Lang!"=="tr" set T%%i.Lang=tur
	 if "!T%%i.Lang!"=="vi" set T%%i.Lang=vie
	 if "!T%%i.Lang!"=="th" set T%%i.Lang=tha
	 if "!T%%i.Lang!"=="nl" set T%%i.Lang=nld
	 if "!T%%i.Lang!"=="pl" set T%%i.Lang=pol
	 if "!T%%i.Lang!"=="sv" set T%%i.Lang=swe
	 if "!T%%i.Lang!"=="da" set T%%i.Lang=dan
	 if "!T%%i.Lang!"=="fi" set T%%i.Lang=fin
)

if "%aacin%"=="y" if "%T1.Channels%"=="8" set ffmpeg_channels=-channel_layout 5.1

if not "%lang%"=="" goto :skip.all.audio
::--------------------------------------------------------encode all lossless audio--------------------------------------------------

set temp.path=%filepath1%& set temp.name=%filename1%& set temp.ext=%fileext1%
set encodeEAE=n
::check for 8 channels audio
for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Channels!"=="8" set ch%%i=y& set encodeEAE=y& set ffmpeg_channels=-channel_layout 5.1
     if "!T%%i.Channels!"=="Object Based" set ch%%i=y& set encodeEAE=y& set ffmpeg_channels=-channel_layout 5.1
)

for /L %%i in (1,1,%count2%) do (
     if /i "%encode_7.1%"=="NO" set ch%%i=n
)

if "%encodeEAE%"=="y" (
	 xcopy "%EAE_path%" "%output_path%\EAE" /E /I /Y > nul
     cd "%output_path%\EAE" & start "" "%EAE%"
)

for /L %%i in (1,1,%count2%) do (
     set /a "FID%%i=%%i-1" 
)
for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="MLP FBA" set THD%%i=y 
)

:: set delay in filename for 7.1 tracks
for /L %%i in (1,1,%count2%) do (
      if "!ch%%i!"=="y" if /i "%fileext1%"==".mkv" if not "!T%%i.Delay!"=="0000" set DELAY%%i=DELAY_!T%%i.Delay!MS
)

::THD encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="MLP FBA" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if "!T%%i.Format!"=="MLP FBA" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%output_path%%temp.name%_!T%%i.Lang!_%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Format!"=="MLP FBA" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%output_path%%temp.name%_!T%%i.Lang!_%%i_!DELAY%%i!.eac3"
)

::DTS-x encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Channels!"=="Object Based" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if "!T%%i.Channels!"=="Object Based" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%output_path%%temp.name%_!T%%i.Lang!_%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Channels!"=="Object Based" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%output_path%%temp.name%_!T%%i.Lang!_%%i_!DELAY%%i!.eac3"
)
::DTS encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="DTS" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if "!T%%i.Format!"=="DTS" if not "!ch%%i!"=="y" if not "!T%%i.BitRate!"=="768000" "%ffmpeg_path%" -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%output_path%%temp.name%_!T%%i.Lang!_%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Format!"=="DTS" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%output_path%%temp.name%_!T%%i.Lang!_%%i_!DELAY%%i!.eac3"
)
::PCM encode ec3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="PCM" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if "!T%%i.Format!"=="PCM" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%output_path%%temp.name%_!T%%i.Lang!_%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Format!"=="PCM" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%output_path%%temp.name%_!T%%i.Lang!_%%i_!DELAY%%i!.eac3"
)

for /L %%i in (1,1,%count2%) do (
     if "!T%%i.Format!"=="FLAC" if "!ch%%i!"=="y" "%ffmpeg_path%" -drc_scale 0 -y -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%%%i.wav"
)

for /L %%i in (1,1,%count2%) do ( 
	 if "!T%%i.Format!"=="FLAC" if not "!ch%%i!"=="y" "%ffmpeg_path%" -i "%temp.path%%temp.name%%temp.ext%" -map 0:!FID%%i! -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -c:s copy -map_chapters -1 -y "%output_path%%temp.name%_!T%%i.Lang!_%%i.mkv"
)

for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Format!"=="FLAC" if "!ch%%i!"=="y" "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%%%i.wav" -eae_root "%output_path%\EAE" -y "%output_path%%temp.name%_!T%%i.Lang!_%%i_!DELAY%%i!.eac3"
)
if "%encodeEAE%"=="y" (
	 taskkill /F /IM EasyAudioEncoder.exe > nul
	 cd /d "%output_path%" & rmdir /Q /S "%output_path%EAE"
)

goto :END
::--------------------------------------------------------------------------------------select only 1 audio---------------------------------------------------------------------------------------------------
:skip.all.audio

set DDP_bitrate2=%DDP_bitrate%

::check for 8 channels audio
for /L %%i in (1,1,%count2%) do ( 
     if "!T%%i.Channels!"=="8" set ch%%i=y
)

:audioCM
set temp.path=%filepath1%& set temp.name=%filename1%& set temp.ext=%fileext1%
if not "%batch.info%"=="y" set temp.path=%filepath%& set temp.name=%filename%& set temp.ext=%fileext%

for /l %%i in (1,1,%count2%) do (
      set T%%i.BitRate=!T%%i.BitRate:~0,-3!
)

:: audio and subs selection according to the script settings
::8channels
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Channels!"=="8" (
        if "!T%%i.Format!"=="MLP FBA" (
            if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=8& set THD=y& goto :skip
        ) else if "!T%%i.Format!"=="DTS" (
            if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=8& goto :skip
        ) else if "!T%%i.Format!"=="PCM" (
            if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=8& goto :skip
        ) else if "!T%%i.Format!"=="FLAC" (
            if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=8& goto :skip
		)
    )
)

::DTS-X 
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Channels!"=="Object Based" (
        if "!T%%i.Format!"=="DTS" (
            if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=8& goto :skip
        )
    )
)
:: 2 or 6 channels
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Format!"=="MLP FBA" (
        if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=6& goto :skip
    ) else if "!T%%i.Format!"=="DTS" (
        if not "!T%%i.BitRate!"=="768" if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=6& goto :skip
    ) else if "!T%%i.Format!"=="PCM" (
        if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=6& goto :skip
    ) else if "!T%%i.Format!"=="FLAC" (
        if "!T%%i.Lang!"=="%langDG%" set /a "FID=%%i-1" & set ch=6& goto :skip
    )
)
::dts 768
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Format!"=="DTS" (
        if "!T%%i.BitRate!"=="768" if "!T%%i.Lang!"=="%langDG%" set DDP_bitrate=768& set /a "FID=%%i-1" & set ch=6& goto :skip
   )
)

:: lossy
for /l %%i in (1,1,%count2%) do (
	 if not "!T%%i.Format!"=="HEVC" if not "!T%%i.Format!"=="AVC" if "!T%%i.Lang!"=="%langDG%" set DDP_bitrate=!T%%i.BitRate!& set /a "FID=%%i-1" & set ch=6& set lossyinput=y& goto :skip
)

::-------------------------------------------------------------------------------------------------------------------------------------------------
::8channels no language found
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Channels!"=="8" (
        if "!T%%i.Format!"=="MLP FBA" (
            set /a "FID=%%i-1"& set ch=8& set THD=y& goto :skip
        ) else if "!T%%i.Format!"=="DTS" (
            set /a "FID=%%i-1" & set ch=8& goto :skip
        ) else if "!T%%i.Format!"=="PCM" (
            set /a "FID=%%i-1" & set ch=8& goto :skip
        ) else if "!T%%i.Format!"=="FLAC" (
            set /a "FID=%%i-1" & set ch=8& goto :skip
        )		
    )
)

::DTS-X no language found
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Channels!"=="Object Based" (
        if "!T%%i.Format!"=="DTS" (
            set /a "FID=%%i-1" & set ch=8& goto :skip
        )
    )
)
::no language found
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Format!"=="MLP FBA" (
        set /a "FID=%%i-1" & set ch=6& goto :skip
    ) else if "!T%%i.Format!"=="DTS" (
      if not "!T%%i.BitRate!"=="768" set /a "FID=%%i-1" & set ch=6& goto :skip
    ) else if "!T%%i.Format!"=="PCM" (
        set /a "FID=%%i-1" & set ch=6& goto :skip
    ) else if "!T%%i.Format!"=="FLAC" (
        set /a "FID=%%i-1" & set ch=6& goto :skip
    )
)
::dts 768
for /l %%i in (1,1,%count2%) do (
    if "!T%%i.Format!"=="DTS" (
        if "!T%%i.BitRate!"=="768" set DDP_bitrate=768& set /a "FID=%%i-1" & set ch=6& goto :skip
   )
)
::lossy
for /l %%i in (1,1,%count2%) do (
	 if not "!T%%i.Format!"=="HEVC" if not "!T%%i.Format!"=="AVC" set DDP_bitrate=!T%%i.BitRate!& set /a "FID=%%i-1" & set ch=6& set lossyinput=y
)
:skip

if /i "%auto.select.audio%"=="NO" if "%currentjob%"=="811" set FID=%manualFID%

echo "%temp.name%" > "%TEMP%filename3.txt"
findstr /c:"IGNOREBITRATE" "%TEMP%filename3.txt" >Nul
if %errorlevel%==0 set DDP_bitrate=%DDP_bitrate2%

for /l %%i in (1,1,%count2%) do (
if "%lossyinput%"=="y" if "!ch%%i!"=="y" set ffmpeg_channels=-channel_layout 5.1
)

if "%FID%"=="" if "%job%"=="batch5.EC3" goto :batch5.EC3
if "%FID%"=="" if "%joba%"=="main.job" goto :main.job
if /i "%encode_LL%"=="YES" (
     "%ffmpeg_path%" -drc_scale 0 -i "%temp.path%%temp.name%%temp.ext%" -map 0:%FID% -c %llcodec% -y "%output_path%%temp.name%_pcm.%mcont%"
	 set PCM-A="%output_path%%temp.name%_pcm.%mcont%"
	 if not "%convert_audio%"=="y" goto :main.job
)

echo Processing... "%temp.path%%temp.name%%temp.ext%"
if "%FID%"=="" echo no lossless audio found, skipping file. & goto :END
:: encode audio to DD+
if "%ch%"=="8" set ffmpeg_channels=-channel_layout 5.1
if /i "%encode_7.1%"=="NO" set ch=6

:: ts m2ts input dont work properly so disabling delay management unless you force it: set input.delay=YES
if not "%input.delay%"=="YES" if not "%temp.ext%"==".mkv" goto :skip.delay
if not "%ch%"=="8" goto :skip.delay

:: set delay variables
set /a FID=%FID%+1
for /l %%i in (1,1,%count2%) do (
      if not "!T%%i.Delay!"=="0000" if "%FID%"=="%%i" set DELAYA=--sync 0:!T%%i.Delay!& set delay=, timeshift=!T%%i.Delay!ms& set DELAYB=_DELAY_!T%%i.Delay!MS
)
set /a FID=%FID%-1

:skip.delay

if "%ch%"=="8" goto :eae
"%ffmpeg_path%" -i "%temp.path%%temp.name%%temp.ext%" -map 0:%FID% -c:a eac3 -b:a %DDP_bitrate%k %ffmpeg_channels% -ar 48000 -c:s copy -map_chapters -1 -metadata:s:a:0 title="DDP @ %DDP_bitrate%kbps" -y "%output_path%%temp.name%_EC3.mkv"
goto :skipeae
:eae
     xcopy "%EAE_path%" "%output_path%\EAE" /E /I /Y > nul
	 cd "%output_path%\EAE" & start "" "%EAE%"
	 "%ffmpeg_path%" -drc_scale 0 -i "%temp.path%%temp.name%%temp.ext%" -map 0:%FID% -c pcm_s24le -ar 48000 -rf64 auto "%TEMP%1.wav"
	 "%PLEX%" -eae_root "%output_path%\EAE" -c:a pcm_s24le -i "%TEMP%1.wav" -eae_root "%output_path%\EAE" -b:a %DDP_bitrate%k "%TEMP%%temp.name%_EAE%DELAYB%.eac3"
	 taskkill /F /IM EasyAudioEncoder.exe > nul
	 cd /d "%output_path%" & rmdir /Q /S "%output_path%\EAE"

if not "%container%"=="TS" "%mkvmerge_path%" --output ^"%output_path%%temp.name%_EC3.mkv^" --language 0:%langDG% --track-name 0:^"DDP 7.1 @ %DDP_bitrate%kbps^" %DELAYA% ^"^(^" ^"%TEMP%%temp.name%_EAE%DELAYB%.eac3^" ^"^)^"
if /i "%container%"=="TS" if exist "%TEMP%%temp.name%_EAE%DELAYB%.eac3" copy /y "%TEMP%%temp.name%_EAE%DELAYB%.eac3" "%output_path%"

:skipeae
if "%job%"=="batch5.EC3" goto :batch5.EC3
if "%joba%"=="main.job" goto :main.job

:END
set ch=& set FID=& set ffmpeg_channels=& set DELAY=& set DELAYA=& set DELAYB=
for /l %%i in (1,1,%count2%) do (
     set THD%%i=& set T%%i.Delay=& set T%%i.BitRate=& set T%%i.Channels=& set T%%i.Lang=& set T%%i.Format=& set ch%%i=
)

if "%aacin%"=="y" if exist "%filepath1%%filename1%.mkv" del "%filepath1%%filename1%.mkv"

if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%" 
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=& set lossyinput=& set aacin=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=
:: go to next file or end the script
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.EAE
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo \033[92mThe script has been completed, press a key to start again...| "%cmdcolor%"
pause & set fileext1=& goto :eae.again

::##################################################################################################################################################################################################
::########################################################################################DEE####################################################################################################
::##################################################################################################################################################################################################

::-----------------------------------------------------------THD thdmerge---------------------------------------------------------------------------------------------------------
:Workflow.2
echo.
echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - AUDIO THD - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo --This script just adds a core to TrueHD
echo --Existing core or silent core
echo --Expect MKV with THD
echo --Input can be a folder or a single file.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

cd "%output_path%"

:: folder with files input
echo Drag and drop folder with files or a single file and press enter...
set /p folder=

setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %folder% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)
if [%fileext1%]==[] (
     for %%i in (!folder!) do set filename1=%%~ni
     for %%i in (!folder!) do set filepath1=%%~di%%~pi
     for %%i in (!folder!) do set fileext1=%%~xi
)

if /i "%fileext1%"==".thd" set jobtype=s& goto :loop.ac3.core
echo Do you want to add a Silent(s), Existing(x) or Encoded(e) AC3 core^? (Default= s)
echo.
echo --^> Silent= s 
echo --^> Existing= x
echo --^> Encoded= e
echo.
set /p jobtype=
if "%jobtype%"=="" set jobtype=s
if /i "%jobtype%"=="s" set jobtype=s
if /i "%jobtype%"=="x" set jobtype=x
if /i "%jobtype%"=="e" set jobtype=e
if not "%jobtype%"=="s" if not "%jobtype%"=="x" if not "%jobtype%"=="e" set jobtype=s

:loop.ac3.core

MD "%temp_folder%temp.folder74"
set TEMP=%temp_folder%temp.folder74\

if /i "%fileext1%"==".thd" set THD="%filepath1%%filename1%%fileext1%"& set AC3.track=%AC3.64kbps_path%& goto :merge
if not "%fileext1%"==".mkv" goto :end
if /i "%same_input_output%"=="YES" set output_path=%filepath1%

:: find the track count and set a variable for the loops
"%mkvmerge_path%" -i "%filepath1%%filename1%%fileext1%" > "%TEMP%input.track.count.txt"

for /f %%i in ('python "%~dp0tools\trackcount.py" -i "%TEMP%input.track.count.txt"') do set countt=%%i

"%mediainfo_path%" "%filepath1%%filename1%%fileext1%" --output=JSON > "%TEMP%mediainfo.JSON"
MD %letterpath%\JQ
copy "%JQ_path%" %letterpath%\JQ > nul

:: check format/language/forced/delay/channels
echo \033[92mReading input tracks format/id/language...| "%cmdcolor%"
for /L %%i in (1,1,%countt%) do (
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Format "%TEMP%mediainfo.JSON"`) do set T%%i.Format=%%~a
	for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].ID "%TEMP%mediainfo.JSON"`) do set T%%i.ID=%%~a
    for /f "usebackq tokens=*" %%a in (`%letterpath%\JQ\jq-win64.exe .media.track[%%i].Language "%TEMP%mediainfo.JSON"`) do set T%%i.Lang=%%~a
)
rmdir /Q /S  "%letterpath%\JQ\" > nul
echo Done.
:: set id to minus one mkvextract
for /L %%i in (1,1,%countt%) do set /A m.id%%i=%%i-1

for /L %%i in (1,1,%countt%) do (
    if "!T%%i.Lang!"=="%langDG%" if "!T%%i.Format!"=="MLP FBA" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd"& set THD="%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd"& set eac3.input%%i=%%i: "%output_path%%filename1%.thd+ac3"& goto :found.audio
)
for /L %%i in (1,1,%countt%) do (
    if "!T%%i.Format!"=="MLP FBA" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd"& set THD="%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.thd"& set eac3.input%%i=%%i: "%output_path%%filename1%.thd+ac3"& goto :found.audio
)
goto :end
:found.audio
::----------------------------------------------------------existing core-------------------------------------------------------------------------------
if "%jobtype%"=="s" set AC3.track=%AC3.64kbps_path%& goto :demux
if "%jobtype%"=="e" goto :encodedcore

for /L %%i in (1,1,%countt%) do (
	if "!T%%i.Lang!"=="%langDG%" if "!T%%i.Format!"=="AC-3" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.ac3"& set AC3.track="%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.ac3"& goto :found.audio
)
for /L %%i in (1,1,%countt%) do (
	if "!T%%i.Format!"=="AC-3" set AUDIO%%i=tracks !m.id%%i!:"%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.ac3"& set AC3.track="%TEMP%%filename1%.track_!T%%i.ID!_!T%%i.Lang!.ac3"& goto :found.audio
)
echo Could^'nt find an AC3 track, will merge a silent core...& set AC3.track=%AC3.64kbps_path%& goto :demux
:found.audio
goto :demux

::----------------------------------------------------------encoded core-------------------------------------------------------------------------------
:encodedcore

"%eac3to_path%" "%filepath1%%filename1%%fileext1%" %eac3.input1% %eac3.input2% %eac3.input3% %eac3.input4% %eac3.input5% %eac3.input6% %eac3.input7% %eac3.input8% %eac3.input9% %eac3.input10%
if NOT ["%errorlevel%"]==["0"] echo EAC3to failed, will merge a silent core...& set AC3.track=%AC3.64kbps_path%& goto :demux
if exist "%output_path%%filename1% - Log.txt" del "%output_path%%filename1% - Log.txt"
goto :end

::--------------------------------------------------------------DEMUX----------------------------------------------------------------------------------
:demux
::DEMUX MKV input
"%mkvextract_path%" "%filepath1%%filename1%%fileext1%" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %AUDIO16% %AUDIO17%

::--------------------------------------------------------------MERGE------------------------------------------------------------------------------------
:merge
:: MERGE
echo merging an AC3 core with TrueHD...
%thdmerge_path% %THD% %AC3.track% "%output_path%%filename1%_thd+ac3.thd"

:end
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%" 
set count2=& set muxing.succes=& set FPS=& set hlg.input=& set profile=& set muxing.succes=& set lossless.input=
set THD=& set forced=& set in.ID=& set ch=& set FID=& set ec3.id=& set DV=& set Hplus=& set shot=& set frameCount=& set first_line=& set Height=& set count2=
set raw.in=& set p7_bl=& set p5_bl=& set JUSTINJECT=& set dropH=& set mlp=& set dts=& set pcm.au=& set resync=& set dup=& set rem=& set delay.name=& set t81=& set SUBext=
set t82=& set t83=& set cmv4.0=& set T1=& set T2=& set T3=& set T4=&set trims=& set max_pq=& set min_pq=& set DVprofile=& set SRT=& set MBOX=
set cropped.input=& set job=& set audio=& set DT=& set RPU=& set EditL6=& set hlg.input=& set max=& set min=& set MDL.max_path=& set dv.profile=
set MDL.min_path=& set final.vid=& set editL9=& set remm=& set sour=& set offs=& set raw=& set HDR=& set FPS= set mode=& set ID=& set v1=& set v2=& set HLG=& set ID=
set p5=& set SDR=& set P7=& set HDR2=& set HDR1=& set v1_1080p=& set v2_1080p=& set MDL3=& set col=& set P5BL=& set subprofile=& set delay=& set way=& set UP1=& set UP2=& set upal1=
set upal2=& set incolor1=& set incolor2=& set MAPPING1=& set MAPPING2=& set upscaled1=& set upscaled2=& set HDR=& set pcm=& set flac=& set DDP=& set PCM=& set delay=& set NOSUB=& set properfps=& set NOAUDIO=
:: go to next file or end the script
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loop.ac3.core
)
setlocal disabledelayedexpansion
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::########################################################################################DEE####################################################################################################
::##################################################################################################################################################################################################

::------------------------------------------------------------------------------------DEE DD+ BD------------------------------------------------------------------------------------------------------------------------------------------------------------------

:Workflow.3
::DEE DD+ encoder
echo.
echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - AUDIO DEE - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- REQUIRES Dolby Encoding Engine (DEE) , see line 391
echo -- Can encode to DD^+ 1536kbps 7.1(ac3 core) or TrueHD 7.1
echo -- Input must have 7.1 channels audio. For 5.1/2.0 audio, use workflow 8-1-1
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

echo   Drag and drop a file and press enter... & set /p input=

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

if /i "%fileext%"==".wav" set ID=0& goto :skipid
"%mkvmerge_path%" -i "%filepath%%filename%%fileext%"
echo What is the audio track id (default=1) and press enter... & set /p ID=
if "%ID%"=="" set ID=1

:skipid
echo.
echo Do you want to encode to DDP  or TrueHD^? (default=d) 
echo.
echo --^> Dolby Digital Plus= d 
echo --^> TrueHD= t
echo.
set /p profile=
if "%profile%"=="" set ID=d
if /i "%profile%"=="t" set ID=t
if /i "%profile%"=="d" set ID=d
if not "%profile%"=="d" if not "%profile%"=="t" set ID=d

if exist "%temp_folder%temp_folder19" rmdir /Q /S "%temp_folder%temp_folder19"
MD "%temp_folder%temp_folder19"
set TEMP=%temp_folder%temp_folder19\

if /i "%fileext%"==".wav" copy "%filepath%%filename%%fileext%" "%TEMP%" & rename "%TEMP%%filename%%fileext%" "1.wav" & goto :skipwavencoding
"%ffmpeg_path%" -drc_scale 0 -i "%filepath%%filename%%fileext%" -map 0:%ID% -af "pan=7.1|c0=c0|c1=c1|c2=c2|c3=c3|c4=c6|c5=c7|c6=c4|c7=c5" -rf64 auto -c pcm_s24le "%TEMP%1.wav"
:skipwavencoding

if /i "%profile%"=="t" goto :THD.PROFILE

echo ^<^?xml version="1.0" encoding="utf-8"^?^> > "%TEMP%DEE_settings.xml"
echo ^<job_config^> >> "%TEMP%DEE_settings.xml"
echo   ^<input^> >> "%TEMP%DEE_settings.xml"
echo     ^<audio^> >> "%TEMP%DEE_settings.xml"
echo       ^<wav version="1"^> >> "%TEMP%DEE_settings.xml"
echo        ^<file_name^>1.wav^</file_name^> >> "%TEMP%DEE_settings.xml"
echo         ^<timecode_frame_rate^>not_indicated^</timecode_frame_rate^> >> "%TEMP%DEE_settings.xml"
echo         ^<offset^>auto^</offset^> >> "%TEMP%DEE_settings.xml"
echo         ^<ffoa^>auto^</ffoa^> >> "%TEMP%DEE_settings.xml"
echo         ^<storage^> >> "%TEMP%DEE_settings.xml"
echo           ^<local^> >> "%TEMP%DEE_settings.xml"
echo             ^<path^>%TEMP%^</path^> >> "%TEMP%DEE_settings.xml"
echo           ^</local^> >> "%TEMP%DEE_settings.xml"
echo         ^</storage^> >> "%TEMP%DEE_settings.xml"
echo       ^</wav^> >> "%TEMP%DEE_settings.xml"
echo     ^</audio^> >> "%TEMP%DEE_settings.xml"
echo   ^</input^> >> "%TEMP%DEE_settings.xml"
echo   ^<filter^> >> "%TEMP%DEE_settings.xml"
echo     ^<audio^> >> "%TEMP%DEE_settings.xml"
echo       ^<pcm_to_ddp version="3"^> >> "%TEMP%DEE_settings.xml"
echo         ^<loudness^> >> "%TEMP%DEE_settings.xml"
echo           ^<measure_only^> >> "%TEMP%DEE_settings.xml"
echo             ^<metering_mode^>1770-3^</metering_mode^> >> "%TEMP%DEE_settings.xml"
echo             ^<dialogue_intelligence^>true^</dialogue_intelligence^> >> "%TEMP%DEE_settings.xml"
echo             ^<speech_threshold^>20^</speech_threshold^> >> "%TEMP%DEE_settings.xml"
echo           ^</measure_only^> >> "%TEMP%DEE_settings.xml"
echo         ^</loudness^> >> "%TEMP%DEE_settings.xml"
echo        ^<encoder_mode^>bluray^</encoder_mode^> >> "%TEMP%DEE_settings.xml"
echo         ^<bitstream_mode^>complete_main^</bitstream_mode^> >> "%TEMP%DEE_settings.xml"
echo         ^<downmix_config^>off^</downmix_config^> >> "%TEMP%DEE_settings.xml"
echo         ^<data_rate^>1536^</data_rate^> >> "%TEMP%DEE_settings.xml"
echo         ^<timecode_frame_rate^>not_indicated^</timecode_frame_rate^> >> "%TEMP%DEE_settings.xml"
echo         ^<start^>0:00:00.005333^</start^> >> "%TEMP%DEE_settings.xml"
echo         ^<end^>end_of_file^</end^> >> "%TEMP%DEE_settings.xml"
echo         ^<time_base^>file_position^</time_base^> >> "%TEMP%DEE_settings.xml"
echo         ^<prepend_silence_duration^>0.0^</prepend_silence_duration^> >> "%TEMP%DEE_settings.xml"
echo         ^<append_silence_duration^>0.0^</append_silence_duration^> >> "%TEMP%DEE_settings.xml"
echo         ^<lfe_on^>true^</lfe_on^> >> "%TEMP%DEE_settings.xml"
echo         ^<dolby_surround_mode^>not_indicated^</dolby_surround_mode^> >> "%TEMP%DEE_settings.xml"
echo         ^<dolby_surround_ex_mode^>yes^</dolby_surround_ex_mode^> >> "%TEMP%DEE_settings.xml"
echo         ^<user_data^>-1^</user_data^> >> "%TEMP%DEE_settings.xml"
echo         ^<drc^> >> "%TEMP%DEE_settings.xml"
echo           ^<line_mode_drc_profile^>music_light^</line_mode_drc_profile^> >> "%TEMP%DEE_settings.xml"
echo           ^<rf_mode_drc_profile^>music_light^</rf_mode_drc_profile^> >> "%TEMP%DEE_settings.xml"
echo         ^</drc^> >> "%TEMP%DEE_settings.xml"
echo         ^<custom_dialnorm^>%dialnorm%^</custom_dialnorm^> >> "%TEMP%DEE_settings.xml"
echo         ^<lfe_lowpass_filter^>true^</lfe_lowpass_filter^> >> "%TEMP%DEE_settings.xml"
echo         ^<surround_90_degree_phase_shift^>false^</surround_90_degree_phase_shift^> >> "%TEMP%DEE_settings.xml"
echo         ^<surround_3db_attenuation^>false^</surround_3db_attenuation^> >> "%TEMP%DEE_settings.xml"
echo         ^<downmix^> >> "%TEMP%DEE_settings.xml"
echo           ^<loro_center_mix_level^>-3^</loro_center_mix_level^> >> "%TEMP%DEE_settings.xml"
echo           ^<loro_surround_mix_level^>-3^</loro_surround_mix_level^> >> "%TEMP%DEE_settings.xml"
echo           ^<ltrt_center_mix_level^>-3^</ltrt_center_mix_level^> >> "%TEMP%DEE_settings.xml"
echo           ^<ltrt_surround_mix_level^>-3^</ltrt_surround_mix_level^> >> "%TEMP%DEE_settings.xml"
echo           ^<preferred_downmix_mode^>loro^</preferred_downmix_mode^> >> "%TEMP%DEE_settings.xml"
echo         ^</downmix^> >> "%TEMP%DEE_settings.xml"
echo         ^<allow_hybrid_downmix^>false^</allow_hybrid_downmix^> >> "%TEMP%DEE_settings.xml"
echo        ^<embedded_timecodes^> >> "%TEMP%DEE_settings.xml"
echo           ^<starting_timecode^>off^</starting_timecode^> >> "%TEMP%DEE_settings.xml"
echo           ^<frame_rate^>auto^</frame_rate^> >> "%TEMP%DEE_settings.xml"
echo         ^</embedded_timecodes^> >> "%TEMP%DEE_settings.xml"
echo       ^</pcm_to_ddp^> >> "%TEMP%DEE_settings.xml"
echo     ^</audio^> >> "%TEMP%DEE_settings.xml"
echo   ^</filter^> >> "%TEMP%DEE_settings.xml"
echo   ^<output^> >> "%TEMP%DEE_settings.xml"
echo     ^<ec3 version="1"^> >> "%TEMP%DEE_settings.xml"
echo       ^<file_name^>"%filename%.ec3"^</file_name^> >> "%TEMP%DEE_settings.xml"
echo       ^<storage^> >> "%TEMP%DEE_settings.xml"
echo         ^<local^> >> "%TEMP%DEE_settings.xml"
echo           ^<path^>%output_path%^</path^> >> "%TEMP%DEE_settings.xml"
echo         ^</local^> >> "%TEMP%DEE_settings.xml"
echo       ^</storage^> >> "%TEMP%DEE_settings.xml"
echo     ^</ec3^> >> "%TEMP%DEE_settings.xml"
echo   ^</output^> >> "%TEMP%DEE_settings.xml"
echo   ^<misc^> >> "%TEMP%DEE_settings.xml"
echo     ^<temp_dir^> >> "%TEMP%DEE_settings.xml"
echo       ^<clean_temp^>true^</clean_temp^> >> "%TEMP%DEE_settings.xml"
echo       ^<path^>%TEMP%^</path^> >> "%TEMP%DEE_settings.xml"
echo    ^</temp_dir^> >> "%TEMP%DEE_settings.xml"
echo   ^</misc^> >> "%TEMP%DEE_settings.xml"
echo ^</job_config^> >> "%TEMP%DEE_settings.xml"

"%DEE_path%" -x "%TEMP%DEE_settings.xml"

goto :skip.core

::------------------------------------------------------------------------------------------------DEE THD----------------------------------------------------------------------------------------------------------------
:THD.profile
:: DEE TRUEHD encoding

echo ^<^?xml version="1.0"^?^> > "%TEMP%DEE_settings.xml"
echo ^<job_config^> >> "%TEMP%DEE_settings.xml"
echo   ^<input^> >> "%TEMP%DEE_settings.xml"
echo     ^<audio^> >> "%TEMP%DEE_settings.xml"
echo       ^<wav version="1"^> >> "%TEMP%DEE_settings.xml"
echo         ^<file_name^>1.wav^</file_name^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<timecode_frame_rate^>not_indicated^</timecode_frame_rate^>    ^<!-- One of: not_indicated, 23.976, 24, 25, 29.97, 30, 48, 50, 59.94, 60 --^> >> "%TEMP%DEE_settings.xml"
echo         ^<offset^>auto^</offset^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<ffoa^>auto^</ffoa^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<storage^> >> "%TEMP%DEE_settings.xml"
echo           ^<local^> >> "%TEMP%DEE_settings.xml"
echo             ^<path^>%TEMP%^</path^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo           ^</local^> >> "%TEMP%DEE_settings.xml"
echo         ^</storage^> >> "%TEMP%DEE_settings.xml"
echo       ^</wav^> >> "%TEMP%DEE_settings.xml"
echo     ^</audio^> >> "%TEMP%DEE_settings.xml"
echo   ^</input^> >> "%TEMP%DEE_settings.xml"
echo   ^<filter^> >> "%TEMP%DEE_settings.xml"
echo     ^<audio^> >> "%TEMP%DEE_settings.xml"
echo       ^<encode_to_dthd version="1"^> >> "%TEMP%DEE_settings.xml"
echo         ^<loudness_measurement^> >> "%TEMP%DEE_settings.xml"
echo           ^<metering_mode^>1770-4^</metering_mode^>    ^<!-- One of: 1770-4, 1770-3, 1770-2, 1770-1, LeqA --^> >> "%TEMP%DEE_settings.xml"
echo           ^<dialogue_intelligence^>true^</dialogue_intelligence^>    ^<!-- boolean: true or false --^> >> "%TEMP%DEE_settings.xml"
echo           ^<speech_threshold^>15^</speech_threshold^>    ^<!-- integer: from 0 to 100 --^> >> "%TEMP%DEE_settings.xml"
echo         ^</loudness_measurement^> >> "%TEMP%DEE_settings.xml"
echo         ^<timecode_frame_rate^>not_indicated^</timecode_frame_rate^>    ^<!-- One of: not_indicated, 23.976, 24, 25, 29.97, 30, 48, 50, 59.94, 60 --^> >> "%TEMP%DEE_settings.xml"
echo         ^<start^>first_frame_of_action^</start^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<end^>end_of_file^</end^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<time_base^>file_position^</time_base^>    ^<!-- One of: file_position, embedded_timecode --^> >> "%TEMP%DEE_settings.xml"
echo         ^<prepend_silence_duration^>0^</prepend_silence_duration^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<append_silence_duration^>0^</append_silence_duration^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^<atmos_presentation^> >> "%TEMP%DEE_settings.xml"
echo           ^<drc_profile^>music_light^</drc_profile^>    ^<!-- One of: film_standard, music_light, music_standard, music_light, speech --^> >> "%TEMP%DEE_settings.xml"
echo           ^<spatial_clusters^>12^</spatial_clusters^>    ^<!-- One of: 12, 14, 16 --^> >> "%TEMP%DEE_settings.xml"
echo           ^<legacy_authoring_compatibility^>true^</legacy_authoring_compatibility^>    ^<!-- boolean: true or false --^> >> "%TEMP%DEE_settings.xml"
echo         ^</atmos_presentation^> >> "%TEMP%DEE_settings.xml"
echo         ^<presentation_8ch^> >> "%TEMP%DEE_settings.xml"
echo           ^<drc_profile^>music_light^</drc_profile^>    ^<!-- One of: film_standard, music_light, music_standard, music_light, speech --^> >> "%TEMP%DEE_settings.xml"
echo           ^<surround_3db_attenuation^>false^</surround_3db_attenuation^>    ^<!-- boolean: true or false --^> >> "%TEMP%DEE_settings.xml"
echo         ^</presentation_8ch^> >> "%TEMP%DEE_settings.xml"
echo         ^<presentation_6ch^> >> "%TEMP%DEE_settings.xml"
echo           ^<drc_profile^>music_light^</drc_profile^>    ^<!-- One of: film_standard, music_light, music_standard, music_light, speech --^> >> "%TEMP%DEE_settings.xml"
echo           ^<surround_3db_attenuation^>false^</surround_3db_attenuation^>    ^<!-- boolean: true or false --^> >> "%TEMP%DEE_settings.xml"
echo         ^</presentation_6ch^> >> "%TEMP%DEE_settings.xml"
echo         ^<presentation_2ch^> >> "%TEMP%DEE_settings.xml"
echo           ^<drc_profile^>music_light^</drc_profile^>    ^<!-- One of: film_standard, music_light, music_standard, music_light, speech --^> >> "%TEMP%DEE_settings.xml"
echo           ^<drc_default_on^>false^</drc_default_on^>    ^<!-- boolean: true or false --^> >> "%TEMP%DEE_settings.xml"
echo           ^<format^>dolby_surround_encoded^</format^>    ^<!-- One of: stereo, dolby_surround_encoded, dolby_headphone_encoded --^> >> "%TEMP%DEE_settings.xml"
echo         ^</presentation_2ch^> >> "%TEMP%DEE_settings.xml"
echo         ^<optimize_data_rate^>false^</optimize_data_rate^>    ^<!-- boolean: true or false --^> >> "%TEMP%DEE_settings.xml"
echo         ^<embedded_timecodes^> >> "%TEMP%DEE_settings.xml"
echo           ^<starting_timecode^>off^</starting_timecode^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo           ^<frame_rate^>auto^</frame_rate^>    ^<!-- One of: auto, 23.976, 24, 25, 29.97, 30 --^> >> "%TEMP%DEE_settings.xml"
echo         ^</embedded_timecodes^> >> "%TEMP%DEE_settings.xml"
echo         ^<log_format^>txt^</log_format^>    ^<!-- One of: txt, html --^> >> "%TEMP%DEE_settings.xml"
echo       ^</encode_to_dthd^> >> "%TEMP%DEE_settings.xml"
echo     ^</audio^> >> "%TEMP%DEE_settings.xml"
echo   ^</filter^> >> "%TEMP%DEE_settings.xml"
echo   ^<output^> >> "%TEMP%DEE_settings.xml"
echo     ^<mlp version="1"^> >> "%TEMP%DEE_settings.xml"
echo       ^<file_name^>%filename%.thd^</file_name^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo       ^<storage^> >> "%TEMP%DEE_settings.xml"
echo         ^<local^> >> "%TEMP%DEE_settings.xml"
echo           ^<path^>^%output_path%^</path^>     ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo         ^</local^> >> "%TEMP%DEE_settings.xml"
echo       ^</storage^> >> "%TEMP%DEE_settings.xml"
echo     ^</mlp^> >> "%TEMP%DEE_settings.xml"
echo   ^</output^> >> "%TEMP%DEE_settings.xml"
echo   ^<misc^> >> "%TEMP%DEE_settings.xml"
echo     ^<temp_dir^> >> "%TEMP%DEE_settings.xml"
echo       ^<clean_temp^>true^</clean_temp^> >> "%TEMP%DEE_settings.xml"
echo       ^<path^>%TEMP%^</path^>    ^<!-- string --^> >> "%TEMP%DEE_settings.xml"
echo     ^</temp_dir^> >> "%TEMP%DEE_settings.xml"
echo   ^</misc^> >> "%TEMP%DEE_settings.xml"
echo ^</job_config^> >> "%TEMP%DEE_settings.xml"

"%DEE_path%" -x "%TEMP%DEE_settings.xml"

if /i "%container%"=="TS" (
        echo merging a silent AC3 core with TrueHD...
        "%thdmerge_path%" "%output_path%%filename%.thd" "%AC3.64kbps_path%" "%output_path%%filename%.thd+ac3"
)
if exist "%output_path%%filename%.thd.mll" del "%output_path%%filename%.thd.mll"
if exist "%output_path%%filename%.thd.log" del "%output_path%%filename%.thd.log"
:skip.core

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************

::----------------------------------------------------------------Encode P5 to HDR10 or SDR------------------------------------------------------------------------------------------------------------

:MODE.V

echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo 1) Workflow.1= %Encoder%: HDR to HDR (DVP7/DVP8/DVP5/HDR10/HLG)
echo 2) Workflow.2= %Encoder%: HDR to SDR (DVP7/DVP8/DVP5/HDR10/HLG)
echo 3) Workflow.3= PRORES:  HDR to HDR (DVP7/DVP8/DVP5/HDR10/HLG) 
echo 4) Workflow.4= PRORES:  DV to SDR (Dolby CM_Offline DV Trim Pass delivery) 
echo 5) Workflow.5= PRORES:  SDR to HDR-100nits
echo 6) Workflow.6= DoVi-P5: P8/P7/prores/MXF to Profile 5 DV HEVC (require DEE.exe)
echo 7) Workflow.7= AQ _strength compression tool
echo 8) Workflow8= back to main menu
echo.
choice /C:12345678 /M Choice?
if ERRORLEVEL 8 (
goto :Main.menu
)

if ERRORLEVEL 7 (
set job=8.2.7& goto :ENCODER
)

if ERRORLEVEL 6 (
set job=8.2.6& goto :ENCODER
)

if ERRORLEVEL 5 (
set job=8.6.5& goto :ENCODER
)

if ERRORLEVEL 4 (
set job=8.6.4& goto :ENCODER
)

if ERRORLEVEL 3 (
set job=8.6.3& goto :ENCODER
)

if ERRORLEVEL 2 (
set job=8.6.2& set SDR=y& goto :ENCODER
)

if ERRORLEVEL 1 (
set job=8.6.1& goto :ENCODER
)

:ENCODER

::Encode HDR to HDR or SDR with x265.exe or prores ffmpeg
echo.
echo.
echo \033[36m          ============ | "%cmdcolor%"
echo \033[36m          - ENCODERS - | "%cmdcolor%"
echo \033[36m          ============ | "%cmdcolor%"
echo.

echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
if "%job%"=="8.6.1" echo -- Encode any HDR source(DVP7/DVP5/DVP8/HDR10/HLG) to HDR x265.exe or NVenc.exe. see line 150
if "%job%"=="8.6.1" echo -- DV P5/P7/P8 will be converted/injected to DV P8.1
if "%job%"=="8.6.1" echo -- FEL Tutorial: https://youtu.be/8BvXqw_cGJE^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql
if "%job%"=="8.6.1" echo -- Does ^not support P5 to P5 encoding

if "%job%"=="8.6.2" echo -- Can Encode any HDR source(DVP7/DVP5/DVP8/HDR10/HLG) to SDR x265.exe or x264.exe

if "%job%"=="8.6.3" echo -- Can Encode any HDR source(DVP7/DVP5/DVP8/HDR10/HLG) to HDR PRORES 422 HQ

if "%job%"=="8.6.4" set loop_mode=NO& echo -- Deliver any Dolby Vision trim pass to PRORES 422 HQ
if "%job%"=="8.6.4" echo -- Require Dolby CM_offline.exe
if "%job%"=="8.6.4" echo -- Workaround: https://youtu.be/lM56zLpKDQ8^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql

if "%job%"=="8.6.5" set loop_mode=NO& echo -- Can encode SDR to HDR10-100nits PQ PRORES 422 HQ
if "%job%"=="8.6.5" echo -- Output must be graded in Resolve otherwise this is just 100nits SDR in an HDR container.
if "%job%"=="8.6.5" echo -- Example: https://youtu.be/728R3ppSWuk^?list=PLFGpkrmX_eOL2Dre1ZyIJP2uMtcQYH8ql

if "%job%"=="8.2.6" set loop_mode=NO& echo -- Encode any P8/P7/prores/IMF/HDR10/HLG source to Profile 5 Dolby Vision
if "%job%"=="8.2.6" echo -- Input can be MKV/TS/MP4/MOV/MXF
if "%job%"=="8.2.6" echo -- Support JPEG2000 MXF and MOV prores (you must provide a valid DV XML)
if "%job%"=="8.2.6" echo -- Support HDR10 and HLG (you must provide a valid DV XML)
if "%job%"=="8.2.6" echo -- Require DEE,  see line 390
if "%job%"=="8.2.6" echo -- encode_dvmezz_to_dv5.py must be edited to do CRF ... see: https://justpaste.it/enibt 

if "%job%"=="8.2.7" echo -- Test different AQ strength. See line 188-203

if not "%job%"=="8.6.3" if not "%job%"=="8.6.4" if not "%job%"=="8.6.5" echo -- Encode settings can be configured at line 143-182
echo -- Require Avisynthplus https://github.com/AviSynth/AviSynthPlus/releases
echo -- Libplacebo SDR tone mapping and P5/HLG input require a gpu with vulkan support
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
if "%job%"=="8.6.4" if not exist "%~dp0tools\cm_offline.exe" echo cm_offline.exe is missing in the tools folder, download it here: https://customer.dolby.com/content-creation-and-delivery/dolby-vision-professional-tools & pause & exit
if /i "%Encoder%"=="X264" if "%job%"=="8.6.1" echo \033[92m x264.exe encoder/codec does not support HDR encoding. Will use x265.exe...| "%cmdcolor%"& echo.
if /i "%Encoder%"=="X264" if "%job%"=="8.6.1" set Encoder=X265
if "%container%"=="MKV" set mux_all_audio=YES& set mux_all_sub=YES
echo   Drag and drop a video and press enter...& set /p input=

set qscale=1
if "%job%"=="8.6.4" set qscale=1& goto :skipqscale
if "%job%"=="8.6.5" set qscale=0& goto :skipqscale
if "%job%"=="8.6.3" echo Which qscale value to use for prores compression^? (default=1, higher values= more compression)& set /p qscale=
if "%qscale%"=="" set qscale=1

:skipqscale
Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi

:: make and set temp folder
if exist "%temp_folder%temp.folder31_new" if exist "%temp_folder%temp.folder31" rmdir /Q /S "%temp_folder%temp.folder31_new" & rmdir /Q /S "%temp_folder%temp.folder31"
if exist "%temp_folder%temp.folder31" set E1=_new
MD "%temp_folder%temp.folder31%E1%"
set TEMP=%temp_folder%temp.folder31%E1%\
if /i "%same_input_output%"=="YES" set output_path=%filepath%
echo.

if "%job%"=="8.6.4" goto :skiploopprompt
if "%job%"=="8.2.6" goto :skiploopprompt
if not "%loop_mode%"=="YES" goto :skiploopprompt

echo.
echo   Which frame do you want to loop^? (default = 1500)

for /L %%i in (1,1,%frame_number%) do (
    echo   Type frame %%i or press enter to skip:
    set /p "frame%%i="
	set f%%i=y
    if "!frame%%i!"=="" goto :breakloop
	set /a "frame_toexp+=1"
)
:breakloop
set frame_number=%frame_toexp%
if /i  "%frame1%"=="" set frame1=1500
echo.
echo   How many time do you want to loop the frame(s)^? (default = 750)& set /p frame_loop=
if /i  "%frame_loop%"=="" set frame_loop=750
echo.
echo   Quick(q) or Full(f) mode^? (default= q)
echo.
echo --^> FULL= f 
echo --^> QUICK= q
set /p quickFEL=
if [%quickFEL%]==[] set quickFEL=q
if /i "%quickFEL%"=="F" set quickFEL=f
if /i "%quickFEL%"=="Q" set quickFEL=q
:: process only a sample instead of the full input
if /i "%quickFEL%"=="f" goto :skiploopprompt

echo.
echo   Quick mode: making a 20min sample...
"%mkvmerge_path%" --output ^"%TEMP%%filename%.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:20:00 > Nul
set input.sample="%TEMP%%filename%.mkv"
echo Done.
for %%i in (!input.sample!) do set filename=%%~ni
for %%i in (!input.sample!) do set filepath=%%~di%%~pi
for %%i in (!input.sample!) do set fileext=%%~xi

:skiploopprompt

set cuda.acc=-hwaccel cuda
if /i "%no_nvidia_check%"=="YES" goto :nvidiacheck
nvidia-smi  > "%TEMP%checknvidia.txt" 2> Nul
findstr /c:"NVIDIA" "%TEMP%checknvidia.txt" > Nul
if %errorlevel%==1 echo No Nvidia GPU detected, enabling FFMS2 decoding & set force_ffms2=YES& set cuda.acc=
echo.

:nvidiacheck
::check input resolution
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "Width=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "Height=%%a"
)

:: check input framecount
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%FrameCount1.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount1.txt"') do (
    set "FrameCount1=%%a"
)
set frameCount1=%frameCount1:"=%

::prores no indexing-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if not "%job%"=="8.6.3" goto :skipnoindex
if /i "%disable_indexing%"=="NO" goto :skipnoindex

echo Encoding to prores without indexing the input may ^not be frame accurate...
echo ============================COMMAND==============================================================================
echo "%ffmpeg_path%" %cuda.acc% -i "%filepath%%filename%%fileext%" %PRORES_settings% -qscale:v %qscale% -loglevel error -stats "%output_path%%filename%_prores.422_No_indexing.mov"
echo =================================================================================================================
echo.
echo frame=%frameCount1% (total)
"%ffmpeg_path%" %cuda.acc% -i "%filepath%%filename%%fileext%" %PRORES_settings% -qscale:v %qscale% -loglevel error -stats "%output_path%%filename%_prores.422_No_indexing.mov" & goto :end

:skipnoindex

::-----------------------------------------master input-------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if exist "%filepath%%filename%.xml" set XML="%filepath%%filename%.xml"& set xml_input=y
if not "%fileext%"==".mxf" if not "%fileext%"==".mov" goto :skip.prores
set prores="%filepath%%filename%%fileext%"
set raw.input=y

if "%xml_input%"=="y" goto :cropping
echo   Drag and drop a XML file and press enter...& set /p XMLinput=

for %%i in (!XMLinput!) do set filenameXML=%%~ni
for %%i in (!XMLinput!) do set filepathXML=%%~di%%~pi
for %%i in (!XMLinput!) do set fileextXML=%%~xi

if [%fileextXML%]==[] echo You must input DV XML metadata... & pause & exit
set XML="%filepathXML%%filenameXML%%fileextXML%"
set xml_input=y
goto :cropping

:skip.prores

if "%job%"=="8.2.6" echo Which qscale value to use for prores compression^? (default=1, higher values= more compression)& set /p qscale=
if "%job%"=="8.2.6" if "%qscale%"=="" set qscale=1
if "%job%"=="8.6.3" goto :skip.crop
if "%job%"=="8.6.4" goto :skip.crop
if "%job%"=="8.6.5" goto :skip.crop

::---------------------------------------------------CROP-------------------------------------------------------------------------------------------

if /i "%auto.crop%"=="NO" goto :cropping

if not "%Height%"=="2160" if not "%Height%"=="1080" if /i "%auto.crop%"=="YES" set crop=y& set left=0& set right=0& set top=0& set bottom=0& goto :skip.crop

:cropping
if /i "%loop_mode%"=="YES"  set crop=n& goto :skip.crop
echo   Do you want to crop^? (default=n)
echo.
echo --^> YES= y
echo --^> NO= n
set /p crop=
echo.
if "%crop%"=="" set crop=n
if /i "%crop%"=="n" set crop=n
if /i "%crop%"=="y" set crop=y
if not "%crop%"=="y" if not "%crop%"=="n" set crop=n
if /i "%crop%"=="n" goto :skip.crop

:: check for raw or ts/m2ts input in order to prepare crop readings in avspmod (ts/m2ts files are buggy and raw hevc cant be played in directshow)
set cropcheck="%filepath%%filename%%fileext%"
if not "%raw%"=="y" if not "%fileext%"==".ts" if not "%fileext%"==".m2ts" goto :skip.sample
:: make mkv sample if input raw hevc or ts/m2ts
echo.
echo Raw HEVC or TS/M2TS input, making a MKV sample to allow avspmod to read the input...
"%mkvmerge_path%" --output ^"%TEMP%sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
set cropcheck="%TEMP%sample.mkv"
::make script for avspmod with raised black for better letterbox reading
:skip.sample
echo DirectShowSource(%cropcheck%) > "%TEMP%%filename%.avs"
echo Levels(0, 2.5, 255, 0, 255, coring=false) >> "%TEMP%%filename%.avs"
:: launch avspmod
start "" "%AvsPmod_path%" "%TEMP%%filename%.avs"

echo.
echo   Odd numbers will be rounded...
echo.
echo Right border pixels offset... (default=0)& set /p right=
echo Left border pixels offset...(default=0)& set /p left=
echo Top border pixels offset...(default=0)& set /p top=
echo Bottom border pixels offset...(default=0)& set /p bottom=
if "%top%"=="" set top=0
if "%left%"=="" set left=0
if "%right%"=="" set right=0
if "%bottom%"=="" set bottom=0

set /a "check=left %% 2"
if %check% equ 1 (
    set /a "left+=1"
)
set /a "check=right %% 2"
if %check% equ 1 (
    set /a "right+=1"
)
set /a "check=top %% 2"
if %check% equ 1 (
    set /a "top+=1"
)
set /a "check=bottom %% 2"
if %check% equ 1 (
    set /a "bottom+=1"
)

:skip.crop

if "%SDR%"=="y" echo Which target nits value do you want to use for the SDR tone mapping^? (default = 125)& set /p SDR_target_nits=
if [%SDR_target_nits%]==[] set SDR_target_nits=125

:tryagainframes
if "%job%"=="8.2.7" (
    for /L %%i in (1,1,%AQframes%) do (
        set /p frame%%i=Enter frame %%i of %AQframes%:
    )
)
:: Subtract 75 from each entered frame
if "%job%"=="8.2.7" (
    for /L %%i in (1,1,%AQframes%) do (
        set /a framestart%%i=!frame%%i! - %AQ.sequence.frames%
    )
)


if "%job%"=="8.2.7" if "%frame1%"=="" echo frames required...& pause & goto :tryagainframes

::-----------------------------------------------------------------encode ddp------------------------------------------------------------------------------------------------------------------------------------------------------------

set convert_audio=n
if /i "%encode_DDP%"=="NO" goto :skipaudio
if /i "%container%"=="MP4" goto :skipaudio
if /i "%job%"=="8.6.3" goto :skipaudio
if /i "%job%"=="8.6.4" goto :skipaudio
if /i "%job%"=="8.2.6" goto :skipaudio
if /i  "%loop_mode%"=="YES" goto :skipaudio

if /i "%fileext%"==".mxf" goto :skipaudio
if /i "%fileext%"==".mov"  goto :skipaudio

:: check if lossless audio present, if not skip the user prompt.
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Audio;%%Format%% --LogFile="%TEMP%audio.format.txt" >Nul
findstr /c:"MLP" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set mlp=n
findstr /c:"DTS" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set dts=n
findstr /c:"PCM" "%TEMP%audio.format.txt" >Nul
if not %errorlevel%==0 set pcm.au=n
if "%mlp%"=="n" if "%dts%"=="n"  if "%pcm.au%"=="n" goto :skipaudio

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
:: check audio tracks info
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath%%filename%%fileext%"

echo.
:: user input for triggering audio encoding
echo   Do you want to convert the audio to DDP^? (default= n ) 
echo.
echo --^> YES= y
echo --^> NO= n
set /p convert_audio=
if "%convert_audio%"=="" set convert_audio=n
if /i "%convert_audio%"=="y" set convert_audio=y
if /i "%convert_audio%"=="n" set convert_audio=n
if /i "%convert_audio%"=="yes" set convert_audio=y
if /i "%convert_audio%"=="no" set convert_audio=n
if not "%convert_audio%"=="n" if not "%convert_audio%"=="y" set convert_audio=n

:skipaudio

if not "%job%"=="8.2.7" if not "%fileext%"==".mxf" if not "%fileext%"==".mov" if not "%fileext%"==".avi" set job.encoder=job8.2& goto :tracks.info
:job8.2.start

::-------------------------------------------------------------DEMUX if needed---------------------------------------------------------------------------------------------------------------------------------------------------------

::demux if output muxing is MP4 or TS
if "%SDR%"=="y" if /i "%container%"=="MP4" set container=MKV
if /i "%MUX%"=="NO" goto :skipdemuxing
if "%job%"=="8.6.3" goto :skipdemuxing
if "%job%"=="8.6.4" goto :skipdemuxing
if "%job%"=="8.6.5" goto :skipdemuxing
if "%job%"=="8.2.7" goto :skipdemuxing
if /i "%container%"=="MKV" goto :skipdemuxing
if /i "%fileext%"==".mxf" goto :skipdemuxing
if /i "%fileext%"==".mov" goto :skipdemuxing
if /i "%fileext%"==".avi" goto :skipdemuxing

echo.&echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       -    DEMUXING     - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.

if /i "%fileext%"==".mkv" "%mkvextract_path%" "%filepath%%filename%%fileext%" %AUDIO1% %AUDIO2% %AUDIO3% %AUDIO4% %AUDIO5% %AUDIO6% %AUDIO7% %AUDIO8% %AUDIO9% %AUDIO10% %AUDIO11% %AUDIO12% %AUDIO13% %AUDIO14% %AUDIO15% %SM1% %SM2% %SM3% %SM4% %SM5% %SM6% %SM7% %SM8% %SM9% %SM10% %SM11% %SM12% %SM13% %SM14% %SM15% %SM16% %SM17% %SM18% %SM19% %SM20% %SM21% %SM22% %SM23% %SM24% %SM25% %SM26% %SM27% %SM28% %SM29% %SM30% %SM31% %SM32% %SM33% %SM34% %SM35% %SM36% %SM37% %SM38% & goto :skipdemuxing
 
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)

	 echo MUXOPT --no-pcr-on-video-pid --new-audio-pes --hdmv-descriptors --vbr --demux --vbv-len=500 > "%TEMP%1.meta"
	 for /L %%i in (2,1,%count2%) do ( 
     if not "!T%%i.Format!"=="HEVC" if not "!T%%i.Format!"=="FLAC" if not "!T%%i.Format!"=="null" if not "!T%%i.sub!"=="y" echo !TSmuxer%%i.Format!, "%filepath%%filename%%fileext%", track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="Timed Text" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
	 if "!T%%i.Format!"=="UTF-8" echo S_TEXT/UTF8, "%filepath%%filename%%fileext%",font-name="Arial",font-size=65,font-color=0xffffffff,bottom-offset=24,font-border=5,text-align=center,video-width=1920,video-height=1080,fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta" 
	 if "!T%%i.Format!"=="PGS" echo S_HDMV/PGS, "%filepath%%filename%%fileext%",fps=%FPS%, track=!T%%i.ID!, lang=!T%%i.Lang! >> "%TEMP%1.meta"
)
 "%tsmuxer_path%" "%TEMP%1.meta" "%TEMP%"

 ::----------------------------------------------------------------------------------------------check input HDR type---------------------------------------------------------------------------------------------------------------------------------------
 
:skipdemuxing

set MBOX=:hdr=none:dvp=8.1& set dv.profile=8& set ID=1
if "%job%"=="8.2.6" set MBOX=& set dv.profile=5& set ID=0

::check if BL has keywords in the filename
echo "%filename%" > "%TEMP%filename1.txt"
findstr /c:"KEEPAUDIO" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set mux_all_audio=YES& set mux_all_sub=YES
findstr /c:"DONTMUX" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set MUX=NO
findstr /c:"KEEPPRORES" "%TEMP%filename1.txt" >Nul
if %errorlevel%==0 set keep_prores=YES

"%JQ_path%" .media.track[1].HDR_Format "%TEMP%mediainfo.JSON" > "%TEMP%check.HDR.txt"
"%JQ_path%" .media.track[1].HDR_Format_Profile "%TEMP%mediainfo.JSON" > "%TEMP%check.DV.txt"
"%JQ_path%" .media.track[1].MasteringDisplay_Luminance "%TEMP%mediainfo.JSON" > "%TEMP%masteringDL.txt"

"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%MasteringDisplay_Luminance%% --LogFile="%TEMP%MDL.txt" >Nul
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%MaxCLL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxcll.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%MaxFALL%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%maxfall.txt"

set HDR=n& set P5BL=n& set P7BL=n& set HLGBL=n
set MDP=G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)& set maxcll_path=0& set maxfall_path=0& set min_pq=1& set max_pq=1000
findstr /c:"07" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P7BL=y& set mode=2& set inCS=1& goto :skip
findstr /c:"08" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P8BL=y& set mode=0& set inCS=1& goto :skip
findstr /c:"05" "%TEMP%check.DV.txt" >Nul
if %errorlevel%==0 set P5BL=y& set mode=3& set inCS=3& goto :skip
findstr /c:"2086" "%TEMP%check.HDR.txt" >Nul
if %errorlevel%==0 set HDR=y& set inCS=1& goto :skip
findstr /c:"2094" "%TEMP%check.HDR.txt" >Nul
if %errorlevel%==0 set HDR=y& set inCS=1& goto :skip
if /i "%fileext%"==".avi" set HDR=y& set inCS=1
:Skip


type "%TEMP%mediainfo.JSON" | findstr HLG >"%TEMP%pq.txt"
findstr /m "HLG" "%TEMP%pq.txt" >Nul
if %errorlevel%==0 set HLGBL=y& set max_pq=1000& set min_pq=1& set maxcll_path=0&set maxfall_path=0& set inCS=2

type "%TEMP%mediainfo.JSON" | findstr MasteringDisplay_ColorPrimaries > "%TEMP%MCP.txt"
findstr /c:"BT.2020" "%TEMP%MCP.txt" >Nul
if %errorlevel%==0 set MDP=G(8500,39850)B(6550,2300)R(35400,14600)WP(15635,16450)

if /i "%fileext%"==".avi" goto :downscalein
if "%job%"=="8.6.4" if "%HDR%"=="y" echo Input has no DV... pause & exit
if /i "%crop%"=="y" set top2=0& set left2=0& set right2=0& set bottom2=0
if "%HDR%"=="y" goto :skip2k.crop
if "%HLGBL%"=="y" goto :skip2k.crop
if not "%job%"=="8.6.1" if not "%job%"=="8.6.2" if not "%job%"=="8.6.3" if not "%job%"=="8.2.6" goto :skip2k.crop
if /i "%fileext%"==".mxf" goto :downscalein
if /i "%fileext%"==".mov" goto :downscalein

::-------------------------------------------------------------check for FEL input----------------------------------------------------------------------------------

"%mkvmerge_path%" --output ^"%TEMP%1.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:00:23 > Nul
"%mkvextract_path%" "%TEMP%1.mkv" tracks 0:"%TEMP%temp.vid.hevc" > Nul
"%dovi_tool_path%" extract-rpu "%TEMP%temp.vid.hevc" -o "%TEMP%chunk.RPU.bin" > Nul

:: export metadata from 23sec sample to json files for L5 info
"%dovi_tool_path%" info --input "%TEMP%chunk.RPU.bin" -f 48 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr left > "%TEMP%left.json"
type "%TEMP%temp.rpu.json" | findstr right > "%TEMP%right.json"
type "%TEMP%temp.rpu.json" | findstr top > "%TEMP%top.json"
type "%TEMP%temp.rpu.json" | findstr bottom > "%TEMP%bottom.json"
type "%TEMP%temp.rpu.json" | findstr el_type > "%TEMP%subprofile.json"

findstr /c:"FEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=FEL
findstr /c:"MEL" "%TEMP%subprofile.json" >Nul
if %errorlevel%==0 set subprofile=MEL

if /i "%subprofile%"=="MEL" if /i "%P7BL%"=="y" set P7BL=n& set P8BL=y& set mode=2& set inCS=1
if "%job%"=="8.6.3" goto :skip2k.crop

::-------------------------------------------------------------downscale ----------------------------------------------------------------------------------
:downscalein
if /i "%downscale%"=="NO" goto :skip2k.crop
if /i "%crop%"=="y" goto :skip2k.crop

::remove the variable's unwanted characters from json
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%left.json"') do (
    set "left2=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%right.json"') do (
    set "right2=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%top.json"') do (
    set "top2=%%a"
)
for /f "tokens=2 delims=:," %%a in ('type "%TEMP%bottom.json"') do (
    set "bottom2=%%a"
)

set "left2=%left2: =%"
set "right2=%right2: =%"
set "top2=%top2: =%"
set "bottom2=%bottom2: =%"
if "%left2%"==" =" set left2=0& set right2=0& set top2=0& set bottom2=0
if "%left2%"=="" set left2=0& set right2=0& set top2=0& set bottom2=0

if not "%top2%"=="0" set /a "top2=%top2% / 2"
if not "%left2%"=="0" set /a "left2=%left2% / 2"
if not "%right2%"=="0" set /a "right2=%right2% / 2"
if not "%bottom2%"=="0" set /a "bottom2=%bottom2% / 2"
if "%top2%"=="" set top2=0
if "%left2%"=="" set left2=0
if "%right2%"=="" set right2=0
if "%bottom2%"=="" set bottom2=0

:skip2k.crop
if "%job%"=="8.2.6" set mode=0
::------------------------------------------------------------------rpu processing----------------------------------------------------------------------------------------------
(
echo {
echo     "mode": %mode%,
echo     "active_area": {
echo         "crop": false,
echo         "presets": [
echo             {
echo                 "id": 0,
echo                 "left": %left2%,
echo                 "right": %right2%,
echo                 "top": %top2%,
echo                 "bottom": %bottom2%
echo             }
echo         ],
echo         "edits": {
echo             "all": 0
echo         }
echo     }
echo }
) > "%TEMP%crop.json"

if "%raw.input%"=="y" goto :P5encoding

(
echo {
echo     "mode": %mode%,
echo     "remove_cmv4": false
echo }
) > "%TEMP%p8.json"

if "%P7BL%"=="y" goto :P7

::index
if not "%fileext%"==".avi" "%ffmsindex%" "%filepath%%filename%%fileext%" -f "%TEMP%indexed.video.ffindex"

if /i "%fileext%"==".avi"  goto :skiprpu
if "%job%"=="8.2.7" if not "%P5BL%"=="y" goto :skip.P7
if "%job%"=="8.6.5" goto :skip.P7
if "%job%"=="8.6.3" goto :skip.P7
if "%SDR%"=="y" goto :skip.P7
if "%HDR%"=="y" goto :skip.P7
if "%HLGBL%"=="y" goto :skip.P7

::------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------P5/P8 DEMUX------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------

::DEMUX p5 p8 INPUT
if not "%fileext%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.hevc"
"%dovi_tool_path%" extract-rpu "%TEMP%BL.hevc" -o  "%TEMP%RPU.bin"
goto :skippipeff

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - |  "%dovi_tool_path%" extract-rpu -o "%TEMP%RPU.bin" -

:skippipeff
if /i "%downscale%"=="YES" if /i "%crop%"=="n" "%dovi_tool_path%" editor -i "%TEMP%RPU.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%P8.RPU.bin" >Nul & goto :2k.out
if not "%crop%"=="y" "%dovi_tool_path%" editor -i "%TEMP%RPU.bin" -j "%TEMP%p8.json" --rpu-out "%TEMP%P8.RPU.bin" >Nul
if /i "%crop%"=="y" "%dovi_tool_path%" editor -i "%TEMP%RPU.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%P8.RPU.bin" >Nul
:2k.out
set RPUforP5="%TEMP%P8.RPU.bin"
if not "%SDR%"=="y" set P8RPU=--dolby-vision-profile 8.1 --dolby-vision-rpu "%TEMP%P8.RPU.bin"
goto :skip.P7

::------------------------------------------------------------------------------------------------------------------------------------------------------
::--------------------------------------P7 DEMUX input-----------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------
:: demux and index P7 layers
:P7
cd /d "%TEMP%"
if not "%fileext%"==".mkv" set ffmpeg_pipe=YES
if /i  "%ffmpeg_pipe%"=="YES"  goto :skip.mkvextract
"%mkvextract_path%" "%filepath%%filename%%fileext%" tracks 0:"%TEMP%BL.P7.hevc"
"%dovi_tool_path%" demux -i "%TEMP%BL.P7.hevc"
goto :index.layers

:skip.mkvextract
"%ffmpeg_path%" -i "%filepath%%filename%%fileext%" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -

:index.layers

if /i "%force_ffms2%"=="NO" goto :dgdemux
     echo.
     echo \033[92m Indexing the HDR10 base layer... | "%cmdcolor%"
	 echo.
     "%ffmsindex%" "%TEMP%BL.hevc" "%TEMP%BL.ffindex"
	 echo \033[92m Indexing the DV 12bits enhancement layer... | "%cmdcolor%"
     "%ffmsindex%" "%TEMP%EL.hevc" "%TEMP%EL.ffindex"
	 echo.
	 goto :skipdgdemux

:dgdemux
echo.
echo \033[92m Indexing the HDR10 base layer... | "%cmdcolor%"
"%DGIndexNV_path%" -i "%TEMP%BL.hevc" -o "%TEMP%BL.dgi" -h -a
echo.
echo \033[92m Indexing the DV 12bits enhancement layer... | "%cmdcolor%"
"%DGIndexNV_path%" -i "%TEMP%EL.hevc" -o "%TEMP%EL.dgi" -h -a
echo.
	 
:skipdgdemux
"%dovi_tool_path%" extract-rpu "%TEMP%EL.hevc" -o "%TEMP%RPU_FEL.bin"
cd /d "%output_path%"
set EL="%TEMP%EL.hevc" 
set BL="%TEMP%BL.hevc"
set P7RPU="%TEMP%RPU_FEL.bin"

if /i "%downscale%"=="YES" if /i "%crop%"=="n" "%dovi_tool_path%" editor -i "%TEMP%RPU_FEL.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%P8.RPU.bin" >Nul & goto :2k.out
if not "%crop%"=="y" "%dovi_tool_path%" editor -i "%TEMP%RPU_FEL.bin" -j "%TEMP%p8.json" --rpu-out "%TEMP%P8.RPU.bin" >Nul
if /i "%crop%"=="y" "%dovi_tool_path%" editor -i "%TEMP%RPU_FEL.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%P8.RPU.bin" >Nul

:2k.out
set RPUforP5="%TEMP%P8.RPU.bin"
if not "%SDR%"=="y" set P8RPU=--dolby-vision-profile 8.1 --dolby-vision-rpu "%TEMP%P8.RPU.bin"

:skip.P7
::------------------------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------static metadata from BL-----------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------
:loop.again
if /i "%loop_mode%"=="YES" if "%P7BL%"=="y" if "%job%"=="8.6.3" goto :getdatafromrpu
if "%job%"=="8.6.5" goto :skiprpu
if not "%job%"=="8.6.1" goto :skiprpu
if "%P7BL%"=="y" goto :getdatafromrpu
if "%P5BL%"=="y" goto :getdatafromrpu
if "%SDR%"=="y" goto :skiprpu
if "%HLGBL%"=="y" goto :skiprpu

for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxcll.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=1 delims=c" %%a in ('type "%TEMP%maxfall.txt"') do (
    set "maxfall_path=%%a"
)
set max_pq=1000
set min_pq=50
set maxcll_path=%maxcll_path: =%
set maxfall_path=%maxfall_path: =%
if "%maxcll_path%"==" =" set maxcll_path=0
if "%maxfall_path%"==" =" set maxfall_path=0
if "%maxcll_path%"=="" set maxcll_path=0
if "%maxfall_path%"=="" set maxfall_path=0

findstr /m "1000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set max_pq=1000
findstr /m "4000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set max_pq=4000
findstr /m "10000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set max_pq=10000
findstr /m "2000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set max_pq=2000
findstr /m "0.0050" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set min_pq=50
findstr /m "0.0001" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set min_pq=1
findstr /m "0.0020" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set min_pq=20
findstr /m "0.0010" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set min_pq=10
findstr /m "0.0000" "%TEMP%MDL.txt" >Nul
if %errorlevel%==0 set min_pq=0

if not "%loop_mode%"=="YES" goto :skiprpu
if not "%P8BL%"=="y" goto :skiprpu

"%dovi_tool_path%" info --input "%TEMP%P8.RPU.bin" -f %frame1% > "%TEMP%raw.txt"
for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw.txt"') do (
    set "maxpq=%%a"
)

for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq %maxpq%') do set valueinnits=%%i
set L1maxosd=%valueinnits%

for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw.txt"') do (
    set "avgpq=%%a"
)
for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq %avgpq%') do set valueinnits=%%i
set L1avgosd=%valueinnits%

goto :skipfulll1mcmf

::------------------------------------------------------------------------------------------------------------------------------------------------------
::-------------get static metadata from RPU----------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------
:getdatafromrpu

if "%job%"=="8.2.7" if not "%P5BL%"=="y" goto :skiprpu
if not "%loop_mode%"=="YES" goto :skipsingleframerpu

"%dovi_tool_path%" info --input "%TEMP%P8.RPU.bin" -f %frame1% > "%TEMP%raw.txt"
for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"max_pq\":" "%TEMP%raw.txt"') do (
    set "maxpq=%%a"
)

for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq %maxpq%') do set valueinnits=%%i
set maxcll_path=%valueinnits%
set L1maxosd=%valueinnits%

for /f "tokens=2 delims=:, " %%a in ('findstr /c:"\"avg_pq\":" "%TEMP%raw.txt"') do (
    set "avgpq=%%a"
)
for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -pq %avgpq%') do set valueinnits=%%i
set maxfall_path=%valueinnits%
set L1avgosd=%valueinnits%
goto :skipfulll1mcmf

:skipsingleframerpu

"%dovi_tool_path%" info -s "%TEMP%P8.RPU.bin" >"%TEMP%sum.rpu.json"
type "%TEMP%sum.rpu.json" | findstr L1 > "%TEMP%L1.txt"
for /f "tokens=4 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=6 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxfall_path=%%a"
)
set maxcll_path=%maxcll_path: =%
set maxfall_path=%maxfall_path: =%
if "%maxcll_path%"==" =" set maxcll_path=0
if "%maxfall_path%"==" =" set maxfall_path=0
if "%maxcll_path%"=="" set maxcll_path=0
if "%maxfall_path%"=="" set maxfall_path=0

:skipfulll1mcmf
"%dovi_tool_path%" info --input "%TEMP%P8.RPU.bin" -f 5 > "%TEMP%temp.rpu.json"
type "%TEMP%temp.rpu.json" | findstr source_min_pq > "%TEMP%min_pq.json"
type "%TEMP%temp.rpu.json" | findstr source_max_pq > "%TEMP%max_pq.json"

set SPQmax_pq=3079
set SPQmin_pq=7
findstr /c:"3079" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=1000& set SPQmax_pq=3079
findstr /c:"3388" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=2000& set SPQmax_pq=3388
findstr /c:"3696" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=4000& set SPQmax_pq=3696
findstr /c:"4095" "%TEMP%max_pq.json" >Nul
if %errorlevel%==0 set max_pq=10000& set SPQmax_pq=4095
findstr /c:"7" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=1& set SPQmin_pq=7
findstr /c:"62" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=50& set SPQmin_pq=62
findstr /c:"38" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=20& set SPQmin_pq=38
findstr /c:"0" "%TEMP%min_pq.json" >Nul
if %errorlevel%==0 set min_pq=0& set SPQmin_pq=0

:skiprpu
::set static HDR10 metadata
if not "%SDR%"=="y" set static_metadata=--master-display "%MDP%L(%max_pq%0000,%min_pq%)" --max-cll "%maxcll_path%,%maxfall_path%"

::========================================custom metadata for sample-loop=================================================================================================

if /i "%fileext%"==".avi" goto :skipcustomrpu
if not "%loop_mode%"=="YES" goto :skipcustomrpu
if "%job%"=="8.6.4" goto :skipcustomrpu 
if "%job%"=="8.6.5" goto :skipcustomrpu 
if "%job%"=="8.2.6" goto :skipcustomrpu
if "%job%"=="8.6.3" goto :skipcustomrpu
if "%job%"=="8.6.2" goto :skipcustomrpu
if not "%P8BL%"=="y" if not "%P7BL%"=="y" if not "%P5BL%"=="y" goto :skipcustomrpu

"%dovi_tool_path%" export -i "%TEMP%P8.RPU.bin" -o "%TEMP%full.json" > Nul
"%dovi_tool_path%" info -s "%TEMP%P8.RPU.bin" > "%TEMP%rpu.info.txt"

set t2.100=&set L2t100=&set t2.600=&set L2t600=&set t2.1000=&set L2t1000=&set t8.100=&set L8t100=&set t8.600=&set L8t600=&set t8.1000=&set L8t1000=
set level9=& set cmv4.0=& set MDP.RPU=

type "%TEMP%rpu.info.txt" | findstr trims: > "%TEMP%trims.txt"
findstr /c:"100 nits" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.100=y& set L2t100=L2 100nits
findstr /c:"600" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.600=y& set L2t600=, 600nits
findstr /c:"1000" "%TEMP%trims.txt" >Nul
if %errorlevel%==0 set t2.1000=y& set L2t1000=, 1000nits

findstr /c:"\"target_display_index\":1" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.100=y& set L8t100=- L8 100nits
findstr /c:"\"target_display_index\":27" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.600=y& set L8t600=, 600nits
findstr /c:"\"target_display_index\":48" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.1000=y& set L8t1000=, 1000nits
findstr /c:"\"target_display_index\":28" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.600=y& set L8t600=, 600nits
findstr /c:"\"target_display_index\":49" "%TEMP%full.json" >Nul
if %errorlevel%==0 set t8.1000=y& set L8t1000=, 1000nits
findstr /c:"cmv40" "%TEMP%full.json" >Nul
if %errorlevel%==0 set cmv4.0=y
findstr /c:"\"source_primary_index\":0" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=DCIP3D65
findstr /c:"\"source_primary_index\":2" "%TEMP%full.json" >Nul
if %errorlevel%==0 set level9=y& set MDP.RPU=BT2020
if /i  "%rem_cmv4%"=="YES" set cmv4.0=n

echo.
if /i "%t8.600%"=="y" set cmv4.0=n& echo WARNING... Input with 600nits L8 trim not supported yet and might never be... Will discard cmv4.0...
if /i "%t8.1000%"=="y" set cmv4.0=n& echo WARNING... Input with 1000nits L8 trim not supported yet and might never be... Will discard cmv4.0...
echo.

set L3=& set L8=
set template="%~dp0tools\generate_sample_template_cmv29_static.json"
if /i  "%cmv4.0%"=="y" set template="%~dp0tools\generate_sample_template_cmv40_static.json"
if /i  "%cmv4.0%"=="y" set L3=-l3 1& set L8=-l8 1

python "%~dp0tools\merge.data.py" -i "%TEMP%raw.txt" -o "%TEMP%raw.metadata.json" >Nul
python "%~dp0tools\generate_sample.py" -t %template% -s "%TEMP%raw.metadata.json" -o "%TEMP%generate.json" -l1 1 -l2 1 %L3% %L8%

"%dovi_tool_nofloor%" generate -j "%TEMP%generate.json" -o "%TEMP%Generated_metadata.bin" > nul
set RPU="%TEMP%Generated_metadata.bin"

:: source pq
     echo { > "%TEMP%sourcepq.json"
     echo 	"min_pq": %SPQmin_pq%, >> "%TEMP%sourcepq.json"
     echo 	"max_pq": %SPQmax_pq% >> "%TEMP%sourcepq.json"
     echo } >> "%TEMP%sourcepq.json"

     "%dovi_tool_nofloor%" editor -i %RPU% -j "%TEMP%sourcepq.json" --rpu-out "%TEMP%RPU.SPQ.bin" > nul
	 set RPU="%TEMP%RPU.SPQ.bin"
	 
:: level 6
echo { > "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %max_pq%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %min_pq%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"
"%dovi_tool_nofloor%" editor -i %RPU% -j "%TEMP%L6.json" --rpu-out "%TEMP%RPU-L6.bin" > nul
set RPU="%TEMP%RPU-L6.bin"
 	
:: level 9
if not "%cmv4.0%"=="y" goto :skipL9
	 echo { > "%TEMP%l9.json"
     echo "mode": 0, >> "%TEMP%l9.json"
     echo "level9": "%MDP.RPU%" >> "%TEMP%l9.json"
     echo } >> "%TEMP%l9.json"
     "%dovi_tool_path%" editor -i %RPU% -j "%TEMP%l9.json" --rpu-out "%TEMP%RPU-L9.bin" > nul
     set RPU="%TEMP%RPU-L9.bin"
	 
:skipL9
set /a frame_loop_minusten=%frame_loop% - 10
::generate duplicate frames json
echo { > "%TEMP%duplicate.json"
echo 	"duplicate": [ >> "%TEMP%duplicate.json"
echo 		{ >> "%TEMP%duplicate.json"
echo 			"source": 1, >> "%TEMP%duplicate.json"
echo 			"offset": 1, >> "%TEMP%duplicate.json"
echo 			"length": %frame_loop_minusten% >> "%TEMP%duplicate.json"
echo 		} >> "%TEMP%duplicate.json"
echo 	] >> "%TEMP%duplicate.json"
echo } >> "%TEMP%duplicate.json"
echo.
:: duplicates frames
"%dovi_tool_nofloor%" editor -i %RPU% -j "%TEMP%duplicate.json" --rpu-out "%TEMP%framecount_adjusted.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
set RPU="%TEMP%framecount_adjusted.bin"

::remove trims not present in original
if /i "%t2.100%"=="y" if /i "%t2.600%"=="y" if /i "%t2.1000%"=="y" goto :skiptrimsremoval

set L2.100=& set L2.600=&set L2.1000=
if not "%t2.100%"=="y" set L2.100=,1
if not "%t2.600%"=="y" set L2.600=,27,28
if not "%t2.1000%"=="y" set L2.1000=,48,49

"%RPU.to.XML%" convert %RPU% "%TEMP%trimstoremove.xml" > nul
"%metafier_path%"  -o "%TEMP%trimsremoved.xml" --remove-trim L2%L2.100%%L2.600%%L2.1000% "%TEMP%trimstoremove.xml" > nul
"%dovi_tool_nofloor%" generate --xml  "%TEMP%trimsremoved.xml" --canvas-width 3840 --canvas-height 2160 --rpu-out "%TEMP%final.bin" > nul
set RPU="%TEMP%final.bin"

:skiptrimsremoval
set P8RPU=--dolby-vision-profile 8.1 --dolby-vision-rpu %RPU%

:skipcustomrpu
:: set tag for encode filename
set encodetype=
if not "%SDR%"=="y" if /i  "%HDR%"=="y" set encodetype=_HDR10_to_HDR10
if not "%SDR%"=="y" if /i  "%P8BL%"=="y" set encodetype=_P8-HDR10_to_DVP8-HDR10
if not "%SDR%"=="y" if /i  "%P5BL%"=="y" set encodetype=_DVP5_to_DVP8-HDR10
if not "%SDR%"=="y" if /i  "%HLGBL%"=="y" set encodetype=_HLG_to_HDR10
if not "%SDR%"=="y" if /i  "%P7BL%"=="y" set encodetype=_DV-FEL_to_DVP8-HDR10
if "%job%"=="8.6.3" if not "%SDR%"=="y" if /i  "%P7BL%"=="y" set encodetype=_DV-FEL_to_HDR10
if "%job%"=="8.6.3" if not "%SDR%"=="y" if /i  "%P5BL%"=="y" set encodetype=_DVP5_to_HDR10
if "%job%"=="8.6.3" if not "%SDR%"=="y" if /i  "%P8BL%"=="y" set encodetype=_DVP8_to_HDR10
if "%job%"=="8.6.3" if not "%SDR%"=="y" if /i  "%HDR%"=="y" set encodetype=_HDR10_to_HDR10
if "%job%"=="8.6.3" if not "%SDR%"=="y" if /i  "%HLGBL%"=="y" set encodetype=_HLG_to_HDR10

if "%SDR%"=="y" if /i  "%HDR%"=="y" set encodetype=_HDR10_to_SDR_%SDR_target_nits%nits_%tone_mapping_function%
if "%SDR%"=="y" if /i  "%P8BL%"=="y" set encodetype=_HDR10_to_SDR_%SDR_target_nits%nits_%tone_mapping_function%
if "%SDR%"=="y" if /i  "%P5BL%"=="y" set encodetype=_DVP5_to_SDR_%SDR_target_nits%nits_%tone_mapping_function%
if "%SDR%"=="y" if /i  "%HLGBL%"=="y" set encodetype=_HLG_to_SDR_%SDR_target_nits%nits_%tone_mapping_function%
if "%SDR%"=="y" if /i  "%P7BL%"=="y" set encodetype=_DV-FEL_to_SDR_%SDR_target_nits%nits_%tone_mapping_function%

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------AVISYNTH SCRIPTs-----------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:: measure frame to be looped
if "%SDR%"=="y" goto :skipmeasure
if not "%loop_mode%"=="YES" goto :skipmeasure
if not "%screenshot_OSD%"=="YES" goto :skipmeasure

if not  "%P7BL%"=="y" if not "%fileext%"==".avi" echo LoadPlugin("%ffms2%") > "%TEMP%scriptmeasure.avs"
if /i "%fileext%"==".avi"  echo AVISource("%filepath%%filename%%fileext%") > "%TEMP%scriptmeasure.avs"
if /i "%fileext%"==".avi"  echo ConvertToYUV420(matrix="2020") >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%") > "%TEMP%scriptmeasure.avs" 
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%") > "%TEMP%scriptmeasure.avs" 
if /i  "%P7BL%"=="y" echo LoadPlugin("%DoViBaker%") >> "%TEMP%scriptmeasure.avs"
echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%TEMP%scriptmeasure.avs" 
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%scriptmeasure.avs" 

:: index
if not "%P7BL%"=="y" if not "%fileext%"==".avi" echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%TEMP%indexed.video.ffindex") >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo bl = DGSource("%TEMP%BL.dgi") >> "%TEMP%scriptmeasure.avs" 
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo el = DGSource("%TEMP%EL.dgi") >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo bl = FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex")  >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo el = FFVideoSource(%EL%, cachefile="%TEMP%EL.ffindex")  >> "%TEMP%scriptmeasure.avs"

::baker process
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo DoViBaker(bl, el, rpu=%P7RPU%) >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo DoViBaker(bl, el) >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo ConvertToYUV420(matrix="2020") >> "%TEMP%scriptmeasure.avs"

if not  "%P5BL%"=="y" if not  "%P7BL%"=="y" if not  "%HLGBL%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36") >> "%TEMP%scriptmeasure.avs"

:: HLH or p5 to HDR10
if /i  "%HLGBL%"=="y" echo ConvertBits(16) >> "%TEMP%scriptmeasure.avs"
if /i  "%P5BL%"=="y" echo ConvertBits(16) >> "%TEMP%scriptmeasure.avs"
if /i  "%P5BL%"=="y" echo libplacebo_Tonemap(src_csp=3, dst_csp=1) >> "%TEMP%scriptmeasure.avs"
if /i  "%HLGBL%"=="y" echo libplacebo_Tonemap(src_csp=2, dst_csp=1) >> "%TEMP%scriptmeasure.avs"
if /i  "%P5BL%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:full=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36") >> "%TEMP%scriptmeasure.avs"
if /i  "%HLGBL%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36") >> "%TEMP%scriptmeasure.avs"

echo Trim(%frame1%, %frame1%) >> "%TEMP%scriptmeasure.avs"
echo.
echo =====================================SCRIPT========================================================
type  "%TEMP%scriptmeasure.avs"
echo ====================================================================================================
echo.
set MaxFALLBL=
set MaxCLLBL=
:: measure
    echo Measuring frame %frame1%...
    "%ffmpeg_path%" -i "%TEMP%scriptmeasure.avs" -vf select='eq(n\,0^)' -vframes 1 -compression_level 0 -y "%TEMP%Frame_%frame1%.png" 2> nul
    for /f "tokens=1" %%a in ('python "%~dp0tools\Measure_HDR.py" -i "%TEMP%Frame_%frame1%.png"') do (
        if not defined MaxCLLBL set "MaxCLLBL=%%a"
        if defined MaxCLLBL set "MaxFALLBL=%%a"
    )
)
echo.
echo MaxCLL= %MaxCLLBL%nits
echo MaxFALL= %MaxFALLBL%nits
echo.
:skipmeasure
::=====================================================================================================================================================================
::=========================================================video script=================================================================================================
::=====================================================================================================================================================================
if "%job%"=="8.2.7" goto :AQ.TEST

::tools/plugin
if not  "%P7BL%"=="y" if not "%fileext%"==".avi" echo LoadPlugin("%ffms2%") > "%TEMP%script.avs" 
if /i "%fileext%"==".avi"  echo AVISource("%filepath%%filename%%fileext%") > "%TEMP%scriptmeasure.avs"
if /i "%fileext%"==".avi"  echo ConvertToYUV420(matrix="2020") >> "%TEMP%scriptmeasure.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%") > "%TEMP%script.avs" 
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%") > "%TEMP%script.avs" 
if /i  "%P7BL%"=="y" echo LoadPlugin("%DoViBaker%") >> "%TEMP%script.avs"
echo LoadPlugin("%~dp0tools\avs_libplacebo.dll") >> "%TEMP%script.avs" 
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll") >> "%TEMP%script.avs" 

:: index
if not "%P7BL%"=="y" if not "%fileext%"==".avi" echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%TEMP%indexed.video.ffindex") >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo bl = DGSource("%TEMP%BL.dgi") >> "%TEMP%script.avs" 
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo el = DGSource("%TEMP%EL.dgi") >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo bl = FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex")  >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo el = FFVideoSource(%EL%, cachefile="%TEMP%EL.ffindex")  >> "%TEMP%script.avs"

::baker process
if /i  "%P7BL%"=="y" if not "%SDR%"=="y" echo SetFilterMTMode("DoViBaker",2)  >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo DoViBaker(bl, el, rpu=%P7RPU%) >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo DoViBaker(bl, el) >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if "%SDR%"=="y" echo %Prefetch% >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="rgb:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"

::tonemap
if "%SDR%"=="y" echo ConvertBits(16) >> "%TEMP%script.avs"
if "%SDR%"=="y" echo libplacebo_Tonemap(src_csp=%inCS%, dst_csp=0, dst_max=%SDR_target_nits%, dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%") >> "%TEMP%script.avs"
if "%SDR%"=="y" echo ConvertToYUV420(matrix="709") >> "%TEMP%script.avs"
if "%SDR%"=="y" echo ConvertBits(10) >> "%TEMP%script.avs"

:: HLH or p5 to HDR10
if /i  "%HLGBL%"=="y" if not "%SDR%"=="y" echo ConvertBits(16) >> "%TEMP%script.avs"
if /i  "%P5BL%"=="y" if not "%SDR%"=="y" echo ConvertBits(16) >> "%TEMP%script.avs"
if /i  "%P5BL%"=="y" if not "%SDR%"=="y" echo libplacebo_Tonemap(src_csp=3, dst_csp=1) >> "%TEMP%script.avs"
if /i  "%HLGBL%"=="y" if not "%SDR%"=="y" echo libplacebo_Tonemap(src_csp=2, dst_csp=1) >> "%TEMP%script.avs"
if /i  "%P5BL%"=="y" if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"
if /i  "%HLGBL%"=="y" if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:limited=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"

::prefetch
if /i  "%P7BL%"=="y" if not "%SDR%"=="y" echo %Prefetch% >> "%TEMP%script.avs"
if /i  "%P7BL%"=="y" if "%SDR%"=="y" if "%Encoder%"=="X264" echo Prefetch(2) >> "%TEMP%script.avs"
if /i  "%HDR%"=="y" if not  "%P7BL%"=="y" if "%SDR%"=="y" echo Prefetch(2) >> "%TEMP%script.avs"
if /i  "%P5BL%"=="y" echo Prefetch(2) >> "%TEMP%script.avs"
if /i  "%HLGBL%"=="y" echo Prefetch(2) >> "%TEMP%script.avs"
if "%SDR%"=="y" if /i  "%P7BL%"=="y" echo Prefetch(2) >> "%TEMP%script.avs"

:: SDR to HDR 100nits
if "%job%"=="8.6.5" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="709:709:709:l=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left") >> "%TEMP%script.avs"

::crop and/or downscale
if /i "%crop%"=="y" echo Crop(%right%, %top%, -%left%, -%bottom%) >> "%TEMP%script.avs"
if /i "%downscale%"=="YES" echo %upscale_algo%Resize(Width / 2, Height / 2) >> "%TEMP%script.avs"	

::loop MODE
if /i  "%P7BL%"=="y" set FELBAKED3=BL+FEL
if /i "%loop_mode%"=="YES" if /i "%screenshot_OSD%"=="YES" echo     subtitle("%filename% %FELBAKED3%", size=30, align=7, 10, 25, text_color=$606060^)\>> "%TEMP%script.avs"
if /i "%loop_mode%"=="YES" if /i "%screenshot_OSD%"=="YES" echo     subtitle("Frame: %frame1%", size=30, align=7, 10, 55, text_color=$606060^)\  >> "%TEMP%script.avs"
if /i "%loop_mode%"=="YES" if /i "%screenshot_OSD%"=="YES" if not "%SDR%"=="y" echo     subtitle("Measurement MAX/AVG: %MaxCLLBL%nits / %MaxFALLBL%nits ", size=30, align=7, 10, 85, text_color=%osdcolor%^)\  >> "%TEMP%script.avs"
if /i "%loop_mode%"=="YES" if /i "%screenshot_OSD%"=="YES" if not "%SDR%"=="y" if not "%HDR%"=="y" echo     subtitle("RPU Level 1 MAX/AVG: %L1maxosd%nits / %L1avgosd%nits ", size=30, align=7, 10, 115, text_color=%osdcolor%^)  >> "%TEMP%script.avs"
if /i "%loop_mode%"=="YES" echo Trim(%frame1%, %frame1%).Loop(%frame_loop%)  >> "%TEMP%script.avs"

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------ENCODE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

::---------------------------------------prores----------------------------------------------------------------------
if not "%job%"=="8.6.3" if not "%job%"=="8.6.5" if not "%job%"=="8.6.4" if not "%job%"=="8.2.6" goto :skipproresencode

	 echo.
	 echo =============================SCRIPT==============================================================================
	 type  "%TEMP%script.avs"
	 echo =================================================================================================================
	 echo.
	 echo ============================COMMAND==============================================================================
	 echo INPUT:  "%filepath%%filename%%fileext%"
	 echo "%ffmpeg_path%" -i "%TEMP%script.avs" %PRORES_settings% -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -loglevel error -stats
	 echo =================================================================================================================
	 echo.
	 if /i "%loop_mode%"=="YES" set framecount1=%frame_loop%
	 echo frame=%frameCount1% (total)
	 
if "%job%"=="8.6.3" "%ffmpeg_path%" -i "%TEMP%script.avs" %PRORES_settings% -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -loglevel error -stats "%output_path%%filename%_prores.422%encodetype%.mov" & goto :end
if "%job%"=="8.6.5" "%ffmpeg_path%" -i "%TEMP%script.avs" %PRORES_settings% -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -loglevel error -stats "%output_path%%filename%_SDR_to_HDR_100nits.mov" & goto :end
if "%job%"=="8.6.4" goto :100nitstrim
if "%job%"=="8.2.6" "%ffmpeg_path%" -i "%TEMP%script.avs" %PRORES_settings% -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -loglevel error -stats "%TEMP%%filename%_prores.422%encodetype%.mov" & set prores="%TEMP%%filename%_prores.422%encodetype%.mov"& goto :P5encoding

:skipproresencode
if /i "%Encoder%"=="NVENC" goto :nvidia

::---------------------------------------X265 / X264---------------------------------------------------------------------

:: hevc or avc settings
if not "%SDR%"=="y" set settings=%X265_HDR_settings%
if "%SDR%"=="y" if /i "%Encoder%"=="X265" set settings=%X265_SDR_settings%
if "%SDR%"=="y" if /i "%Encoder%"=="X264" set settings=%X264_SDR_settings%
if "%x265x264_mode%"=="0" set x265x264_target=--crf %x265x264_CRF%
if "%x265x264_mode%"=="1" set x265x264_target=--bitrate %x265x264_bitrate%
set out_ext=hevc
if /i "%Encoder%"=="X264" set out_ext=264
if /i "%Encoder%"=="X264" set container=MKV
if /i "%Encoder%"=="X264" set encoder_path=%x264_path%& set defineinput=
if /i "%Encoder%"=="X265" set encoder_path=%x265_path%& set defineinput=--input

::logs
if /i "%encode_log%"=="YES" echo =====================================INPUT===================================== > "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" echo "%filepath%%filename%%fileexte%" >> "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt" 

if /i "%encode_log%"=="YES" echo =====================================SCRIPT==================================== >> "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" type "%TEMP%script.avs" >> "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt"

if /i "%encode_log%"=="YES" echo ===================================SETTINGS=================================== >> "%output_path%%filename%%encodetype%_LOG.txt"
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt" 
if /i "%encode_log%"=="YES" echo %settings% %static_metadata% %P8RPU% --input "%TEMP%script.avs" --output "%output_path%%filename%%encodetype%.%out_ext%" >> "%output_path%%filename%%encodetype%_LOG.txt"
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt"

if /i "%encode_log%"=="YES" echo ======================================X265====================================== >> "%output_path%%filename%%encodetype%_LOG.txt"
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt"

	 echo.
	 echo =============================SCRIPT==============================================================================
	 type  "%TEMP%script.avs"
	 echo INPUT:  "%filepath%%filename%%fileext%"
	 echo =================================================================================================================
	 echo.

if not "%encode_log%"=="YES" if not "%x265x264_mode%"=="2" echo on
if not "%encode_log%"=="YES" if not "%x265x264_mode%"=="2" "%encoder_path%" %x265x264_target% --preset %x265x264_speed% %settings% %static_metadata% %P8RPU% %defineinput% "%TEMP%script.avs" --output "%output_path%%filename%%encodetype%.%out_ext%"
@echo off
if not "%encode_log%"=="YES" if "%x265x264_mode%"=="2" echo on
if not "%encode_log%"=="YES" if "%x265x264_mode%"=="2" "%encoder_path%" --pass 1 --bitrate %x265x264_bitrate% --preset %x265x264_speed% %settings% %static_metadata% %P8RPU% %defineinput% "%TEMP%script.avs" --stats "%TEMP%%filename%.stats" --output NUL
if not "%encode_log%"=="YES" if "%x265x264_mode%"=="2" echo \033[92mStarting Pass Two... | "%cmdcolor%" 
if not "%encode_log%"=="YES" if "%x265x264_mode%"=="2" "%encoder_path%" --pass 2 --bitrate %x265x264_bitrate% --preset %x265x264_speed% %settings% %static_metadata% %P8RPU% %defineinput% "%TEMP%script.avs" --stats "%TEMP%%filename%.stats" --output "%output_path%%filename%%encodetype%.%out_ext%"
@echo off

if /i "%encode_log%"=="YES" if not "%x265x264_mode%"=="2" echo on
if /i "%encode_log%"=="YES" if not "%x265x264_mode%"=="2" "%encoder_path%" %x265x264_target% --preset %x265x264_speed% %settings% %static_metadata% %P8RPU% %defineinput% "%TEMP%script.avs" --output "%output_path%%filename%%encodetype%.%out_ext%" 2>&1 | PowerShell -Command "$input | Tee-Object -Variable 'log'; $log | Out-File \"$('%output_path%%filename%%encodetype%_LOG.txt' -replace '\\','\\')\" -Append -Encoding ASCII; $log"
@echo off
if /i "%encode_log%"=="YES" if "%x265x264_mode%"=="2" echo on
if /i "%encode_log%"=="YES" if "%x265x264_mode%"=="2" "%encoder_path%" --pass 1 --bitrate %x265x264_bitrate% --preset %x265x264_speed% %settings% %static_metadata% %P8RPU% %defineinput% "%TEMP%script.avs" --stats "%TEMP%%filename%.stats" --output NUL 2>&1 | PowerShell -Command "$input | Tee-Object -Variable 'log'; $log | Out-File \"$('%output_path%%filename%%encodetype%_LOG.txt' -replace '\\','\\')\" -Append -Encoding ASCII; $log"
if /i "%encode_log%"=="YES" if "%x265x264_mode%"=="2" echo \033[92mStarting Pass Two... | "%cmdcolor%" 
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt"
if /i "%encode_log%"=="YES" echo Starting Pass Two...  >> "%output_path%%filename%%encodetype%_LOG.txt"
if /i "%encode_log%"=="YES" echo. >> "%output_path%%filename%%encodetype%_LOG.txt"
if /i "%encode_log%"=="YES" if "%x265x264_mode%"=="2" "%encoder_path%"  --pass 2 --bitrate %x265x264_bitrate%  --preset %x265x264_speed% %settings% %static_metadata% %P8RPU% %defineinput% "%TEMP%script.avs" --stats "%TEMP%%filename%.stats" --output "%output_path%%filename%%encodetype%.%out_ext%" 2>&1 | PowerShell -Command "$input | Tee-Object -Variable 'log'; $log | Out-File \"$('%output_path%%filename%%encodetype%_LOG.txt' -replace '\\','\\')\" -Append -Encoding ASCII; $log"

@echo off
if /i "%loop_mode%"=="NO" goto :skiploopmuxing
::mux looped file
if /i "%P8RPU%"=="" "%mkvmerge_path%" --output ^"%output_path%%filename%_%MaxCLLBL%nits_HDR10_Frame_%frame1%_LOOP.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%output_path%%filename%%encodetype%.%out_ext%^" ^"^)^"& goto :nomp4box
"%mp4box2_path%" -add "%output_path%%filename%%encodetype%.%out_ext%":name=:hdr=none:dvp=8.1:fps=%FPS% -tmp "%TEMP:~0,-1%" -brand mp43isom -ab dby1 "%output_path%%filename%_%MaxCLLBL%nits_DoVi_Frame_%frame1%_LOOP.mp4"
::make HDR10 version
"%ffmpeg_path%" -i "%output_path%%filename%_%MaxCLLBL%nits_DoVi_Frame_%frame1%_LOOP.mp4" -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | "%dovi_tool_path%" demux -
del "%output_path%EL.hevc"
"%mkvmerge_path%" --output ^"%output_path%%filename%_%MaxCLLBL%nits_HDR10_Frame_%frame1%_LOOP.mkv^" %mkvtoolnix_settings%  --default-duration 0:24000/1001p ^"^(^" ^"%output_path%BL.hevc^" ^"^)^"
del "%output_path%BL.hevc"

:nomp4box
del "%output_path%%filename%%encodetype%.%out_ext%"

for /l %%i in (2,1,%frame_toexp%) do (
if "!f%%i!"=="y" set frame1=!frame%%i!& set f%%i=n& goto :loop.again
)
goto :end2
:skiploopmuxing
set HDR="%output_path%%filename%%encodetype%.%out_ext%"& goto :MUXER

::---------------------------------------NVIDIA------------------------------------------------------------------

:nvidia
:: NVenc gpu encoding (nvidia)
if not "%SDR%"=="y" set settings=%NVENC_HDR_settings%
if "%SDR%"=="y" set settings=%NVENC_SDR_settings%

echo on
"%nvenc_path%" %settings% %static_metadata% %P8RPU% -i "%TEMP%script.avs" -o "%output_path%%filename%_GPU_encoded%encodetype%.hevc" & echo off & set HDR="%output_path%%filename%_GPU_encoded%encodetype%.hevc"& goto :MUXER

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------100 nits trim delivery-------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:100nitstrim
"%ffmpeg_path%" -i "%TEMP%script.avs" %PRORES_settings% -qscale:v %qscale% -color_primaries bt2020 -color_trc smpte2084 -colorspace bt2020nc -loglevel error -stats "%TEMP%%filename%_prores.422%encodetype%.mov" & set prores="%TEMP%%filename%_prores.422%encodetype%.mov"
:: prores deliver trim
if not exist "%TEMP%P8.RPU.bin" echo Input doesnt have DV trim pass. & pause & exit

"%mediainfo_path%" %prores% --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
set framereatechange=
if "%FPS%"=="24.000" set framereatechange=--rate 24
if "%FPS%"=="25.000" set framereatechange=--rate 25
if "%FPS%"=="29.970" set framereatechange=--rate 30000/1001
if "%FPS%"=="30.000" set framereatechange=--rate 30
if "%FPS%"=="50.000" set framereatechange=--rate 50
if "%FPS%"=="59.940" set framereatechange=--rate 60000/1001
if "%FPS%"=="60.000" set framereatechange=--rate 60
:: rpu to xml
"%RPU.to.XML%" convert "%TEMP%P8.RPU.bin" "%TEMP%DV.xml" %frameratechange% %framereatechange% --size %Width%x%Height%
echo.

"%cm_offline_path%" -m "%TEMP%DV.xml"  --show-targets
echo Which trim (target ID) ^do you want to deliver^? (default = 1)& set /p CMOFFLINE.TARGET=
if [%CMOFFLINE.TARGET%]==[] set CMOFFLINE.TARGET=1
echo.

if /i "%CM_CPU%"=="YES" set cpu.only=--cpu-only

if "%FPS%"=="%%a" set FPS=23.976
if "%FPS%"=="" set FPS=23.976
if "%FPS%"=="23.976" set FPS=24000/1001
if "%FPS%"=="23.974" set FPS=24000/1001
if "%FPS%"=="23.975" set FPS=24000/1001
if "%FPS%"=="23.977" set FPS=24000/1001
if "%FPS%"=="23.978" set FPS=24000/1001
if "%FPS%"=="23.979" set FPS=24000/1001
if "%FPS%"=="24.000" set FPS=24
if "%FPS%"=="25.000" set FPS=25
if "%FPS%"=="29.970" set FPS=30000/1001
if "%FPS%"=="30.000" set FPS=30
if "%FPS%"=="50.000" set FPS=50
if "%FPS%"=="59.940" set FPS=60000/1001
if "%FPS%"=="60.000" set FPS=60

MD "%output_path%\%filename%_1\"
::encode pq prores to SDR prores
"%cm_offline_path%" -m "%TEMP%DV.xml" -r %FPS% --targ %CMOFFLINE.TARGET% --quicktime-codec prores_422_hq %prores% %cpu.only% "%output_path%\%filename%_1\%filename%_TRIM_prores.mov"

if exist "%output_path%\%filename%_1\%filename%_TRIM_prores.mov" move "%output_path%\%filename%_1\%filename%_TRIM_prores.mov" "%output_path%" > nul
if exist "%output_path%\%filename%_TRIM_prores.mov" rmdir /Q /S "%output_path%\%filename%_1"

if /i "%keep_prores%"=="YES" if exist "%TEMP%_prores.422.HDR_FEL_BAKED.mov" move "%TEMP%_prores.422.HDR_FEL_BAKED.mov" "%output_path%" > nul
if /i "%keep_prores%"=="YES" if exist "%TEMP%%filename%_prores.422.HDR.mov" move "%TEMP%%filename%_prores.422.HDR.mov" "%output_path%" > nul
goto :end

::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------P5---------------------------------------------------------------------------------------------------------------------------------------------------------------
::-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

:P5encoding

set bitrate.for.vbr=--data-rate %DEE_P5_bitrate%

::------------------------------RAW input------------------------------------------------------

if not "%raw.input%"=="y" goto :skip.raw.input
set output.resolution=scale=%Width%:%Height%
if /i "%crop%"=="y" (
        set /a w.total=%left%+%right%
        set /a h.total=%top%+%bottom%
)
if /i "%crop%"=="y" (
        set /a Width2=%Width%-%w.total%
        set /a Height2=%Height%-%h.total%
)
if /i "%crop%"=="y" set output.resolution=crop=%Width2%:%Height2%

goto :skip.noneraw.input

::------------------------------non-RAW input------------------------------------------------------
:skip.raw.input

"%mediainfo_path%" %prores% --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width2.txt"
"%mediainfo_path%" %prores% --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height2.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Width2.txt"') do (
    set "Width2=%%a"
)
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Height2.txt"') do (
    set "Height2=%%a"
)

set output.resolution=scale=%Width2%:%Height2%
set size=--size %Width2%x%Height2%
:skip.noneraw.input

::--------------------------------------------set dee settings--------------------------------------------

python "%~dp0tools\DEE_crop.py" -i "%DEE_python_P5_script%" -e %output.resolution% >Nul

if /i  "%DEE_CRF%"=="YES" (
         set DEE_pass=1& set bitrate.for.vbr=
		 python "%~dp0tools\DEE_settings.py" -i "%DEE_python_P5_script%" -e %DEE_CRF_settings% >Nul
)


"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "FPS=%%a"
)
set framereatechange=
if "%FPS%"=="24.000" set framereatechange=--rate 24
if "%FPS%"=="25.000" set framereatechange=--rate 25
if "%FPS%"=="29.970" set framereatechange=--rate 30000/1001
if "%FPS%"=="30.000" set framereatechange=--rate 30
if "%FPS%"=="50.000" set framereatechange=--rate 50
if "%FPS%"=="59.940" set framereatechange=--rate 60000/1001
if "%FPS%"=="60.000" set framereatechange=--rate 60

if /i "%xml_input%"=="y" "%dovi_tool_path%" generate --xml %XML% --canvas-width %Width% --canvas-height %Height% --rpu-out "%TEMP%P8.RPU.bin" & set RPUforP5="%TEMP%P8.RPU.bin"
if not "%raw.input%"=="y" if /i "%xml_input%"=="y" if /i "%crop%"=="y" "%dovi_tool_path%" editor -i "%TEMP%P8.RPU.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%P8.RPUcrop.bin" & set RPUforP5="%TEMP%P8.RPUcrop.bin"

"%RPU.to.XML%" convert %RPUforP5% "%TEMP%%filename%_DV.xml" %framereatechange% %size%
if NOT ["%errorlevel%"]==["0"] echo No Dolby Vision metadata found... & pause & exit
set XML="%TEMP%%filename%_DV.xml"

if "%FPS%"=="%%a" set FPS=23.976
if "%FPS%"=="" set FPS=23.976
if "%FPS%"=="23.974" set FPS=23.976
if "%FPS%"=="23.975" set FPS=23.976
if "%FPS%"=="23.977" set FPS=23.976
if "%FPS%"=="23.978" set FPS=23.976
if "%FPS%"=="23.979" set FPS=23.976
if "%FPS%"=="24.000" set FPS=24
if "%FPS%"=="25.000" set FPS=25
if "%FPS%"=="29.970" set FPS=29.970
if "%FPS%"=="30.000" set FPS=30
if "%FPS%"=="50.000" set FPS=50
if "%FPS%"=="59.940" set FPS=59.940
if "%FPS%"=="60.000" set FPS=60

::------------------------------encode---------------------------------------------------------------

:: encode jpeg2000 mxf input
if not "%fileext%"==".mxf" goto :skipmxf
           python "%DEE_python_P5_script%" -i "%filepath%%filename%%fileext%" --input-format jpeg2000_mxf:range=auto:framerate=%FPS% -m %XML% --temp "%TEMP:~0,-1%" --ffmpeg "%ffmpeg_path%" --preset %DEE_P5_preset% --encoder-pass-num %DEE_pass% %bitrate.for.vbr% --mdpp none  --data-stream 1 --progress 1 --overwrite 1 --output "%output_path%%filename%_jpeg2000.P5.DV.h265"
           set final="%output_path%%filename%_jpeg2000.P5.DV.h265"
		   goto :skipprores
		   
:skipmxf

::encode prores
python "%DEE_python_P5_script%" -i %prores% --input-format prores_mov:range=auto:trackid=-1:framerate=%FPS% -m %XML% --temp "%TEMP:~0,-1%" --ffmpeg "%ffmpeg_path%" --preset %DEE_P5_preset% --encoder-pass-num %DEE_pass%  %bitrate.for.vbr% --mdpp none  --data-stream 1 --progress 1 --overwrite 1 --output "%output_path%%filename%.P5.DV.h265"
set final="%output_path%%filename%.P5.DV.h265"& set HDR="%output_path%%filename%.P5.DV.h265"

:skipprores
if not "%raw.input%"=="y" goto :skiprawcrop
if not  "%crop%"=="y" goto :skiprawcrop

::crop L5
echo.
        echo \033[92mCropping RPU... | "%cmdcolor%"
        "%dovi_tool_path%" extract-rpu %final% -o "%TEMP%%filename%_RPU.bin"
        "%dovi_tool_path%" editor -i "%TEMP%%filename%_RPU.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%cropped.bin" >Nul
		echo Done.
		echo.
:: get original rpu mdl and maxcll/fall
"%dovi_tool_path%" info -s "%TEMP%cropped.bin" >"%TEMP%sum.rpu.json"
type "%TEMP%sum.rpu.json" | findstr L1 > "%TEMP%L1.txt"
for /f "tokens=4 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxcll_path=%%a"
)
for /f "tokens=6 delims=(:.)" %%a in ('type "%TEMP%L1.txt"') do (
    set "maxfall_path=%%a"
)


type "%TEMP%sum.rpu.json" | findstr "RPU mastering display:" > "%TEMP%L1m.txt"
for /f "tokens=3 delims=(/n)" %%a in ('type "%TEMP%L1m.txt"') do (
    set "MDL.max_path=%%a"
)
for /f "tokens=2 delims=(./)" %%a in ('type "%TEMP%L1m.txt"') do (
    set "MDL.min_path=%%a"
)

set MDL.min_path=%MDL.min_path:0=%
if "%MDL.min_path%"=="5" set MDL.min_path=50
if "%MDL.min_path%"=="2" set MDL.min_path=20

:: generate l6 json and edit the rpu
echo { > "%TEMP%L6.json"
echo    "level6": { >> "%TEMP%L6.json"
echo        "max_display_mastering_luminance": %MDL.max_path%, >> "%TEMP%L6.json"
echo        "min_display_mastering_luminance": %MDL.min_path%, >> "%TEMP%L6.json"
echo        "max_content_light_level": %maxcll_path%, >> "%TEMP%L6.json"
echo        "max_frame_average_light_level": %maxfall_path% >> "%TEMP%L6.json"
echo    } >> "%TEMP%L6.json"
echo } >> "%TEMP%L6.json"

echo \033[92mEditing L6... MDL_Min=%MDL.min_path%, MDL_Max=%MDL.max_path%, MaxCLL=%maxcll_path%, MaxFALL=%maxfall_path% | "%cmdcolor%"
"%dovi_tool_path%" editor -i "%TEMP%cropped.bin" -j "%TEMP%L6.json" --rpu-out "%TEMP%%filename%.P5.DV_cropped.bin" > nul
if NOT ["%errorlevel%"]==["0"] pause
echo Done.
echo.

echo.&echo.
echo \033[36m         ================ | "%cmdcolor%"
echo \033[36m         - INJECTING DV - | "%cmdcolor%"
echo \033[36m         ================ | "%cmdcolor%"
echo.
::inject cropped + L6 edited rpu
"%dovi_tool_path%" %dropH% inject-rpu -i %final% --rpu-in "%TEMP%%filename%.P5.DV_cropped.bin" -o "%output_path%%filename%.P5.DV_cropped.hevc"
if ["%errorlevel%"]==["0"] del %final%
set final="%output_path%%filename%.P5.DV_cropped.hevc"& set HDR="%output_path%%filename%.P5.DV_cropped.hevc"
:: copy final rpu to output path
if /i "%keep_rpu%"=="YES" copy /y "%TEMP%%filename%.P5.DV_cropped.bin" "%output_path%" > nul

goto :skip2ndcrop

:skiprawcrop
if /i "%downscale%"=="NO" goto :skip2ndcrop
         echo Adjusting L5 to 1080p...
        "%dovi_tool_path%" extract-rpu %final% -o "%TEMP%%filename%_RPU.bin"
        "%dovi_tool_path%" editor -i "%TEMP%%filename%_RPU.bin" -j "%TEMP%crop.json" --rpu-out "%TEMP%cropped.P5.RPU.bin" >Nul
		"%dovi_tool_path%" %dropH% inject-rpu -i %final% --rpu-in "%TEMP%cropped.P5.RPU.bin" -o "%output_path%%filename%.P5.DV_1080p.hevc"
		if ["%errorlevel%"]==["0"] del %final%
		set final="%output_path%%filename%.P5.DV_1080p.hevc"& set HDR="%output_path%%filename%.P5.DV_1080p.hevc"
		echo Done.

:skip2ndcrop

if "%raw.input%"=="y" if "%crop%"=="y" goto :skipfirstmerge
if not "%fileext%"==".mxf" if /i "%downscale%"=="NO" if "%FPS%"=="23.976" "%mkvmerge_path%" --output ^"%TEMP%fixframerate.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%output_path%%filename%.P5.DV.h265^" ^"^)^" & set final="%TEMP%fixframerate.mkv"& del "%output_path%%filename%.P5.DV.h265"

:skipfirstmerge
if "%raw.input%"=="y" if "%crop%"=="y" if /i "%downscale%"=="NO" if "%FPS%"=="23.976" "%mkvmerge_path%" --output ^"%TEMP%fixframerate.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%output_path%%filename%.P5.DV_cropped.hevc^" ^"^)^" & set final="%TEMP%fixframerate.mkv"& del "%output_path%%filename%.P5.DV_cropped.hevc"
if "%fileext%"==".mxf" if not "%crop%"=="y" if /i "%downscale%"=="NO" if "%FPS%"=="23.976" "%mkvmerge_path%" --output ^"%TEMP%fixframerate.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%output_path%%filename%_jpeg2000.P5.DV.h265^" ^"^)^" & set final="%TEMP%fixframerate.mkv"& del "%output_path%%filename%_jpeg2000.P5.DV.h265"
if "%FPS%"=="23.976" "%ffmpeg_path%" -vsync drop -i %final% -c copy -bsf:v hevc_metadata=tick_rate=24000/1001:num_ticks_poc_diff_one=1 "%output_path%%filename%.P5.DV.final.hevc"& set HDR="%output_path%%filename%.P5.DV.final.hevc"& del %final%
if "%FPS%"=="29.970" "%ffmpeg_path%" -vsync drop -i %final% -c copy -bsf:v hevc_metadata=tick_rate=30000/1001:num_ticks_poc_diff_one=1 "%output_path%%filename%.P5.DV.final.hevc"& set HDR="%output_path%%filename%.P5.DV.final.hevc"& del %final%
if "%FPS%"=="59.940" "%ffmpeg_path%" -vsync drop -i %final% -c copy -bsf:v hevc_metadata=tick_rate=60000/1001:num_ticks_poc_diff_one=1 "%output_path%%filename%.P5.DV.final.hevc"& set HDR="%output_path%%filename%.P5.DV.final.hevc"& del %final%

:end

if not "%fileext%"==".mxf" if not "%fileext%"==".mov" if not "%job%"=="8.6.3" if not "%job%"=="8.6.4" if not "%job%"=="8.6.5" goto :MUXER

:end2
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::##################################################################################################################################################################################################
::######################################################################################## AQ TEST ###################################################################################################
::##################################################################################################################################################################################################

:AQ.TEST

:: hevc or avc settings
if not "%SDR%"=="y" set AQTESTsettings=%AQTEST.HDRsettings%
if "%SDR%"=="y" if /i "%Encoder%"=="X265" set AQTESTsettings=%AQTEST.SDRsettings%
if /i "%Encoder%"=="X264"set AQTESTsettings=%AQTEST.X264settings%
set x265x264_target=--crf %x265x264_CRF%
if "%x265x264_mode%"=="1" echo two pass encoding not supported for this mode... Will do CRF...
set out_ext=hevc
if /i "%Encoder%"=="X264" set out_ext=264
if /i "%Encoder%"=="X264" set container=MKV
if /i "%Encoder%"=="X264" set encoder_path=%x264_path%& set defineinput=
if /i "%Encoder%"=="X265" set encoder_path=%x265_path%& set defineinput=--input

::tools/plugin
for /L %%i in (1,1,%AQframes%) do (
    if /i "%fileext%"==".avi" echo AVISource("%filepath%%filename%%fileext%"^) >> "%TEMP%script%%i.avs"
	if /i "%fileext%"==".avi" echo ConvertToYUV420(matrix="2020"^) >> "%TEMP%script%%i.avs"
    if not "%fileext%"==".avi" if not "%P7BL%"=="y" echo LoadPlugin("%ffms2%"^) > "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo LoadPlugin("%ffms2%"^) > "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo LoadPlugin("%DGDecodeNV.dll%"^) > "%TEMP%script%%i.avs"

    if /i "%P7BL%"=="y" echo LoadPlugin("%DoViBaker%"^) >> "%TEMP%script%%i.avs"
    echo LoadPlugin("%~dp0tools\avs_libplacebo.dll"^) >> "%TEMP%script%%i.avs"
    echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%script%%i.avs"

    if not "%P7BL%"=="y" if not "%fileext%"==".avi" echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%TEMP%indexed.video.ffindex"^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo bl = DGSource("%TEMP%BL.dgi"^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo el = DGSource("%TEMP%EL.dgi"^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo bl = FFVideoSource(%BL%, cachefile="%TEMP%BL.ffindex"^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo el = FFVideoSource(%EL%, cachefile="%TEMP%EL.ffindex"^) >> "%TEMP%script%%i.avs"

    if /i "%P7BL%"=="y" if not "%SDR%"=="y" echo SetFilterMTMode("DoViBaker",2^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="NO" echo DoViBaker(bl, el, rpu=%P7RPU%^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if /i "%force_ffms2%"=="YES" echo DoViBaker(bl, el^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if "%SDR%"=="y" echo Prefetch(8^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="rgb:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%script%%i.avs"
	
    if "%SDR%"=="y" echo ConvertBits(16^) >> "%TEMP%script%%i.avs"
    if "%SDR%"=="y" echo libplacebo_Tonemap(src_csp=%inCS%, dst_csp=0, dst_max=%SDR_target_nits%, dynamic_peak_detection=%peak_detect%, smoothing_period=%smoothing_period%, percentile=%percentile%, tone_mapping_function="%tone_mapping_function%", gamut_mapping_mode="%gamut_mapping_mode%"^) >> "%TEMP%script%%i.avs"
    if "%SDR%"=="y" echo ConvertToYUV420(matrix="709"^) >> "%TEMP%script%%i.avs"
    if "%SDR%"=="y" echo ConvertBits(10^) >> "%TEMP%script%%i.avs"

    if /i "%HLGBL%"=="y" if not "%SDR%"=="y" echo ConvertBits(16^) >> "%TEMP%script%%i.avs"
    if /i "%P5BL%"=="y" if not "%SDR%"=="y" echo ConvertBits(16^) >> "%TEMP%script%%i.avs"
    if /i "%P5BL%"=="y" if not "%SDR%"=="y" echo libplacebo_Tonemap(src_csp=3, dst_csp=1^) >> "%TEMP%script%%i.avs"
    if /i "%HLGBL%"=="y" if not "%SDR%"=="y" echo libplacebo_Tonemap(src_csp=2, dst_csp=1^) >> "%TEMP%script%%i.avs"
    if /i "%P5BL%"=="y" if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:full=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left"^) >> "%TEMP%script%%i.avs"
    if /i "%HLGBL%"=="y" if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="YUV420P10",colorspace_op="2020ncl:st2084:2020:limited=>2020ncl:st2084:2020:limited",dither_type="error_diffusion",chromaloc_op="left=>top_left"^) >> "%TEMP%script%%i.avs"

    if /i "%P7BL%"=="y" if not "%SDR%"=="y" echo Prefetch(8^) >> "%TEMP%script%%i.avs"
    if /i "%P7BL%"=="y" if "%SDR%"=="y" if "%Encoder%"=="X264" echo Prefetch(2^) >> "%TEMP%script%%i.avs"
    if /i "%HDR%"=="y" if not "%P7BL%"=="y" if "%SDR%"=="y" echo Prefetch(2^) >> "%TEMP%script%%i.avs"
    if /i "%P5BL%"=="y" echo Prefetch(2^) >> "%TEMP%script%%i.avs"
    if /i "%HLGBL%"=="y" echo Prefetch(2^) >> "%TEMP%script%%i.avs"
    if "%SDR%"=="y" if /i "%P7BL%"=="y" echo Prefetch(2^) >> "%TEMP%script%%i.avs"

    if /i "%crop%"=="y" echo Crop(%right%, %top%, -%left%, -%bottom%^) >> "%TEMP%script%%i.avs"
    if /i "%downscale%"=="YES" echo %upscale_algo%Resize(Width / 2, Height / 2^) >> "%TEMP%script%%i.avs"
)
::make a script copy for source screenshots
for /L %%i in (1,1,%AQframes%) do (
copy "%TEMP%script%%i.avs" "%TEMP%script%%i_copie.avs" > Nul
ren "%TEMP%script%%i_copie.avs" "script_source%%i.avs" > Nul
)
::add trims and osd to source png
for /L %%i in (1,1,%AQframes%) do (
    if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%script_source%%i.avs"
	if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%script_source%%i.avs"
    echo  subtitle("SOURCE", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%script_source%%i.avs"
	echo  subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%script_source%%i.avs"
    echo Trim(!frame%%i!, !frame%%i!^) >> "%TEMP%script_source%%i.avs"
)
:: export source png
for /L %%i in (1,1,%AQframes%) do (
echo Exporting Source png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%script_source%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_SOURCE.png" 2>nul
)

::frames to encode
for /L %%i in (1,1,%AQframes%) do (
    echo Trim(!framestart%%i!, !frame%%i!^) >> "%TEMP%script%%i.avs"
)

::##########################  encode  #########################################################

for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value1% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value1% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value1%.video%%i.%out_ext%"
)
for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value2% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value2% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value2%.video%%i.%out_ext%"
)
for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value3% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value3% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value3%.video%%i.%out_ext%"
)
for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value4% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value4% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value4%.video%%i.%out_ext%"
)
for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value5% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value5% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value5%.video%%i.%out_ext%"
)
for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value6% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value6% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value6%.video%%i.%out_ext%"
)
for /L %%i in (1,1,%AQframes%) do (
echo.
echo Proccessing the scene of frame !frame%%i! at AQ %AQ.value7% (%%i of %AQframes%^)
echo.
"%encoder_path%" %x265x264_target% --preset %x265x264_speed% %AQTESTsettings% --aq-strength %AQ.value7% %static_metadata% --fps 24000/1001 %defineinput% "%TEMP%script%%i.avs" --output "%TEMP%AQ-%AQ.value7%.video%%i.%out_ext%"
)

::##########################  mux  #########################################################
echo.
echo Muxing...
echo.
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value1%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value1%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value2%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value2%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value3%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value3%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value4%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value4%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value5%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value5%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value6%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value6%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%mkvmerge_path%" --output ^"%TEMP%AQ-%AQ.value7%.video%%i.mkv^" --compression 0:none ^"^(^" ^"%TEMP%AQ-%AQ.value7%.video%%i.%out_ext%^" ^"^)^"  > Nul
)
echo.
echo Done...
echo.
::##########################  index  #########################################################

echo.
echo Indexing...
echo.
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value1%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value1%.video%%i.ffindex" > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value2%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value2%.video%%i.ffindex" > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value3%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value3%.video%%i.ffindex" > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value4%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value4%.video%%i.ffindex" > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value5%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value5%.video%%i.ffindex" > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value6%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value6%.video%%i.ffindex" > Nul
)
for /L %%i in (1,1,%AQframes%) do (
"%ffmsindex%" "%TEMP%AQ-%AQ.value7%.video%%i.mkv" -f "%TEMP%AQ-%AQ.value7%.video%%i.ffindex" > Nul
)
echo.
echo Done...
echo.
::##########################  screenshot scripts  #########################################################
echo.
echo Making the scripts for the screenshots...
echo.
::script for screenshot
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value1%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value1%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value1%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value1%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value1%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value1%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value1%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value1%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value1%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value1%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value1%.video%%i.avs"
)
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value2%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value2%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value2%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value2%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value2%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value2%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value2%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value2%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value2%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value2%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value2%.video%%i.avs"
)
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value3%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value3%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value3%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value3%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value3%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value3%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value3%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value3%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value3%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value3%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value3%.video%%i.avs"
)
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value4%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value4%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value4%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value4%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value4%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value4%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value4%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value4%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value4%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value4%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value4%.video%%i.avs"
)
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value5%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value5%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value5%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value5%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value5%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value5%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value5%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value5%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value5%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value5%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value5%.video%%i.avs"
)
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value6%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value6%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value6%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value6%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value6%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value6%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value6%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value6%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value6%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value6%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value6%.video%%i.avs"
)
for /L %%i in (1,1,%AQframes%) do (
echo LoadPlugin("%ffms2%"^) > "%TEMP%AQ-%AQ.value7%.video%%i.avs"
echo LoadPlugin("%~dp0tools\avsresize_r21\x64\Release\avsresize.dll"^) >> "%TEMP%AQ-%AQ.value7%.video%%i.avs" 
echo FFVideoSource("%TEMP%AQ-%AQ.value7%.video%%i.mkv", cachefile="%TEMP%AQ-%AQ.value7%.video%%i.ffindex"^) >> "%TEMP%AQ-%AQ.value7%.video%%i.avs"
if not "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="2020ncl:st2084:2020:limited=>rgb:st2084:2020:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36"^) >> "%TEMP%AQ-%AQ.value7%.video%%i.avs"
if  "%SDR%"=="y" echo z_ConvertFormat(pixel_type="RGBP16",colorspace_op="709:709:709:limited=>rgb:709:709:full",dither_type="error_diffusion",resample_filter="spline36",resample_filter_uv="spline36",chromaloc_op="left=>top_left"^) >> "%TEMP%AQ-%AQ.value7%.video%%i.avs"
echo     subtitle("Aq_Strength= %AQ.value7%", size=50, align=7, 10, 25, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value7%.video%%i.avs"
echo    subtitle("FRAME: !frame%%i! ", size=50, align=7, 10, 45, text_color=$606060^)\ >> "%TEMP%AQ-%AQ.value7%.video%%i.avs"
echo Trim(%AQ.sequence.frames%, %AQ.sequence.frames%^) >> "%TEMP%AQ-%AQ.value7%.video%%i.avs"
)
echo.
echo Done...
echo.
::##########################  Export screenshot  #########################################################

for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value1% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value1%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value1%.png" 2>nul
)
for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value2% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value2%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value2%.png" 2>nul
)
for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value3% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value3%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value3%.png" 2>nul
)
for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value4% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value4%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value4%.png" 2>nul
)
for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value5% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value5%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value5%.png" 2>nul
)
for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value6% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value6%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value6%.png" 2>nul
)
for /L %%i in (1,1,%AQframes%) do (
echo Exporting AQ-%AQ.value7% png frame: !frame%%i! (%%i of %AQframes%^)
 "%ffmpeg_path%" -i "%TEMP%AQ-%AQ.value7%.video%%i.avs" -vf select='eq(n,0^)' -vframes 1 -compression_level %pic_compression% -y "%output_path%!frame%%i!_AQ-%AQ.value7%.png" 2>nul
)

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. | "%cmdcolor%"
pause
exit

::##################################################################################################################################################################################################
::########################################################################################DEE####################################################################################################
::##################################################################################################################################################################################################

:: ---------------------------------------------------------MODE.R.--------------------------------------------------------------------------------------------------------------------------------------------------------
:MODE.M
echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       -   SELECT A WORKFLOW   - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.                                                           
echo 1) Workflow.1= FIND frame difference between two sources
echo 2) Workflow.2= Change Framerate or ^Color range bitstream
echo 3) Workflow.3= MKV Sample Maker
echo 4) Workflow.4= Find a video frame count
echo 5) Workflow.5= Subtitles_Tonemap (reduce SUP subtitles brightness)
echo 6) Workflow.6= Check audio Dialogue Normalization
echo 7) Workflow.7= Find Main Movie Playlist (BD MPLS)
echo 8) Workflow.8= 12-bit-PQ / Nits Converter
echo 9) Workflow.9= Go back to the main menu...

echo.
choice /C:123456789 /M Choice?

if ERRORLEVEL 9 (
goto :Main.Menu
)

if ERRORLEVEL 8 (
goto :MODE.8
)

if ERRORLEVEL 7 (
goto :MODE.7
)

if ERRORLEVEL 6 (
goto :MODE.6
)

if ERRORLEVEL 5 (
goto :MODE.5
)

if ERRORLEVEL 4 (
goto :MODE.4
)

if ERRORLEVEL 3 (
goto :MODE.3
)
if ERRORLEVEL 2 (
goto :MODE.2
)

if ERRORLEVEL 1 (
goto :MODE.1
)

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################


:MODE.1

echo.
echo \033[36m       ==================== | "%cmdcolor%"
echo \033[36m       - FRAME DIFFERENCE - | "%cmdcolor%"
echo \033[36m       ==================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- AUTO FAST: Export the first ^& middle frame of each shot for frames 6000 to 7500
echo -- AUTO FAST: Check for identical frames and calculate the frame difference. (does ^not tone map HDR)
echo -- AUTO FAST: Will try to calculate the difference but better rely on the png frame number instead.
echo -- MANUAL: will index each clip and open them in avspmod for manual verification
echo -- Input can be HEVC/AVC/MKV/TS/M2TS but must have at least 7500 frames (6min)
echo -- You can input a single file, it will just be indexed.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

if exist "%temp_folder%temp.folder7" rmdir /Q /S "%temp_folder%temp.folder7"

:: user input
echo "Drag and drop the first video file and press enter..."
set /p v1=
echo.
echo "(OPTIONAL) Drag and drop the second video file and press enter..."
set /p v2=
echo.

:: make and set temp folder
if exist "%temp_folder%temp.folder10_new" if exist "%temp_folder%temp.folder10" rmdir /Q /S "%temp_folder%temp.folder10_new" & rmdir /Q /S "%temp_folder%temp.folder10"
if exist "%temp_folder%temp.folder10" set E1=_new
MD "%temp_folder%temp.folder10%E1%"
set TEMP=%temp_folder%temp.folder10%E1%\

if [%v2%]==[] set manual=m& set full=s& goto :skip

echo Auto(a) or Manual(m) Verification^? (DEFAULT=a )
echo.
echo --^> AUTO= a 
echo --^> MANUAL= m
echo.
set /p manual=
if "%manual%"=="" set manual=a
if /i "%manual%"=="a" set manual=a
if /i "%manual%"=="m" set manual=m
if not "%manual%"=="a" if not "%manual%"=="m" set manual=a
echo.

:skip
:: make variable of input path and filename
Setlocal EnableDelayedExpansion
for %%i in (!v1!) do set filename=%%~ni
for %%i in (!v1!) do set filepath=%%~di%%~pi
for %%i in (!v1!) do set fileext=%%~xi
for %%i in (!v2!) do set filename_2=%%~ni
for %%i in (!v2!) do set filepath_2=%%~di%%~pi
for %%i in (!v2!) do set fileext_2=%%~xi
Setlocal DisableDelayedExpansion

if /i "%manual%"=="m" goto :manual.check

MD "%output_path%SCREENSHOTS\"

if  /i "%downscaleframediff%"=="NO" goto :skipdownsize1
::---------------------------------------------------------------------------------------------------------------------------------
::downscale to 1080p to speed up 2160p input one
set downscaleinput1=y
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width.txt"
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width.txt"') do (
    set "W=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height.txt"') do (
    set "H=%%a"
)

if %H% leq 1080 set downscaleinput1=n& goto :skipdownsize
set /a H=%H% / 2
set /a W=%W% / 2
set /a remainder1=%H% %% 2
set /a remainder2=%W% %% 2
if "%remainder1%"=="1" set /a H=%H% - 1
if "%remainder2%"=="1" set /a W=%W% - 1

:skipdownsize
::downscale to 1080p to speed up 2160p input two
set downscaleinput2=y
"%mediainfo_path%" "%filepath_2%%filename_2%%fileext_2%" --output=JSON > "%TEMP%mediainfo2.JSON"
"%mediainfo_path%" "%filepath_2%%filename_2%%fileext_2%" --output=Video;%%Width%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Width2.txt"
"%mediainfo_path%" "%filepath_2%%filename_2%%fileext_2%" --output=Video;%%Height%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Height2.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Width2.txt"') do (
    set "W2=%%a"
)
for /f "tokens=1 delims=" %%a in ('type "%TEMP%Height2.txt"') do (
    set "H2=%%a"
)
if %H2% leq 1080 set downscaleinput2=n& goto :skipdownsize1
set /a H2=%H2% / 2
set /a W2=%W2% / 2
set /a remainder3=%H2% %% 2
set /a remainder4=%W2% %% 2
if "%remainder3%"=="1" set /a H2=%H2% - 1
if "%remainder4%"=="1" set /a W2=%W2% - 1

:skipdownsize1
::---------------------------------------------------------------------------------------------------------------------------------

echo \033[92m making sample to speed up processing... | "%cmdcolor%"
"%mkvmerge_path%" --output ^"%output_path%SCREENSHOTS\%filename%_sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:25 > Nul
"%mkvmerge_path%" --output ^"%output_path%SCREENSHOTS\%filename_2%_sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath_2%%filename_2%%fileext_2%^" ^"^)^" --split parts:00:00:00-00:05:25 > Nul
echo Done.
:: V1 indexing, make sample from frame 6000 to 8000 and convert to prores
"%ffmsindex%" "%output_path%SCREENSHOTS\%filename%_sample.mkv" -f "%output_path%SCREENSHOTS\%filename%.ffindex"
echo LoadPlugin("%ffms2%") > "%output_path%SCREENSHOTS\%filename%.avs"
echo FFVideoSource("%output_path%SCREENSHOTS\%filename%_sample.mkv", cachefile="%output_path%SCREENSHOTS\%filename%.ffindex") >> "%output_path%SCREENSHOTS\%filename%.avs"
if /i "%downscaleframediff%"=="YES" if /i "%downscaleinput1%"=="y" echo BicubicResize(%W%, %H%) >> "%output_path%SCREENSHOTS\%filename%.avs"
echo trim(6000,7500) >> "%output_path%SCREENSHOTS\%filename%.avs"
"%ffmpeg_path%" -i "%output_path%SCREENSHOTS\%filename%.avs" -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v 10 -pix_fmt yuv422p10le -an -y -hide_banner -loglevel error -stats "%output_path%SCREENSHOTS\v1.mov"

:: V2 indexing, make sample from frame 6000 to 8000 and convert to prores
"%ffmsindex%" "%output_path%SCREENSHOTS\%filename_2%_sample.mkv" -f "%output_path%SCREENSHOTS\%filename_2%.ffindex"
echo LoadPlugin("%ffms2%") > "%output_path%SCREENSHOTS\%filename_2%.avs"
echo FFVideoSource("%output_path%SCREENSHOTS\%filename_2%_sample.mkv", cachefile="%output_path%SCREENSHOTS\%filename_2%.ffindex") >> "%output_path%SCREENSHOTS\%filename_2%.avs"
echo trim(6000,7500) >> "%output_path%SCREENSHOTS\%filename_2%.avs"
if /i "%downscaleframediff%"=="YES" if /i "%downscaleinput2%"=="y" echo BicubicResize(%W2%, %H2%) >> "%output_path%SCREENSHOTS\%filename_2%.avs"
"%ffmpeg_path%" -i "%output_path%SCREENSHOTS\%filename_2%.avs" -c:v prores_ks -profile:v 3 -vendor apl0 -qscale:v 10 -pix_fmt yuv422p10le -an -y -hide_banner -loglevel error -stats "%output_path%SCREENSHOTS\v2.mov"
set v1="%output_path%SCREENSHOTS\v1.mov"
set v2="%output_path%SCREENSHOTS\v2.mov"
set t=time -d 1500

::---------------------------------------------------------------------------------------------------------------------------------
echo.
echo \033[92m Detecting scene cuts and extracting PNG to output path for: "%filename%" | "%cmdcolor%"
::export frames from scene cuts
"%scenedetect_path%" --input %v1% %t% detect-adaptive save-images -m 0 -p -c 0 -n 2 -f $FRAME_NUMBER-v1 --output "%output_path%SCREENSHOTS" list-scenes --output "%output_path%SCREENSHOTS" >> "%TEMP%%filename%.txt"
echo Done.
echo.
echo \033[92m Detecting scene cuts and extracting PNG to output path for "%filename_2%" | "%cmdcolor%"
"%scenedetect_path%" --input %v2% %t% detect-adaptive save-images -m 0 -p -c 0 -n 2 -f $FRAME_NUMBER-v2 --output "%output_path%SCREENSHOTS" list-scenes --output "%output_path%SCREENSHOTS" >> "%TEMP%%filename_2%.txt"
echo Done.

setlocal enabledelayedexpansion
for /r "%output_path%SCREENSHOTS" %%a in (*.png) do (
    set "old_filename=%%~nxa"
    if not "!old_filename:v1=!" == "!old_filename!" (
        set "new_full_filename=!old_filename:v1=%filename%!"
        ren "%%a" "!new_full_filename!"
    )
)
for /r "%output_path%SCREENSHOTS" %%a in (*.png) do (
    set "old_filename_2=%%~nxa"
    if not "!old_filename_2:v2=!" == "!old_filename_2!" (
        set "new_full_filename_2=!old_filename_2:v2=%filename_2%!"
        ren "%%a" "!new_full_filename_2!"
    )
)
Setlocal DisableDelayedExpansion

echo.
echo \033[92m Now trying to find the frame difference... (may ^not find one or can throw an error but you can always check the exported frames...) | "%cmdcolor%"
echo.
::--------------------------------------------------------------------------------------------------------------------------------
::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------2nd try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-3 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::----------------------------------------------------3rd try-----------------------------------------------------------------------


::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul

for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-3 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-4 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------4th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-4 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-5 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------5th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-5 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-6 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------6th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-6 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-7 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------7th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-7 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-8 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------8th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-8 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-9 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------9th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-9 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-10 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff
::----------------------------------------------------- 10th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-10 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-11 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::----------------------------------------------------11th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-3 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-4 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------12th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-4 2>nul
if %num_lines% lss 8 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-5 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------13th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-5 2>nul
if %num_lines% lss 9 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-6 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------14th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-6 2>nul
if %num_lines% lss 10 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-7 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------15th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-7 2>nul
if %num_lines% lss 11 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-8 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------16th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-8 2>nul
if %num_lines% lss 12 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-9 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff

::-----------------------------------------------------17th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-9 2>nul
if %num_lines% lss 13 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-10 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul
if "%diff1%"=="%diff2%" goto :found.diff
::----------------------------------------------------- 18th try-----------------------------------------------------------------------

::check input 1
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-10 2>nul
if %num_lines% lss 14 goto :skip.more.try
for /f "skip=%num_lines% tokens=2 delims=," %%i in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene1=%%i & goto :done) 2>nul
:done
::check input 2
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-1 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%v in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene11=%%v & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v1-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-11 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%c in (%output_path%SCREENSHOTS\v1-Scenes.csv) do (set scene2=%%c & goto :done) 2>nul
:done
for /f %%a in ('type "%output_path%SCREENSHOTS\v2-Scenes.csv" ^| find /v /c ""') do set /a num_lines=%%a-2 2>nul
for /f "skip=%num_lines% tokens=2 delims=," %%r in (%output_path%SCREENSHOTS\v2-Scenes.csv) do (set scene12=%%r & goto :done) 2>nul
:done
set /a diff1=%scene1%-%scene11% 2>nul
set /a diff2=%scene2%-%scene12% 2>nul

:skip.more.try
if not "%diff1%"=="%diff2%" echo Couldnt find a difference, check the exported screenshots... & goto :skip.guessing

:found.diff
:: read and set fps, audio type , subs and resolution
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=Video;%%FrameRate%%\r\n ^
    *.ts *.mp4 *.mkv *.m2ts *.mov *.hevc *.h265 *.avi >"%TEMP%Framerate.txt"
for /f "tokens=1 delims=(,)" %%a in ('type "%TEMP%Framerate.txt"') do (
    set "fps_path=%%a"
)
:: calculate difference in miliseconds
set /a DD=%diff1%*1000
powershell -Command "$delay = %DD% / %fps_path%; Write-Host $delay" > "%TEMP%delay.raw.txt"
for /f "tokens=1 delims=(.)" %%a in ('type "%TEMP%delay.raw.txt"') do (
    set "delay1=%%a"
)

set /a DD=%diff2%*1000
powershell -Command "$delay = %DD% / %fps_path%; Write-Host $delay" > "%TEMP%delay.raw.txt"
for /f "tokens=1 delims=(.)" %%a in ('type "%TEMP%delay.raw.txt"') do (
    set "delay2=%%a"
)

:: print results
echo.
echo.
echo \033[92m WARNING! WARNING! WARNING! | "%cmdcolor%"
echo This may not be the true difference, ALWAYS DOUBLE-CHECK WITH THE EXTRACTED PNGs...
echo.
echo --^> Possible difference in frames: %diff1%
echo --^> Possible difference in MS: %delay1%
echo.

:skip.guessing

ren "%output_path%SCREENSHOTS" "%filename%_VS_%filename_2%"
explorer "%output_path%%filename%_VS_%filename_2%"
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::---------------------------------------MANUAL fast ----------------------------------------------------------------------------------------------------------------------------
:manual.check

echo Analyse the whole videos or just a sample^? (default=f)"
echo.
echo --^> Sample (fast)= f
echo --^> Whole Video (slow)= s 
echo.
set /p full=
if /i "%full%"=="s" set full=s
if /i "%full%"=="f" set full=f
if not "%full%"=="s" if not "%full%"=="f" set full=f

MD "%output_path%%filename%\"

:: make samples
if /i "%full%"=="s" goto :skip.fast
echo \033[92m making samples... | "%cmdcolor%"
"%mkvmerge_path%" --output ^"%output_path%%filename%\%filename%_sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
if not [%v2%]==[] "%mkvmerge_path%" --output ^"%output_path%%filename%\%filename_2%_sample.mkv^" --compression 0:none --no-audio --no-subtitles ^"^(^" ^"%filepath_2%%filename_2%%fileext_2%^" ^"^)^" --split parts:00:00:00-00:05:00 > Nul
echo Done.
	 
echo \033[92m Indexing Video 1: %filename% | "%cmdcolor%"
"%ffmsindex%" "%output_path%%filename%\%filename%_sample.mkv" -f "%output_path%%filename%\v1.ffindex"

echo LoadPlugin("%ffms2%") > "%output_path%%filename%\%filename%_V1_script.avs"
echo FFVideoSource("%output_path%%filename%\%filename%_sample.mkv", cachefile="%output_path%%filename%\v1.ffindex") >> "%output_path%%filename%\%filename%_V1_script.avs"
echo #%upscale_algo%Resize(3840, 2160)  >> "%output_path%%filename%\%filename%_V1_script.avs"

if [%v2%]==[] goto :end
echo \033[92m Indexing Video 2: %filename_2% | "%cmdcolor%"
"%ffmsindex%" "%output_path%%filename%\%filename_2%_sample.mkv" -f "%output_path%%filename%\v2.ffindex"

echo LoadPlugin("%ffms2%") > "%output_path%%filename%\%filename_2%_V2_script.avs"
echo FFVideoSource("%output_path%%filename%\%filename_2%_sample.mkv", cachefile="%output_path%%filename%\v2.ffindex") >> "%output_path%%filename%\%filename_2%_V2_script.avs"
echo #%upscale_algo%Resize(3840, 2160) >> "%output_path%%filename%\%filename_2%_V2_script.avs"
echo Done.
goto :end
::----------------------------------------Manual full---------------------------------------------------------------------------------------------------------------------------------

:skip.fast
::index files for accurate frame reading
echo \033[92m Indexing Video 1: %filename% | "%cmdcolor%"
"%ffmsindex%" "%filepath%%filename%%fileext%" -f "%output_path%%filename%\v1.ffindex"

if [%v2%]==[] goto :skip
echo \033[92m Indexing Video 2: %filename_2% | "%cmdcolor%"
"%ffmsindex%" "%filepath_2%%filename_2%%fileext_2%" -f "%output_path%%filename%\v2.ffindex"
echo Done.

:skip
:: Make V1 script
echo LoadPlugin("%ffms2%") > "%output_path%%filename%\%filename%_V1_script.avs"
echo FFVideoSource("%filepath%%filename%%fileext%", cachefile="%output_path%%filename%\v1.ffindex") >> "%output_path%%filename%\%filename%_V1_script.avs"
echo #%upscale_algo%Resize(3840, 2160)  >> "%output_path%%filename%\%filename%_V1_script.avs"
if [%v2%]==[] goto :end

:: Make V2 script
echo LoadPlugin("%ffms2%") > "%output_path%%filename%\%filename_2%_V2_script.avs"
echo FFVideoSource("%filepath_2%%filename_2%%fileext_2%", cachefile="%output_path%%filename%\v2.ffindex") >> "%output_path%%filename%\%filename_2%_V2_script.avs"
echo #%upscale_algo%Resize(3840, 2160) >> "%output_path%%filename%\%filename_2%_V2_script.avs"

:end
::run the scripts in avspmod
if not [%v2%]==[] start "" "%AvsPmod_path%" "%output_path%%filename%\%filename%_v1_script.avs" "%output_path%%filename%\%filename_2%_v2_script.avs"
if [%v2%]==[] start "" "%AvsPmod_path%" "%output_path%%filename%\%filename%_v1_script.avs"

:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
if exist "%output_path%%filename%_v1_sample.log" del "%output_path%%filename%_v1_sample.log"
if exist "%output_path%%filename_2%_v2_sample.log" del "%output_path%%filename_2%_v2_sample.log"
if exist "%output_path%%filename%_v1.log" del "%output_path%%filename%_v1.log"
if exist "%output_path%%filename_2%_v2.log" del "%output_path%%filename_2%_v2.log"
echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::------------------------------------------------------------------------------------------------------------------------------------------------------------------------
::---------------------------------------------------------------framerate change---------------------------------------------------------------------------------------
::------------------------------------------------------------------------------------------------------------------------------------------------------------------------
:MODE.2

echo.
echo \033[36m          ============= | "%cmdcolor%"
echo \033[36m          - FRAMERATE - | "%cmdcolor%"
echo \033[36m          ============= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- Input can be a single file or a folder with files  (SRT/MKV/MP4/TS/M2TS/HEVC/H265)
echo -- Can change HEVC bitstream framerate or color range
echo -- Can change SRT subtitles framerate (must be demuxed)
echo -- This workflow does not mux, and only HEVC is supported for video inputs
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.

echo   Drag and drop a file or a folder with files and press enter...& set /p video_path=
echo.

set batch.info=y
cd /d "%output_path%"
setlocal enabledelayedexpansion

set count=0
:: find how many files there are to process
for /r %video_path% %%F in (*) do (
    set /a "count+=1"
    set "file!count!=%%~fF"
)
:: set files to variables
>variables.txt (
    for /l %%i in (1,1,%count%) do (
        echo file%%i=!file%%i!
    )
)

for /f "usebackq tokens=1,* delims==" %%a in ("variables.txt") do (
    set "%%a=%%b"
)

del variables.txt
:: set filenames filepaths and file extensions to variables
for /l %%i in (1,1,%count%) do (
    for %%j in ("!file%%i!") do (
        set "filename%%i=%%~nj"
        set "filepath%%i=%%~dpj"
        set "fileext%%i=%%~xj"
		set f%%i=y
    )
)

if [%fileext1%]==[] (
     for %%i in (!video_path!) do set filename1=%%~ni
     for %%i in (!video_path!) do set filepath1=%%~di%%~pi
     for %%i in (!video_path!) do set fileext1=%%~xi
)

if /i "%same_input_output%"=="YES" set output_path=%filepath1%

if /i "%fileext1%"==".srt" (
         set fix=srt
		 echo What is the input framerate^? choice are: 23/24/25^(default=23^) & set /p inputframerate=
		 echo What is the output framerate^? choice are: 23/24/25^(default=23^) & set /p FPS=
		 goto :skipprompt
)

echo What do you want to change^? FrameRate(f) or ^Color Range(c)^? (default=f)
echo.
echo --^> FrameRate= f 
echo --^> Color Range= c
echo.
set /p fix=
if [%fix%]==[] set fix=f
if /i "%fix%"=="c" set fix=c
if /i "%fix%"=="f" set fix=f
if not "%fix%"=="f" if not "%fix%"=="c" set fix=f

if /i "%fix%"=="c" echo Change to Full(1) or Limited range(2)^? Choices are: full=1 or limited=0 ^(default=0^) and press enter...& set /p flag=
if /i "%fix%"=="f" echo What framerate do you want to use^? Choices are: 23/24/25 ^(default=23^)& set /p FPS=
echo.
:skipprompt
if [%inputframerate%]==[] set inputframerate=23.976
if "%inputframerate%"=="23" set inputframerate=23.976
if "%inputframerate%"=="29" set inputframerate=29.970
if "%inputframerate%"=="59" set inputframerate=59.940
if [%flag%]==[]  set flag=0
if [%FPS%]==[]  set FPS=24000/1001& set framerate=23.976
if "%FPS%"=="23" set FPS=24000/1001& set framerate=23.976
if "%FPS%"=="24" set framerate=24
if "%FPS%"=="25" set framerate=25
if "%FPS%"=="30" set framerate=30
if "%FPS%"=="60" set framerate=60
if "%FPS%"=="29" set FPS=30000/1001& set framerate=29.970
if "%FPS%"=="59" set FPS=60000/1001& set framerate=59.940

::----------------------------------------------------------JOB----------------------------------------------------------------------------------------------

:loopframerate

::skip files
if /i "%fix%"=="srt" if not "%fileext1%"==".srt" echo Invalid extension, skipping file...& goto :end
if not "%fix%"=="srt" if not "%fileext1%"==".mkv" if not "%fileext1%"==".ts" if not "%fileext1%"==".m2ts" if not "%fileext1%"==".mp4" if not "%fileext1%"==".hevc" if not "%fileext1%"==".h265" echo Invalid extension, skipping file...& goto :end

::color range change
if /i "%fix%"=="c" "%ffmpeg_path%"  -i "%filepath1%%filename1%%fileext1%" -c:v copy -bsf:v hevc_metadata=video_full_range_flag=%flag% "%output_path%%filename1%_fixed.hevc"
::video framerate change
if /i "%fix%"=="f" "%ffmpeg_path%" -vsync drop -i "%filepath1%%filename1%%fileext1%" -c copy -bsf:v hevc_metadata=tick_rate=%FPS%:num_ticks_poc_diff_one=1 "%output_path%%filename1%_%framerate%fps.hevc"
::subtitles framerate change
if /i "%fix%"=="srt" python  "%~dp0tools\SRT_FrameRate_Editor.py" -i "%filepath1%%filename1%%fileext1%" -f %inputframerate% -c %framerate% -o "%output_path%%filename1%_%framerate%fps.srt" 
if /i "%fix%"=="srt" echo \033[92m Converting %inputframerate% fps to %framerate% fps of "%filepath1%%filename1%%fileext1%" | "%cmdcolor%"
echo done.
echo.

 :end
for /l %%i in (2,1,%count%) do (
if "!f%%i!"=="y" set filename1=!filename%%i!& set filepath1=!filepath%%i!& set fileext1=!fileext%%i!& set f%%i=n& goto :loopframerate
)

echo.
set end_time=%time%
set options="tokens=1-4 delims=:.,"
for /f %options% %%a in ("%start_time%") do set start_s=%%a&set start_m=%%b&set start_c=%%c&set start_ms=%%d
for /f %options% %%a in ("%end_time%") do set end_s=%%a&set end_m=%%b&set end_c=%%c&set end_ms=%%d

set /a start=(start_s*3600*100 + start_m*60*100 + start_c*100 + start_ms)/100
set /a end=(end_s*3600*100 + end_m*60*100 + end_c*100 + end_ms)/100

set /a elapsed=end-start
set /a hh=elapsed/(60*60), rest=elapsed%%(60*60), mm=rest/60, ss=rest%%60

if %mm% lss 10 set mm=0%mm%
if %ss% lss 10 set ss=0%ss%

echo.
echo Start time: %start_time%
echo End time: %end_time%
echo Time taken: %hh%:%mm%:%ss%
echo.
echo \033[92mThe script has been completed. | "%cmdcolor%"
pause
exit

::##################################################################################################################################################################################################
::##################################################################################################################################################################################################
::##################################################################################################################################################################################################

:: ---------------------------------------------------------Sample Maker-----------------------------------------------------------------------------------------------------------------------------------------
:MODE.3
:Chunk.AgainZZ
echo.
echo \033[36m       ============= | "%cmdcolor%"
echo \033[36m       -   SAMPLE  - | "%cmdcolor%"
echo \033[36m       ============= | "%cmdcolor%"
echo. 
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow just makes a 5 minutes sample.
echo -- Timestamp editable at line 216
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
echo   Drag and drop a file(MKV/TS/M2TS/MP4/HEVC) and press enter...
set /p video_path=

Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

if /i "%same_input_output%"=="YES" set output_path=%filepath%

"%mkvmerge_path%" --output ^"%output_path%%filename%_chunk.mkv^" --compression 0:none ^"^(^" ^"%filepath%%filename%%fileext%^" ^"^)^" --split parts:%timestamp%
echo.
echo \033[92mThe script has been completed. | "%cmdcolor%"
goto :Chunk.AgainZZ

::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************

:MODE.4

::find framecount
echo.
echo \033[36m       ================== | "%cmdcolor%"
echo \033[36m       -   FRAMECOUNT   - | "%cmdcolor%"
echo \033[36m       ================== | "%cmdcolor%"
echo. 
echo \033[92m----------------------------------------------------------------------| "%cmdcolor%"
echo -- This workflow just quickly display a video framecount
echo \033[92m----------------------------------------------------------------------| "%cmdcolor%"
echo.
:checkframecountagain
::user input
echo   Drag and drop a file and press enter...
set /p video_path=
:: make variable of path, filename and extension. only input with "!" wont work.
Setlocal EnableDelayedExpansion
for %%i in (!video_path!) do set filename=%%~ni
for %%i in (!video_path!) do set filepath=%%~di%%~pi
for %%i in (!video_path!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion
if exist "%temp_folder%temp.folder27" rmdir /Q /S "%temp_folder%temp.folder27"
MD "%temp_folder%temp.folder27"
set TEMP=%temp_folder%temp.folder27\

::set variable
set frameCount=
:: check frame count with media info
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.JSON"
"%JQ_path%" .media.track[1].FrameCount "%TEMP%mediainfo.JSON" > "%TEMP%FrameCount.txt"
for /f "tokens=1 delims=" %%a in ('type "%TEMP%FrameCount.txt"') do (
    set "FrameCount=%%a"
)
set frameCount=%frameCount:"=%
echo.
::display result
echo ==============================
echo Input frame count is: %FrameCount%
echo ==============================
echo.
rmdir /Q /S "%TEMP%"
:: start again
goto :checkframecountagain

::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************


:MODE.5
echo.
echo \033[36m       ================== | "%cmdcolor%"
echo \033[36m       -   SUB TONEMAP  - | "%cmdcolor%"
echo \033[36m       ================== | "%cmdcolor%"
echo. 
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- Input must be a folder with sup file(s).
echo -- Tonemap pgs(.sup) subtitles ^for proper HDR brightness.
echo -- Brightness reduction percentage can be configured at line 258 (default = 60%)
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
:: user input
echo Drag and drop a folder and press enter... & set /p input=

Setlocal EnableDelayedExpansion
for %%i in (!input!) do set filename=%%~ni
for %%i in (!input!) do set filepath=%%~di%%~pi
for %%i in (!input!) do set fileext=%%~xi
Setlocal DisableDelayedExpansion

%subtitle_tonemap% "%filepath%%filename%%fileext%" -p %percentage% -o "%output_path%\%filename%_tonemapped"
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo.
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu
exit

::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************


:MODE.6
:: dialogue normalization
echo.
echo \033[36m       ================ | "%cmdcolor%"
echo \033[36m       -   DIALNORM   - | "%cmdcolor%"
echo \033[36m       ================ | "%cmdcolor%"
echo. 
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo -- This script checks for Dialogue Normalization metadata
echo -- Many AVR cannot disable it with DDP tracks
echo -- see: https://www.avsforum.com/threads/defeating-dialnorm.3253654/
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
:again.dial
::user input
echo   Drag and drop a file and press enter...& set /p input_path=

:: make variable of path, filename and extension. only input with "!" wont work.
Setlocal EnableDelayedExpansion
for %%i in (!input_path!) do set filename=%%~ni
for %%i in (!input_path!) do set filepath=%%~di%%~pi
for %%i in (!input_path!) do set fileext=%%~xi

:: make and set temp folder
if exist "%temp_folder%temp.folder35_new" rmdir /Q /S "%temp_folder%temp.folder35_new"
if exist "%temp_folder%temp.folder35" set E1=_new
MD "%temp_folder%temp.folder35%E1%"
set TEMP=%temp_folder%temp.folder35%E1%\

echo.&echo.
echo \033[36m  =============== | "%cmdcolor%"
echo \033[36m  - INPUT INFO  - | "%cmdcolor%"
echo \033[36m  =============== | "%cmdcolor%"
echo.
::list tracks id
"%ffprobe_path%" -v error -select_streams a -show_entries stream=index,codec_name,channel_layout:stream_tags=language -of default=noprint_wrappers=1 "%filepath%%filename%%fileext%"
echo.
::user input
echo Which track do you want to check (0=1 / 1=2 / default=2) and press enter... & set /p ID=
if "%ID%"=="" set ID=2

::mediainfo export
"%mediainfo_path%" "%filepath%%filename%%fileext%" --output=JSON > "%TEMP%mediainfo.json"
"%JQ_path%" .media.track[%ID%].extra.dialnorm "%TEMP%mediainfo.json" > "%TEMP%dial.txt"
for /f "delims=" %%x in (%TEMP%dial.txt) do set Dialnorm=%%x

::calculate Dialnorm
set "Dialnorm=%Dialnorm:-=%"
set /a "result=31-%Dialnorm%"
if /i "%result%"=="31" set result=0 
echo.
echo.
echo.
::result
echo \033[92m     ------------------------------------------| "%cmdcolor%"
echo \033[92m     Track %ID% has a -%result%DB Dialogue Normalization| "%cmdcolor%"
echo \033[92m     ------------------------------------------| "%cmdcolor%"
echo.
echo.

echo.
:: delete temp files
if not "%DEL_temp%"=="NO" echo Deleting TEMP folder... & rmdir /Q /S "%TEMP%"
::start again
goto :again.dial

::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************

:MODE.7
echo.
echo \033[36m       ====================== | "%cmdcolor%"
echo \033[36m       -   FIND A PLAYLIST  - | "%cmdcolor%"
echo \033[36m       ====================== | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo --This script scan and display playlists from a Bluray Disc folder
echo \033[92m-------------------------------------------------------------------------------------| "%cmdcolor%"
echo.
:scan.again
echo   Drag and drop your BD folder and press enter... & set /p BD_path=
:: list playlists
"%DGDemux_path%" -d %BD_path%
echo Done, press enter to scan another bluray! & pause & goto :scan.again

::**************************************************************************************************************************************************************************************************************************************************************************************
::**************************************************************************************************************************************************************************************************************************************************************************************

:MODE.8
echo.
echo \033[36m       ========================= | "%cmdcolor%"
echo \033[36m       - 12-bit Nits Converter - | "%cmdcolor%"
echo \033[36m       ========================= | "%cmdcolor%"
echo.
echo \033[92m-------------------------------------------------------| "%cmdcolor%"
echo -- This workflow can convert 12-bit to nits or nits to 12-bit
echo \033[92m-------------------------------------------------------| "%cmdcolor%"
echo.
echo.
echo   Nits to PQ (1) or PQ to Nits(2)^? (Default = 1)
echo.
echo --^> Nits_to_PQ= 1 
echo --^> PQ_to_Nits= 2
echo.
set /p conversion=
if [%conversion%]==[]  set conversion=1
if not "%conversion%"=="1" if not "%conversion%"=="2" set conversion=1

if /i  "%conversion%"=="1" set type1=12-bit-PQ& set type=Nits& set input=nits
if /i  "%conversion%"=="2" set type1=Nits& set type=12-bit-PQ& set input=pq

:calculateagain
echo   Enter %type% value and press enter... & set /p value=
echo.
if [%value%]==[] goto :end

::Calculate value
for /f "tokens=*" %%i in ('python "%~dp0tools\12bit_Nits_Converter.py" -%input% %value%') do set output=%%i

:: Display the captured output
echo \033[92m %value% %type% in %type1% is %output%  | "%cmdcolor%"
echo.
set value=
::loop
goto :calculateagain

:end
set filename1=&set filepath1=& set fileext1=&set filename=&set filepath=& set fileext=
echo \033[92mThe script has been completed. Do you want to quit or go back to main menu (q or m default=q)^?| "%cmdcolor%"& set /p action=
if /i "%action%"=="m" goto :Main.Menu

exit